<!-- fragments/top.html -->
<div th:fragment="topFragment">
  <header class="top-bar">
    <div class="left-section">
      <button id="menuToggle" title="Î©îÎâ¥ Ïó¥Í∏∞/Îã´Í∏∞">
        <i class="fas fa-bars"></i>
      </button>
      <h1 class="site-title">MyBaseLink</h1>
    </div>

    <div class="right-section">
      <div id="profileBtn" class="unified-btn" title="ÌîÑÎ°úÌïÑ">
        <i class="fas fa-user-circle"></i>
      </div>

      <div id="sessionRefreshContainer" class="unified-btn session-refresh-btn" title="Remaining time">
        <i class="fas fa-clock" id="timerIcon"></i>
        <span id="sessionTimer">--:--</span>
        <i id="refreshSessionBtn" class="fas fa-rotate-right" title="Refresh"></i>
      </div>

      <button id="logoutBtn" class="unified-btn" title="Î°úÍ∑∏ÏïÑÏõÉ">
        <i class="fas fa-right-from-bracket"></i>
      </button>
    </div>
  </header>

  <!-- ‚úÖ ÌîÑÎ°úÌïÑ Î†àÏù¥Ïñ¥ -->
  <div id="profileLayer" class="profile-layer">
    <h3>ÎÇ¥ ÌîÑÎ°úÌïÑ</h3>
    <label>Ïù¥Î¶Ñ:<input type="text" id="profileName" readonly></label>
    <label>Ïù¥Î©îÏùº:<input type="email" id="profileEmail" placeholder="you@example.com" readonly></label>

    <!-- üåô Îã§ÌÅ¨Î™®Îìú ÌÜ†Í∏Ä Ïä§ÏúÑÏπò -->
    <div class="darkmode-toggle">
      <span class="label">Îã§ÌÅ¨ Î™®Îìú</span>
      <label class="switch">
        <input type="checkbox" id="darkModeSwitch" />
        <span class="slider"></span>
      </label>
    </div>

    <div class="profile-layer-btns">
      <button id="closeProfileBtn">Îã´Í∏∞</button>
    </div>
  </div>

  <!-- ÏÑ∏ÏÖò ÏïåÎ¶º -->
  <div id="sessionAlert" class="session-alert" style="display: none;"></div>

<style>
  :root {
    --primary-bg: #f3f4f6;
    --border-color: #d1d5db;
    --text-color: #111827;
    --unified-btn-bg: #e5e7eb;
    --unified-btn-text: #1f2937;
    --icon-color: #374151;
    --alert-info-bg: rgba(37, 99, 235, 0.15);
    --alert-info-text: #1e3a8a;
    --alert-warning-text: #f59e0b;
    --alert-danger-text: #dc2626;
    --profile-bg: rgba(255,255,255,0.8);
    --shadow-color: rgba(0, 0, 0, 0.1);
    --glass-border: rgba(255,255,255,0.4);
    --glass-shadow: rgba(31, 41, 55, 0.2);
    --transition-speed: 0.25s;
  }

  /* üåô Îã§ÌÅ¨Î™®Îìú Î≥ÄÏàò */
  body.dark-mode {
    --primary-bg: #1f2937;
    --border-color: #374151;
    --text-color: #f9fafb;
    --unified-btn-bg: #374151;
    --unified-btn-text: #f3f4f6;
    --icon-color: #f3f4f6;
    --profile-bg: rgba(40, 45, 50, 0.85);
    --shadow-color: rgba(0, 0, 0, 0.6);
    --alert-info-bg: rgba(37, 99, 235, 0.25);
    --alert-info-text: #93c5fd;
    --alert-warning-text: #fbbf24;
    --alert-danger-text: #f87171;
  }

  /* ===============================================================
     ‚úÖ ÏÉÅÎã® Î∞î
  =============================================================== */
  .top-bar {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 50px;
    display: flex; align-items: center;
    background: var(--primary-bg);
    border-bottom: 1px solid var(--border-color);
    color: var(--text-color);
    z-index: 4000;
    box-sizing: border-box;
    padding: 0 1rem;
    transition: background var(--transition-speed), color var(--transition-speed);
  }

  .left-section {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }
  .site-title {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .right-section {
    position: absolute;
    right: 0.6rem;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  /* ‚úÖ Î©îÎâ¥ ÌÜ†Í∏Ä */
  #menuToggle {
    background: none;
    border: none;
    color: var(--text-color);
    font-size: 20px;
    cursor: pointer;
    width: 36px; height: 36px;
    transition: transform 0.2s ease;
  }
  #menuToggle:hover { transform: scale(1.1); }

  /* ‚úÖ Í≥µÌÜµ Î≤ÑÌäº */
  .unified-btn {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    height: 36px; min-width: 36px; padding: 0 10px;
    background: var(--unified-btn-bg); color: var(--unified-btn-text);
    border-radius: 6px; font-size: 14px; border: none; cursor: pointer;
    transition: all 0.2s;
  }
  .unified-btn i { font-size: 16px; color: var(--icon-color); }

  /* ‚úÖ ÌÉÄÏù¥Î®∏ */
  #sessionRefreshContainer {
    display: flex; align-items: center; gap: 6px;
    font-family: "Roboto Mono", monospace;
    font-variant-numeric: tabular-nums;
  }
  #sessionTimer {
    display: inline-block; min-width: 3.2em; text-align: center;
    font-size: 13px; font-weight: 600;
  }

  /* ‚úÖ ÌîÑÎ°úÌïÑ Î†àÏù¥Ïñ¥ */
  .profile-layer {
    position: absolute;
    top: 60px; right: 1rem;
    width: 260px;
    padding: 16px 18px;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    background: var(--profile-bg);
    box-shadow: 0 4px 20px var(--glass-shadow);
    backdrop-filter: blur(10px);
    display: none;
    z-index: 5000;
    color: var(--text-color);
    animation: fadeIn 0.25s ease;
  }

  .profile-layer h3 { margin: 0 0 12px; font-size: 15px; font-weight: 700; }
  .profile-layer label { display: flex; flex-direction: column; gap: 3px; margin-bottom: 10px; font-size: 13px; font-weight: 500; }
  .profile-layer input {
    border: 1px solid #d1d5db; border-radius: 6px; padding: 6px 8px;
    font-size: 13px; background: rgba(255,255,255,0.9); color: #111827;
  }

  /* üåô Îã§ÌÅ¨Î™®Îìú ÌÜ†Í∏Ä */
  .darkmode-toggle {
    display: flex; justify-content: space-between; align-items: center;
    margin: 10px 0 14px 0; font-size: 13px; font-weight: 500;
  }
  .switch { position: relative; width: 42px; height: 22px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute; inset: 0; cursor: pointer;
    background-color: #cbd5e1; border-radius: 34px; transition: 0.3s;
  }
  .slider::before {
    content: ""; position: absolute; height: 16px; width: 16px;
    left: 3px; bottom: 3px; background: #fff; border-radius: 50%;
    transition: 0.3s;
  }
  input:checked + .slider { background-color: #2563eb; }
  input:checked + .slider::before { transform: translateX(20px); }

  .profile-layer-btns { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
  .profile-layer-btns button {
    padding: 5px 10px; border-radius: 6px; border: none; font-size: 13px;
    background: #2563eb; color: #fff; cursor: pointer; transition: background 0.2s;
  }
  .profile-layer-btns button:hover { background: #1d4ed8; }

  /* ‚úÖ ÏïåÎ¶º */
  .session-alert {
    position: fixed; top: 60px; right: 1rem;
    background: var(--alert-info-bg); color: var(--alert-info-text);
    padding: 6px 10px; border-radius: 6px; font-size: 13px;
    box-shadow: 0 2px 6px var(--shadow-color);
    opacity: 0.9; backdrop-filter: blur(4px);
    z-index: 6000; pointer-events: none;
  }

  @keyframes fadeIn { from {opacity:0;transform:translateY(-6px);} to {opacity:1;transform:translateY(0);} }

  @media (max-width:640px){
    .right-section{right:0.5rem;gap:6px;}
    .profile-layer{right:0.5rem;width:90%;padding:14px;}
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (sel) => document.querySelector(sel);
  const menuToggleBtn = $("#menuToggle");
  const profileBtn = $("#profileBtn");
  const profileLayer = $("#profileLayer");
  const closeProfileBtn = $("#closeProfileBtn");
  const timerEl = $("#sessionTimer");
  const timerIcon = $("#timerIcon");
  const refreshBtn = $("#refreshSessionBtn");
  const logoutBtn = $("#logoutBtn");
  const profileNameInput = $("#profileName");
  const profileEmailInput = $("#profileEmail");
  const alertBox = $("#sessionAlert");
  const darkSwitch = $("#darkModeSwitch");
  let timerInterval = null;

  // ‚úÖ Í≥µÏö© ÏïåÎ¶º
  function setAlert(msg, autoHideMs = 1500) {
    alertBox.textContent = msg;
    alertBox.style.display = "block";
    setTimeout(() => (alertBox.style.display = "none"), autoHideMs);
  }

  // ‚úÖ Îã§ÌÅ¨Î™®Îìú Ï¥àÍ∏∞ Î≥µÏõê
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") {
    document.body.classList.add("dark-mode");
    darkSwitch.checked = true;
  }

  // ‚úÖ Îã§ÌÅ¨Î™®Îìú Ï†ÑÌôò
  darkSwitch.addEventListener("change", () => {
    if (darkSwitch.checked) {
      document.body.classList.add("dark-mode");
      localStorage.setItem("theme", "dark");
    } else {
      document.body.classList.remove("dark-mode");
      localStorage.setItem("theme", "light");
    }
  });

  // ‚úÖ ÌÉÄÏù¥Î®∏
  function startTimer(remainingMillis) {
    if (timerInterval) clearInterval(timerInterval);
    const endTime = Date.now() + remainingMillis;
    tick();
    timerInterval = setInterval(tick, 1000);
    function tick() {
      const remain = endTime - Date.now();
      if (remain <= 0) {
        clearInterval(timerInterval);
        timerEl.textContent = "00:00";
        timerIcon.style.color = "var(--alert-danger-text)";
        setAlert("ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.", 2000);
        localStorage.removeItem("token");
        setTimeout(() => (location.href = "/login"), 1500);
        return;
      }
      const m = Math.floor(remain / 60000);
      const s = Math.floor((remain % 60000) / 1000);
      timerEl.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      timerIcon.style.color = remain <= 5*60*1000 ? "var(--alert-warning-text)" : "";
    }
  }

  // ‚úÖ ÌîÑÎ°úÌïÑ + ÏÑ∏ÏÖò Î°úÎìú
  async function initProfileAndTimer() {
    try {
      const token = localStorage.getItem("token");
      const res = await fetch("/auth/validate", {
        headers: token ? {"Authorization":"Bearer "+token} : {},
        credentials: "include"
      });
      const data = await res.json();
      if (!res.ok || !data.valid) {
        setAlert("ÏÑ∏ÏÖòÏù¥ ÏóÜÏäµÎãàÎã§.", 2000);
        localStorage.removeItem("token");
        setTimeout(() => (location.href="/login"), 1200);
        return;
      }
      startTimer(data.remainingMillis ?? 0);
      profileNameInput.value = data.name || data.username || "";
      profileEmailInput.value = data.email || "";
    } catch { setAlert("ÏÑ∏ÏÖò ÌôïÏù∏ Ïã§Ìå®", 1500); }
  }

  async function refreshSession() {
    try {
      const token = localStorage.getItem("token");
      const res = await fetch("/auth/refresh", {
        method:"POST",
        headers: token ? {"Authorization":"Bearer "+token}:{},
        credentials:"include"
      });
      const body = await res.json().catch(()=>({}));
      if (!res.ok) { setAlert(body.error || "ÏÑ∏ÏÖò Ïó∞Ïû• Ïã§Ìå®",1500); return; }
      if (body.token) localStorage.setItem("token", body.token);
      setAlert("ÏÑ∏ÏÖòÏù¥ Ïó∞Ïû•ÎêòÏóàÏäµÎãàÎã§.",1000);
      startTimer(body.sessionMillis ?? 15*60*1000);
    } catch { setAlert("ÏÑ∏ÏÖò Ïó∞Ïû• Ï§ë Ïò§Î•ò",1500); }
  }

  async function doLogout() {
    try {
      const token = localStorage.getItem("token");
      await fetch("/auth/logout", {method:"POST",headers: token?{"Authorization":"Bearer "+token}:{},credentials:"include"});
    } finally {
      localStorage.removeItem("token");
      setAlert("Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§.",800);
      setTimeout(() => (location.href="/login"),800);
    }
  }

  // ‚úÖ Ïù¥Î≤§Ìä∏
  menuToggleBtn?.addEventListener("click",()=>{ if(window.toggleSidebar) window.toggleSidebar(); });
  profileBtn?.addEventListener("click",(e)=>{ e.stopPropagation(); profileLayer.style.display=profileLayer.style.display==="block"?"none":"block"; });
  closeProfileBtn?.addEventListener("click",()=>profileLayer.style.display="none");
  document.addEventListener("click",(e)=>{ if(profileLayer.style.display==="block"&&!profileLayer.contains(e.target)&&e.target!==profileBtn) profileLayer.style.display="none"; });
  refreshBtn?.addEventListener("click",refreshSession);
  logoutBtn?.addEventListener("click",doLogout);

  initProfileAndTimer();
});
</script>
</div>
