<!-- top.html -->
<div th:fragment="topFragment">
  <header class="top-bar">
    <div class="left-section">
      <button id="menuToggle" title="ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°">
        <i class="fas fa-bars"></i>
      </button>
      <h1 class="site-title">MyBaseLink</h1>
    </div>

    <div class="right-section">
      <div id="profileBtn" class="unified-btn" title="í”„ë¡œí•„">
        <i class="fas fa-user-circle"></i>
      </div>

      <div id="sessionRefreshContainer" class="unified-btn session-refresh-btn" title="Remaining time">
        <i class="fas fa-clock" id="timerIcon"></i>
        <span id="sessionTimer">--:--</span>
        <i id="refreshSessionBtn" class="fas fa-rotate-right" title="Refresh"></i>
      </div>

      <button id="logoutBtn" class="unified-btn" title="ë¡œê·¸ì•„ì›ƒ">
        <i class="fas fa-right-from-bracket"></i>
      </button>
    </div>
  </header>

  <!-- âœ… í”„ë¡œí•„ ë ˆì´ì–´ -->
  <div id="profileLayer" class="profile-layer">
    <h3>ë‚´ í”„ë¡œí•„</h3>
    <label>ì´ë¦„:<input type="text" id="profileName" readonly></label>
    <label>ì´ë©”ì¼:<input type="email" id="profileEmail" placeholder="you@example.com" readonly></label>

    <!-- ğŸŒ™ ë‹¤í¬ëª¨ë“œ í† ê¸€ ìŠ¤ìœ„ì¹˜ -->
    <div class="darkmode-toggle">
      <span class="label">ë‹¤í¬ ëª¨ë“œ</span>
      <label class="switch">
        <input type="checkbox" id="darkModeSwitch" />
        <span class="slider"></span>
      </label>
    </div>

    <div class="profile-layer-btns">
      <button id="closeProfileBtn">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ì„¸ì…˜ ì•Œë¦¼ -->
  <div id="sessionAlert" class="session-alert" style="display: none;"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (sel) => document.querySelector(sel);
  const menuToggleBtn = $("#menuToggle");
  const profileBtn = $("#profileBtn");
  const profileLayer = $("#profileLayer");
  const closeProfileBtn = $("#closeProfileBtn");
  const timerEl = $("#sessionTimer");
  const timerIcon = $("#timerIcon");
  const refreshBtn = $("#refreshSessionBtn");
  const logoutBtn = $("#logoutBtn");
  const profileNameInput = $("#profileName");
  const profileEmailInput = $("#profileEmail");
  const alertBox = $("#sessionAlert");
  const darkSwitch = $("#darkModeSwitch");
  let timerInterval = null;

  // âœ… ê³µìš© ì•Œë¦¼
  function setAlert(msg, autoHideMs = 1500) {
    alertBox.textContent = msg;
    alertBox.style.display = "block";
    setTimeout(() => (alertBox.style.display = "none"), autoHideMs);
  }

  // âœ… ë‹¤í¬ëª¨ë“œ ì´ˆê¸° ë³µì›
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") {
    document.body.classList.add("dark-mode");
    darkSwitch.checked = true;
  }

  // âœ… ë‹¤í¬ëª¨ë“œ ì „í™˜
  darkSwitch.addEventListener("change", () => {
    if (darkSwitch.checked) {
      document.body.classList.add("dark-mode");
      localStorage.setItem("theme", "dark");
    } else {
      document.body.classList.remove("dark-mode");
      localStorage.setItem("theme", "light");
    }
  });

  // âœ… íƒ€ì´ë¨¸
  function startTimer(remainingMillis) {
    if (timerInterval) clearInterval(timerInterval);
    const endTime = Date.now() + remainingMillis;
    tick();
    timerInterval = setInterval(tick, 1000);
    function tick() {
      const remain = endTime - Date.now();
      if (remain <= 0) {
        clearInterval(timerInterval);
        timerEl.textContent = "00:00";
        timerIcon.style.color = "var(--top-alert-danger-text)"; // CSS ë³€ìˆ˜ ì´ë¦„ ë³€ê²½ ì ìš©
        setAlert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", 2000);
        localStorage.removeItem("token");
        setTimeout(() => (location.href = "/login"), 1500);
        return;
      }
      const m = Math.floor(remain / 60000);
      const s = Math.floor((remain % 60000) / 1000);
      timerEl.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      timerIcon.style.color = remain <= 5*60*1000 ? "var(--top-alert-warning-text)" : ""; // CSS ë³€ìˆ˜ ì´ë¦„ ë³€ê²½ ì ìš©
    }
  }

  // âœ… í”„ë¡œí•„ + ì„¸ì…˜ ë¡œë“œ
  async function initProfileAndTimer() {
    try {
      const token = localStorage.getItem("token");
      const res = await fetch("/auth/validate", {
        headers: token ? {"Authorization":"Bearer "+token} : {},
        credentials: "include"
      });
      const data = await res.json();
      if (!res.ok || !data.valid) {
        setAlert("ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.", 2000);
        localStorage.removeItem("token");
        setTimeout(() => (location.href="/login"), 1200);
        return;
      }
      startTimer(data.remainingMillis ?? 0);
      profileNameInput.value = data.name || data.username || "";
      profileEmailInput.value = data.email || "";
    } catch { setAlert("ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨", 1500); }
  }

  async function refreshSession() {
    try {
      const token = localStorage.getItem("token");
      const res = await fetch("/auth/refresh", {
        method:"POST",
        headers: token ? {"Authorization":"Bearer "+token}:{},
        credentials:"include"
      });
      const body = await res.json().catch(()=>({}));
      if (!res.ok) { setAlert(body.error || "ì„¸ì…˜ ì—°ì¥ ì‹¤íŒ¨",1500); return; }
      if (body.token) localStorage.setItem("token", body.token);
      setAlert("ì„¸ì…˜ì´ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.",1000);
      startTimer(body.sessionMillis ?? 15*60*1000);
    } catch { setAlert("ì„¸ì…˜ ì—°ì¥ ì¤‘ ì˜¤ë¥˜",1500); }
  }

  async function doLogout() {
    try {
      const token = localStorage.getItem("token");
      await fetch("/auth/logout", {method:"POST",headers: token?{"Authorization":"Bearer "+token}:{},credentials:"include"});
    } finally {
      localStorage.removeItem("token");
      setAlert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.",800);
      setTimeout(() => (location.href="/login"),800);
    }
  }

  // âœ… ì´ë²¤íŠ¸
  menuToggleBtn?.addEventListener("click",()=>{ if(window.toggleSidebar) window.toggleSidebar(); });
  profileBtn?.addEventListener("click",(e)=>{ e.stopPropagation(); profileLayer.style.display=profileLayer.style.display==="block"?"none":"block"; });
  closeProfileBtn?.addEventListener("click",()=>profileLayer.style.display="none");
  document.addEventListener("click",(e)=>{ if(profileLayer.style.display==="block"&&!profileLayer.contains(e.target)&&e.target!==profileBtn) profileLayer.style.display="none"; });
  refreshBtn?.addEventListener("click",refreshSession);
  logoutBtn?.addEventListener("click",doLogout);

  initProfileAndTimer();
});
</script>
</div>