<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <title>üìä Stock Batch Dashboard</title>

  <!-- ===============================================================
  üìä MyBaseLinkV2 - stockBatchBoard ÏÉÅÌÉú Î≥µÏõê ÏïàÏ†ïÌåê v1.2 (2025-11-01)
  ---------------------------------------------------------------
  ‚úÖ Ï≤´ Î≤àÏß∏ ÏÇ¨Ïö©Ïûê(Ïã§ÌñâÏûê) ÏÉÅÌÉú ÏûêÎèô Î≥µÏõê (ÏÉàÎ°úÍ≥†Ïπ®/Î©îÎâ¥ Ïù¥Îèô ÌõÑ)
  ‚úÖ ÏßÑÌñâÎ•†¬∑Ï∑®ÏÜåÎ≤ÑÌäº¬∑ÌûåÌä∏ Ï¶âÏãú Î≥µÍµ¨
  ‚úÖ Î°úÍ∑∏ ÏÉâÏÉÅ Í∞ïÏ°∞ + 200ms Î≤ÑÌçº + 700Ï§Ñ Î°§ÎßÅ(Î†â Î∞©ÏßÄ)
  ‚úÖ SSE Ïû¨Ïó∞Í≤∞ UI(Í≤ΩÍ≥†/Î≥µÏõê) + ÏÜåÏöîÏãúÍ∞Ñ ÌëúÏãú
  =============================================================== -->
  <style>
    h2 {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: .4rem;
      color: #111827;
    }

    .card-box,
    .dashboard-cards,
    .log-wrapper {
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05);
      margin-top: 14px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: .9rem;
      font-weight: 600;
      color: #fff;
      min-width: 110px;
      text-align: center;
    }

    .btn-start {
      background: #2563eb;
    }

    .btn-cancel {
      background: #dc2626;
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .controls {
      display: flex;
      gap: .6rem;
      flex-wrap: wrap;
      align-items: center;
    }

    input[type=number] {
      width: 90px;
      padding: .45rem .6rem;
      border: 1px solid #bbb;
      border-radius: 6px;
    }

    .dashboard-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }

    .card {
      flex: 1 1 300px;
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .05);
      display: flex;
      flex-direction: column;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .95rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .card-header i {
      color: #2563eb;
    }

    .card-header .right {
      margin-left: auto;
      font-weight: 600;
      font-size: .9rem;
    }

    .progress-bar {
      width: 100%;
      background: #e5e7eb;
      height: 14px;
      border-radius: 7px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-bar div {
      height: 100%;
      width: 0%;
      transition: width .3s;
    }

    .bar-total div {
      background: #2563eb;
    }

    .bar-krx div {
      background: #10b981;
    }

    .bar-data div {
      background: #f59e0b;
    }

    .log-wrapper h3 {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 0;
      font-size: 1rem;
    }

    .copy-btn {
      font-size: .9rem;
      cursor: pointer;
      user-select: none;
      margin-left: 10px;
      color: #444;
      opacity: .7;
    }

    .copy-btn:hover {
      opacity: 1;
      text-decoration: none;
    }

    .log-box {
      background: #111;
      color: #eee;
      font-family: Consolas, monospace;
      font-size: 13px;
      padding: 10px;
      border-radius: 10px;
      height: 380px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 6px;
      line-height: 1.4;
    }

    .log-info {
      color: #9ca3af;
    }

    .log-progress {
      color: #60a5fa;
    }

    .log-error {
      color: #ef4444;
      font-weight: 600;
    }

    .log-complete {
      color: #22c55e;
      font-weight: 600;
    }

    #connStatus {
      font-size: 12px;
      margin-left: 10px;
      color: #888;
    }

    #timer {
      font-size: 12px;
      margin-left: 10px;
      color: #555;
    }
  </style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">

    <div class="page-header">
      <div class="page-title">
        <h2 th:text="${pageTitle} ?: 'üìÑ Í∏∞Î≥∏ ÌéòÏù¥ÏßÄ Ï†úÎ™©'">üìÑ Í∏∞Î≥∏ ÌéòÏù¥ÏßÄ Ï†úÎ™©</h2>
      </div>
      <div class="breadcrumb">
        <i class="fas fa-folder-open"></i>
        <span th:text="${breadcrumb} ?: 'ÏãúÏä§ÌÖú / Í∏∞Î≥∏ Í≤ΩÎ°ú'">ÏãúÏä§ÌÖú / Í∏∞Î≥∏ Í≤ΩÎ°ú</span>
      </div>
    </div>

    <div class="card-box">
      <div class="controls">
        <label>ÏõåÏª§:
          <input type="number" id="workers" value="8" min="1" max="16">
        </label>
        <label><input type="checkbox" id="force"> Í∞ïÏ†ú Îã§Ïö¥Î°úÎìú</label>
        <button id="btnStart" class="btn btn-start">ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë</button>
        <button id="btnCancel" class="btn btn-cancel" disabled>Ï∑®ÏÜå</button>
        <span id="timer"></span>
        <span id="connStatus"></span>
      </div>
      <div id="adminHint" style="font-size:12px;color:#666;margin-top:4px;">‚Äª Í¥ÄÎ¶¨ÏûêÎßå Ïã§Ìñâ Í∞ÄÎä•</div>
    </div>

    <div class="dashboard-cards">
      <div class="card">
        <div class="card-header"><i class="fas fa-layer-group"></i>Ï†ÑÏ≤¥ ÏßÑÌñâÎ•†
          <span class="right" id="badgeTotal">-</span>
        </div>
        <strong id="pctTotal">0%</strong>
        <div class="progress-bar bar-total"><div id="barTotal"></div></div>
      </div>

      <div class="card">
        <div class="card-header"><i class="fas fa-database"></i>KRX Ï¢ÖÎ™© Î™©Î°ù
          <span class="right" id="badgeKrx"></span>
        </div>
        <strong id="pctKrx">0%</strong>
        <div class="progress-bar bar-krx"><div id="barKrx"></div></div>
      </div>

      <div class="card">
        <div class="card-header"><i class="fas fa-chart-line"></i>Í∞úÎ≥Ñ Ï¢ÖÎ™© Îç∞Ïù¥ÌÑ∞
          <span class="right" id="badgeData"></span>
        </div>
        <strong id="pctData">0%</strong>
        <div class="progress-bar bar-data"><div id="barData"></div></div>
      </div>
    </div>

    <div class="log-wrapper">
      <h3>
        Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏
        <span class="copy-btn" id="copyLogBtn">üìÑ</span>
      </h3>
      <div id="logBox" class="log-box">Î°úÍ∑∏ ÎåÄÍ∏∞Ï§ë...</div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
(function(){
  const $btnStart=document.getElementById("btnStart"),
        $btnCancel=document.getElementById("btnCancel"),
        $barTotal=document.getElementById("barTotal"),
        $pctTotal=document.getElementById("pctTotal"),
        $barKrx=document.getElementById("barKrx"),
        $pctKrx=document.getElementById("pctKrx"),
        $barData=document.getElementById("barData"),
        $pctData=document.getElementById("pctData"),
        $badgeTotal=document.getElementById("badgeTotal"),
        $badgeKrx=document.getElementById("badgeKrx"),
        $badgeData=document.getElementById("badgeData"),
        $hint=document.getElementById("adminHint"),
        $log=document.getElementById("logBox"),
        $copy=document.getElementById("copyLogBtn"),
        $workers=document.getElementById("workers"),
        $force=document.getElementById("force"),
        $conn=document.getElementById("connStatus"),
        $timer=document.getElementById("timer");

  let isOwner=false, currentTaskId=null, es=null, startTime=null, timerInterval=null;
  let connected=false, reconnecting=false, currentUser=null;

  // ===== Î°úÍ∑∏ Í¥ÄÎ¶¨ =====
  const MAX_LOG_LINES=700, FLUSH_INTERVAL=200;
  let logLines=[], pendingLogs=[], flushTimer=null;

  function colorize(line){
    if(/(error|ÏòàÏô∏)/i.test(line)) return `<span class="log-error">${line}</span>`;
    if(/\[PROGRESS\]/i.test(line)) return `<span class="log-progress">${line}</span>`;
    if(/\b(LOG|INFO)\b/i.test(line)) return `<span class="log-info">${line}</span>`;
    if(/(ÏôÑÎ£å|COMPLETED)/i.test(line)) return `<span class="log-complete">${line}</span>`;
    return line;
  }

  function scheduleFlush(){
    if(flushTimer) return;
    flushTimer=setTimeout(()=>{
      flushTimer=null;
      if(pendingLogs.length===0) return;
      for(const line of pendingLogs) logLines.push(colorize(line));
      pendingLogs.length=0;
      if(logLines.length>MAX_LOG_LINES) logLines=logLines.slice(-MAX_LOG_LINES);
      $log.innerHTML=logLines.join("<br>");
      $log.scrollTop=$log.scrollHeight;
    },FLUSH_INTERVAL);
  }

  function appendLog(msg){
    if(!msg) return;
    if($log.textContent.includes("ÎåÄÍ∏∞Ï§ë")){
      $log.textContent="";
      logLines=[];
      pendingLogs=[];
    }
    pendingLogs.push(msg);
    scheduleFlush();
  }

  // ===== ÌÉÄÏù¥Î®∏ =====
  function startTimer(){
    startTime=Date.now();
    if(timerInterval) clearInterval(timerInterval);
    timerInterval=setInterval(()=>{
      const sec=Math.floor((Date.now()-startTime)/1000);
      const m=Math.floor(sec/60), s=sec%60;
      $timer.textContent=`‚è± ${m>0?m+"Î∂Ñ ":""}${s}Ï¥à Í≤ΩÍ≥º`;
    },1000);
  }

  function stopTimer(final){
    if(timerInterval){clearInterval(timerInterval);timerInterval=null;}
    if(final!=null) $timer.textContent=`‚úÖ Ï¥ù ${final}Ï¥à ÏÜåÏöî`;
  }

  // ===== ÌçºÏÑºÌä∏ =====
  function setBar(bar,pct,val){
    const v=Math.min(100,Math.max(0,Math.round(val||0)));
    bar.style.width=v+"%";
    pct.textContent=v+"%";
  }

  // ===== UI =====
  function resetUI(){
    isOwner=false; currentTaskId=null;
    setBar($barTotal,$pctTotal,0);
    setBar($barKrx,$pctKrx,0);
    setBar($barData,$pctData,0);
    $badgeTotal.textContent="-"; $badgeKrx.textContent=""; $badgeData.textContent="";
    $hint.innerHTML="‚Äª Í¥ÄÎ¶¨ÏûêÎßå Ïã§Ìñâ Í∞ÄÎä•";
    $btnStart.disabled=false; $btnCancel.disabled=true;
    $log.textContent="Î°úÍ∑∏ ÎåÄÍ∏∞Ï§ë...";
    $timer.textContent=""; startTime=null;
  }

  function applyOwnerUI(runner, progress){
    isOwner=true;
    $hint.innerHTML=`‚öôÔ∏è ${runner}Îãò Ïã§Ìñâ Ï§ë (${Math.round(progress||0)}%)`;
    $btnStart.disabled=true; $btnCancel.disabled=false;
  }

  function applyWatcherUI(runner, progress){
    isOwner=false;
    $hint.innerHTML=`üö´ ${runner}Îãò Ïã§Ìñâ Ï§ë (${Math.round(progress||0)}%)`;
    $btnStart.disabled=true; $btnCancel.disabled=true;
  }

  // ===== ÏÉÅÌÉú Î≥µÏõê =====
  async function restoreState(){
    try{
      const meRes = await fetch("/auth/validate",{credentials:"include"});
      if(meRes.ok){
        const me = await meRes.json();
        if(me && me.valid) currentUser = me.username || me.name || null;
      }
      const res = await fetch("/api/stock/batch/active",{credentials:"include"});
      if(!res.ok) return;
      const a = await res.json();
      if(!a || !a.active){ resetUI(); return; }

      const runner = a.runner || "Ïïå Ïàò ÏóÜÏùå";
      const prog = (typeof a.progress==="number") ? a.progress : 0;
      currentTaskId = a.taskId || null;

      setBar($barTotal,$pctTotal,prog||0);
      if(currentUser && runner && currentUser===runner){
        applyOwnerUI(runner, prog);
      }else{
        applyWatcherUI(runner, prog);
      }
    }catch(e){
      console.warn("ÏÉÅÌÉú Î≥µÏõê Ïã§Ìå®", e);
    }
  }

  // ===== SSE =====
  function connect(){
    if(es){try{es.close();}catch(_){}} es=null;
    es=new EventSource("/api/stock/batch/sse",{withCredentials:true});
    connected=true; reconnecting=false; $conn.textContent="";

    es.addEventListener("status",e=>{
      const d=JSON.parse(e.data||"{}");
      if(d.status==="IDLE"){resetUI();return;}

      if(d.dataTotal>0){
        setBar($barData,$pctData,(d.dataSaved*100/d.dataTotal));
        $badgeData.textContent=`${d.dataSaved}/${d.dataTotal}`;
      }
      if(d.krxTotal>0){
        setBar($barKrx,$pctKrx,(d.krxSaved*100/d.krxTotal));
        $badgeKrx.textContent=`${d.krxSaved}/${d.krxTotal}`;
      }
      if(typeof d.progress==="number"){setBar($barTotal,$pctTotal,d.progress);}

      if(d.runner){
        const owner = (typeof d.owner==="boolean") ? d.owner : (currentUser && d.runner && currentUser===d.runner);
        if(owner){ applyOwnerUI(d.runner, d.progress||0); }
        else     { applyWatcherUI(d.runner, d.progress||0); }
      }

      if(Array.isArray(d.logs)) d.logs.forEach(l=>appendLog(l));

      if(d.status==="START"){ startTimer(); }
      if(d.status==="COMPLETED"){
        setBar($barTotal,$pctTotal,100);
        $badgeTotal.textContent="‚úÖ ÏôÑÎ£å";
        stopTimer(Math.floor((Date.now()-startTime)/1000));
        $btnStart.disabled=false; $btnCancel.disabled=true;
      }
      if(d.status==="CANCELLED"||d.status==="FAILED"){
        stopTimer(null);
        resetUI();
      }
    });

    es.addEventListener("ping",()=>{connected=true;});

    es.onerror=()=>{
      if(!reconnecting){
        reconnecting=true;
        $conn.textContent="‚ö†Ô∏è SSE Ïû¨Ïó∞Í≤∞ Ï§ë...";
      }
      connected=false;
      try{es.close();}catch(_){}
      es=null;
      setTimeout(()=>{
        connect();
        $conn.textContent="‚úÖ Ïó∞Í≤∞ Î≥µÏõêÎê®";
        setTimeout(()=>{$conn.textContent="";},1500);
      },2000);
    };

    window.addEventListener("beforeunload",()=>{if(es){try{es.close();}catch(_){}}});
  }

  // ===== Î≤ÑÌäº =====
  $btnStart.onclick=async()=>{
    resetUI();
    setBar($barTotal,$pctTotal,0);
    $btnStart.disabled=true;
    $btnCancel.disabled=true;
    const url=`/api/stock/batch/update?workers=${$workers.value||8}${$force.checked?"&force=true":""}`;
    const res=await fetch(url,{method:"POST",credentials:"include"});
    if(res.ok){
      const d=await res.json().catch(()=>({}));
      currentTaskId=d.taskId||null;
    } else {
      appendLog("‚ö†Ô∏è Îã§Î•∏ ÏÇ¨Ïö©Ïûê ÏûëÏóÖ Ï§ë");
    }
  };

  $btnCancel.onclick=async()=>{
    if(!isOwner||!currentTaskId) return;
    await fetch(`/api/stock/batch/cancel/${currentTaskId}`,{method:"POST",credentials:"include"});
  };

  $copy.onclick=()=>{
    const t=logLines.join("\n");
    navigator.clipboard.writeText(t);
    $copy.textContent="‚úÖ";
    setTimeout(()=>{$copy.textContent="üìÑ";},900);
  };

  (async function init(){
    await restoreState();
    connect();
  })();
})();
</script>
</th:block>

</body>
</html>
