<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š AthenaAI ë°°ì¹˜ ì—…ë°ì´íŠ¸</title> 
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --main-bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-color-primary: #111827;
            --text-color-secondary: #6b7280;
            --border-color-default: #d1d5db;
            --input-bg: #ffffff;
            --progress-bar-bg: #e5e7eb;

            --log-box-bg: #111;
            --log-text-default: #e0e0e0;
            --log-text-info: #9ca3af;
            --log-text-progress: #60a5fa;
            --log-text-warning: #f59e0b;
            --log-text-error: #ef4444;
            --log-text-complete: #22c55e;

            --card-border: #d1d5db;
            --error-card-bg: #fff;
            --error-card-border: #e5e7eb;
            --error-card-text: #374151;
            --error-card-hover: #fee2e2;
            --error-card-header: #b91c1c;
        }

        /* ğŸ’¡ ë‹¤í¬ëª¨ë“œ í•„ìš” ì‹œ ìŠ¤íƒ€ì¼ ì¶”ê°€ ê°€ëŠ¥ */

        .global-status-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 12px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .global-status-header {
            font-weight: 600;
            color: var(--text-color-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
        }
        .global-status-body {
            font-size: .9rem;
            color: var(--text-color-secondary);
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }
        .global-status-progress {
            width: 100%;
            height: 10px;
            background: var(--progress-bar-bg);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 8px;
        }
        .global-status-progress div {
            height: 100%;
            width: 0%;
            background: #2563eb;
            transition: width .25s;
        }

        .status-idle{color:#6b7280;}
        .status-running{color:#2563eb;}
        .status-completed{color:#22c55e;}
        .status-failed{color:#ef4444;}
        .status-cancelled{color:#f59e0b;}
        @keyframes blink {0%,100%{opacity:1}50%{opacity:.35}}
        .blinking{animation:blink 1.2s infinite;}
    </style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">

    <div class="page-header">
      <div class="page-title">
        <h2>ğŸ“„ êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜</h2>
      </div>
      <div class="breadcrumb">
        <i class="fas fa-folder-open"></i>
        <span>ì‹œìŠ¤í…œ / ë¶„ì„ ë„êµ¬ (AthenaAi)</span>
      </div>
    </div>

    <!-- âœ… ì „ì—­(Global) ìƒíƒœ ì¹´ë“œ -->
    <div class="global-status-card">
        <div class="global-status-header">
          ğŸŒ AthenaAI ë°°ì¹˜ ì§„í–‰ ìƒíƒœ
          <span id="globalStatusText" class="status-idle">ëŒ€ê¸°ì¤‘</span>
        </div>

        <div class="global-status-body">
          <div>ì‹¤í–‰ì: <span id="globalRunner">ë¯¸ì—°ê²°</span></div>
          <div>ì „ì²´ ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div>
        </div>

        <div class="global-status-progress">
            <div id="globalProgressBar"></div>
        </div>
    </div>
    
        <!-- âœ… ë¶„ì„ ì˜µì…˜ ì„¹ì…˜ -->
    <div class="card mb-8">
        <form id="analysisForm">

            <!-- âœ… 1. ë¶„ì„ ìœ í˜• ì„ íƒ -->
            <button type="button"
                    class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-0 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150"
                    onclick="toggleSection('analysisTypeContent', this)">
                <span>1. ë¶„ì„ ìœ í˜• ì„ íƒ</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>

            <div id="analysisTypeContent" class="pb-4 transition-all duration-300 ease-in-out">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

                    <!-- MA ë¶„ì„ -->
                    <label for="maRadio" class="block">
                        <input type="radio" name="analysisType" id="maRadio" value="ma"
                               class="hidden" checked onclick="toggleMaPeriods()">
                        <div class="option-card">
                            <p class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2 text-indigo-500">ğŸ“‰</span> ì´ë™í‰ê· ì„ (MA) ë¶„ì„ (ê¸°ë³¸)
                            </p>
                            <p class="text-sm text-gray-500 mt-1">ì¥ê¸° í•˜ë½ ë°°ì—´ ì¢…ëª© íƒìƒ‰</p>

                            <!-- MA ê¸°ê°„ -->
                            <div id="maPeriodsContainer"
                                 class="ml-0 mt-3 p-3 bg-indigo-100/50 rounded-lg transition-all duration-300">
                                <h4 class="font-semibold text-indigo-700 mb-2 text-sm">
                                    MA ê¸°ê°„ ì„ íƒ (í•˜ë½ ë°°ì—´ í™•ì¸):
                                </h4>

                                <div class="flex flex-wrap gap-x-4 gap-y-2">

                                    <input type="checkbox" name="maPeriods" value="60" id="ma60"
                                           checked class="rounded text-indigo-600">
                                    <label for="ma60" class="text-sm">60ì¼ì„ </label>

                                    <input type="checkbox" name="maPeriods" value="200" id="ma200"
                                           checked class="rounded text-indigo-600">
                                    <label for="ma200" class="text-sm">200ì¼ì„ </label>

                                    <input type="checkbox" name="maPeriods" value="500" id="ma500"
                                           checked disabled class="rounded text-indigo-600 opacity-50">
                                    <label for="ma500" id="ma500Label" class="text-sm opacity-50">500ì¼ì„ </label>
                                    <span id="ma500Hint" class="text-red-500 text-xs font-semibold">(ìµœì†Œ 3ë…„ í•„ìš”)</span>
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- Double Bottom -->
                    <label for="doubleBottomRadio" class="block">
                        <input type="radio" name="analysisType" id="doubleBottomRadio"
                               value="double_bottom" class="hidden" onclick="toggleMaPeriods()">
                        <div class="option-card">
                            <p class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2 text-green-500">ğŸ“ˆ</span> ì´ì¤‘ë°”ë‹¥ (Wìí˜• íŒ¨í„´)
                            </p>
                            <p class="text-sm text-gray-500 mt-1">ê°•ë ¥í•œ ì¶”ì„¸ ë°˜ì „ íƒìƒ‰</p>
                        </div>
                    </label>

                    <!-- Triple Bottom -->
                    <label for="tripleBottomRadio" class="block">
                        <input type="radio" name="analysisType" id="tripleBottomRadio"
                               value="triple_bottom" class="hidden" onclick="toggleMaPeriods()">
                        <div class="option-card">
                            <p class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2 text-green-500">ğŸ“Š</span> ì‚¼ì¤‘ë°”ë‹¥ íŒ¨í„´
                            </p>
                            <p class="text-sm text-gray-500 mt-1">ë°”ë‹¥ ë‹¤ì§€ê¸° ì¢…ëª© íƒìƒ‰</p>
                        </div>
                    </label>

                    <!-- Cup & Handle -->
                    <label for="cupAndHandleRadio" class="block">
                        <input type="radio" name="analysisType" id="cupAndHandleRadio"
                               value="cup_and_handle" class="hidden" onclick="toggleMaPeriods()">
                        <div class="option-card">
                            <p class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2 text-amber-500">â˜•</span> ì»µì•¤í•¸ë“¤ íŒ¨í„´
                            </p>
                            <p class="text-sm text-gray-500 mt-1">ëŒíŒŒ ì§ì „ ì¢…ëª© íƒìƒ‰</p>
                        </div>
                    </label>

                    <!-- Decline 5 Days -->
                    <label for="decline5dRadio" class="block">
                        <input type="radio" name="analysisType" id="decline5dRadio"
                               value="decline_5d" class="hidden" onclick="toggleMaPeriods()">
                        <div class="option-card">
                            <p class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2 text-red-600">ğŸ”»</span> ë‹¨ê¸° ê¸‰ë½ì£¼ (5ì¼ ì—°ì† í•˜ë½)
                            </p>
                            <p class="text-sm text-gray-500 mt-1">ê³¼ëŒ€ ë‚™í­ì£¼ íƒìƒ‰</p>
                        </div>
                    </label>

                    <!-- Decline 20 Days -->
                    <label for="decline20dRadio" class="block">
                        <input type="radio" name="analysisType" id="decline20dRadio"
                               value="decline_20d" class="hidden" onclick="toggleMaPeriods()">
                        <div class="option-card">
                            <p class="text-lg font-semibold text-gray-800 flex items-center">
                                <span class="mr-2 text-red-700">â¬‡ï¸</span> ì¤‘ê¸° ì—°ì† í•˜ë½ (20ì¼)
                            </p>
                            <p class="text-sm text-gray-500 mt-1">í•œ ë‹¬ê°„ ë°˜ë“± ì—†ëŠ” ì¢…ëª© íƒìƒ‰</p>
                        </div>
                    </label>

                </div>
            </div>

            <!-- âœ… 2. ì¶”ê°€ í•„í„°ë§ ì˜µì…˜ -->
            <button type="button"
                    class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150"
                    onclick="toggleSection('filteringOptionsContent', this)">
                <span>2. ì¶”ê°€ í•„í„°ë§ ì˜µì…˜</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>

            <div id="filteringOptionsContent" class="pb-4 transition-all duration-300 ease-in-out">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                    <!-- ì•…ì¬ ì œì™¸ -->
                    <div class="p-4 bg-white rounded-lg border border-red-200 shadow-sm flex items-center">
                        <input type="checkbox" id="excludeNegatives" checked
                               class="mr-3 h-5 w-5 rounded text-red-500 focus:ring-red-400 border-gray-300">
                        <label for="excludeNegatives" class="text-lg text-red-700 font-bold flex-grow">
                            ğŸš¨ ì•…ì¬ ì¢…ëª© ì œì™¸
                        </label>
                    </div>

                    <!-- ë¶„ì„ ê¸°ê°„ -->
                    <div class="p-4 bg-white rounded-lg border border-blue-200 shadow-sm flex items-center">
                        <span class="mr-3 text-blue-700 font-bold">ğŸ“… ë¶„ì„ ê¸°ê°„:</span>
                        <input type="number" id="dataPeriodYears" value="5" min="1" max="10"
                               class="w-16 px-3 py-1 border border-blue-300 rounded-lg text-center font-bold text-lg focus:ring-blue-500"
                               oninput="updateMaCheckboxes()">
                        <span class="ml-2 text-blue-800 font-semibold">ë…„ì¹˜</span>
                    </div>

                    <!-- ì›Œì»¤ìˆ˜ -->
                    <div class="p-4 bg-white rounded-lg border border-purple-200 shadow-sm flex items-center">
                        <span class="mr-3 text-purple-700 font-bold">ğŸ› ï¸ ì‘ì—…ì ìˆ˜:</span>
                        <input type="number" id="workerCount" value="8" min="1" max="16"
                               class="w-16 px-3 py-1 border border-purple-300 rounded-lg text-center font-bold text-lg focus:ring-purple-500">
                        <span class="ml-2 text-purple-800 font-semibold">ê°œ</span>
                    </div>

                </div>
            </div>

            <!-- âœ… 3. ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ -->
            <button type="button"
                    class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150"
                    onclick="toggleSection('topNCountContent', this)">
                <span>3. ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ ì„¤ì •</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>

            <div id="topNCountContent"
                 class="pb-4 transition-all duration-300 ease-in-out">

                <div class="flex items-center bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <label for="topNCount"
                           class="text-lg text-gray-700 font-medium mr-4">
                        ìƒìœ„ ì¢…ëª© ê°œìˆ˜(N):
                    </label>

                    <input type="number" id="topNCount" value="10" min="1" max="50"
                           class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-center font-bold text-xl">

                    <span class="ml-4 text-gray-500 text-sm">1~50 ì‚¬ì´</span>
                </div>
            </div>

        </form>

        <!-- âœ… ì‹¤í–‰ / ì·¨ì†Œ ë²„íŠ¼ -->
        <div class="run-controls-wrapper mt-8">

            <button type="button" id="runAnalysisBtn"
                    onclick="runAnalysis()"
                    class="flex-grow px-6 py-3 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-200">
                ğŸš€ ë¶„ì„ ì‹¤í–‰ ë° ìœ ë§ ì¢…ëª© ì°¾ê¸°
            </button>

            <button type="button" id="btnCancel"
                    onclick="cancelAnalysis()"
                    class="px-6 py-3 bg-red-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-200"
                    disabled>
                âŒ ì·¨ì†Œ
            </button>

        </div>

    </div>
    
    
        <!-- âœ… ê²°ê³¼ ì˜ì—­ -->
    <div class="card mb-10">

        <!-- í™”ë©´ ìƒë‹¨ ì œëª© -->
        <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center">
            ğŸ“Š ë¶„ì„ ê²°ê³¼
        </h3>

        <!-- âœ… ê²°ê³¼ í…Œì´ë¸” -->
        <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
            <table class="min-w-full bg-white text-gray-800" id="resultTable">
                <thead class="bg-gray-100 border-b border-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">ì¢…ëª©ì½”ë“œ</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">ì¢…ëª©ëª…</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">ì‹ í˜¸ ê°•ë„</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">MA ë°°ì—´</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">ì°¨íŠ¸ í™•ì¸</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody"></tbody>
            </table>
        </div>

        <!-- âœ… ê²°ê³¼ ì—†ìŒ -->
        <div id="noResultBox" class="hidden p-6 text-center text-gray-500 text-lg">
            ë¶„ì„ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>

    </div>

    <!-- âœ… ë¡œê·¸ ì˜ì—­ -->
    <div class="card mb-14">
        <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center">
            ğŸªµ ì‹¤ì‹œê°„ ë¡œê·¸
            <button id="copyLogBtn" class="ml-4 px-3 py-1 bg-indigo-600 text-white text-sm rounded-md">
                ë³µì‚¬
            </button>
        </h3>

        <div id="logBox"
             class="h-64 bg-black text-green-300 text-sm p-3 rounded-md overflow-y-auto font-mono">
            <p class="opacity-70">ë¡œê·¸ ëŒ€ê¸°ì¤‘...</p>
        </div>
    </div>

    <!-- âœ… ì°¨íŠ¸ ëª¨ë‹¬ -->
    <div id="chartModal"
         class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-50">
        <div class="bg-white rounded-xl shadow-xl p-4 max-w-4xl w-full relative">

            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-700">ğŸ“ˆ ì°¨íŠ¸</h3>
                <button onclick="closeChartModal()"
                        class="text-gray-600 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <!-- âœ… ì°¨íŠ¸ ì´ë¯¸ì§€ -->
            <img id="chartImage" src="" class="w-full rounded-lg shadow-md">

        </div>
    </div>
    
<th:block layout:fragment="pageScript">
<script>
(function () {

  /* ================================
     âœ… ìš”ì†Œ ì„ íƒ (HTML ì‹¤ì œ id ê¸°ì¤€)
  ================================== */
  const $runBtn = document.getElementById("runAnalysisBtn");
  const $cancelBtn = document.getElementById("btnCancel");

  const $analysisForm = document.getElementById("analysisForm");
  const $log = document.getElementById("logBox");
  const $copyLogBtn = document.getElementById("copyLogBtn");

  const $resultTableBody = document.getElementById("resultTableBody");
  const $noResultBox = document.getElementById("noResultBox");

  const $chartModal = document.getElementById("chartModal");
  const $chartImage = document.getElementById("chartImage");
  const $modalTitle = document.getElementById("modalTitle");

  const $globalStatusText = document.getElementById("globalStatusText");
  const $globalRunner = document.getElementById("globalRunner");
  const $globalProgressLabel = document.getElementById("globalProgressLabel");
  const $globalProgressBar = document.getElementById("globalProgressBar");

  let currentTaskId = null;
  let es = null;
  let currentUser = "-";

  /* ================================
     âœ… ë¶„ì„ ìœ í˜• ì„ íƒ
  ================================== */
  function getSelectedPattern() {
    const checked = document.querySelector("input[name='analysisType']:checked");
    return checked ? checked.value : "ma";
  }

  /* ================================
     âœ… MA ì²´í¬ë°•ìŠ¤ ìë™ í™œì„±/ë¹„í™œì„±
  ================================== */
  window.updateMaCheckboxes = function () {
    const years = Number(document.getElementById("dataPeriodYears").value);
    const ma500 = document.getElementById("ma500");
    const ma500Label = document.getElementById("ma500Label");
    const ma500Hint = document.getElementById("ma500Hint");

    if (years >= 3) {
      ma500.disabled = false;
      ma500.classList.remove("opacity-50");
      ma500Label.classList.remove("opacity-50");
      ma500Hint.classList.add("hidden");
    } else {
      ma500.checked = false;
      ma500.disabled = true;
      ma500.classList.add("opacity-50");
      ma500Label.classList.add("opacity-50");
      ma500Hint.classList.remove("hidden");
    }
  };

  window.toggleMaPeriods = function () {
    const isMA = document.getElementById("maRadio").checked;
    const box = document.getElementById("maPeriodsContainer");
    box.style.display = isMA ? "block" : "none";
  };

  /* ================================
     âœ… ì „ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸
  ================================== */
  function updateGlobalState(st, runner, progress) {
    const S = (st || "IDLE").toUpperCase();
    $globalStatusText.textContent = S;
    $globalRunner.textContent = runner || "-";

    const pct = Math.min(100, Math.max(0, Math.floor(progress || 0)));
    $globalProgressLabel.textContent = pct + "%";
    $globalProgressBar.style.width = pct + "%";

    $globalStatusText.className = "";
    if (S === "RUNNING") $globalStatusText.classList.add("status-running", "blinking");
    else if (S === "COMPLETED") $globalStatusText.classList.add("status-completed");
    else if (S === "FAILED") $globalStatusText.classList.add("status-failed");
    else if (S === "CANCELLED") $globalStatusText.classList.add("status-cancelled");
    else $globalStatusText.classList.add("status-idle");
  }

  /* ================================
     âœ… ë¡œê·¸ì¸ ì‚¬ìš©ì
  ================================== */
  async function initCurrentUser() {
    try {
      const r = await fetch("/auth/me", { credentials: "include" });
      if (!r.ok) return "-";
      const d = await r.json();
      return d.username || "-";
    } catch {
      return "-";
    }
  }

  /* ================================
     âœ… ë¡œê·¸
  ================================== */
  function appendLog(line) {
    if (!line) return;
    const p = document.createElement("p");
    p.textContent = line;
    $log.appendChild(p);
    $log.scrollTop = $log.scrollHeight;
  }

  /* ================================
     âœ… ë¡œê·¸ ë³µì‚¬
  ================================== */
  $copyLogBtn.onclick = () => {
    const t = Array.from($log.querySelectorAll("p"))
      .map(p => p.textContent)
      .join("\n");

    navigator.clipboard.writeText(t)
      .then(() => appendLog("[LOG] ğŸ“‹ ë¡œê·¸ ë³µì‚¬ ì™„ë£Œ"));
  };

  /* ================================
     âœ… ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
  ================================== */
  function renderResults(list) {
    $resultTableBody.innerHTML = "";

    if (!list || list.length === 0) {
      $noResultBox.classList.remove("hidden");
      return;
    }
    $noResultBox.classList.add("hidden");

    list.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-4 py-2 border">${item.ticker || "-"}</td>
        <td class="px-4 py-2 border">${item.name || "-"}</td>
        <td class="px-4 py-2 border">${item.score || "-"}</td>
        <td class="px-4 py-2 border">${item.ma_pattern || "-"}</td>
        <td class="px-4 py-2 border text-center">
          <button class="px-3 py-1 bg-indigo-600 text-white rounded-md"
                  onclick="showChart('${item.ticker}', '${item.name}')">ë³´ê¸°</button>
        </td>
      `;
      $resultTableBody.appendChild(tr);
    });
  }

  /* ================================
     âœ… ì°¨íŠ¸ ëª¨ë‹¬
  ================================== */
  window.showChart = (ticker, name) => {
    $modalTitle.textContent = `ğŸ“ˆ ${ticker} - ${name}`;
    $chartImage.src = `/api/stock/batch/athena/chart?ticker=${ticker}&ts=${Date.now()}`;
    $chartModal.classList.remove("hidden");
  };

  window.closeChartModal = () => {
    $chartModal.classList.add("hidden");
    $chartImage.src = "";
  };

  /* ================================
     âœ… SSE
  ================================== */
  function connectSSE() {
    if (es) { try { es.close(); } catch {} }

    es = new EventSource("/api/stock/batch/athena/sse");

    es.addEventListener("status", (ev) => {
      const d = JSON.parse(ev.data || "{}");

      if (d.globalStatus)
        updateGlobalState(d.globalStatus, d.globalRunner, d.globalProgress);

      if (Array.isArray(d.logs))
        d.logs.forEach(line => appendLog(line));

      if (Array.isArray(d.results))
        renderResults(d.results);

      const isOwner = (d.runner === currentUser);

      if (["START", "IN_PROGRESS", "RUNNING"].includes(d.status)) {
        $runBtn.disabled = true;
        $cancelBtn.disabled = !isOwner ? true : false;
      }

      if (["COMPLETED", "FAILED", "CANCELLED"].includes(d.status)) {
        $runBtn.disabled = false;
        $cancelBtn.disabled = true;
      }

      if (d.taskId) currentTaskId = d.taskId;
    });

    es.onerror = () => {
      try { es.close(); } catch {}
      es = null;
      setTimeout(connectSSE, 2000);
    };
  }

  /* ================================
     âœ… ì‹¤í–‰
  ================================== */
  window.runAnalysis = async () => {
    $runBtn.disabled = true;
    $cancelBtn.disabled = false;

    $log.innerHTML = `<p class="opacity-70">ë¶„ì„ ì‹œì‘...</p>`;
    $resultTableBody.innerHTML = "";
    $noResultBox.classList.add("hidden");

    const pattern = getSelectedPattern();
    const years = document.getElementById("dataPeriodYears").value;
    const workers = document.getElementById("workerCount").value;
    const excludeNeg = document.getElementById("excludeNegatives").checked;
    const topN = document.getElementById("topNCount").value;

    const url = `/api/stock/batch/athena/start`
      + `?pattern=${pattern}`
      + `&years=${years}`
      + `&workers=${workers}`
      + `&excludeNeg=${excludeNeg}`
      + `&topN=${topN}`;

    const res = await fetch(url, { method: "POST" });

    if (res.ok) {
      const d = await res.json();
      currentTaskId = d.taskId;
      appendLog(`ğŸŸ¢ ì‹¤í–‰ë¨ (${d.runner})`);
    } else {
      appendLog("âš ï¸ ì‹¤í–‰ ì‹¤íŒ¨");
      $runBtn.disabled = false;
      $cancelBtn.disabled = true;
    }
  };

  /* ================================
     âœ… ì·¨ì†Œ
  ================================== */
  window.cancelAnalysis = async () => {
    if (!currentTaskId) return;

    const res = await fetch(`/api/stock/batch/athena/cancel/${currentTaskId}`, { method: "POST" });
    if (res.ok) {
      appendLog("ğŸŸ¥ ì‘ì—… ì·¨ì†Œë¨");
      $runBtn.disabled = false;
      $cancelBtn.disabled = true;
    } else {
      appendLog("âš ï¸ ì·¨ì†Œ ì‹¤íŒ¨");
    }
  };

  /* ================================
     âœ… ì´ˆê¸° ì‹¤í–‰
  ================================== */
  (async function init() {
    currentUser = await initCurrentUser();
    connectSSE();
    updateMaCheckboxes();
    toggleMaPeriods();
  })();

})();
</script>
</th:block>

    </div>
  </div>
 </body>
</html>
