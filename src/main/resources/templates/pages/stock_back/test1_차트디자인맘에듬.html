<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ë¡œë²Œ ì£¼ì‹ ë°°ì¹˜ ì°¨íŠ¸ ë¶„ì„</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Chart.js ì»¨í…Œì´ë„ˆ ë°˜ì‘í˜• ì„¤ì • */
        .chart-container {
            position: relative;
            height: 400px; /* ë°ìŠ¤í¬í†± ê¸°ë³¸ ë†’ì´ */
            width: 100%;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px; /* ëª¨ë°”ì¼ ë†’ì´ ì¡°ì • */
            }
        }
    </style>
    <!-- Chart.js CDN ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Chart.jsì˜ ë°ì´í„° ìŠ¤íŠ¸ë¦¬ë° ê¸°ëŠ¥ì„ ìœ„í•œ adapter ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white shadow-xl rounded-2xl p-6 md:p-8">
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-800">ğŸ“Š ê¸€ë¡œë²Œ ë°°ì¹˜ ì‘ì—… ì‹¤ì‹œê°„ ë¶„ì„</h1>
            <p class="text-gray-500 mt-1">ë°°ì¹˜ IDë¥¼ ì…ë ¥í•˜ì—¬ ì£¼ì‹ ë°ì´í„° ì—…ë°ì´íŠ¸ í˜„í™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.</p>
        </header>

        <!-- ì œì–´ íŒ¨ë„ -->
        <div class="mb-8 p-4 bg-indigo-50 rounded-xl flex flex-col md:flex-row items-start md:items-center gap-4">
            <div class="flex-grow w-full md:w-auto">
                <label for="batchIdInput" class="block text-sm font-medium text-indigo-700 mb-1">ëª¨ë‹ˆí„°ë§í•  ë°°ì¹˜ ID ì…ë ¥:</label>
                <input type="text" id="batchIdInput" placeholder="ì˜ˆ: 550e8400-e29b-41d4-a716-446655440000"
                       class="w-full px-4 py-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm"
                       value="mock-batch-123"> <!-- í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ê¸°ë³¸ê°’ ì„¤ì • -->
            </div>
            <button id="connectButton"
                    class="w-full md:w-auto mt-4 md:mt-0 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out">
                ğŸ“¡ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
            </button>
        </div>

        <!-- ì‹¤ì‹œê°„ ìƒíƒœ ë° ë©”íŠ¸ë¦­ íŒ¨ë„ -->
        <div id="statusPanel" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- ìƒíƒœ ì¹´ë“œ 1: í˜„ì¬ ì§„í–‰ë¥  -->
            <div class="bg-blue-50 border border-blue-200 p-5 rounded-xl shadow-lg">
                <p class="text-sm font-medium text-blue-700">ì§„í–‰ë¥ </p>
                <div class="text-3xl font-bold text-blue-900 mt-1" id="progressDisplay">0%</div>
                <div class="text-xs text-blue-500 mt-1" id="messageDisplay">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
            </div>
            <!-- ìƒíƒœ ì¹´ë“œ 2: ìµœê·¼ ì—…ë°ì´íŠ¸ ê°€ê²© -->
            <div class="bg-green-50 border border-green-200 p-5 rounded-xl shadow-lg">
                <p class="text-sm font-medium text-green-700">ìµœê·¼ ì—…ë°ì´íŠ¸ ê°€ê²© (USD)</p>
                <div class="text-3xl font-bold text-green-900 mt-1" id="priceDisplay">--</div>
                <div class="text-xs text-green-500 mt-1" id="timeDisplay">ì‹œê°„: --</div>
            </div>
            <!-- ìƒíƒœ ì¹´ë“œ 3: ì´ ì—…ë°ì´íŠ¸ ë³¼ë¥¨ -->
            <div class="bg-yellow-50 border border-yellow-200 p-5 rounded-xl shadow-lg">
                <p class="text-sm font-medium text-yellow-700">ì—…ë°ì´íŠ¸ëœ ì´ ë³¼ë¥¨</p>
                <div class="text-3xl font-bold text-yellow-900 mt-1" id="volumeDisplay">0</div>
                <div class="text-xs text-yellow-500 mt-1">ë‹¨ìœ„: ì£¼</div>
            </div>
        </div>
        
        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="chart-container bg-gray-50 border border-gray-200 rounded-xl p-4 shadow-inner">
            <canvas id="stockPriceChart"></canvas>
        </div>
        
        <!-- ë¡œê·¸/ë””ë²„ê·¸ ì¶œë ¥ ì˜ì—­ -->
        <div class="mt-8">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">ìŠ¤íŠ¸ë¦¼ ë¡œê·¸</h3>
            <div id="logArea" class="h-40 overflow-y-auto p-3 text-xs bg-gray-800 text-gray-200 rounded-lg">
                ì—¬ê¸°ì— ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>
        </div>

        <div id="messageBox" class="fixed top-5 right-5 p-3 rounded-lg shadow-xl text-white hidden transition-opacity duration-300"></div>

    </div>

    <script>
        // DOM ìš”ì†Œ
        const batchIdInput = document.getElementById('batchIdInput');
        const connectButton = document.getElementById('connectButton');
        const progressDisplay = document.getElementById('progressDisplay');
        const messageDisplay = document.getElementById('messageDisplay');
        const priceDisplay = document.getElementById('priceDisplay');
        const timeDisplay = document.getElementById('timeDisplay');
        const volumeDisplay = document.getElementById('volumeDisplay');
        const logArea = document.getElementById('logArea');
        const messageBox = document.getElementById('messageBox');
        const chartCanvas = document.getElementById('stockPriceChart');

        // ìƒíƒœ ë³€ìˆ˜
        let eventSource = null;
        let stockChart = null;
        let totalVolume = 0;

        // API ì„¤ì •
        const BATCH_STATUS_URL = '/api/global/batch/status';

        /**
         * Chart.js ì´ˆê¸°í™” í•¨ìˆ˜
         */
        function initializeChart() {
            if (stockChart) {
                stockChart.destroy();
            }
            
            totalVolume = 0;
            volumeDisplay.textContent = '0';

            const config = {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'ì£¼ì‹ ê°€ê²© (USD)',
                            data: [], // [{x: timestamp, y: price}] í˜•íƒœë¡œ ì €ì¥
                            borderColor: 'rgb(79, 70, 229)', // indigo-600
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            tension: 0.1,
                            pointRadius: 2,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second',
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                }
                            },
                            title: {
                                display: true,
                                text: 'ì‹œê°„'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ê°€ê²© (USD)'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            };

            stockChart = new Chart(chartCanvas, config);
            logMessage('Chart.jsê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        /**
         * SSE ì—°ê²°ì„ ì„¤ì •í•˜ê³  ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         */
        function connectSseStream(batchId) {
            if (eventSource) {
                eventSource.close();
            }

            const url = `${BATCH_STATUS_URL}?batchId=${batchId}`;
            eventSource = new EventSource(url);
            
            connectButton.textContent = 'ğŸ›‘ ì—°ê²° ëŠê¸°';
            connectButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            connectButton.classList.add('bg-red-600', 'hover:bg-red-700');
            logMessage(`SSE ìŠ¤íŠ¸ë¦¼ì— ì—°ê²° ì¤‘: ${url}`, 'info');


            // 1. 'init' ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì—°ê²° ì„±ê³µ ì‹œ)
            eventSource.addEventListener('init', (event) => {
                logMessage('SSE ì—°ê²° ì„±ê³µ! ë°ì´í„° ìŠ¤íŠ¸ë¦¼ ëŒ€ê¸° ì¤‘.', 'success');
                showMessageBox('ì—°ê²° ì„±ê³µ: ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì‹œì‘', 'success');
            });

            // 2. 'update' ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì£¼ìš” ë°ì´í„° ì—…ë°ì´íŠ¸)
            eventSource.addEventListener('update', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    // ìƒíƒœ íŒ¨ë„ ì—…ë°ì´íŠ¸
                    progressDisplay.textContent = `${data.progress || 0}%`;
                    messageDisplay.textContent = data.message || 'ì—…ë°ì´íŠ¸ ì§„í–‰ ì¤‘...';

                    if (data.stockData) {
                        const now = new Date();
                        const price = data.stockData.price || 0;
                        const volume = data.stockData.volume || 0;

                        // ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
                        priceDisplay.textContent = `$${price.toFixed(2)}`;
                        timeDisplay.textContent = `ì‹œê°„: ${now.toLocaleTimeString()}`;
                        totalVolume += volume;
                        volumeDisplay.textContent = totalVolume.toLocaleString();
                        
                        // ì°¨íŠ¸ ë°ì´í„° ì¶”ê°€
                        stockChart.data.datasets[0].data.push({
                            x: now.getTime(),
                            y: price
                        });
                        
                        // ì°¨íŠ¸ ê°±ì‹  (ìµœëŒ€ 50ê°œ ë°ì´í„° í¬ì¸íŠ¸ ìœ ì§€)
                        if (stockChart.data.datasets[0].data.length > 50) {
                            stockChart.data.datasets[0].data.shift();
                        }
                        stockChart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì—…ë°ì´íŠ¸
                    }
                    
                    logMessage(`[Update] Progress: ${data.progress}%, Price: ${data.stockData?.price || 'N/A'}`);

                } catch (e) {
                    logMessage(`[Error] ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                }
            });

            // 3. 'complete' ì´ë²¤íŠ¸ ì²˜ë¦¬ (ë°°ì¹˜ ì‘ì—… ì™„ë£Œ ì‹œ)
            eventSource.addEventListener('complete', (event) => {
                logMessage('ë°°ì¹˜ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë¦¼ì„ ë‹«ìŠµë‹ˆë‹¤.', 'info');
                showMessageBox('ë°°ì¹˜ ì™„ë£Œ', 'success');
                disconnectSseStream();
            });

            // 4. 'error' ì´ë²¤íŠ¸ ì²˜ë¦¬
            eventSource.onerror = (error) => {
                logMessage(`[Error] SSE ì—°ê²° ì˜¤ë¥˜ ë°œìƒ`, 'error');
                console.error("SSE Error:", error);
                showMessageBox('ì—°ê²° ì˜¤ë¥˜ ë°œìƒ', 'error');
                disconnectSseStream();
            };
        }

        /**
         * SSE ì—°ê²°ì„ ëŠê³  ë²„íŠ¼ ìƒíƒœë¥¼ ë³µì›í•©ë‹ˆë‹¤.
         */
        function disconnectSseStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            connectButton.textContent = 'ğŸ“¡ ìŠ¤íŠ¸ë¦¼ ì—°ê²°';
            connectButton.classList.remove('bg-red-600', 'hover:bg-red-700');
            connectButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            logMessage('SSE ìŠ¤íŠ¸ë¦¼ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        /**
         * ë¡œê·¸ ì˜ì—­ì— ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
         */
        function logMessage(message, type = 'default') {
            const now = new Date().toLocaleTimeString();
            let color = 'text-gray-400';
            if (type === 'error') color = 'text-red-400';
            else if (type === 'success') color = 'text-green-400';
            else if (type === 'info') color = 'text-blue-400';

            const logEntry = `<div class="${color}">[${now}] ${message}</div>`;
            logArea.innerHTML += logEntry;
            logArea.scrollTop = logArea.scrollHeight; // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
        }

        /**
         * ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showMessageBox(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-blue-500');
            messageBox.classList.add('opacity-100');

            if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        connectButton.addEventListener('click', () => {
            const batchId = batchIdInput.value.trim();
            if (eventSource) {
                // ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì—°ê²° ëŠê¸°
                disconnectSseStream();
            } else {
                if (batchId) {
                    initializeChart();
                    connectSseStream(batchId);
                } else {
                    showMessageBox('ë°°ì¹˜ IDë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                }
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì°¨íŠ¸ ì´ˆê¸°í™”
        window.onload = initializeChart;
    </script>
</body>
</html>