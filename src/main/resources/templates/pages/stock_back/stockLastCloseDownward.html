<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
<meta charset="UTF-8">
<title>ğŸ“‰ ì—°ì† í•˜ë½ ì¢…ëª© ë¶„ì„</title>

<!-- ===============================================================
ğŸ“‰ MyBaseLinkV2 - stockLastCloseDownward.html (v4.2 ì•ˆì •íŒ)
---------------------------------------------------------------
âœ… í™•ëŒ€ ì°¨íŠ¸ ì™¼ìª½ ì˜ë¦¼ ì™„ì „ ìˆ˜ì • (ì •ì¤‘ì•™ ë°°ì¹˜)
âœ… ì„ ì  ì¢…ë£Œ / ì™„ë£Œ ì‹œ "ë¶„ì„ ì‹œì‘" ë²„íŠ¼ ìë™ ë³µì›
âœ… ê¸°ì¡´ ë””ìì¸/ê¸°ëŠ¥ ì™„ë²½ ìœ ì§€
=============================================================== -->
<style>
  h2{font-size:1.3rem;font-weight:700;margin-bottom:.4rem;color:#111827;}
  .card-box,.dashboard-cards,.log-wrapper,.result-box{
    background:#fff;border-radius:12px;padding:18px;
    box-shadow:0 2px 6px rgba(0,0,0,.05);margin-top:14px;
  }
  .btn{display:inline-flex;align-items:center;justify-content:center;
       padding:9px 14px;border-radius:8px;border:none;cursor:pointer;
       font-size:.9rem;font-weight:600;color:#fff;min-width:110px;}
  .btn-start{background:#2563eb;}
  .btn-cancel{background:#dc2626;}
  .btn:hover{opacity:.9;}
  .btn:disabled{opacity:.5;cursor:not-allowed;}
  .controls{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;}
  input,select{padding:.4rem .6rem;border:1px solid #bbb;border-radius:6px;font-size:.83rem;}
  select{min-width:120px;}

  /* ì§„í–‰ë¥  */
  .dashboard-cards{display:flex;gap:14px;flex-wrap:wrap;}
  .card{flex:1 1 300px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.05);}
  .progress-bar{width:100%;background:#e5e7eb;height:14px;border-radius:7px;margin-top:10px;overflow:hidden;}
  .progress-bar div{height:100%;width:0%;transition:width .3s;background:#2563eb;}
  .card-header{display:flex;align-items:center;gap:6px;font-weight:600;font-size:.95rem;}
  .card-header .right{margin-left:auto;font-size:.9rem;}

  /* ë¡œê·¸ */
  .log-box{background:#111;color:#eee;font-family:Consolas,mono;font-size:12.5px;padding:8px;border-radius:10px;height:280px;overflow-y:auto;white-space:pre-wrap;}
  .log-error{color:#ef4444;font-weight:600;}
  .log-progress{color:#60a5fa;}
  .log-complete{color:#22c55e;font-weight:600;}

  /* í…Œì´ë¸” */
  table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:clamp(10px,1vw,13px);}
  th,td{border-bottom:1px solid #e5e7eb;padding:5px 4px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  th{background:#f3f4f6;font-weight:600;color:#374151;}
  tr:hover{background:#f9fafb;cursor:pointer;}
  .table-container{border-radius:8px;overflow:auto;max-height:60vh;margin-top:8px;}
  .no-result{text-align:center;padding:14px;color:#999;}

  /* ì°¨íŠ¸ ëª¨ë‹¬ */
  .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:1000;}
  .modal-content{background:#fff;border-radius:10px;padding:16px;width:90%;max-width:900px;max-height:90vh;
    box-shadow:0 2px 10px rgba(0,0,0,0.25);display:flex;flex-direction:column;}
  .modal-header{display:flex;justify-content:flex-end;gap:8px;margin-bottom:10px;}
  .modal-btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:.85rem;color:#fff;}
  .btn-close{background:#dc2626;}
  .btn-zoom{background:#2563eb;}
  .chart-box{position:relative;display:flex;align-items:center;justify-content:center;min-height:400px;}
  .chart-box img{width:100%;height:auto;border-radius:8px;opacity:0;transition:opacity .4s ease;}
  .chart-box img.loaded{opacity:1;}
  .spinner-container{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
                     background:rgba(255,255,255,0.7);border-radius:10px;}
  .spinner{border:4px solid #e5e7eb;border-top:4px solid #2563eb;border-radius:50%;width:44px;height:44px;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}

  /* ===== í™•ëŒ€ ëª¨ë‹¬ (v4.2 ê°œì„ ) ===== */
/* ===== í™•ëŒ€ ëª¨ë‹¬ (v4.3 ìµœì¢… ìˆ˜ì •) ===== */
.zoom-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.85);
  display: none;
  align-items: center; justify-content: center;
  overflow: auto;
  z-index: 3000;
  backdrop-filter: blur(2px);
}

/* âœ… ì¢Œìš°/ìƒí•˜ ìŠ¤í¬ë¡¤ ì™„ì „ í—ˆìš© */
.zoom-inner {
  position: relative;
  background: #111;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
  align-items: flex-start;        /* âœ… ìƒë‹¨ ê¸°ì¤€ */
  justify-content: flex-start;    /* âœ… ì¢Œì¸¡ ê¸°ì¤€ */
  width: 90%;
  max-width: 1600px;
  height: 80vh;
  overflow: auto;                 /* âœ… ì™„ì „ ìŠ¤í¬ë¡¤ */
}

/* âœ… ì´ë¯¸ì§€ ì „ì²´ ë³´ê¸°: ìŠ¤í¬ë¡¤ë¡œ ìƒí•˜ì¢Œìš° ì™„ì „ ì´ë™ ê°€ëŠ¥ */
.zoom-inner img {
  display: block;
  width: auto;              /* ê°€ë¡œ ì œí•œ ì œê±° */
  height: auto;             /* ì„¸ë¡œ ì œí•œ ì œê±° */
  max-width: none;
  max-height: none;
  margin: 0;
  border-radius: 8px;
}

/* ë‹«ê¸° ë²„íŠ¼ ê·¸ëŒ€ë¡œ ìœ ì§€ */
.zoom-close-btn {
  position: absolute;
  top: 10px; right: 10px;
  background: #dc2626;
  color: #fff;
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  font-size: .9rem;
  cursor: pointer;
  z-index: 3100;
  transition: background .2s ease;
}
.zoom-close-btn:hover { background: #b91c1c; }


  .zoom-close-btn {
    position: absolute;
    top: 10px; right: 10px;
    background: #dc2626;
    color: #fff;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: .9rem;
    cursor: pointer;
    z-index: 3100;
    transition: background .2s ease;
  }
  .zoom-close-btn:hover { background: #b91c1c; }

</style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <div class="page-header">
      <div class="page-title"><h2>ğŸ“‰ ì—°ì† í•˜ë½ ì¢…ëª© ë¶„ì„</h2></div>
      <div class="breadcrumb"><i class="fas fa-chart-line"></i><span>ë¶„ì„ / ì—°ì† í•˜ë½</span></div>
    </div>

    <div class="card-box">
      <div class="controls">
        <label>ê¸°ê°„:
          <select id="periodSelect">
            <option value="7">1ì£¼ì¼</option><option value="14">2ì£¼ì¼</option><option value="21">3ì£¼ì¼</option>
            <option value="28">4ì£¼ì¼</option><option value="30">1ê°œì›”</option><option value="90">3ê°œì›”</option>
            <option value="180" selected>6ê°œì›”</option><option value="365">1ë…„</option><option value="730">2ë…„</option>
          </select>
        </label>
        <label>ì‹œì‘ì¼:<input type="date" id="startDate"></label>
        <label>ì¢…ë£Œì¼:<input type="date" id="endDate"></label>
        <label>Top N:<input type="number" id="topN" value="100" min="10" max="500"></label>
        <button id="btnStart" class="btn btn-start">ë¶„ì„ ì‹œì‘</button>
        <button id="btnCancel" class="btn btn-cancel" disabled>ì·¨ì†Œ</button>
      </div>
    </div>

    <div class="dashboard-cards">
      <div class="card">
        <div class="card-header"><i class="fas fa-layer-group"></i>ì „ì²´ ì§„í–‰ë¥ <span class="right" id="badgeTotal">-</span></div>
        <strong id="pctTotal">0%</strong>
        <div class="progress-bar"><div id="barTotal"></div></div>
      </div>
    </div>

    <div class="log-wrapper">
      <h3>ì‹¤ì‹œê°„ ë¡œê·¸</h3>
      <div id="logBox" class="log-box">ë¡œê·¸ ëŒ€ê¸°ì¤‘...</div>
    </div>

    <div class="result-box">
      <h3>ğŸ“Š ì—°ì† í•˜ë½ ì¢…ëª© ê²°ê³¼ (<span id="resultCount">0</span>ê°œ)</h3>
      <div class="table-container">
        <table>
          <thead><tr><th>#</th><th>ì¢…ëª©ì½”ë“œ</th><th>ì¢…ëª©ëª…</th><th>ì—°ì†í•˜ë½ì¼ìˆ˜</th></tr></thead>
          <tbody id="resultTableBody"><tr><td colspan="4" class="no-result">ê²°ê³¼ ì—†ìŒ</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ê¸°ë³¸ ì°¨íŠ¸ -->
    <div id="chartModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <button class="modal-btn btn-close" id="btnCloseChart">ë‹«ê¸°</button>
          <button class="modal-btn btn-zoom" id="btnZoomChart">í™•ëŒ€ ë³´ê¸° ğŸ”</button>
        </div>
        <div class="chart-box">
          <div class="spinner-container" id="chartSpinner"><div class="spinner"></div></div>
          <img id="chartImage" src="" alt="ì°¨íŠ¸ ë¯¸ë¦¬ë³´ê¸°">
        </div>
      </div>
    </div>

    <!-- í™•ëŒ€ ëª¨ë‹¬ -->
    <div id="zoomModal" class="zoom-modal">
      <div class="zoom-inner">
        <button class="zoom-close-btn" id="zoomCloseBtn">ë‹«ê¸° âœ–</button>
        <img id="zoomImage" src="" alt="í™•ëŒ€ ì°¨íŠ¸">
      </div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
(()=>{
  const $start=document.getElementById("startDate"),$end=document.getElementById("endDate"),
        $period=document.getElementById("periodSelect"),$btnStart=document.getElementById("btnStart"),
        $btnCancel=document.getElementById("btnCancel"),$log=document.getElementById("logBox"),
        $bar=document.getElementById("barTotal"),$pct=document.getElementById("pctTotal"),$badge=document.getElementById("badgeTotal"),
        $tbody=document.getElementById("resultTableBody"),$resultCount=document.getElementById("resultCount"),
        $chartModal=document.getElementById("chartModal"),$chartImage=document.getElementById("chartImage"),
        $chartSpinner=document.getElementById("chartSpinner"),$btnCloseChart=document.getElementById("btnCloseChart"),
        $btnZoomChart=document.getElementById("btnZoomChart"),$zoomModal=document.getElementById("zoomModal"),
        $zoomImage=document.getElementById("zoomImage"),$zoomClose=document.getElementById("zoomCloseBtn");
  let es=null;

  const now=new Date(), s=new Date(); s.setMonth(now.getMonth()-6);
  $start.value=s.toISOString().split("T")[0]; $end.value=now.toISOString().split("T")[0];
  $period.onchange=()=>{const d=parseInt($period.value);const end=new Date(), st=new Date();st.setDate(end.getDate()-d);
                        $start.value=st.toISOString().split("T")[0];$end.value=end.toISOString().split("T")[0];};

  function appendLog(line){if(!line)return;if($log.textContent.includes("ëŒ€ê¸°ì¤‘"))$log.textContent="";
    const safe=line.replace(/[<>]/g,"");if(/error/i.test(safe))$log.innerHTML+=`<br><span class='log-error'>${safe}</span>`;
    else if(/\[PROGRESS\]/i.test(safe))$log.innerHTML+=`<br><span class='log-progress'>${safe}</span>`;
    else if(/ì™„ë£Œ|COMPLETE/i.test(safe))$log.innerHTML+=`<br><span class='log-complete'>${safe}</span>`;
    else $log.innerHTML+="<br>"+safe;$log.scrollTop=$log.scrollHeight;}
  function setBar(p){$bar.style.width=p+"%";$pct.textContent=p.toFixed(1)+"%";$badge.textContent=p>=100?"âœ… ì™„ë£Œ":Math.round(p)+"%";}
  function renderResults(list){$tbody.innerHTML="";if(!list||list.length===0){$tbody.innerHTML='<tr><td colspan="4" class="no-result">ê²°ê³¼ ì—†ìŒ</td></tr>';return;}
    $resultCount.textContent=list.length;list.forEach((r,i)=>{const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i+1}</td><td>${r.ticker}</td><td>${r.name}</td><td>${r.streak}</td>`;
      tr.onclick=()=>openChart(r.ticker);$tbody.appendChild(tr);});}

  function connectSSE(){
    if(es){try{es.close();}catch{}}
    es=new EventSource("/api/stock/lastCloseDownward/sse",{withCredentials:true});
    es.addEventListener("status",e=>{
      const d=JSON.parse(e.data||"{}");
      if(d.progress!==undefined)setBar(d.progress);
      if(Array.isArray(d.logs))d.logs.forEach(l=>appendLog(l));
      if(Array.isArray(d.results))renderResults(d.results);
      // âœ… ëª¨ë“  ì¢…ë£Œ ìƒíƒœì—ì„œ ë²„íŠ¼ ë³µì›
      if(["COMPLETE","COMPLETED","FAILED","CANCELLED","IDLE"].includes(d.status)){
        $btnStart.disabled=false;
        $btnCancel.disabled=true;
      }
    });
    es.onerror=()=>setTimeout(connectSSE,2000);
  }

  $btnStart.onclick=async()=>{
    const s=$start.value,e=$end.value;
    $btnStart.disabled=true;$btnCancel.disabled=true;setBar(0);
    $log.textContent="ë¶„ì„ ì‹œì‘ ì¤‘...";
    try{
      const res=await fetch(`/api/stock/lastCloseDownward/start?startDate=${s}&endDate=${e}&workers=8`,
                            {method:"POST",credentials:"include"});
      if(res.ok){appendLog("[LOG] ë¶„ì„ ì‹œì‘ë¨");$btnCancel.disabled=false;}
      else{appendLog("âš ï¸ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì„ ì  ì¤‘ì…ë‹ˆë‹¤.");$btnStart.disabled=false;}
    }catch(err){appendLog("[ERROR] ì„œë²„ ì—°ê²° ì‹¤íŒ¨");$btnStart.disabled=false;}
  };

  $btnCancel.onclick=async()=>{
    await fetch(`/api/stock/lastCloseDownward/cancel`,{method:"POST",credentials:"include"});
    appendLog("[LOG] ë¶„ì„ ì·¨ì†Œ ìš”ì²­ë¨");
    $btnCancel.disabled=true;$btnStart.disabled=false;
  };

  function openChart(symbol){
    const s=$start.value,e=$end.value;
    $chartImage.classList.remove("loaded");
    $chartSpinner.style.display="flex";$chartModal.style.display="flex";
    fetch(`/api/stock/lastCloseDownward/chart/${symbol}?startDate=${s}&endDate=${e}`,{credentials:"include"})
      .then(r=>r.json()).then(d=>{
        if(d.image_data){
          const img="data:image/png;base64,"+d.image_data;
          $chartImage.onload=()=>{setTimeout(()=>{$chartSpinner.style.display="none";$chartImage.classList.add("loaded");},150);}
          $chartImage.src=img;$zoomImage.src=img;
        }else{$chartSpinner.style.display="none";appendLog("[ERROR] ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨");}
      });
  }

  $btnCloseChart.onclick=()=>{$chartModal.style.display="none";};
  $btnZoomChart.onclick=()=>{$chartModal.style.display="none";$zoomModal.style.display="flex";};
  $zoomClose.onclick=()=>{$zoomModal.style.display="none";};

  connectSSE();
})();
</script>
</th:block>
</body>
</html>
