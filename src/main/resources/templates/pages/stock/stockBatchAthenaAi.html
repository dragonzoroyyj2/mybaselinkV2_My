<!-- stockBatchAthenaAi.html -->
<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š AthenaAI ë°°ì¹˜ ì—…ë°ì´íŠ¸</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .chart-canvas-wrap{width:100%;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;min-height:300px;}
    #chartCanvas,#macdCanvas{width:100%;height:360px;}
    @media(max-width:640px){#chartCanvas,#macdCanvas{height:260px;}}

    .accordion-section { border-bottom: 1px solid #e5e7eb; }
    .accordion-header { display:flex;justify-content:space-between;align-items:center;width:100%;padding:1rem 1.25rem;font-size:1.25rem;font-weight:700;cursor:pointer;transition:background-color 0.2s; }
    .accordion-header:hover { background-color:#eef2ff; }

    .accordion-content {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: scaleY(0.95);
      transform-origin: top;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .accordion-content.open {
      max-height: 1000px;
      opacity: 1;
      transform: scaleY(1);
    }

    .option-card-wrapper { cursor:pointer; transition:all 0.25s ease; }
    .option-card {
      border:2px solid #d1d5db;
      border-radius:12px;
      padding:1rem;
      text-align:center;
      background-color:#fff;
      font-weight:600;
      transition:all 0.25s ease;
    }
    .option-card-wrapper:hover .option-card {
      border-color:#818cf8;
      background-color:#eef2ff;
    }
    input[type="radio"]:checked + .option-card {
      border-color:#4f46e5;
      background-color:#eef2ff;
      box-shadow:0 0 8px rgba(79,70,229,0.3);
      transform:scale(1.03);
    }
    input[type="radio"]:not(:checked) + .option-card { opacity:0.7; }

    .rotate-icon { transition:transform 0.4s ease; }
    .rotate-icon.open { transform:rotate(180deg); }

    .status-running { color:#3b82f6; font-weight:bold; }
    .status-locked { color:#f59e0b; font-weight:bold; }
    .status-completed { color:#22c55e; font-weight:bold; }
    .status-failed { color:#ef4444; font-weight:bold; }
    .status-cancelled { color:#9ca3af; font-weight:bold; }
    .status-idle { color:#6b7280; }

    @keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.5;} }
    .status-running.blinking { animation:blink 1s infinite; }

    .tooltip-container { position:relative; display:inline-block; }
    .info-icon { margin-left:5px; font-size:0.8em; font-weight:bold; color:#4f46e5; cursor:pointer; }
    .tooltip-box {
      visibility:hidden; opacity:0; transition:opacity 0.3s;
      width:200px; background-color:#333; color:#fff;
      text-align:left; border-radius:6px; padding:10px;
      position:absolute; z-index:10; bottom:125%; left:50%;
      margin-left:-100px; font-size:0.85em; line-height:1.4;
    }
    .tooltip-box.visible { visibility:visible; opacity:1; }
    .tooltip-box::after {
      content:""; position:absolute; top:100%; left:50%; margin-left:-5px;
      border-width:5px; border-style:solid; border-color:#333 transparent transparent transparent;
    }

    .modal-open-fix { overflow:hidden!important; position:fixed; width:100%; height:100vh; top:0; left:0; }

    @keyframes fadeInUp { from{transform:translateY(30px);opacity:0;} to{transform:translateY(0);opacity:1;} }
    .loader { border-top-color:#4f46e5; animation:spin 1s linear infinite; }
    @keyframes spin { to{ transform:rotate(360deg);} }

    #chartModal { align-items:center; justify-content:center; }
    #chartModal .modal-card { margin:auto; transform:translateY(0); }
    
    
    
button:disabled {
  opacity: 0.4 !important;
  cursor: not-allowed !important;
  pointer-events: none !important;
}
  </style>

  <!-- ë°˜ë“œì‹œ Chart.jsë³´ë‹¤ ë¨¼ì € -->
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</head>


<body>
<div layout:fragment="content">
<div class="content-container p-4 md:p-6 lg:p-8">

<!-- ğŸ“Œ í—¤ë” -->
	<div class="page-header">
	  <div class="page-title">
	    <h2 th:text="${pageTitle} ?: 'ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ ì œëª©'">ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ ì œëª©</h2>
	  </div>
	  <div class="breadcrumb">
	    <i class="fas fa-folder-open"></i>
	    <span th:text="${breadcrumb} ?: 'ì‹œìŠ¤í…œ / ê¸°ë³¸ ê²½ë¡œ'">ì‹œìŠ¤í…œ / ê¸°ë³¸ ê²½ë¡œ</span>
	  </div>
	</div>   

<!-- ğŸŒ ì „ì—­ ìƒíƒœ -->
<div class="global-status-card bg-white border border-gray-200 rounded-xl p-4 shadow-sm mb-6">
  <div class="flex justify-between items-center mb-2">
    <span class="font-bold text-lg">ğŸŒ AthenaAI ì „ì—­ ë°°ì¹˜ ì§„í–‰ ìƒíƒœ</span>
    <span id="globalStatusText" class="text-gray-500">ëŒ€ê¸°ì¤‘</span>
  </div>
  <div class="flex justify-between text-sm text-gray-600 mb-2">
    <div>ì‹¤í–‰ì: <span id="globalRunner">ë¯¸ì—°ê²°</span></div>
    <div>ì „ì²´ ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div>
  </div>
  <div class="w-full h-3 bg-gray-200 rounded-lg overflow-hidden">
    <div id="globalProgressBar" class="h-full bg-blue-600 transition-all duration-300" style="width:0%"></div>
  </div>
</div>

<!-- âš™ï¸ ì•„ì½”ë””ì–¸ ì¹´ë“œ -->
<div class="card bg-white border border-gray-200 rounded-xl p-5 mb-10 shadow-sm">
  <form id="analysisForm" class="space-y-4">

    <div class="accordion-section">
      <div class="accordion-header" onclick="toggleAccordion('analysisTypeContent', 'icon1')">
        <span>1ï¸âƒ£ ë¶„ì„ ìœ í˜• ì„ íƒ</span>
        <i id="icon1" class="fas fa-chevron-down rotate-icon"></i>
      </div>
      <div id="analysisTypeContent" class="accordion-content open p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <label class="option-card-wrapper">
          <input type="radio" name="analysisType" id="maRadio" value="long_term_down_trend" class="hidden" checked onclick="toggleMaPeriods()">
          <div class="option-card border-2 p-4 rounded-xl">ğŸ“‰ MA ì¥ê¸° í•˜ë½ ì¶”ì„¸</div>
        </label>
        <label class="option-card-wrapper">
          <input type="radio" name="analysisType" value="double_bottom" class="hidden" onclick="toggleMaPeriods()">
          <div class="option-card border-2 p-4 rounded-xl">ğŸ“ˆ ì´ì¤‘ë°”ë‹¥</div>
        </label>
        <label class="option-card-wrapper">
          <input type="radio" name="analysisType" value="triple_bottom" class="hidden" onclick="toggleMaPeriods()">
          <div class="option-card border-2 p-4 rounded-xl">ğŸ“Š ì‚¼ì¤‘ë°”ë‹¥</div>
        </label>
        <label class="option-card-wrapper">
          <input type="radio" name="analysisType" value="cup_and_handle" class="hidden" onclick="toggleMaPeriods()">
          <div class="option-card border-2 p-4 rounded-xl">â˜• ì»µì•¤í•¸ë“¤</div>
        </label>
        
     	<label class="option-card-wrapper">
          <input type="radio" name="analysisType" value="half_cup" class="hidden" onclick="toggleMaPeriods()">
          <div class="option-card border-2 p-4 rounded-xl">ğŸŒ“ í•˜í”„ ì•¤ í•¸ë“¤</div>
        </label>
      </div>
    </div>

    <!-- MA ì˜µì…˜ -->
	<div id="maPeriodsContainer" class="bg-indigo-50 rounded-lg p-4 mt-2">
	  <h4 class="font-bold text-indigo-600 mb-2">MA ê¸°ê°„</h4>
	  <div class="flex flex-wrap gap-4 items-center text-sm">
	    <input type="checkbox" id="ma20" value="20" checked disabled class="mr-1">
	    <label for="ma20" class="font-bold">20ì¼ (í•„ìˆ˜)</label>
	
	    <input type="checkbox" id="ma50" name="maPeriods" value="50" checked>
	    <label for="ma50">50ì¼</label>
	
	    <input type="checkbox" id="ma200" name="maPeriods" value="200" checked>
	    <label for="ma200">200ì¼</label>
	  </div>
	</div>


    <!-- 2ï¸âƒ£ ì‹¤í–‰ ì˜µì…˜ + ê²°ê³¼ ê°œìˆ˜ -->
    <div class="accordion-section">
      <div class="accordion-header" onclick="toggleAccordion('executionOptionsContent', 'icon2')">
        <span>2ï¸âƒ£ ì‹¤í–‰ ì˜µì…˜</span>
        <i id="icon2" class="fas fa-chevron-down rotate-icon"></i>
      </div>
      <div id="executionOptionsContent" class="accordion-content p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-4 bg-gray-50 border rounded-lg flex items-center gap-2">
          <span class="text-purple-700 font-bold">ğŸ› ï¸ ì‘ì—…ì:</span>
          <input id="workerCount" type="number" value="8" min="1" max="16" class="w-20 text-center border rounded-lg">
        </div>
        <div class="p-4 bg-gray-50 border rounded-lg flex items-center gap-2">
          <span class="text-purple-700 font-bold">ğŸ”¢ ìƒìœ„ N:</span>
          <input id="topNCount" type="number" value="10" min="1" max="50" class="w-20 text-center border rounded-lg">
        </div>
      </div>
    </div>

  </form>

  <!-- ì‹¤í–‰/ì·¨ì†Œ ë²„íŠ¼ -->
  <div class="flex flex-col sm:flex-row gap-4 mt-8">
    <button id="runAnalysisBtn" onclick="runAnalysis()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-lg font-bold">ğŸš€ ë¶„ì„ ì‹¤í–‰</button>
    <button id="btnCancel" onclick="cancelAnalysis()" class="flex-1 bg-red-600 text-white py-3 rounded-xl text-lg font-bold" disabled>âŒ ì·¨ì†Œ</button>
  </div>
</div>

<!-- ê²°ê³¼/ë¡œê·¸ ì¹´ë“œ -->
<div class="card bg-white border rounded-xl p-5 mb-10 shadow-sm">
  <h3 class="text-2xl font-bold mb-4">ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>
  	<div class="overflow-x-auto">
		  <table class="min-w-full text-sm" id="resultTable">
		    <thead class="bg-gray-100">
		      <tr>
		        <th class="p-3">ìˆœìœ„</th>       
		        <th class="p-3">ì¢…ëª©ì½”ë“œ</th>
		        <th class="p-3">ì¢…ëª©ëª…</th>
		        <th class="p-3">ì‹ í˜¸</th>
		        <th class="p-3">MA ë°°ì—´</th>
		        <th class="p-3">í¬ë¡œìŠ¤ ì—¬ë¶€</th>
		        <th class="p-3">ì°¨íŠ¸</th>
		      </tr>
		    </thead>
		    <tbody id="resultTableBody"></tbody>
		  </table>
	</div>
  
  
  <div id="noResultBox" class="hidden p-6 text-center text-gray-500">ê²°ê³¼ ì—†ìŒ</div>
</div>

<div class="card bg-white border rounded-xl p-5 mb-10 shadow-sm">
  <h3 class="text-2xl font-bold mb-4 flex items-center">
    ğŸªµ ì‹¤ì‹œê°„ ë¡œê·¸
    <button id="copyLogBtn" class="ml-3 text-sm bg-indigo-600 text-white px-3 py-1 rounded-md">ë³µì‚¬</button>
  </h3>
  <div id="logBox" class="h-64 bg-black text-green-300 p-3 overflow-y-auto font-mono text-xs rounded-md"><p>ë¡œê·¸ ëŒ€ê¸°ì¤‘...</p></div>
</div>

<!-- ğŸ“ˆ ì°¨íŠ¸ ëª¨ë‹¬ (ì™„ì „ ë°˜ì‘í˜• ì¤‘ì•™ ì •ë ¬ + ìŠ¤í¬ë¡¤ ë½ + ì• ë‹ˆë©”ì´ì…˜ ì ìš©) -->
<div id="chartModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[9999] p-4">
  <div class="modal-card bg-white rounded-2xl w-full max-w-[95vw] sm:max-w-2xl md:max-w-3xl lg:max-w-5xl max-h-[90vh] overflow-y-auto p-4 relative shadow-2xl animate-[fadeInUp_0.25s_ease-out]">
    <h2 id="modalTitle" class="text-lg sm:text-xl md:text-2xl font-bold mb-4 text-left pl-2 pr-24"></h2>

    <!-- âœ… ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div id="chartLoading" class="hidden absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center z-20">
      <div class="loader border-4 border-t-4 border-gray-200 border-t-indigo-500 rounded-full w-10 h-10 animate-spin"></div>
    </div>

    <!-- âœ… ì°¨íŠ¸ ìº”ë²„ìŠ¤ -->
    <div class="chart-canvas-wrap mb-4">
      <canvas id="chartCanvas"></canvas>
    </div>
    <div class="chart-canvas-wrap mb-2">
      <canvas id="macdCanvas"></canvas>
    </div>

    <!-- âœ… ìƒë‹¨ ì œì–´ ë²„íŠ¼ -->
    <div class="absolute top-3 right-3 flex items-center gap-2">
      <button id="btnResetZoom" class="hidden bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 transition">
        ğŸ”„ ì¤Œ ì´ˆê¸°í™”
      </button>
      <button id="btnSaveChart" class="hidden bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700 transition">
        ğŸ’¾ ì´ë¯¸ì§€ ì €ì¥
      </button>
      <button onclick="closeChartModal()" class="text-gray-500 hover:text-black text-lg font-bold">âœ–</button>
    </div>
  </div>
</div>


</div>
</div>


<th:block layout:fragment="pageScript">

<script>

/* ==========================================================
 * ğŸ“œ AthenaAI (chart + analyze) í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ (ì™„ì„±íŒ)
 * - Chart.js Financial + Zoom í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
 * - JSON ì°¨íŠ¸ ë Œë”ë§ ì•ˆì •í™” (animation:false)
 * - payload.results ì œê±° â†’ payload ì§ì ‘ íŒŒì‹± (Aì•ˆ)
 * - SSE ìƒíƒœ ë™ê¸°í™” + ì‹¤í–‰/ì·¨ì†Œ
 * - ë¡œê·¸ + ê²°ê³¼ í…Œì´ë¸” + ì°¨íŠ¸ ëª¨ë‹¬ ì™„ì „ í†µí•©
 * ========================================================== */

/* ----------------------------------------------------------
 *  ì•„ì½”ë””ì–¸
 * ---------------------------------------------------------- */
window.toggleAccordion = function(contentId, iconId) {
  const content = document.getElementById(contentId);
  const icon = document.getElementById(iconId);
  const isOpen = content.classList.contains('open');

  if (window.innerWidth < 768) {
    document.querySelectorAll('.accordion-content').forEach(c => { if (c !== content) c.classList.remove('open'); });
    document.querySelectorAll('.rotate-icon').forEach(i => { if (i !== icon) i.classList.remove('open'); });
  }

  content.classList.toggle('open', !isOpen);
  icon.classList.toggle('open', !isOpen);
};


/* ----------------------------------------------------------
 *  ì¦‰ì‹œ ì‹¤í–‰ ìŠ¤ì½”í”„
 * ---------------------------------------------------------- */
(function () {

	let esGlobal = null;

	function connectGlobalSSE() {
	  if (esGlobal) { try { esGlobal.close(); } catch(e){} }

	  esGlobal = new EventSource("/api/global/sse");

	  esGlobal.addEventListener("status", (ev) => {
		    const d = JSON.parse(ev.data || "{}");

		    updateGlobalState(
		        d.globalStatus,
		        d.globalRunner,
		        d.globalProgress
		    );

		    updateButtonState(
		        d.globalStatus,
		        d.globalRunner
		    );
		});


	  esGlobal.onerror = () => {
	    try{ esGlobal.close(); }catch(e){}
	    setTimeout(connectGlobalSSE, 2000);
	  };
	}

	
	
  /* ----------------------------------------------------------
   * DOM í•¸ë“¤
   * ---------------------------------------------------------- */
  const $runBtn = document.getElementById("runAnalysisBtn");
  const $cancelBtn = document.getElementById("btnCancel");
  const $analysisForm = document.getElementById("analysisForm");
  const $log = document.getElementById("logBox");
  const $copyLogBtn = document.getElementById("copyLogBtn");
  const $resultTableBody = document.getElementById("resultTableBody");
  const $noResultBox = document.getElementById("noResultBox");

  const $chartModal = document.getElementById("chartModal");
  const $modalTitle = document.getElementById("modalTitle");
  const $btnResetZoom = document.getElementById('btnResetZoom');
  const $btnSaveChart = document.getElementById('btnSaveChart');
  const $chartLoading = document.getElementById('chartLoading');

  const $globalStatusText = document.getElementById("globalStatusText");
  const $globalRunner = document.getElementById("globalRunner");
  const $globalProgressLabel = document.getElementById("globalProgressLabel");
  const $globalProgressBar = document.getElementById("globalProgressBar");

  const $priceCanvas = document.getElementById('chartCanvas');
  const $macdCanvas  = document.getElementById('macdCanvas');

  let priceChart = null;
  let macdChart  = null;

  let currentTaskId = null;
  let es = null;
  let currentUser = "ë¯¸ì—°ê²°";
  let globalStatus = "IDLE";

  /* ----------------------------------------------------------
   * Chart.js Financial / Zoom í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
   * ---------------------------------------------------------- */
  (function ensureFinancialRegistered(){
    try {
      const hasCandle =
        (Chart?.registry?.controllers?.get?.('candlestick')) ||
        (Chart?.controllers && (Chart.controllers.candlestick || Chart.FinancialController));

      if (!hasCandle) {
        const candlestick = (Chart.FinancialController || Chart.controllers?.candlestick);
        const ohlc        = (Chart.OhlcController      || Chart.controllers?.ohlc);
        if (candlestick) Chart.register(candlestick);
        if (ohlc)        Chart.register(ohlc);
      }

      const zoomCandidate = window.ChartZoom || window.chartjsPluginZoom || window.Zoom || window['chartjs-plugin-zoom'];
      if (zoomCandidate && typeof zoomCandidate.id === 'string') {
        Chart.register(zoomCandidate);
      }
    } catch (e) {}
  })();


  /* ----------------------------------------------------------
   * íŒ¨í„´/MA ì„ íƒ íŒŒì‹±
   * ---------------------------------------------------------- */
  function getSelectedPattern() {
    const checked = document.querySelector("input[name='analysisType']:checked");
    return checked ? checked.value : "ma";
  }

  function getMaPeriods() {
    const maPeriodsElements = document.querySelectorAll('input[name="maPeriods"]:checked');
    return Array.from(maPeriodsElements)
      .map(el => el.value)
      .filter((value, index, self) => self.indexOf(value) === index)
      .sort((a, b) => parseInt(a) - parseInt(b))
      .join(',');
  }

  window.toggleMaPeriods = function () {
    const isMA = document.getElementById("maRadio").checked;
    const box = document.getElementById("maPeriodsContainer");
    if (!box) return;
    const inputs = box.querySelectorAll('input[type="checkbox"]');
    inputs.forEach(input => {
      if (input.id === 'ma20') return;
      input.disabled = !isMA;
    });
    box.style.display = isMA ? "block" : "none";
  };


  /* ----------------------------------------------------------
   * ë¡œê·¸
   * ---------------------------------------------------------- */
  function appendLog(line) {
    if (!line) return;
    const p = document.createElement("p");

    if (line.includes("[ERROR]") || line.includes("ì‹¤íŒ¨")) p.className = 'text-red-500';
    else if (line.includes("WARNING")) p.className = 'text-yellow-500';
    else if (line.includes("COMPLETED")) p.className = 'text-green-500 font-extrabold';
    else p.className = 'text-gray-300';

    p.textContent = line;
    $log.appendChild(p);
    $log.scrollTop = $log.scrollHeight;
  }

  $copyLogBtn.onclick = () => {
    const t = Array.from($log.querySelectorAll("p"))
      .map(p => p.textContent)
      .join("\n");

    if (t.trim() === 'ë¡œê·¸ ëŒ€ê¸°ì¤‘...') {
      appendLog("[LOG] ë³µì‚¬í•  ë¡œê·¸ ì—†ìŒ");
      return;
    }

    navigator.clipboard.writeText(t)
      .then(() => appendLog("[LOG] ë¡œê·¸ ë³µì‚¬ ì™„ë£Œ"));
  };


  /* ----------------------------------------------------------
   * ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
   * ---------------------------------------------------------- */
  function renderResults(list) {
    $resultTableBody.innerHTML = "";
    if (!list || list.length === 0) {
      $noResultBox.classList.remove("hidden");
      return;
    }
    $noResultBox.classList.add("hidden");

    list.forEach((item, index) => {
      const rowId = `result-row-${item.ticker}`;
      const tr = document.createElement("tr");
      tr.className = 'hover:bg-gray-100';

      const conditions = item.technical_conditions || {};
      const cross =
        conditions.goldencross_50_200_detected
          ? `<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">â­ ê³¨ë“ </span>`
          : conditions.deadcross_50_200_detected
              ? `<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">ğŸ’€ ë°ë“œ</span>`
              : '-';

      tr.innerHTML = `
        <td class="p-3 border font-bold">${index + 1}</td>
        <td class="p-3 border">${item.ticker || "-"}</td>
        <td class="p-3 border">${item.name || "-"}</td>
        <td class="p-3 border">${conditions.market_regime || "-"}</td>
        <td class="p-3 border">${conditions.down_trend_status || "-"}</td>
        <td class="p-3 border">${cross}</td>
        <td class="p-3 border text-center">
          <button class="px-3 py-1 bg-indigo-600 text-white rounded-md"
                  onclick="showChart('${item.ticker}', '${item.name}')">ë³´ê¸°</button>
        </td>
      `;
      $resultTableBody.appendChild(tr);
    });

    appendLog(`[LOG] ê²°ê³¼ ${list.length}ê°œ ì—…ë°ì´íŠ¸`);
  }


  /* ----------------------------------------------------------
   * ì°¨íŠ¸ ê³µí†µ ìœ í‹¸
   * ---------------------------------------------------------- */
  function destroyCharts() {
    try { priceChart?.destroy(); } catch(e){}
    try { macdChart?.destroy(); } catch(e){}
    priceChart = null;
    macdChart = null;
  }

  /* ----------------------------------------------------------
   * ì¢Œí‘œ ìœ í‹¸
   * ---------------------------------------------------------- */
  function toXY(ds) {
    if (!Array.isArray(ds)) return [];
    return ds.map(d => {
      const ts = new Date(d.x).getTime();
      if (isNaN(ts) || d.y == null) return null;
      return { x: ts, y: d.y };
    }).filter(Boolean);
  }

  /* ----------------------------------------------------------
   * Price Chart  (ë¹ˆ ë°ì´í„°ë©´ ì°¨íŠ¸ ìƒëµ â†’ í•˜ì–€ ë°°ê²½/íŒ¨ë‹ ë²„ê·¸ ì™„ì „í•´ê²°)
   * ---------------------------------------------------------- */
  function buildPriceChart(ctx, payload) {

    const raw = payload.ohlcv_data;
    if (!raw || !Array.isArray(raw) || raw.length === 0) {
      // ë°ì´í„° ì—†ìœ¼ë©´ ì°¨íŠ¸ ìƒì„±í•˜ì§€ ì•ŠìŒ
      return;
    }

    const ohlcData = raw.map(d => {
      const ts = new Date(d.x).getTime();
      if (isNaN(ts)) return null;
      return { x: ts, o: d.o, h: d.h, l: d.l, c: d.c };
    }).filter(Boolean);

    const ma20  = payload.ma_data?.MA20  ? toXY(payload.ma_data.MA20)  : [];
    const ma50  = payload.ma_data?.MA50  ? toXY(payload.ma_data.MA50)  : [];
    const ma200 = payload.ma_data?.MA200 ? toXY(payload.ma_data.MA200) : [];

    priceChart = new Chart(ctx, {
      type: 'candlestick',
      data: {
        datasets: [
          { label:'OHLCV', data:ohlcData, parsing:false, borderWidth:1 },
          { type:'line', label:'MA20',  data:ma20,  parsing:false, pointRadius:0, borderWidth:1, borderColor:'#22c55e' },
          { type:'line', label:'MA50',  data:ma50,  parsing:false, pointRadius:0, borderWidth:1, borderColor:'#7c3aed' },
          { type:'line', label:'MA200', data:ma200, parsing:false, pointRadius:0, borderWidth:1, borderColor:'#3b82f6' }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        interaction:{ mode:'nearest', intersect:false },
        parsing:false,
        scales:{
          x:{
            type:'time',
            time:{ tooltipFormat:'yyyy-MM-dd' },
            adapters:{ date:{ zone:'Asia/Seoul' }},
            grid:{ display:false }
          },
          y:{
            beginAtZero:false,
            ticks:{ callback:v => v.toLocaleString() }
          }
        },
        plugins:{
          zoom:{
            limits:{ x:{ min:'original', max:'original' } }, /* ì¢Œìš° ë ì•ˆë‚ ì•„ê°€ê²Œ ê³ ì • */
            zoom:{ wheel:{enabled:true}, pinch:{enabled:true}, mode:'x' },
            pan:{ enabled:true, mode:'x' }
          },
          legend:{ labels:{ usePointStyle:true } }
        }
      }
    });
  }


  /* ----------------------------------------------------------
   * MACD Chart (ë¹ˆ ë°ì´í„° ë°©ì§€)
   * ---------------------------------------------------------- */
   function buildMacdChart(ctx, payload) {

	   const macdRaw  = payload.macd_data?.MACD;
	   const sigRaw   = payload.macd_data?.Signal;
	   const histRaw  = payload.macd_data?.Histogram;

	   if (!macdRaw || !sigRaw || !histRaw) {
	     return;
	   }

	   const macd   = toXY(macdRaw);
	   const signal = toXY(sigRaw);
	   const hist   = toXY(histRaw);

	   if (macd.length === 0 && signal.length === 0 && hist.length === 0) {
	     return;
	   }

	   macdChart = new Chart(ctx, {
	     data: {
	       datasets: [
	         {
	           type: 'line',
	           label: 'MACD',
	           data: macd,
	           parsing: false,
	           pointRadius: 0,
	           borderWidth: 1,
	           borderColor: '#111827'
	         },
	         {
	           type: 'line',
	           label: 'Signal',
	           data: signal,
	           parsing: false,
	           pointRadius: 0,
	           borderWidth: 1,
	           borderColor: '#f43f5e'
	         },
	         {
	           type: 'bar',
	           label: 'Histogram',
	           data: hist,
	           parsing: false,
	           borderWidth: 0,
	           backgroundColor: ctx => {
	             const v = ctx.parsed.y;
	             return v > 0
	               ? 'rgba(34,197,94,0.7)'
	               : 'rgba(239,68,68,0.7)';
	           }
	         }
	       ]
	     },

	     options:{
	       responsive:true,
	       maintainAspectRatio:false,
	       animation:false,
	       parsing:false,
	       interaction:{ mode:'nearest', intersect:false },

	       scales:{
	         x:{
	           type:'time',
	           time:{ tooltipFormat:'yyyy-MM-dd' },
	           adapters:{ date:{ zone:'Asia/Seoul' }},
	           grid:{ display:false }
	         },
	         y:{ beginAtZero:false }
	       },

	       plugins:{
	         zoom:{
	           limits:{ x:{ min:'original', max:'original' }},
	           zoom:{ wheel:{enabled:true}, pinch:{enabled:true}, mode:'x' },
	           pan:{ enabled:true, mode:'x' }
	         },
	         legend:{ labels:{ usePointStyle:true } }
	       }
	     }
	   });
	 }




  /* ----------------------------------------------------------
   * fetch â†’ ì°¨íŠ¸ ë Œë”ë§
   * ---------------------------------------------------------- */
  async function tryRenderChartsByJson(ticker, name) {

    const url = `/api/stock/batch/athena/chart?symbol=${encodeURIComponent(ticker)}&ts=${Date.now()}`;
    const res = await fetch(url, { headers:{ 'Accept':'application/json' }});
    if (!res.ok) throw new Error("HTTP " + res.status);

    const ct = res.headers.get('Content-Type') || '';
    if (!ct.includes('application/json')) throw new Error("JSON ì•„ë‹˜");

    const payload = await res.json();

    destroyCharts();

    buildPriceChart($priceCanvas.getContext('2d'), payload);
    buildMacdChart($macdCanvas.getContext('2d'), payload);

    $btnResetZoom.classList.remove("hidden");
    $btnSaveChart.classList.remove("hidden");

    $btnResetZoom.onclick = () => {
      priceChart?.resetZoom?.();
      macdChart?.resetZoom?.();
    };

    $btnSaveChart.onclick = () => {
      try {
        const c1 = $priceCanvas;
        const c2 = $macdCanvas;

        const merged = document.createElement('canvas');
        merged.width  = Math.max(c1.width, c2.width);
        merged.height = c1.height + c2.height + 20;

        const ctx2 = merged.getContext('2d');
        ctx2.fillStyle = '#ffffff';
        ctx2.fillRect(0,0,merged.width, merged.height);

        ctx2.drawImage(c1,0,0);
        ctx2.drawImage(c2,0,c1.height+10);

        const link = document.createElement('a');
        link.download = `${ticker}_${name}_chart.png`;
        link.href = merged.toDataURL('image/png');
        link.click();
      } catch(e) {
        appendLog("[ERROR] ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: " + e.message);
      }
    };
  }


  /* ----------------------------------------------------------
   * ëª¨ë‹¬ showChart
   * ---------------------------------------------------------- */
  window.showChart = async (ticker, name) => {
    $modalTitle.textContent = `ğŸ“ˆ ${ticker} - ${name}`;
    $chartModal.classList.remove("hidden");
    document.body.classList.add('modal-open-fix');

    $chartLoading.classList.remove("hidden");
    await new Promise(r => setTimeout(r, 120));

    try {
      await tryRenderChartsByJson(ticker, name);
    } catch (err) {
      destroyCharts();
      $btnResetZoom.classList.add('hidden');
      $btnSaveChart.classList.add('hidden');
      appendLog("[ERROR] ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨: " + err.message);
    } finally {
      $chartLoading.classList.add("hidden");
    }
  };

  window.closeChartModal = () => {
    $chartModal.classList.add("hidden");
    destroyCharts();
    document.body.classList.remove('modal-open-fix');
  };


  /* ----------------------------------------------------------
   * SSE ì—°ê²°
   * ---------------------------------------------------------- */
  function updateGlobalState(st, runner, progress) {
    const S = (st || "IDLE").toUpperCase();
    let pct = 0;

    if (S === "COMPLETED") pct = 100;
    else if (S === "RUNNING") pct = Math.floor(progress || 0);
    else pct = 0;

    $globalStatusText.textContent = S;
    $globalRunner.textContent = runner || "ë¯¸ì—°ê²°";
    $globalProgressLabel.textContent = pct + "%";
    $globalProgressBar.style.width = pct + "%";

    $globalStatusText.className = "";
    if (S === "RUNNING" && runner === currentUser) $globalStatusText.classList.add("status-running","blinking");
    else if (S === "RUNNING") $globalStatusText.classList.add("status-locked");
    else if (S === "COMPLETED") $globalStatusText.classList.add("status-completed");
    else if (S === "FAILED") $globalStatusText.classList.add("status-failed");
    else if (S === "CANCELLED") $globalStatusText.classList.add("status-cancelled");
    else $globalStatusText.classList.add("status-idle");
  }

  function updateButtonState(status, runner) {
    const S = (status || "IDLE").toUpperCase();
    const isRunning = ["START","IN_PROGRESS","RUNNING"].includes(S);
    const isOwner = (runner === currentUser);

    if (!isRunning) {
      $runBtn.disabled = false;
    } else {
      $runBtn.disabled = true;
    }

    $cancelBtn.disabled = !(isRunning && isOwner);
  }

  function connectSSE() {
    if (es) { try { es.close(); } catch(e){} }

    es = new EventSource("/api/stock/batch/athena/sse");
    es.onopen = () => appendLog("[LOG] SSE ì—°ê²° ì„±ê³µ.");

    es.addEventListener("status", (ev) => {
      const d = JSON.parse(ev.data || "{}");

      if (d.globalStatus) {
        updateGlobalState(d.globalStatus,d.globalRunner,d.globalProgress);
        updateButtonState(d.globalStatus,d.globalRunner);
      }
      if (Array.isArray(d.logs)) d.logs.forEach(line=>appendLog(line));
      if (Array.isArray(d.results)) renderResults(d.results);
      if (d.taskId) currentTaskId = d.taskId;
    });

    es.onerror = () => {
      appendLog("[ERROR] SSE ì˜¤ë¥˜, ì¬ì‹œë„");
      try { es.close(); } catch(e){}
      es = null;
      setTimeout(connectSSE, 2000);
    };
  }


  /* ----------------------------------------------------------
   * ì‹¤í–‰/ì·¨ì†Œ
   * ---------------------------------------------------------- */
  window.runAnalysis = async () => {
    if ($runBtn.disabled) return;

    $log.innerHTML = `<p class="opacity-70">ë¶„ì„ ìš”ì²­ ì¤‘...</p>`;
    $resultTableBody.innerHTML = "";
    $noResultBox.classList.add("hidden");

    const pattern = getSelectedPattern();
    const workers = document.getElementById("workerCount").value;
    const topN = document.getElementById("topNCount").value;
    const maPeriods = getMaPeriods();

    const url =
      `/api/stock/batch/athena/start`
      + `?pattern=${encodeURIComponent(pattern)}`
      + `&workers=${encodeURIComponent(workers)}`
      + `&maPeriods=${encodeURIComponent(maPeriods)}`
      + `&topN=${encodeURIComponent(topN)}`;

    try {
      const res = await fetch(url,{ method:'POST' });
      if (!res.ok) {
        appendLog("[ERROR] ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨");
      } else {
        const data = await res.json();
        currentTaskId = data.taskId;
        appendLog(`[LOG] ë¶„ì„ ì‹œì‘: TaskID ${currentTaskId}`);
      }
    } catch(e) {
      appendLog("[FATAL] ë¶„ì„ ìš”ì²­ ì˜¤ë¥˜: " + e.message);
    }
  };

  window.cancelAnalysis = async () => {
    if (!currentTaskId) {
      appendLog("[WARNING] ì·¨ì†Œí•  ì‘ì—… ì—†ìŒ");
      return;
    }
    try {
      const res = await fetch(`/api/stock/batch/athena/cancel/${encodeURIComponent(currentTaskId)}`, { method:'POST' });
      if (!res.ok) appendLog("[ERROR] ì·¨ì†Œ ì‹¤íŒ¨");
      else appendLog("[LOG] ì·¨ì†Œ ì™„ë£Œ");
    } catch(e) {
      appendLog("[ERROR] ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜: " + e.message);
    }
  };


  /* ----------------------------------------------------------
   * í˜„ì¬ ì‚¬ìš©ì ë¶ˆëŸ¬ì˜¤ê¸°
   * ---------------------------------------------------------- */
  async function initCurrentUser() {
    try {
      const res = await fetch("/auth/me",{ credentials:'include' });
      if (!res.ok) return;
      const data = await res.json();
      currentUser = data.username || data.fullName || "-";
    } catch(e){}
  }


  /* ----------------------------------------------------------
   * ì´ˆê¸° ì‹¤í–‰
   * ---------------------------------------------------------- */
   document.addEventListener("DOMContentLoaded", () => {
	   toggleMaPeriods();
	   initCurrentUser().then(() => {
	     connectGlobalSSE();  // â† ì´ ì¤„ ì¶”ê°€
	     connectSSE();        // ê¸°ì¡´ AthenaAI SSE
	   });
	 })

})();

</script>


</th:block>


</body>
</html>
