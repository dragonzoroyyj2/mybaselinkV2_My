<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
<meta charset="UTF-8">
<title>📊 Stock Batch Dashboard</title>

<style>
  .content-container{width:100%;max-width:1600px;margin:0 auto;padding:1rem 2%;box-sizing:border-box;}
  h2{font-size:1.3rem;font-weight:700;margin-bottom:.4rem;color:#111827;}
  .card-box,.dashboard-cards,.log-wrapper{background:#fff;border-radius:12px;padding:18px;box-shadow:0 2px 6px rgba(0,0,0,.05);margin-top:14px;}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-size:.9rem;font-weight:600;color:#fff;min-width:110px;text-align:center;}
  .btn-start{background:#2563eb;}
  .btn-cancel{background:#dc2626;}
  .btn:disabled{opacity:.5;cursor:not-allowed;}
  .controls{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;}
  input[type=number]{width:90px;padding:.45rem .6rem;border:1px solid #bbb;border-radius:6px;}
  .dashboard-cards{display:flex;flex-wrap:wrap;gap:14px;}
  .card{flex:1 1 300px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.05);display:flex;flex-direction:column;}
  .card-header{display:flex;align-items:center;gap:6px;font-size:.95rem;font-weight:600;margin-bottom:6px;}
  .card-header i{color:#2563eb;}
  .card-header .right{margin-left:auto;font-weight:600;font-size:.9rem;}
  .progress-bar{width:100%;background:#e5e7eb;height:14px;border-radius:7px;margin-top:10px;overflow:hidden;}
  .progress-bar div{height:100%;width:0%;transition:width .3s;}
  .bar-total div{background:#2563eb;}
  .bar-krx div{background:#10b981;}
  .bar-data div{background:#f59e0b;}
  .log-wrapper h3{display:flex;align-items:center;justify-content:space-between;margin:0;font-size:1rem;}
  .copy-btn{font-size:.9rem;cursor:pointer;user-select:none;margin-left:10px;color:#444;opacity:.7;}
  .copy-btn:hover{opacity:1;text-decoration:none;}
  .log-box{background:#111;color:#eee;font-family:Consolas,mono;font-size:13px;padding:10px;border-radius:10px;height:350px;overflow-y:auto;white-space:pre-wrap;margin-top:6px;}
</style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>📊 종목 일괄 업데이트 Dashboard</h2>
    <p>진행상황 + 실시간 로그 확인 가능</p>

    <div class="card-box">
      <div class="controls">
        <label>워커:
          <input type="number" id="workers" value="8" min="1" max="16">
        </label>
        <label><input type="checkbox" id="force"> 강제 다운로드</label>
        <button id="btnStart" class="btn btn-start">업데이트 시작</button>
        <button id="btnCancel" class="btn btn-cancel" disabled>취소</button>
      </div>
      <div id="adminHint" style="font-size:12px;color:#666;margin-top:4px;">
        ※ 관리자만 실행 가능
      </div>
    </div>

    <div class="dashboard-cards">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-layer-group"></i>전체 진행률
          <span class="right" id="badgeTotal">-</span>
        </div>
        <strong id="pctTotal">0%</strong>
        <div class="progress-bar bar-total"><div id="barTotal"></div></div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-database"></i>KRX 종목 목록
          <span class="right" id="badgeKrx"></span>
        </div>
        <strong id="pctKrx">0%</strong>
        <div class="progress-bar bar-krx"><div id="barKrx"></div></div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-chart-line"></i>개별 종목 데이터
          <span class="right" id="badgeData"></span>
        </div>
        <strong id="pctData">0%</strong>
        <div class="progress-bar bar-data"><div id="barData"></div></div>
      </div>
    </div>

    <div class="log-wrapper">
      <h3>
        실시간 로그
        <span class="copy-btn" id="copyLogBtn">📄</span>
      </h3>
      <div id="logBox" class="log-box">로그 대기중...</div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
(function(){
  const API = {
    start:(w,f)=>`/api/stock/batch/update?workers=${w}${f?"&force=true":""}`,
    status:(id)=>`/api/stock/batch/status/${id}`,
    statusCurrent:()=>`/api/stock/batch/status/current`,
    cancel:(id)=>`/api/stock/batch/cancel/${id}`,
    active:()=>`/api/stock/batch/active`
  };

  const $workers=document.getElementById("workers"),
        $force=document.getElementById("force"),
        $btnStart=document.getElementById("btnStart"),
        $btnCancel=document.getElementById("btnCancel"),
        $barTotal=document.getElementById("barTotal"),
        $barKrx=document.getElementById("barKrx"),
        $barData=document.getElementById("barData"),
        $pctTotal=document.getElementById("pctTotal"),
        $pctKrx=document.getElementById("pctKrx"),
        $pctData=document.getElementById("pctData"),
        $badgeTotal=document.getElementById("badgeTotal"),
        $badgeKrx=document.getElementById("badgeKrx"),
        $badgeData=document.getElementById("badgeData"),
        $hint=document.getElementById("adminHint"),
        $log=document.getElementById("logBox"),
        $copy=document.getElementById("copyLogBtn");

  let taskId=null, poll=null, lastSeq=0, isOwner=false;

  function setBar(bar,pct,val){
    const v=Math.min(100,Math.max(0,Number.isFinite(val)?Math.round(val):0));
    bar.style.width=v+"%"; pct.textContent=v+"%";
  }
  function disableInputs(dis){ $workers.disabled=dis; $force.disabled=dis; }
  function enableOwnerUI(){ $btnStart.disabled=true; $btnCancel.disabled=false; disableInputs(true); }
  function disableAllUI(){ $btnStart.disabled=true; $btnCancel.disabled=true; disableInputs(true); }
  function enableIdleUI(){ $btnStart.disabled=false; $btnCancel.disabled=true; disableInputs(false); }
  function appendLog(line){
    if(!$log) return;
    if($log.textContent.includes("대기중")) $log.textContent="";
    $log.textContent += (line||"") + "\n";
    $log.scrollTop = $log.scrollHeight;
  }
  function resetAll(){
    taskId=null; isOwner=false; lastSeq=0;
    setBar($barTotal,$pctTotal,0);
    setBar($barKrx,$pctKrx,0);
    setBar($barData,$pctData,0);
    $badgeTotal.textContent="-"; $badgeKrx.textContent=""; $badgeData.textContent="";
    $log.textContent="로그 대기중...";
    $hint.innerHTML="※ 관리자만 실행 가능";
    if(poll){clearInterval(poll); poll=null;}
    enableIdleUI();
  }

  async function safeFetchJSON(url, options){
    try{
      const res = await fetch(url, {
        ...options,
        credentials: 'include' // ✅ JWT 쿠키 포함
      });
      if(!res.ok) return {};
      const ct = res.headers.get("content-type")||"";
      if(!ct.includes("application/json")) return {};
      return await res.json();
    }catch(e){
      console.warn("fetch 오류:", e);
      return {};
    }
  }

  async function pollStatus(){
    const url = isOwner && taskId ? API.status(taskId) : API.statusCurrent();
    const data = await safeFetchJSON(url);

    // ✅ LOCKED 상태에서도 퍼센트 동기화
    if(data.status==="LOCKED"){
      const r = data.result||{};
      const runner = r.runner || data.runner || "알 수 없음";
      const pct = Math.round(r.progress||0);
      $hint.innerHTML = `<span style="color:#dc2626;font-weight:700;">🚫 ${runner}님 실행 중 (${pct}%)</span>`;
      disableAllUI();

      // 🔥 진행률 표시
      setBar($barTotal,$pctTotal,pct);

      if (r.krxTotal > 0 && r.krxSaved >= 0) {
        const p2 = Math.round((r.krxSaved / r.krxTotal) * 100);
        setBar($barKrx, $pctKrx, p2);
        $badgeKrx.textContent = `${r.krxSaved}/${r.krxTotal}`;
      }

      if (r.dataTotal > 0 && r.dataSaved >= 0) {
        const p3 = Math.round((r.dataSaved / r.dataTotal) * 100);
        setBar($barData, $pctData, p3);
        $badgeData.textContent = `${r.dataSaved}/${r.dataTotal}`;
      }

      return;
    }

    if(data.status==="NOT_FOUND"){
      resetAll();
      return;
    }

    const r = data.result||{};

    if(isOwner){
      if(r.progress!=null) setBar($barTotal,$pctTotal,r.progress);
      if(r.dataTotal>0){
        const ds=+r.dataSaved||0, dt=+r.dataTotal||0;
        const p = dt>0 ? Math.round(ds*100/dt) : 0;
        setBar($barData,$pctData,p);
        $badgeData.textContent = (dt>0 && ds>=dt) ? `✅ 완료 ${dt}/${dt}` : `${ds}/${dt}`;
      }
      if(r.krxTotal>0){
        const ks=+r.krxSaved||0, kt=+r.krxTotal||0;
        const p = kt>0 ? Math.round(ks*100/kt) : 0;
        setBar($barKrx,$pctKrx,p);
        $badgeKrx.textContent = (kt>0 && ks>=kt) ? `✅ 완료 ${kt}/${kt}` : `${ks}/${kt}`;
      }
      if(r.runner){
        $hint.innerHTML = `<span style="color:#2563eb;font-weight:700;">⚙️ ${r.runner}님 실행 중 (${Math.round(r.progress||0)}%)</span>`;
      }

      const logs = data.logs||[];
      if(logs.length > lastSeq){
        logs.slice(lastSeq).forEach(l => appendLog(l.line));
        lastSeq = logs.length;
      }

      if(data.status==="COMPLETED"){
        setBar($barKrx,$pctKrx,100);
        setBar($barData,$pctData,100);
        setBar($barTotal,$pctTotal,100);
        $badgeTotal.textContent="✅ 업데이트 완료";
        if(poll){clearInterval(poll); poll=null;}
        enableIdleUI();
        return;
      }
      if(data.status==="CANCELLED"){
        appendLog("⏹ 취소됨");
        if(poll){clearInterval(poll); poll=null;}
        enableIdleUI();
        return;
      }
    } else {
      if(data.status==="COMPLETED" || data.status==="CANCELLED"){
        resetAll();
        return;
      }
      disableAllUI();
    }
  }

  // ✅ 페이지 진입시 현재 상태 확인 (403 방지 포함)
  (async function bootstrap(){
    resetAll();
    const info = await safeFetchJSON(API.active());
    if(info.active && info.taskId){
      taskId = null;
      isOwner = false;
      const runner = info.runner || "알 수 없음";
      const pct = Math.round(info.progress||0);
      $hint.innerHTML = `<span style="color:#dc2626;font-weight:700;">🚫 ${runner}님 실행 중 (${pct}%)</span>`;
      disableAllUI();
      poll = setInterval(pollStatus, 800);
    } else {
      enableIdleUI();
    }
  })();

  // ✅ 시작 버튼
  $btnStart.onclick = async ()=>{
    resetAll();
    enableOwnerUI();
    const w=+$workers.value||8, f=$force.checked;
    const res = await fetch(API.start(w,f),{method:"POST", credentials:'include'}); // ✅ 쿠키포함
    if(res.status===409){
      const d = await safeFetchJSON(API.active());
      const runner = d.runner || "알 수 없음";
      const pct = Math.round(d.progress||0);
      $hint.innerHTML = `<span style="color:#dc2626;font-weight:700;">🚫 ${runner}님 실행 중 (${pct}%)</span>`;
      disableAllUI();
      poll = setInterval(pollStatus, 1000);
      return;
    }
    if(!res.ok){
      enableIdleUI();
      return;
    }
    const d=await res.json();
    taskId=d.taskId;
    isOwner=true;
    enableOwnerUI();
    poll = setInterval(pollStatus, 700);
  };

  // ✅ 취소 (소유자만)
  $btnCancel.onclick = async ()=>{
    if(!isOwner || !taskId) return;
    const res = await fetch(API.cancel(taskId),{method:"POST", credentials:'include'});
    if(res.status===403){
      appendLog("⛔ 취소 권한이 없습니다.");
      return;
    }
    appendLog("⏹ 사용자 요청으로 취소됨");
    if(poll){clearInterval(poll); poll=null;}
    enableIdleUI();
  };

  // ✅ 로그 복사
  $copy.onclick = ()=>{
    navigator.clipboard.writeText($log.textContent||"");
    const prev=$copy.textContent; $copy.textContent="✅"; setTimeout(()=>{$copy.textContent=prev;},900);
  };

})();
</script>


</th:block>

</body>
</html>
