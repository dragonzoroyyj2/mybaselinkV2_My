<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
<meta charset="UTF-8">
<title>📊 Stock Batch Dashboard</title>

<style>
  .content-container {
    width: 100%;
    max-width: 1600px;
    margin: 0 auto;
    padding: 1rem 2%;
    box-sizing: border-box;
  }
  h2 {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 0.4rem;
    color: #111827;
  }
  .card-box, .dashboard-cards, .log-wrapper {
    background: #fff;
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    margin-top: 14px;
  }
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    color: #fff;
    min-width: 110px;
    text-align: center;
  }
  .btn-start { background:#2563eb; }
  .btn-cancel { background:#dc2626; }
  .btn:disabled { opacity:0.5; cursor:not-allowed; }

  .controls {
    display:flex;
    gap:0.6rem;
    flex-wrap:wrap;
    align-items:center;
  }
  input[type=number] {
    width:90px;
    padding:0.45rem 0.6rem;
    border:1px solid #bbb;
    border-radius:6px;
  }

  .dashboard-cards {
    display:flex;
    flex-wrap:wrap;
    gap:14px;
  }
  .card {
    flex:1 1 300px;
    background:#fff;
    border-radius:12px;
    padding:16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    display:flex;
    flex-direction:column;
  }
  .card-header {
    display:flex;
    align-items:center;
    gap:6px;
    font-size:0.95rem;
    font-weight:600;
    margin-bottom:6px;
  }
  .card-header i { color:#2563eb; }
  .card-header .right {
    margin-left:auto;
    font-weight:600;
    font-size:0.9rem;
  }

  .progress-bar {
    width:100%;
    background:#e5e7eb;
    height:14px;
    border-radius:7px;
    margin-top:10px;
    overflow:hidden;
  }
  .progress-bar div { height:100%; width:0%; transition:width .3s; }
  .bar-total div { background:#2563eb; }
  .bar-krx div { background:#10b981; }
  .bar-data div { background:#f59e0b; }

  .log-wrapper h3 {
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin:0;
    font-size:1rem;
  }
  .copy-btn {
    font-size:0.9rem;
    cursor:pointer;
    user-select:none;
    margin-left:10px;
    color:#444;
    opacity:0.7;
  }
  .copy-btn:hover {
    opacity:1;
    text-decoration:none; /* 밑줄 제거 유지 */
  }

  .log-box {
    background:#111;
    color:#eee;
    font-family:Consolas, mono;
    font-size:13px;
    padding:10px;
    border-radius:10px;
    height:350px;
    overflow-y:auto;
    white-space:pre-wrap;
    margin-top:6px;
  }
</style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>📊 종목 일괄 업데이트 Dashboard</h2>
    <p>진행상황 + 실시간 로그 확인 가능</p>

    <div class="card-box">
      <div class="controls">
        <label>워커:
          <input type="number" id="workers" value="8" min="1" max="16">
        </label>
        <label><input type="checkbox" id="force"> 강제 다운로드</label>
        <button id="btnStart" class="btn btn-start">업데이트 시작</button>
        <button id="btnCancel" class="btn btn-cancel" disabled>취소</button>
      </div>
      <div id="adminHint" style="font-size:12px;color:#666;margin-top:4px;">
        ※ 관리자만 실행 가능
      </div>
    </div>

    <div class="dashboard-cards">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-layer-group"></i>전체 진행률
          <span class="right" id="badgeTotal">-</span>
        </div>
        <strong id="pctTotal">0%</strong>
        <div class="progress-bar bar-total"><div id="barTotal"></div></div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-database"></i>KRX 종목 목록
          <span class="right" id="badgeKrx"></span>
        </div>
        <strong id="pctKrx">0%</strong>
        <div class="progress-bar bar-krx"><div id="barKrx"></div></div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-chart-line"></i>개별 종목 데이터
          <span class="right" id="badgeData"></span>
        </div>
        <strong id="pctData">0%</strong>
        <div class="progress-bar bar-data"><div id="barData"></div></div>
      </div>
    </div>

    <div class="log-wrapper">
      <h3>
        실시간 로그
        <span class="copy-btn" id="copyLogBtn">📄</span>
      </h3>
      <div id="logBox" class="log-box">로그 대기중...</div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
(function(){
  const API = {
    start:(w,f)=>`/api/stock/batch/update?workers=${w}${f?"&force=true":""}`,
    status:(id)=>`/api/stock/batch/status/${id}`,
    cancel:(id)=>`/api/stock/batch/cancel/${id}`
  };

  const $workers=document.getElementById("workers"),
        $force=document.getElementById("force"),
        $btnStart=document.getElementById("btnStart"),
        $btnCancel=document.getElementById("btnCancel"),
        $barTotal=document.getElementById("barTotal"),
        $barKrx=document.getElementById("barKrx"),
        $barData=document.getElementById("barData"),
        $pctTotal=document.getElementById("pctTotal"),
        $pctKrx=document.getElementById("pctKrx"),
        $pctData=document.getElementById("pctData"),
        $badgeTotal=document.getElementById("badgeTotal"),
        $badgeKrx=document.getElementById("badgeKrx"),
        $badgeData=document.getElementById("badgeData"),
        $hint=document.getElementById("adminHint"),
        $log=document.getElementById("logBox"),
        $copy=document.getElementById("copyLogBtn");

  let taskId=null, poll=null, lastSeq=0;

  function setBar(bar,pct,val){
    const v=Math.min(100,Math.max(0,Number.isFinite(val)?Math.round(val):0));
    bar.style.width=v+"%";
    pct.textContent=v+"%";
  }

  function disableUI(dis){
    $btnStart.disabled=dis;
    $btnCancel.disabled=!dis;
    $workers.disabled=dis;
    $force.disabled=dis;
  }

  function textEscape(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  function appendLogLine(line){
    if($log.textContent.includes("대기중")) $log.textContent="";
    const clean = textEscape(line);
    $log.insertAdjacentHTML("beforeend", clean + "\n");
    $log.scrollTop = $log.scrollHeight;
  }

  function resetAll(){
    taskId=null;
    lastSeq=0;
    setBar($barTotal,$pctTotal,0);
    setBar($barKrx,$pctKrx,0);
    setBar($barData,$pctData,0);
    $badgeTotal.textContent="-";
    $badgeKrx.textContent="";
    $badgeData.textContent="";
    $hint.innerHTML="※ 관리자만 실행 가능";
    $log.textContent="로그 대기중...";
    if(poll){clearInterval(poll);poll=null;}
    disableUI(false);
  }

  function applyProgressPayload(data){
    const r = data?.result || {};
    if (r.progress != null) setBar($barTotal,$pctTotal,r.progress);

    if (r.dataTotal > 0) {
      const ds = Number(r.dataSaved || 0);
      const dt = Number(r.dataTotal || 0);
      const p = dt>0 ? Math.round((ds/dt)*100) : 0;
      setBar($barData,$pctData,p);
      $badgeData.textContent = (ds>=dt && dt>0) ? `✅ 완료 ${dt}/${dt}` : `${ds}/${dt}`;
    }

    if (r.krxTotal > 0) {
      const ks = Number(r.krxSaved || 0);
      const kt = Number(r.krxTotal || 0);
      const p = kt>0 ? Math.round((ks/kt)*100) : 0;
      setBar($barKrx,$pctKrx,p);
      $badgeKrx.textContent = (ks>=kt && kt>0) ? `✅ 완료 ${kt}/${kt}` : `${ks}/${kt}`;
    }

    if (data?.status === "COMPLETED") {
      setBar($barKrx,$pctKrx,100);
      setBar($barData,$pctData,100);
      setBar($barTotal,$pctTotal,100);
      $badgeTotal.textContent = "✅ 업데이트 완료";
      disableUI(false);
    }
  }

  async function pollStatus(){
	  if(!taskId) return;
	  try{
	    const res = await fetch(API.status(taskId));
	    const data = await res.json();

	    // ✅ 다른 사용자가 실행 중
	    if(data.status === "LOCKED"){
	      const r = data.result || {};
	      const runner = r.runner || "알 수 없음";
	      const pct = Math.round(r.progress || 0);
	      $hint.innerHTML = `<span style="color:#dc2626;font-weight:700;">🚫 ${runner}님 실행 중 (${pct}%)</span>`;
	      disableUI(true);
	      return;
	    }

	    if(data.reset === true){
	      resetAll();
	      return;
	    }

	    const r = data.result || {};
	    if(r.progress != null) setBar($barTotal, $pctTotal, r.progress);
	    if(r.dataTotal > 0){
	      const p = (r.dataSaved / r.dataTotal * 100);
	      setBar($barData, $pctData, p);
	      $badgeData.textContent = r.dataSaved >= r.dataTotal ? `✅ 완료 ${r.dataTotal}/${r.dataTotal}` : `${r.dataSaved}/${r.dataTotal}`;
	    }
	    if(r.krxTotal > 0){
	      const p2 = (r.krxSaved / r.krxTotal * 100);
	      setBar($barKrx, $pctKrx, p2);
	      $badgeKrx.textContent = r.krxSaved >= r.krxTotal ? `✅ 완료 ${r.krxTotal}/${r.krxTotal}` : `${r.krxSaved}/${r.krxTotal}`;
	    }

	    if(r.runner){
	      $hint.innerHTML = `<span style="color:#2563eb;font-weight:700;">⚙️ ${r.runner}님 실행 중 (${Math.round(r.progress||0)}%)</span>`;
	      disableUI(true);
	    }

	    if(data.status === "COMPLETED" || data.status === "CANCELLED"){
	      setBar($barTotal,$pctTotal,100);
	      $badgeTotal.textContent = "✅ 완료";
	      disableUI(false);
	      resetAll();
	    }

	    const logs = data.logs || [];
	    if(logs.length > lastSeq){
	      logs.slice(lastSeq).forEach(l => {
	        if($log.textContent.includes("표시됩니다")) $log.textContent = l.line;
	        else $log.textContent += "\n" + l.line;
	      });
	      lastSeq = logs.length;
	      $log.scrollTop = $log.scrollHeight;
	    }

	  }catch(e){
	    console.error("pollStatus error", e);
	  }
	}



  $btnStart.onclick = async () => {
	  resetAll();
	  disableUI(true);
	  const w = +$workers.value || 8;
	  const f = $force.checked;

	  try {
	    const res = await fetch(API.start(w, f), { method: "POST" });

	    // ✅ 409 (다른 사용자 실행 중) 처리 추가
	    if (res.status === 409) {
	      console.warn("다른 사용자가 이미 실행 중입니다. 상태 확인으로 전환합니다.");
	      // 바로 상태조회 호출
	      const st = await fetch(API.status("current"));
	      const data = await st.json();
	      if (data.status === "LOCKED") {
	        const r = data.result || {};
	        const runner = r.runner || "알 수 없음";
	        const pct = Math.round(r.progress || 0);
	        $hint.innerHTML = `<span style="color:#dc2626;font-weight:700;">🚫 ${runner}님 실행 중 (${pct}%)</span>`;
	      } else {
	        $hint.innerHTML = `🚫 다른 사용자가 실행 중`;
	      }
	      disableUI(true);
	      return;
	    }

	    // ✅ 기존 정상 실행 로직
	    if (!res.ok) {
	      const d = await res.json().catch(() => ({}));
	      const name = d.runner || "다른 사용자";
	      $hint.innerHTML = `🚫 ${name}님 실행 중`;
	      disableUI(true);
	      return;
	    }

	    const d = await res.json();
	    taskId = d.taskId;
	    poll = setInterval(pollStatus, 500);

	  } catch (err) {
	    console.error("업데이트 시작 중 오류", err);
	    disableUI(false);
	  }
	};


  $btnCancel.onclick = async ()=>{
    if(!taskId) return;
    try{
      await fetch(API.cancel(taskId), {
        method:"POST",
        credentials:"include"
      });
      // 취소 라인 로그창에도 남김
      appendLogLine("⏹ 사용자 요청으로 취소됨");
      // 안내줄 문구 업데이트(요청사항)
      $hint.innerHTML = `※ 관리자만 실행 가능 <span style="color:#dc2626;font-weight:700;margin-left:6px;">⏹ 취소되었습니다.</span>`;
      // 폴링 중지 및 UI 해제
      if (poll) { clearInterval(poll); poll=null; }
      disableUI(false);
      taskId = null;
    }catch(e){
      appendLogLine("취소 요청 실패");
    }
  };

  $copy.onclick = ()=>{
    const text = $log.textContent || "";
    navigator.clipboard.writeText(text).then(()=>{
      const prev = $copy.textContent;
      $copy.textContent = "✅";
      setTimeout(()=>{ $copy.textContent = prev; }, 900);
    });
  };

})();
</script>
</th:block>

</body>
</html>
