<!-- stockBatchAthenaAi.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Font Import URL */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* ë§¤ìš° ë°ì€ ë°°ê²½ */
            padding: 20px;
            min-height: 100vh; 
            color: #1e293b; /* Slate-800 */
        }
        .container {
            max-width: 1100px;
            margin: auto;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 30px;
        }
        
        /* 1. Analysis Option Cards */
        .option-card {
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-radius: 8px;
            padding: 16px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        input[type="radio"]:checked + .option-card {
            border-color: #4f46e5; 
            background-color: #eef2ff; 
            font-weight: 600;
        }

        /* 2. Table Styles (Responsive Fix and Sticky Header) */
        .results-table th, .results-table td {
            padding: 12px 16px; 
            text-align: left;
            white-space: nowrap;
            min-width: 100px;
        }
        .results-table th {
            background-color: #eef2ff;
            color: #4f46e5;
            font-weight: 700;
            cursor: default;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .results-table tbody tr {
            border-bottom: 1px solid #f1f5f9; 
            transition: background-color 0.15s;
        }
        .results-table tbody tr:hover {
            background-color: #f8fafc;
            cursor: pointer;
        }

        /* 3. Modal Styles: opacityì™€ pointer-eventsë¡œ ìƒíƒœ ê´€ë¦¬ */
        .modal-show {
            opacity: 1 !important;
            pointer-events: auto !important; /* ëª¨ë‹¬ í™œì„±í™” ì‹œ í´ë¦­ í—ˆìš© */
        }
        .modal-content {
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.3s;
            transform: scale(0.95);
            opacity: 0;
        }
        .modal-content-show {
            transform: scale(1) !important;
            opacity: 1 !important;
        }
        
        /* Canvas Responsive: ìº”ë²„ìŠ¤ëŠ” ë¶€ëª¨ ìš”ì†Œì˜ í¬ê¸°ì— ë§ì¶°ì§€ë„ë¡ ì„¤ì • */
        #stockChartCanvas {
            max-width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">ğŸ“ˆ êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ì„¤ì •</h1>
            <p class="text-gray-500">ì›í•˜ëŠ” ë¶„ì„ ì¡°ê±´ì„ ì„ íƒí•˜ê³  ì‹¤í–‰í•˜ì—¬ ìœ ë§ ì¢…ëª©ì„ ì°¾ì•„ë³´ì„¸ìš”.</p>
        </header>

        <div class="card mb-8">
            
            <div id="errorMessageContainer" class="hidden p-3 mb-6 bg-red-100 border border-red-400 text-red-700 rounded-lg font-semibold transition-all duration-300" role="alert">
                <span id="errorMessageTitle" class="font-bold mr-2"></span>
                <span id="errorMessageText"></span>
            </div>
            
            <form id="analysisForm">
                
                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-0 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('analysisTypeContent', this)">
                    <span>1. ë¶„ì„ ìœ í˜• ì„ íƒ</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="analysisTypeContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        
                        <label for="maRadio" class="block">
                            <input type="radio" name="analysisType" id="maRadio" value="ma" checked 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-indigo-500">ğŸ“‰</span> ì´ë™í‰ê· ì„ (MA) ë¶„ì„ (Default)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ì¥ê¸° í•˜ë½ì¶”ì„¸ ì§„í–‰ ì¢…ëª© íƒìƒ‰</p>
                                <div id="maPeriodsContainer" class="ml-0 mt-3 p-3 bg-indigo-100/50 rounded-lg transition-all duration-300">
                                    <h4 class="font-semibold text-indigo-700 mb-2 text-sm">MA ê¸°ê°„ ì„ íƒ (í•˜ë½ë°°ì—´ í™•ì¸):</h4>
                                    <div class="flex flex-wrap gap-x-4 gap-y-2">
                                        <input type="checkbox" name="maPeriods" value="60" id="ma60" checked class="rounded text-indigo-600"> 
                                        <label for="ma60" class="text-sm">60ì¼ì„ </label>
                                        
                                        <input type="checkbox" name="maPeriods" value="200" id="ma200" checked class="rounded text-indigo-600"> 
                                        <label for="ma200" class="text-sm">200ì¼ì„ </label>
                                        
                                        <input type="checkbox" name="maPeriods" value="500" id="ma500" checked class="rounded text-indigo-600" disabled> 
                                        <label for="ma500" id="ma500Label" class="text-sm opacity-50">500ì¼ì„ </label>
                                        <span id="ma500Hint" class="text-red-500 text-xs font-semibold">(ìµœì†Œ 3ë…„ í•„ìš”)</span>
                                    </div>
                                </div>
                            </div>
                        </label>

                        <label for="doubleBottomRadio" class="block">
                            <input type="radio" name="analysisType" id="doubleBottomRadio" value="double_bottom" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-green-500">ğŸ“ˆ</span> ì´ì¤‘ë°”ë‹¥ (Wìí˜• íŒ¨í„´)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ê°•ë ¥í•œ ì¶”ì„¸ ë°˜ì „ ì´ˆê¸° ì‹ í˜¸ íƒìƒ‰</p>
                            </div>
                        </label>

                        <label for="tripleBottomRadio" class="block">
                            <input type="radio" name="analysisType" id="tripleBottomRadio" value="triple_bottom" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-green-500">ğŸ“Š</span> ì‚¼ì¤‘ë°”ë‹¥ íŒ¨í„´
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ë°”ë‹¥ ë‹¤ì§€ê¸°ê°€ ì™„ë£Œëœ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>

                        <label for="cupAndHandleRadio" class="block">
                            <input type="radio" name="analysisType" id="cupAndHandleRadio" value="cup_and_handle" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-amber-500">â˜•</span> ì»µì•¤í•¸ë“¤ íŒ¨í„´
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ëŒíŒŒ ì§ì „ì˜ ìƒìŠ¹ ìœ ë ¥ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>
                        
                        <label for="decline5dRadio" class="block">
                            <input type="radio" name="analysisType" id="decline5dRadio" value="decline_5d" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-red-600">ğŸ”»</span> ë‹¨ê¸° ê¸‰ë½ì£¼ (5ì¼ ì—°ì† í•˜ë½)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ì¼ì£¼ì¼ê°„ ë§¤ë„ì„¸ê°€ ì§‘ì¤‘ëœ ê³¼ëŒ€ ë‚™í­ì£¼ íƒìƒ‰</p>
                            </div>
                        </label>

                        <label for="decline20dRadio" class="block">
                            <input type="radio" name="analysisType" id="decline20dRadio" value="decline_20d" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-red-700">â¬‡ï¸</span> ì¤‘ê¸° ì—°ì† í•˜ë½ (20ì¼ ì—°ì† í•˜ë½)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">í•œ ë‹¬ê°„ ëšœë ·í•œ ë°˜ë“± ì—†ì´ í•˜ë½í•œ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>
                        
                    </div>
                </div>

                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('filteringOptionsContent', this)">
                    <span>2. ì¶”ê°€ í•„í„°ë§ ì˜µì…˜</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="filteringOptionsContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-white rounded-lg border border-red-200 shadow-sm flex items-center">
                            <input type="checkbox" id="excludeNegatives" name="excludeNegatives" 
                                class="mr-3 h-5 w-5 rounded text-red-500 focus:ring-red-400 border-gray-300">
                            <label for="excludeNegatives" class="text-lg text-red-700 font-bold flex-grow">
                                ğŸš¨ ì•…ì¬ ì¢…ëª© ì œì™¸ í•„í„°
                            </label>
                        </div>
                        
                        <div class="p-4 bg-white rounded-lg border border-blue-200 shadow-sm flex items-center">
                            <span class="mr-3 text-blue-700 font-bold">ğŸ“… ë¶„ì„ ê¸°ê°„:</span>
                            <input type="number" id="dataPeriodYears" value="5" min="1" max="10" 
                                oninput="updateMaCheckboxes()"
                                class="w-16 px-3 py-1 border border-blue-300 rounded-lg text-center font-bold text-lg focus:ring-blue-500">
                            <span class="ml-2 text-blue-800 font-semibold">ë…„ì¹˜ ë°ì´í„°</span>
                        </div>
                    </div>
                </div>

                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('topNCountContent', this)">
                    <span>3. ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ ì„¤ì •</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="topNCountContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                    <div class="flex items-center bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label for="topNCount" class="text-lg text-gray-700 font-medium mr-4">ìƒìœ„ ì¢…ëª© ê°œìˆ˜ (N):</label>
                        <input type="number" id="topNCount" value="10" min="1" max="50" 
                            class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-center font-bold text-xl">
                        <span class="ml-4 text-gray-500 text-sm">1ì—ì„œ 50 ì‚¬ì´</span>
                    </div>
                </div>

            </form>
            
            <button type="button" onclick="runAnalysis()" id="runAnalysisBtn"
                    class="mt-8 w-full px-6 py-3 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                ğŸš€ ë¶„ì„ ì‹¤í–‰ ë° ìœ ë§ ì¢…ëª© ì°¾ê¸°
            </button>
            
            <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('resultsContent', this)">
                <span>4. ë¶„ì„ ê²°ê³¼</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>
            <div id="resultsContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                <div id="resultsContainer" class="relative">
                    <div id="resultsDisplay" class="p-0 bg-white min-h-[120px]">
                        </div>
    
                    <div id="loadingOverlay" class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center hidden transition-opacity duration-300 rounded-xl border-4 border-blue-400 p-8 z-20">
                        <div class="text-4xl animate-spin text-blue-600">âš™ï¸</div>
                        <p class="mt-4 text-xl font-bold text-blue-600">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
                        <p class="text-gray-500 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”. ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>

            <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('logContent', this)">
                <span>5. ì‹¤ì‹œê°„ ë¡œê·¸</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>
            <div id="logContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                <div id="logDisplay" class="h-48 bg-gray-800 text-gray-200 p-4 overflow-y-scroll rounded-xl font-mono text-sm border border-gray-700">
                    </div>
            </div>
            
        </div>
        </div>

    <div id="chartModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300 pointer-events-none">
        <div id="modalContent" class="modal-content bg-white rounded-xl p-6 sm:p-8 shadow-2xl max-w-5xl w-full h-[95vh] sm:h-[90vh] flex flex-col">
            
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b pb-3">
                <h3 id="modalTitle" class="text-xl sm:text-3xl font-bold text-indigo-700 mb-2 sm:mb-0 truncate">ì°¨íŠ¸ ìƒì„¸ ë¶„ì„</h3>
                <div class="flex space-x-2 flex-shrink-0">
                    <button onclick="simulateZoom('out')" class="px-2 py-1 sm:px-3 sm:py-1 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300 transition">
                        ğŸ” ì¶•ì†Œ
                    </button>
                    <button onclick="simulateZoom('in')" class="px-2 py-1 sm:px-3 sm:py-1 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300 transition">
                        ğŸ” í™•ëŒ€
                    </button>
                    <button onclick="closeChartModal()" class="px-3 py-1 sm:px-4 sm:py-1 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition">
                        âœ–ï¸ ë‹«ê¸°
                    </button>
                </div>
            </div>

            <div class="flex-grow overflow-hidden bg-gray-100 rounded-lg p-2">
                <canvas id="stockChartCanvas" class="w-full h-full"></canvas>
            </div>

            <div id="chartZoomInfo" class="mt-4 text-center text-gray-500 text-xs sm:text-sm">
                (í˜„ì¬: ê¸°ë³¸ ì°¨íŠ¸ ë²”ìœ„) ì°¨íŠ¸ ë°ì´í„°ëŠ” ì‹œë®¬ë ˆì´ì…˜ì´ë©° ì‹¤ì œ ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const ALL_STOCKS = [
            'ì‚¼ì„±ì „ì', 'SKí•˜ì´ë‹‰ìŠ¤', 'LGì—ì†”', 'NAVER', 'ì¹´ì¹´ì˜¤', 'í˜„ëŒ€ì°¨',
            'POSCOí™€ë”©ìŠ¤', 'KBê¸ˆìœµ', 'ì‹ í•œì§€ì£¼', 'ì…€íŠ¸ë¦¬ì˜¨', 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', 
            'HLB', 'í•˜ì´ë¸Œ', 'JYP Ent.', 'LGì „ì', 'ëŒ€í•œí•­ê³µ', 'ê¸°ì•„', 'ì—ì½”í”„ë¡œ', 'HDí˜„ëŒ€',
            'KT', 'LGí™”í•™', 'í¬ìŠ¤ì½”í“¨ì²˜ì— ', 'SKí…”ë ˆì½¤', 'ì—”ì”¨ì†Œí”„íŠ¸', 'ë„·ë§ˆë¸”', 'í¬ë˜í”„í†¤', 'HMM',
            'ì•„ì‹œì•„ë‚˜í•­ê³µ', 'í•˜ë‚˜ê¸ˆìœµì§€ì£¼', 'ìš°ë¦¬ê¸ˆìœµì§€ì£¼', 'LGë””ìŠ¤í”Œë ˆì´', 'ê¸ˆí˜¸ì„ìœ ', 'S-Oil',
            'SKì´ë…¸ë² ì´ì…˜', 'ë¡¯ë°ì¼€ë¯¸ì¹¼', 'ì‚¼ì„±SDI', 'SKC', 'LGì´ë…¸í…', 'ë§Œë„', 'í˜„ëŒ€ë¡œí…œ' 
        ];
        
        let currentChartZoomLevel = 1; 
        let currentChartData = {}; 

        // --- Dropdown Toggle Function ---
        /** ì„¹ì…˜ì„ í† ê¸€í•˜ê³  í™”ì‚´í‘œ ì•„ì´ì½˜ì˜ ë°©í–¥ì„ ë³€ê²½í•©ë‹ˆë‹¤. */
        function toggleSection(contentId, buttonElement) {
            const content = document.getElementById(contentId);
            // Find the chevron icon element (the last span child of the button)
            const chevron = buttonElement.querySelector('span:last-child');
            
            const isHidden = content.classList.contains('hidden');
            
            if (isHidden) {
                // Show content
                content.classList.remove('hidden');
                // Change icon to 'up' chevron
                chevron.textContent = 'â–´'; 
                chevron.classList.add('rotate-180');

                // 1ë²ˆ ì„¹ì…˜ì´ ì—´ë¦´ ë•Œë§Œ MA ê¸°ê°„ ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸
                if (contentId === 'analysisTypeContent') {
                     toggleMaPeriods(true);
                }
            } else {
                // Hide content
                content.classList.add('hidden');
                // Change icon to 'down' chevron
                chevron.textContent = 'â–¾';
                chevron.classList.remove('rotate-180');

                // 1ë²ˆ ì„¹ì…˜ì´ ë‹«í ë•Œ MA ê¸°ê°„ ì»¨í…Œì´ë„ˆë„ ìˆ¨ê¹€
                if (contentId === 'analysisTypeContent') {
                     toggleMaPeriods(false);
                }
            }
        }
        
        /** ì„¹ì…˜ì„ ê°•ì œë¡œ ì—¬ëŠ” í•¨ìˆ˜. (ë¶„ì„ ì‹¤í–‰ ì‹œ í•„ìš”) */
        function forceOpenSection(contentId) {
            const content = document.getElementById(contentId);
            // Assuming the button is the sibling before the content div
            const button = content.previousElementSibling; 
            if (content.classList.contains('hidden')) {
                toggleSection(contentId, button);
            }
        }


        // --- Log Update Function (Critical for Auto-Scrolling) ---
        /** ì‹¤ì‹œê°„ ë¡œê·¸ì°½ì— ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ê³  ìŠ¤í¬ë¡¤ì„ ëê¹Œì§€ ë‚´ë¦½ë‹ˆë‹¤. */
        function updateLog(message) {
            const logDisplay = document.getElementById('logDisplay');
            const logEntry = document.createElement('div');
            
            // ìŠ¤íƒ€ì¼ë§: ì‹œê°„ ì •ë³´ëŠ” íšŒìƒ‰, ë©”ì‹œì§€ëŠ” ë°ì€ ë…¹ìƒ‰
            const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            logEntry.innerHTML = `<span class="text-gray-500">[${time}]</span> <span class="text-green-400">${message}</span>`;
            
            // ì˜¤ë˜ëœ ë¡œê·¸ ì œê±° (ì„±ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ 100ì¤„ ì œí•œ)
            if (logDisplay.children.length > 100) {
                logDisplay.removeChild(logDisplay.firstChild);
            }

            logDisplay.appendChild(logEntry);
            
            // ** ìë™ ìŠ¤í¬ë¡¤ ** (ë¡œê·¸ì°½ì´ ëê¹Œì§€ ë‚´ë ¤ê°€ë„ë¡ ë³´ì¥)
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }

        /** ì•Œë¦¼ ë©”ì‹œì§€ ëª¨ë‹¬ (Alert Modal)ì„ í‘œì‹œí•©ë‹ˆë‹¤. (alert() ê¸ˆì§€ ê·œì¹™ ì¤€ìˆ˜) */
        function alertModal(message, title) {
            const container = document.getElementById('errorMessageContainer');
            const titleEl = document.getElementById('errorMessageTitle');
            const textEl = document.getElementById('errorMessageText');

            titleEl.textContent = title + (title ? ':' : '');
            textEl.textContent = message;
            container.classList.remove('hidden');
            console.error(`[${title}] ${message}`); // ì½˜ì†” ë¡œê¹…

            // 5ì´ˆ í›„ ë©”ì‹œì§€ ìë™ ìˆ¨ê¹€
            setTimeout(() => {
                container.classList.add('hidden');
            }, 5000);
        }

        // --- MA Checkbox Update Logic ---
        function updateMaCheckboxes() {
            const dataPeriodInput = document.getElementById('dataPeriodYears');
            const dataPeriod = parseInt(dataPeriodInput.value, 10);
            
            const ma500 = document.getElementById('ma500');
            const ma500Label = document.getElementById('ma500Label');
            const ma500Hint = document.getElementById('ma500Hint');

            if (dataPeriod < 3) {
                ma500.checked = false;
                ma500.disabled = true;
                ma500Label.classList.add('opacity-50');
                ma500Hint.textContent = `(ìµœì†Œ 3ë…„ í•„ìš”)`;
            } else {
                ma500.disabled = false;
                ma500Label.classList.remove('opacity-50');
                ma500Hint.textContent = '';
                if (document.getElementById('maRadio').checked) {
                     ma500.checked = true; // 3ë…„ ì´ìƒì´ë©´ ìë™ìœ¼ë¡œ ì²´í¬
                }
            }
        }

        function toggleMaPeriods(forceOpen) {
            const maPeriodsContainer = document.getElementById('maPeriodsContainer');
            const maRadio = document.getElementById('maRadio');
            
            // 1ë²ˆ ì„¹ì…˜ì´ ë‹«í˜€ ìˆì„ ë•ŒëŠ” ë¬´ì¡°ê±´ ìˆ¨ê¹€
            const section1Content = document.getElementById('analysisTypeContent');
            if (section1Content && section1Content.classList.contains('hidden')) {
                maPeriodsContainer.style.display = 'none';
                return;
            }

            // forceOpenì´ ëª…ì‹œë˜ì§€ ì•Šì€ ê²½ìš°, ë¼ë””ì˜¤ ë²„íŠ¼ ìƒíƒœì— ë”°ë¼ í† ê¸€
            if (maRadio.checked) {
                maPeriodsContainer.style.display = 'block';
                updateMaCheckboxes(); 
            } else {
                maPeriodsContainer.style.display = 'none';
            }
        }


        // --- New: AI Analysis Service (Simulating athena_k_market_ai.py) ---
        
        /**
         * ì„ íƒëœ íŒ¨í„´ì„ ê¸°ë°˜ìœ¼ë¡œ Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹œì¥ ë¶„ì„ í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
         * ì´ í•¨ìˆ˜ëŠ” athena_k_market_ai.py ë°±ì—”ë“œ ë¡œì§ì˜ ì‹¤í–‰ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.
         * @param {Object} options - ë¶„ì„ ì˜µì…˜
         * @returns {Promise<{analysisText: string, error: string | null}>}
         */
        async function fetchAIAnalysis(options) {
            // [ì—…ë°ì´íŠ¸] ìƒˆë¡œìš´ íŒ¨í„´ ì¶”ê°€
            const analysisTypeMap = {
                'ma': 'ì¥ê¸° ì´ë™í‰ê· ì„ (MA) í•˜ë½ë°°ì—´ íŒ¨í„´',
                'double_bottom': 'ê°•ë ¥í•œ ì´ì¤‘ë°”ë‹¥ (Wìí˜•) ë°˜ì „ íŒ¨í„´',
                'triple_bottom': 'ì‚¼ì¤‘ë°”ë‹¥ ë‹¤ì§€ê¸° íŒ¨í„´',
                'cup_and_handle': 'ì»µì•¤í•¸ë“¤ ìƒìŠ¹ ëŒíŒŒ íŒ¨í„´',
                'decline_5d': '5ì¼ ì—°ì† ì¢…ê°€ í•˜ë½ (ë‹¨ê¸° ê¸‰ë½ì£¼) íŒ¨í„´', // <-- ì¶”ê°€
                'decline_20d': '20ì¼ ì—°ì† ì¢…ê°€ í•˜ë½ (ì¤‘ê¸° í•˜ë½ ëª¨ë©˜í…€) íŒ¨í„´', // <-- ì¶”ê°€
            };
            
            const analysisTitle = analysisTypeMap[options.analysisType] || 'ì¼ë°˜ ê¸°ìˆ ì  ë¶„ì„ íŒ¨í„´';
            let maDetails = '';
            if (options.analysisType === 'ma' && options.maPeriods.length > 0) {
                maDetails = `(ê¸°ê°„: ${options.maPeriods.join(',')}ì¼ì„ )`;
            }

            const systemPrompt = `ë‹¹ì‹ ì€ í•œêµ­ ì£¼ì‹ ì‹œì¥ì˜ ê¸°ìˆ ì  ë¶„ì„ì„ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” AI ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ìš”ì²­í•œ '${analysisTitle}' íŒ¨í„´ê³¼ ê´€ë ¨ëœ ì‹œì¥ ë™í–¥, ê·¸ë¦¬ê³  ì´ íŒ¨í„´ì´ í˜„ì¬ ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥ì— ì‹œì‚¬í•˜ëŠ” ë°”ë¥¼ ì „ë¬¸ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬, ìƒìœ„ 3~5ê°œ ì¢…ëª©ì„ ì–¸ê¸‰í•˜ë©° ê°„ê²°í•œ ë¶„ì„ ë³´ê³ ì„œ(ìµœì†Œ 3ë¬¸ë‹¨)ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`;
            const userQuery = `${options.dataPeriod}ë…„ì¹˜ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ '${analysisTitle}' ${maDetails} íŒ¨í„´ì´ ê°•í•˜ê²Œ í¬ì°©ë˜ëŠ” í•œêµ­ ì‹œì¥ ì¢…ëª©êµ° ë° ì‹œì¥ ì „ì²´ì˜ ì ì¬ì  ìœ„í—˜/ê¸°íšŒë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”. ì•…ì¬ ì¢…ëª© ì œì™¸ í•„í„°ë§: ${options.excludeNegatives ? 'ì ìš©ë¨' : 'ë¯¸ì ìš©'}`;

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
                config: { language: 'ko' }
            };
            
            let attempt = 0;
            const maxAttempts = 5;

            while (attempt < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxAttempts - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempt++;
                            continue; 
                        }
                        return { analysisText: '', error: `API ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${response.statusText}` };
                    }

                    const result = await response.json();
                    const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text || 'ë¶„ì„ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                    return { analysisText, error: null };

                } catch (e) {
                    console.error("AI API í˜¸ì¶œ ì˜¤ë¥˜:", e);
                    return { analysisText: '', error: `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì‘ë‹µ ì²˜ë¦¬ ì˜¤ë¥˜: ${e.message}` };
                }
            }
            return { analysisText: '', error: 'API ìš”ì²­ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼.' };
        }
        
        /**
         * AI ë¶„ì„ í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª¨ì˜ ì£¼ì‹ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì—¬ í…Œì´ë¸”ì— í‘œì‹œí•  ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤.
         * @param {string} analysisText - AIê°€ ìƒì„±í•œ ë¶„ì„ ë³´ê³ ì„œ í…ìŠ¤íŠ¸
         * @param {Object} options - ë¶„ì„ ì˜µì…˜
         * @returns {Object} ë Œë”ë§ ê°€ëŠ¥í•œ ê²°ê³¼ ê°ì²´
         */
        function mapAITextToSimulatedStocks(analysisText, options) {
            // AI í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ ì¢…ëª© ëª©ë¡ì„ ê²°ì •í•©ë‹ˆë‹¤.
            // ì‹¤ì œ ì‹œìŠ¤í…œì—ì„œëŠ” AIê°€ ì§ì ‘ ì¢…ëª© ì½”ë“œë¥¼ ë°˜í™˜í•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” í…ìŠ¤íŠ¸ì—ì„œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ì—¬ ëª¨ì˜ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            
            let stockNames = [];
            // ë¶„ì„ í…ìŠ¤íŠ¸ì—ì„œ ì¢…ëª©ëª…ì„ ì¶”ì¶œí•˜ê±°ë‚˜, ê¸°ë³¸ ëª©ë¡ì—ì„œ ëœë¤í•˜ê²Œ ì„ íƒ
            const mentionedStocks = ['ì‚¼ì„±ì „ì', 'SKí•˜ì´ë‹‰ìŠ¤', 'ì¹´ì¹´ì˜¤', 'NAVER', 'í˜„ëŒ€ì°¨', 'LGì—ì†”'];
            
            // AI í…ìŠ¤íŠ¸ì˜ ê¸¸ì´ì— ë”°ë¼ ì‹ ë¢°ë„ ì ìˆ˜ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
            const baseConfidence = Math.min(100, 50 + analysisText.length / 50); 

            // íŒ¨í„´ë³„ë¡œ ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•˜ì—¬ ìˆœìœ„ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
            let potentialStocks = ALL_STOCKS.slice(0, 20); // ìƒìœ„ 20ê°œë§Œ ê³ ë ¤ (ëœë¤ì„± ì¤„ì„)
            
            // AI ì–¸ê¸‰ ì¢…ëª©ì´ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§€ë„ë¡ í•©ë‹ˆë‹¤.
            const finalStocks = potentialStocks.filter(name => mentionedStocks.includes(name));
            const otherStocks = potentialStocks.filter(name => !mentionedStocks.includes(name));
            
            // ì–¸ê¸‰ëœ ì¢…ëª©ì— ë†’ì€ ì ìˆ˜ ë¶€ì—¬
            let topStocks = finalStocks.map(name => ({
                name,
                score: baseConfidence + Math.random() * 20,
                isMentioned: true
            }));

            // ë‚˜ë¨¸ì§€ ì¢…ëª©ì— ê¸°ë³¸ ì ìˆ˜ ë¶€ì—¬
            topStocks = topStocks.concat(otherStocks.map(name => ({
                name,
                score: 50 + Math.random() * 30,
                isMentioned: false
            })));

            topStocks.sort((a, b) => b.score - a.score);
            let winningStocks = topStocks.slice(0, options.topNCount);


            let stocksResult = winningStocks.map((stock, index) => {
                let reason, statusText;
                let isPositive = stock.score > 75; 
                let analysisTitle = options.analysisType;

                if (analysisTitle === 'ma') {
                    reason = `MA(${options.maPeriods.join(',')}) í•˜ë½ë°°ì—´ ê°•ë„ ${stock.score.toFixed(2)}ì `;
                    statusText = 'ê°•í•œ í•˜ë½ì¶”ì„¸';
                    isPositive = stock.score > 80; // MAëŠ” ì ìˆ˜ê°€ ë†’ì„ìˆ˜ë¡ í•˜ë½ ê°•ë„ê°€ ì…ˆ
                } else if (analysisTitle === 'decline_5d' || analysisTitle === 'decline_20d') { // <-- ì—°ì† í•˜ë½ ë¡œì§
                    const days = analysisTitle === 'decline_5d' ? 5 : 20;
                    reason = `${days}ì¼ ì—°ì† í•˜ë½ ëª¨ë©˜í…€ ê°•ë„ ${stock.score.toFixed(2)}ì `;
                    statusText = 'ë‹¨ê¸°/ì¤‘ê¸° ê¸‰ë½ í¬ì°©';
                    isPositive = false; // ì—°ì† í•˜ë½ì€ ê¸°ë³¸ì ìœ¼ë¡œ ë¶€ì •ì  ì‹ í˜¸
                } else {
                    const analysisTitleMap = {
                        'double_bottom': 'ì´ì¤‘ë°”ë‹¥', 'triple_bottom': 'ì‚¼ì¤‘ë°”ë‹¥', 'cup_and_handle': 'ì»µì•¤í•¸ë“¤'
                    };
                    reason = `${analysisTitleMap[analysisTitle] || 'íŒ¨í„´'} ì í•©ë„ ${stock.score.toFixed(2)}ì `;
                    statusText = stock.isMentioned ? 'AI ì£¼ìš” ì–¸ê¸‰ ì¢…ëª©' : 'íŒ¨í„´ í¬ì°© ì‹ í˜¸';
                    isPositive = stock.score > 80;
                }

                return {
                    rank: index + 1,
                    name: stock.name,
                    score: stock.score,
                    isPositive: isPositive,
                    reason: reason,
                    statusText: statusText,
                    period: options.dataPeriod
                };
            });

            const analysisTitleMap = {
                'ma': 'ì¥ê¸° í•˜ë½ì¶”ì„¸ í™•ì¸ ì¢…ëª©',
                'double_bottom': 'ì´ì¤‘ë°”ë‹¥ íŒ¨í„´ ìœ ë§ ì¢…ëª©',
                'triple_bottom': 'ì‚¼ì¤‘ë°”ë‹¥ íŒ¨í„´ ìœ ë§ ì¢…ëª©',
                'cup_and_handle': 'ì»µì•¤í•¸ë“¤ íŒ¨í„´ ìœ ë§ ì¢…ëª©',
                'decline_5d': '5ì¼ ì—°ì† í•˜ë½ ì¢…ëª© (ë‹¨ê¸° ê¸‰ë½ì£¼)', // <-- ì¶”ê°€
                'decline_20d': '20ì¼ ì—°ì† í•˜ë½ ì¢…ëª© (ì¤‘ê¸° í•˜ë½ ì§€ì†)', // <-- ì¶”ê°€
            };

            return {
                title: analysisTitleMap[options.analysisType] || 'AI ì¢…í•© ë¶„ì„ ê²°ê³¼',
                description: analysisText, // AI í…ìŠ¤íŠ¸ë¥¼ ì„¤ëª… í•„ë“œì— ë„£ì–´ ê²°ê³¼ ì˜ì—­ì— í‘œì‹œ
                excludeNegatives: options.excludeNegatives,
                stocks: stocksResult,
                topNRequested: options.topNCount,
                isDowntrendSearch: options.analysisType === 'ma' || options.analysisType.startsWith('decline_'), // <-- í•˜ë½ ì¡°ê±´ ì¶”ê°€
            };
        }
        
        // --- Analysis Execution Logic ---

        async function runAnalysis() { // í•¨ìˆ˜ë¥¼ asyncë¡œ ë³€ê²½
            const runAnalysisBtn = document.getElementById('runAnalysisBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // 1. ì˜µì…˜ ìˆ˜ì§‘ ë° ìœ íš¨ì„± ê²€ì‚¬ (ì´ì „ê³¼ ë™ì¼)
            const analysisType = document.querySelector('input[name="analysisType"]:checked').value;
            const excludeNegatives = document.getElementById('excludeNegatives').checked;
            
            const dataPeriodInput = document.getElementById('dataPeriodYears');
            const dataPeriod = parseInt(dataPeriodInput.value, 10);
            if (isNaN(dataPeriod) || dataPeriod < 1 || dataPeriod > 10) {
                alertModal("ë¶„ì„ ë°ì´í„° ê¸°ê°„ì€ 1ë…„ì—ì„œ 10ë…„ ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.", "ì…ë ¥ ì˜¤ë¥˜");
                dataPeriodInput.focus();
                return;
            }

            const topNCountInput = document.getElementById('topNCount');
            const topNCount = parseInt(topNCountInput.value, 10);
            if (isNaN(topNCount) || topNCount < 1 || topNCount > ALL_STOCKS.length) { 
                alertModal(`ìƒìœ„ ì¢…ëª© ê°œìˆ˜(N)ëŠ” 1ì—ì„œ ${ALL_STOCKS.length} ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.`, "ì…ë ¥ ì˜¤ë¥˜");
                topNCountInput.focus();
                return;
            }

            let maPeriods = [];
            if (analysisType === 'ma') {
                const maCheckboxes = document.querySelectorAll('input[name="maPeriods"]:checked:not(:disabled)');
                maPeriods = Array.from(maCheckboxes).map(cb => cb.value);
                if (maPeriods.length === 0) {
                    alertModal("MA ë¶„ì„ì„ ì„ íƒí–ˆì§€ë§Œ, ì„ íƒëœ ì´ë™í‰ê· ì„  ê¸°ê°„ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "ê²½ê³ ");
                    return;
                }
            }
            
            // ë¶„ì„ ì˜µì…˜ ê°ì²´
            const analysisOptions = { analysisType, excludeNegatives, dataPeriod, topNCount, maPeriods };

            // 2. UI ë³€ê²½ ë° ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
            runAnalysisBtn.disabled = true;
            runAnalysisBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            runAnalysisBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            runAnalysisBtn.textContent = `â±ï¸ AI ë¶„ì„ ì‹¤í–‰ ì¤‘...`;

            forceOpenSection('resultsContent');
            forceOpenSection('logContent');

            loadingOverlay.classList.remove('hidden');
            document.getElementById('resultsDisplay').innerHTML = ''; 
            
            document.getElementById('logDisplay').innerHTML = '';
            updateLog(`[Controller] ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. (ìœ í˜•: ${analysisType.toUpperCase()}, ê¸°ê°„: ${dataPeriod}ë…„)`);
            updateLog(`[Service] athena_k_market_ai.py (AI ì—”ì§„) í˜¸ì¶œ ì‹œì‘...`);

            // 3. AI ë¶„ì„ (athena_k_market_ai.py ì‹¤í–‰ ì‹œë®¬ë ˆì´ì…˜)
            const aiResult = await fetchAIAnalysis(analysisOptions)
            
            // 4. ê²°ê³¼ ì²˜ë¦¬ (ì´ì–´ì„œ ì‘ì„±)
            updateLog(`[Service] AI ë¶„ì„ ì™„ë£Œ. (ì˜¤ë¥˜: ${aiResult.error ? aiResult.error : 'ì—†ìŒ'})`);

            if (aiResult.error) {
                alertModal(`AI ë¶„ì„ ì‹¤íŒ¨: ${aiResult.error}`, "AI ì˜¤ë¥˜");
                loadingOverlay.classList.add('hidden');
                runAnalysisBtn.disabled = false;
                runAnalysisBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                runAnalysisBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                runAnalysisBtn.textContent = `ğŸš€ ë¶„ì„ ì‹¤í–‰ ë° ìœ ë§ ì¢…ëª© ì°¾ê¸°`;
                return;
            }

            // 5. ëª¨ì˜ ë°ì´í„° ìƒì„± ë° í…Œì´ë¸” ë Œë”ë§
            const finalResults = mapAITextToSimulatedStocks(aiResult.analysisText, analysisOptions);
            renderResultsTable(finalResults);
            
            // 6. UI ë³µì› ë° ìµœì¢… ë¡œê·¸
            loadingOverlay.classList.add('hidden');
            runAnalysisBtn.disabled = false;
            runAnalysisBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            runAnalysisBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            runAnalysisBtn.textContent = `âœ… ë¶„ì„ ì™„ë£Œ (ì´ ${finalResults.stocks.length} ì¢…ëª© í¬ì°©)`;
            updateLog(`[Controller] ìµœì¢… ê²°ê³¼ ${finalResults.stocks.length}ê°œ ì¢…ëª© í¬ì°©. í™”ë©´ì— í‘œì‹œ ì™„ë£Œ.`);
        }
        
        // --- Rendering Logic (Placeholder for full render implementation) ---
        function renderResultsTable(results) {
            const container = document.getElementById('resultsDisplay');
            if (!container) return;

            let tableRows = results.stocks.map(stock => {
                const badgeColor = stock.isPositive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                return `
                    <tr onclick="openChartModal('${stock.name}', '${stock.rank}')">
                        <td class="font-bold text-center">${stock.rank}</td>
                        <td class="font-bold text-gray-800">${stock.name}</td>
                        <td>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${badgeColor}">
                                ${stock.isPositive ? 'ê°•ë ¥ ì‹ í˜¸' : stock.statusText}
                            </span>
                        </td>
                        <td>${stock.reason}</td>
                    </tr>
                `;
            }).join('');

            const tableHtml = `
                <div class="mb-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                    <h5 class="text-xl font-bold text-indigo-700 mb-2">${results.title}</h5>
                    <p class="text-sm text-gray-600 whitespace-pre-wrap">${results.description.slice(0, 300)}...</p>
                    <p class="text-xs text-gray-500 mt-2">(${results.topNRequested}ê°œ í‘œì‹œë¨. ì•…ì¬ ì œì™¸ í•„í„°: ${results.excludeNegatives ? 'ON' : 'OFF'})</p>
                </div>
                <div class="overflow-x-auto max-h-[500px]">
                    <table class="w-full results-table border-collapse">
                        <thead>
                            <tr>
                                <th class="text-center">ìˆœìœ„</th>
                                <th>ì¢…ëª©ëª…</th>
                                <th>ìƒíƒœ</th>
                                <th>íŒ¨í„´ ì í•© ì‚¬ìœ  (ì ìˆ˜)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }

        function renderInitialState() {
             const container = document.getElementById('resultsDisplay');
             container.innerHTML = `
                <div class="p-6 text-center text-gray-500 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                    <p class="text-xl font-semibold mb-2">ë¶„ì„ ëŒ€ê¸° ì¤‘</p>
                    <p>ìƒë‹¨ì˜ ì„¤ì •ì„ í™•ì¸í•˜ê³  [ë¶„ì„ ì‹¤í–‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                </div>
            `;
        }


        // --- Chart Modal Logic ---
        function openChartModal(stockName, rank) {
            const modal = document.getElementById('chartModal');
            const modalContent = document.getElementById('modalContent');
            document.getElementById('modalTitle').textContent = `[${rank}ìœ„] ${stockName} ìƒì„¸ ì°¨íŠ¸ ë¶„ì„`;

            modal.classList.add('modal-show');
            modalContent.classList.add('modal-content-show');
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” (ì‹œë®¬ë ˆì´ì…˜)
            const canvas = document.getElementById('stockChartCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '24px Arial';
            ctx.fillStyle = '#1e293b';
            ctx.textAlign = 'center';
            ctx.fillText(`${stockName} ì°¨íŠ¸ ë¡œë”©... (ì‹œë®¬ë ˆì´ì…˜)`, canvas.width / 2, canvas.height / 2);
            
            currentChartZoomLevel = 1;
            document.getElementById('chartZoomInfo').textContent = `(${stockName}ì˜ ê¸°ë³¸ ì°¨íŠ¸ ë²”ìœ„) ì°¨íŠ¸ ë°ì´í„°ëŠ” ì‹œë®¬ë ˆì´ì…˜ì´ë©° ì‹¤ì œ ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
        }

        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            const modalContent = document.getElementById('modalContent');

            modal.classList.remove('modal-show');
            modalContent.classList.remove('modal-content-show');
        }

        function simulateZoom(direction) {
            if (direction === 'in') currentChartZoomLevel = Math.min(3, currentChartZoomLevel + 0.5);
            else currentChartZoomLevel = Math.max(0.5, currentChartZoomLevel - 0.5);
            
            document.getElementById('chartZoomInfo').textContent = `(í˜„ì¬: ${currentChartZoomLevel.toFixed(1)}x í™•ëŒ€) ì°¨íŠ¸ ë°ì´í„°ëŠ” ì‹œë®¬ë ˆì´ì…˜ì´ë©° ì‹¤ì œ ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            renderInitialState();
            toggleSection('analysisTypeContent', document.querySelector('#analysisTypeContent').previousElementSibling);
            updateMaCheckboxes(); 
        });
    </script>
</body>
</html>