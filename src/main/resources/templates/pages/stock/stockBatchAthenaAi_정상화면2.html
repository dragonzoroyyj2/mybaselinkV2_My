<!-- stockBatchAthenaA.html -->
<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š AthenaAI ë°°ì¹˜ ì—…ë°ì´íŠ¸</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Font Import URL */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
    <!-- Chart.js and Adapter for Time Series -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
      :root {
        --main-bg: #f3f4f6;
        --card-bg: #ffffff;
        --text-color-primary: #111827;
        --text-color-secondary: #6b7280;
        --border-color-default: #d1d5db;
        --input-bg: #ffffff;
        --progress-bar-bg: #e5e7eb;
        --log-box-bg: #111; 
        --log-text-default: #e0e0e0;
        --log-text-info: #9ca3af;
        --log-text-progress: #60a5fa;
        --log-text-warning: #f59e0b;
        --log-text-error: #ef4444;
        --log-text-complete: #22c55e;
        --card-border: #d1d5db;
        --error-card-bg: #fff;
        --error-card-border: #e5e7eb;
        --error-card-text: #374151;
        --error-card-hover: #fee2e2;
        --error-card-header: #b91c1c;
      }
      /* Dark mode styles would go here if needed */

      .global-status-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 14px 18px;
        margin-bottom: 12px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
      }
      .global-status-header {
        font-weight: 600;
        color: var(--text-color-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1rem;
      }
      .global-status-body {
        font-size: .9rem;
        color: var(--text-color-secondary);
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
      }
      .global-status-progress {
        width: 100%;
        height: 10px;
        background: var(--progress-bar-bg);
        border-radius: 6px;
        overflow: hidden;
        margin-top: 8px;
      }
      .global-status-progress div {
        height: 100%;
        width: 0%;
        background: #2563eb;
        transition: width .25s;
      }
      .status-idle{color:#6b7280;}
      .status-running{color:#2563eb;}
      .status-completed{color:#22c55e;}
      .status-failed,.status-timeout{color:#ef4444;}
      .status-cancelled{color:#f59e0b;}
      @keyframes blink {0%,100%{opacity:1}50%{opacity:.35}}
      .blinking{animation:blink 1.2s infinite;}

      /* ì·¨ì†Œ ë²„íŠ¼ ìœ„ì¹˜ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
      .run-controls-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75rem; /* Tailwind: gap-3 */
        margin-top: 2rem; /* Tailwind: mt-8 */
      }
      
      /* Option Card Styles */
      .option-card {
        @apply p-4 rounded-xl border border-gray-200 shadow-md transition duration-150 cursor-pointer;
      }
      input[type="radio"]:checked + .option-card {
        @apply border-indigo-500 bg-indigo-50 shadow-lg;
      }

      /* Modal and Chart Styles */
      #chartModal.active {
          opacity: 1;
          pointer-events: auto;
      }
      .modal-content {
          transform: scale(0.9);
          opacity: 0;
          transition: all 0.3s ease-out;
      }
      #chartModal.active .modal-content {
          transform: scale(1);
          opacity: 1;
      }
    </style>
</head>
<body>


<div layout:fragment="content">
  <div class="content-container">

    <div class="page-header">
      <div class="page-title">
        <h2 th:text="${pageTitle} ?: 'ğŸ“„ êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜'">ğŸ“„ êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜</h2>
      </div>
      <div class="breadcrumb">
        <i class="fas fa-folder-open"></i>
        <span th:text="${breadcrumb} ?: 'ì‹œìŠ¤í…œ / ë¶„ì„ ë„êµ¬ (AthenaAi)'">ì‹œìŠ¤í…œ / ë¶„ì„ ë„êµ¬ (AthenaAi)</span>
      </div>
    </div>

    <div class="global-status-card">
        <div class="global-status-header">
          ğŸŒ AthenaAI ë°°ì¹˜ ì§„í–‰ ìƒíƒœ
          <span id="globalStatusText" class="status-idle">ëŒ€ê¸°ì¤‘</span>
        </div>
        <div class="global-status-body">
          <div>ì‹¤í–‰ì: <span id="globalRunner">ë¯¸ì—°ê²°</span></div>
          <div>ì „ì²´ ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div>
        </div>
        <div class="global-status-progress"><div id="globalProgressBar"></div></div>
    </div>
    <div class="card mb-8">
            
            <div id="errorMessageContainer" class="hidden p-3 mb-6 bg-red-100 border border-red-400 text-red-700 rounded-lg font-semibold transition-all duration-300" role="alert">
                <span id="errorMessageTitle" class="font-bold mr-2"></span>
                <span id="errorMessageText"></span>
            </div>
            
            <form id="analysisForm">
                
                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-0 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('analysisTypeContent', this)">
                    <span>1. ë¶„ì„ ìœ í˜• ì„ íƒ</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="analysisTypeContent" class="pb-4 transition-all duration-300 ease-in-out">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        
                        <label for="maRadio" class="block">
                            <input type="radio" name="analysisType" id="maRadio" value="ma" checked 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-indigo-500">ğŸ“‰</span> ì´ë™í‰ê· ì„ (MA) ë¶„ì„ (Default)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ì¥ê¸° í•˜ë½ì¶”ì„¸ ì§„í–‰ ì¢…ëª© íƒìƒ‰</p>
                                <div id="maPeriodsContainer" class="ml-0 mt-3 p-3 bg-indigo-100/50 rounded-lg transition-all duration-300">
                                    <h4 class="font-semibold text-indigo-700 mb-2 text-sm">MA ê¸°ê°„ ì„ íƒ (í•˜ë½ë°°ì—´ í™•ì¸):</h4>
                                    <div class="flex flex-wrap gap-x-4 gap-y-2">
                                        <input type="checkbox" name="maPeriods" value="60" id="ma60" checked class="rounded text-indigo-600"> 
                                        <label for="ma60" class="text-sm">60ì¼ì„ </label>
                                        
                                        <input type="checkbox" name="maPeriods" value="200" id="ma200" checked class="rounded text-indigo-600"> 
                                        <label for="ma200" class="text-sm">200ì¼ì„ </label>
                                        
                                        <input type="checkbox" name="maPeriods" value="500" id="ma500" checked class="rounded text-indigo-600" disabled> 
                                        <label for="ma500" id="ma500Label" class="text-sm opacity-50">500ì¼ì„ </label>
                                        <span id="ma500Hint" class="text-red-500 text-xs font-semibold">(ìµœì†Œ 3ë…„ í•„ìš”)</span>
                                    </div>
                                </div>
                            </div>
                        </label>

                        <label for="doubleBottomRadio" class="block">
                            <input type="radio" name="analysisType" id="doubleBottomRadio" value="double_bottom" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-green-500">ğŸ“ˆ</span> ì´ì¤‘ë°”ë‹¥ (Wìí˜• íŒ¨í„´)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ê°•ë ¥í•œ ì¶”ì„¸ ë°˜ì „ ì´ˆê¸° ì‹ í˜¸ íƒìƒ‰</p>
                            </div>
                        </label>

                        <label for="tripleBottomRadio" class="block">
                            <input type="radio" name="analysisType" id="tripleBottomRadio" value="triple_bottom" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-green-500">ğŸ“Š</span> ì‚¼ì¤‘ë°”ë‹¥ íŒ¨í„´
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ë°”ë‹¥ ë‹¤ì§€ê¸°ê°€ ì™„ë£Œëœ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>

                        <label for="cupAndHandleRadio" class="block">
                            <input type="radio" name="analysisType" id="cupAndHandleRadio" value="cup_and_handle" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-amber-500">â˜•</span> ì»µì•¤í•¸ë“¤ íŒ¨í„´
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ëŒíŒŒ ì§ì „ì˜ ìƒìŠ¹ ìœ ë ¥ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>
                        
                        <label for="decline5dRadio" class="block">
                            <input type="radio" name="analysisType" id="decline5dRadio" value="decline_5d" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-red-600">ğŸ”»</span> ë‹¨ê¸° ê¸‰ë½ì£¼ (5ì¼ ì—°ì† í•˜ë½)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ì¼ì£¼ì¼ê°„ ë§¤ë„ì„¸ê°€ ì§‘ì¤‘ëœ ê³¼ëŒ€ ë‚™í­ì£¼ íƒìƒ‰</p>
                            </div>
                        </label>

                        <label for="decline20dRadio" class="block">
                            <input type="radio" name="analysisType" id="decline20dRadio" value="decline_20d" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-red-700">â¬‡ï¸</span> ì¤‘ê¸° ì—°ì† í•˜ë½ (20ì¼ ì—°ì† í•˜ë½)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">í•œ ë‹¬ê°„ ëšœë ·í•œ ë°˜ë“± ì—†ì´ í•˜ë½í•œ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>
                        
                    </div>
                </div>

                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('filteringOptionsContent', this)">
                    <span>2. ì¶”ê°€ í•„í„°ë§ ì˜µì…˜</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="filteringOptionsContent" class="pb-4 transition-all duration-300 ease-in-out">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-white rounded-lg border border-red-200 shadow-sm flex items-center">
                            <input type="checkbox" id="excludeNegatives" name="excludeNegatives" checked
                                class="mr-3 h-5 w-5 rounded text-red-500 focus:ring-red-400 border-gray-300">
                            <label for="excludeNegatives" class="text-lg text-red-700 font-bold flex-grow">
                                ğŸš¨ ì•…ì¬ ì¢…ëª© ì œì™¸ í•„í„°
                            </label>
                        </div>
                        
                        <div class="p-4 bg-white rounded-lg border border-blue-200 shadow-sm flex items-center">
                            <span class="mr-3 text-blue-700 font-bold">ğŸ“… ë¶„ì„ ê¸°ê°„:</span>
                            <input type="number" id="dataPeriodYears" value="5" min="1" max="10" 
                                oninput="updateMaCheckboxes()"
                                class="w-16 px-3 py-1 border border-blue-300 rounded-lg text-center font-bold text-lg focus:ring-blue-500">
                            <span class="ml-2 text-blue-800 font-semibold">ë…„ì¹˜</span>
                        </div>
                        
                        <div class="p-4 bg-white rounded-lg border border-purple-200 shadow-sm flex items-center">
                            <span class="mr-3 text-purple-700 font-bold">ğŸ› ï¸ ì‘ì—…ì ìˆ˜:</span>
                            <input type="number" id="workerCount" value="8" min="1" max="16" 
                                class="w-16 px-3 py-1 border border-purple-300 rounded-lg text-center font-bold text-lg focus:ring-purple-500">
                            <span class="ml-2 text-purple-800 font-semibold">ê°œ</span>
                        </div>
                    </div>
                </div>

                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('topNCountContent', this)">
                    <span>3. ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ ì„¤ì •</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="topNCountContent" class="pb-4 transition-all duration-300 ease-in-out">
                    <div class="flex items-center bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label for="topNCount" class="text-lg text-gray-700 font-medium mr-4">ìƒìœ„ ì¢…ëª© ê°œìˆ˜ (N):</label>
                        <input type="number" id="topNCount" value="10" min="1" max="50" 
                            class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-center font-bold text-xl">
                        <span class="ml-4 text-gray-500 text-sm">1ì—ì„œ 50 ì‚¬ì´</span>
                    </div>
                </div>

            </form>

            <div class="run-controls-wrapper">
                <button type="button" onclick="runAnalysis()" id="runAnalysisBtn"
                        class="flex-grow px-6 py-3 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                    ğŸš€ ë¶„ì„ ì‹¤í–‰ ë° ìœ ë§ ì¢…ëª© ì°¾ê¸°
                </button>
                
                <button type="button" id="btnCancel" onclick="cancelAnalysis()" class="px-6 py-3 bg-red-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50" disabled>
                    âŒ ì·¨ì†Œ
                </button>
            </div>
            
            <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('resultsContent', this)">
                <span>4. ë¶„ì„ ê²°ê³¼</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>
            <div id="resultsContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                <div id="resultsContainer" class="relative">
                    <div id="resultsDisplay" class="p-0 bg-white min-h-[120px]">
                        <p class="p-4 text-gray-500">ë¶„ì„ ì‹¤í–‰ í›„ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
    
                    <div id="loadingOverlay" class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center hidden transition-opacity duration-300 rounded-xl border-4 border-blue-400 p-8 z-20">
                        <div class="text-4xl animate-spin text-blue-600">âš™ï¸</div>
                        <p class="mt-4 text-xl font-bold text-blue-600">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
                        <p class="text-gray-500 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”. ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>

            <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('logContent', this)">
                <span>5. ì‹¤ì‹œê°„ ë¡œê·¸</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>
            <div id="logContent" class="pb-4 transition-all duration-300 ease-in-out">
                <div id="logDisplay" class="h-48 bg-gray-800 text-gray-200 p-4 overflow-y-scroll rounded-xl font-mono text-sm border border-gray-700">
                    <div class="log-line"><span style="color:#9ca3af;">[INFO]</span> ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì„ í™•ì¸ ì¤‘...</div>
                </div>
            </div>
            
        </div>
        </div>

    <div id="chartModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300 pointer-events-none">
        <div id="modalContent" class="modal-content bg-white rounded-xl p-6 sm:p-8 shadow-2xl max-w-5xl w-full h-[95vh] sm:h-[90vh] flex flex-col">
            
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b pb-3">
                <h3 id="modalTitle" class="text-xl sm:text-3xl font-bold text-indigo-700 mb-2 sm:mb-0 truncate">ì°¨íŠ¸ ìƒì„¸ ë¶„ì„</h3>
                <div class="flex space-x-2 flex-shrink-0">
                    <button onclick="simulateZoom('out')" class="px-2 py-1 sm:px-3 sm:py-1 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300 transition">
                        ğŸ” ì¶•ì†Œ
                    </button>
                    <button onclick="simulateZoom('in')" class="px-2 py-1 sm:px-3 sm:py-1 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300 transition">
                        ğŸ” í™•ëŒ€
                    </button>
                    <button onclick="closeChartModal()" class="px-3 py-1 sm:px-4 sm:py-1 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition">
                        âœ–ï¸ ë‹«ê¸°
                    </button>
                </div>
            </div>

            <div class="flex-grow overflow-hidden bg-gray-100 rounded-lg p-2">
                <canvas id="stockChartCanvas" class="w-full h-full"></canvas>
            </div>

            <div id="chartZoomInfo" class="mt-4 text-center text-gray-500 text-xs sm:text-sm">
                (í˜„ì¬: ê¸°ë³¸ ì°¨íŠ¸ ë²”ìœ„) ì°¨íŠ¸ ë°ì´í„°ëŠ” ì‹œë®¬ë ˆì´ì…˜ì´ë©° ì‹¤ì œ ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="pageScript">
    <script>
        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜ (API ì—°ë™ì„ ìœ„í•´ ì‚¬ìš©)
        let currentTaskId = null;
        let sseSimulatorInterval = null; // SSE ì—°ê²°ì„ ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ì¸í„°ë²Œ
        let chartInstance = null;
        
        // =====================================================================
        // 1. UI ë° ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜
        // =====================================================================

        /**
         * ë¡œê·¸ ë©”ì‹œì§€ë¥¼ ì‹¤ì‹œê°„ ë¡œê·¸ ì°½ì— ì¶”ê°€í•˜ê³  ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ë‚´ë¦½ë‹ˆë‹¤.
         */
        function logMessage(message, level = 'info') {
            const logDisplay = document.getElementById('logDisplay');
            const now = new Date();
            const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            
            let color = '';
            let label = '';

            switch (level) {
                case 'progress':
                    color = '#60a5fa'; // Tailwind blue-400
                    label = 'PROGRESS';
                    break;
                case 'warning':
                    color = '#f59e0b'; // Tailwind amber-500
                    label = 'WARN';
                    break;
                case 'error':
                    color = '#ef4444'; // Tailwind red-500
                    label = 'ERROR';
                    break;
                case 'complete':
                    color = '#22c55e'; // Tailwind green-500
                    label = 'COMPLETE';
                    break;
                case 'info':
                default:
                    color = '#9ca3af'; // Tailwind gray-400
                    label = 'INFO';
            }

            const logLine = document.createElement('div');
            logLine.classList.add('log-line', 'mt-1');
            logLine.innerHTML = `<span style="color: #6b7280;">[${timeString}]</span> <span style="color:${color}; font-weight: 600;">[${label}]</span> ${message}`;
            logDisplay.appendChild(logLine);
            
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }

        /**
         * ì „ì—­ ìƒíƒœ ì¹´ë“œ(Global Status Card)ì˜ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateGlobalStatus(progress, statusText, statusClass, runner = 'ë¯¸ì—°ê²°') {
            const statusLabel = document.getElementById('globalStatusText');
            const progressBar = document.getElementById('globalProgressBar');
            const progressLabel = document.getElementById('globalProgressLabel');
            const runnerLabel = document.getElementById('globalRunner');

            // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            statusLabel.textContent = statusText;
            progressLabel.textContent = `${Math.round(progress)}%`;
            if (runner !== 'ë¯¸ì—°ê²°') {
                 runnerLabel.textContent = runner;
            }

            // ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            statusLabel.className = statusClass;
            statusLabel.classList.toggle('blinking', statusClass === 'status-running' && progress < 100);
            
            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
            progressBar.style.width = `${progress}%`;

            // ë¡œë”© ì˜¤ë²„ë ˆì´ ì œì–´
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (statusClass === 'status-running' && progress < 100) {
                loadingOverlay.classList.remove('hidden');
            } else {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        /**
         * ì„¹ì…˜ ë‚´ìš© í‘œì‹œ/ìˆ¨ê¹€ì„ í† ê¸€í•©ë‹ˆë‹¤.
         */
        function toggleSection(contentId, button) {
            const content = document.getElementById(contentId);
            const icon = button.querySelector('span.transition-transform');
            
            if (content.classList.contains('hidden')) {
                // ì—´ê¸°
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
                // 'resultsContent'ë¥¼ ì—´ ë•ŒëŠ” ë¡œë”© ìƒíƒœë¥¼ ì²´í¬í•©ë‹ˆë‹¤.
                if (contentId === 'resultsContent' && document.getElementById('loadingOverlay').classList.contains('hidden')) {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }
            } else {
                // ë‹«ê¸°
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        /**
         * ë¶„ì„ ìœ í˜•ì´ MAì¼ ë•Œë§Œ ê¸°ê°„ ì„ íƒ ì˜µì…˜ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function toggleMaPeriods() {
            const maPeriodsContainer = document.getElementById('maPeriodsContainer');
            const maRadio = document.getElementById('maRadio');

            if (maRadio.checked) {
                maPeriodsContainer.style.display = 'block';
            } else {
                maPeriodsContainer.style.display = 'none';
            }
        }

        /**
         * ë°ì´í„° ê¸°ê°„(ë…„)ì— ë”°ë¼ 500ì¼ì„  ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateMaCheckboxes() {
            const dataPeriodYears = parseInt(document.getElementById('dataPeriodYears').value, 10);
            const ma500 = document.getElementById('ma500');
            const ma500Label = document.getElementById('ma500Label');
            const ma500Hint = document.getElementById('ma500Hint');

            if (dataPeriodYears >= 3) {
                ma500.disabled = false;
                // updateMaCheckboxesëŠ” oninput ì´ë²¤íŠ¸ë¡œ í˜¸ì¶œë˜ë¯€ë¡œ, ì²´í¬ ìƒíƒœëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³  disabledë§Œ ì œì–´
                ma500Label.classList.remove('opacity-50');
                ma500Hint.classList.add('hidden');
            } else {
                ma500.disabled = true;
                ma500.checked = false; // ê¸°ê°„ ë¶€ì¡± ì‹œ ê°•ì œ í•´ì œ
                ma500Label.classList.add('opacity-50');
                ma500Hint.classList.remove('hidden');
            }
        }

        /**
         * ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  ë¡œê·¸ì— ê¸°ë¡í•©ë‹ˆë‹¤.
         */
        function displayError(title, text) {
            const container = document.getElementById('errorMessageContainer');
            document.getElementById('errorMessageTitle').textContent = title;
            document.getElementById('errorMessageText').textContent = text;
            container.classList.remove('hidden');
            logMessage(`${title}: ${text}`, 'error');
            // ì‹¤í–‰ ìƒíƒœ ì´ˆê¸°í™” (í•„ìš” ì‹œ)
            setControlsState(false);
            updateGlobalStatus(0, 'ì‹¤íŒ¨', 'status-failed');
        }

        /**
         * ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
         */
        function hideError() {
            document.getElementById('errorMessageContainer').classList.add('hidden');
        }

        /**
         * UI ì»¨íŠ¸ë¡¤ ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function setControlsState(isRunning) {
            document.getElementById('runAnalysisBtn').disabled = isRunning;
            document.getElementById('btnCancel').disabled = !isRunning;
            
            // í¼ ì…ë ¥ ë¹„í™œì„±í™”/í™œì„±í™”
            const formInputs = document.querySelectorAll('#analysisForm input');
            formInputs.forEach(input => {
                // MA 500ì¼ì„ ì²˜ëŸ¼ ë¡œì§ìƒ disabledì¸ ê²ƒì€ ì œì™¸
                if (input.id !== 'ma500' || input.disabled === false) {
                    input.disabled = isRunning;
                }
            });
            // MA 500ì¼ì„ ì€ dataPeriodYearsì— ë”°ë¼ ë‹¤ì‹œ ì œì–´í•´ì•¼ í•¨
            updateMaCheckboxes();
        }

        // =====================================================================
        // 2. MOCK DATA (ì‹¤ì œ ì—°ë™ ì‹œ API ì‘ë‹µìœ¼ë¡œ ëŒ€ì²´)
        // =====================================================================
        
        /**
         * ìµœì¢… ë¶„ì„ ê²°ê³¼ Mock Data ìƒì„±
         */
        function getMockFinalResults() {
            return [
                { code: "005930", name: "ì‚¼ì„±ì „ì", score: 98.5, pattern_match: "double_bottom", recent_volume_increase: true },
                { code: "000660", name: "SKí•˜ì´ë‹‰ìŠ¤", score: 95.2, pattern_match: "cup_and_handle", recent_volume_increase: false },
                { code: "035720", name: "ì¹´ì¹´ì˜¤", score: 91.8, pattern_match: "ma", recent_volume_increase: true },
                { code: "051910", name: "LGí™”í•™", score: 88.0, pattern_match: "triple_bottom", recent_volume_increase: false },
                { code: "096770", name: "SKì´ë…¸ë² ì´ì…˜", score: 85.5, pattern_match: "ma", recent_volume_increase: true },
                { code: "005380", name: "í˜„ëŒ€ì°¨", score: 84.1, pattern_match: "decline_5d", recent_volume_increase: false },
                { code: "003490", name: "ëŒ€í•œí•­ê³µ", score: 82.7, pattern_match: "decline_20d", recent_volume_increase: true },
                { code: "066570", name: "LGì „ì", score: 80.3, pattern_match: "double_bottom", recent_volume_increase: false },
                { code: "086790", name: "í•˜ë‚˜ê¸ˆìœµì§€ì£¼", score: 78.9, pattern_match: "cup_and_handle", recent_volume_increase: true },
                { code: "105560", name: "KBê¸ˆìœµ", score: 75.4, pattern_match: "triple_bottom", recent_volume_increase: false },
            ];
        }

        /**
         * ì°¨íŠ¸ìš© ì—­ì‚¬ì  ì£¼ê°€ ë°ì´í„° Mock Data ìƒì„± (1ë…„ì¹˜)
         */
        function getMockStockData(code, name) {
            const data = [];
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 365); // 1ë…„ì¹˜ ë°ì´í„°

            let price = code.startsWith('005') ? 70000 : 50000;
            let volume = 1000000;

            for (let d = startDate; d <= today; d.setDate(d.getDate() + 1)) {
                if (d.getDay() === 0 || d.getDay() === 6) continue; // ì£¼ë§ ì œì™¸

                // ê°€ê²© ë³€ë™ ì‹œë®¬ë ˆì´ì…˜ (ëœë¤ ì›Œí¬)
                price = price * (1 + (Math.random() - 0.45) * 0.02);
                
                // MA íŒ¨í„´ ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•´ ê°€ê²©ì´ ì¥ê¸°ê°„ í•˜ë½ í›„ ë°˜ë“±í•˜ëŠ” íŒ¨í„´ì„ ê°€ì •
                if (d.getMonth() < 6 && price > 30000) {
                    price = price * (1 + (Math.random() - 0.55) * 0.015);
                } else if (d.getMonth() === 7) {
                    price = price * (1 + (Math.random() - 0.3) * 0.02); // ë°˜ë“± ì‹œì‘
                }

                // ê±°ë˜ëŸ‰ ì‹œë®¬ë ˆì´ì…˜
                volume = Math.max(500000, volume + Math.floor((Math.random() - 0.5) * 200000));

                data.push({
                    date: new Date(d).toISOString().split('T')[0],
                    close: Math.round(price),
                    volume: volume
                });
            }

            // ê°„ë‹¨í•œ MA ê³„ì‚° (5ì¼, 20ì¼)
            const ma5 = [];
            const ma20 = [];

            for (let i = 0; i < data.length; i++) {
                // MA 5
                const slice5 = data.slice(Math.max(0, i - 4), i + 1);
                const avg5 = slice5.reduce((sum, item) => sum + item.close, 0) / slice5.length;
                ma5.push(avg5);

                // MA 20
                const slice20 = data.slice(Math.max(0, i - 19), i + 1);
                const avg20 = slice20.reduce((sum, item) => sum + item.close, 0) / slice20.length;
                ma20.push(avg20);
            }

            return {
                code,
                name,
                labels: data.map(item => item.date),
                prices: data.map(item => item.close),
                ma5: ma5,
                ma20: ma20,
            };
        }

        // =====================================================================
        // 3. API ë° SSE ì—°ê²° (ì‹œë®¬ë ˆì´ì…˜ í¬í•¨)
        // =====================================================================
        
        // API ìš”ì²­ì— í•„ìš”í•œ íŒŒë¼ë¯¸í„°ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
        function getAnalysisParams() {
            const pattern = document.querySelector('input[name="analysisType"]:checked').value;
            const years = parseInt(document.getElementById('dataPeriodYears').value, 10);
            const workers = parseInt(document.getElementById('workerCount').value, 10);
            const excludeNeg = document.getElementById('excludeNegatives').checked;
            // MA ê¸°ê°„ì€ ì˜ˆì‹œì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ, ì‹¤ì œ API ì—°ë™ì„ ìœ„í•´ í¬í•¨ ê°€ëŠ¥
            const maPeriods = Array.from(document.querySelectorAll('input[name="maPeriods"]:checked'))
                                .map(cb => cb.value);

            return { pattern, years, workers, excludeNeg, maPeriods };
        }


        /**
         * ë¶„ì„ ì‹¤í–‰ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (API í˜¸ì¶œ)
         */
        async function runAnalysis() {
            if (currentTaskId) {
                logMessage('ì´ë¯¸ ë¶„ì„ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.', 'warning');
                return;
            }

            const params = getAnalysisParams();

            const topN = parseInt(document.getElementById('topNCount').value, 10);
            if (topN < 1 || topN > 50) {
                displayError('ì…ë ¥ ì˜¤ë¥˜', 'ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ëŠ” 1ì—ì„œ 50 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            hideError();
            setControlsState(true);
            document.getElementById('resultsDisplay').innerHTML = '<p class="p-4 text-gray-500">ë¶„ì„ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>';


            // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° êµ¬ì„± (ì‹¤ì œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ì— ë§ê²Œ ì¡°ì •)
            const query = new URLSearchParams({
                pattern: params.pattern,
                workers: params.workers,
                years: params.years,
                excludeNeg: params.excludeNeg
            }).toString();

            try {
                // ì‹¤ì œ API ì—”ë“œí¬ì¸íŠ¸: /api/analysis/start
                // const response = await fetch(`/api/analysis/start?${query}`, { method: 'POST' });
                
                // MOCK API: 1ì´ˆ ì§€ì—° í›„ Mock Task ID ë°˜í™˜
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // MOCK RESPONSE
                const mockResponse = { taskId: `task-${Date.now()}` };
                
                // ì‹¤ì œ ì‘ë‹µ ì²˜ë¦¬
                if (mockResponse && mockResponse.taskId) {
                    currentTaskId = mockResponse.taskId;
                    logMessage(`ë¶„ì„ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. Task ID: ${currentTaskId}`, 'info');
                    // SSE ì—°ê²° ì‹œì‘ (ì‹œë®¬ë ˆì´ì…˜)
                    startSseSimulation(currentTaskId);
                    // ê²°ê³¼ ì„¹ì…˜ ê°•ì œ ì˜¤í”ˆ
                    toggleSection('resultsContent', document.querySelector('[onclick="toggleSection(\'resultsContent\', this)"]'));
                } else {
                    displayError('ì‹œì‘ ì‹¤íŒ¨', 'ë°°ì¹˜ ì‘ì—… ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜.');
                }

            } catch (error) {
                displayError('í†µì‹  ì˜¤ë¥˜', `ë¶„ì„ ì‹œì‘ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                currentTaskId = null;
                setControlsState(false);
            }
        }


        /**
         * ë¶„ì„ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (API í˜¸ì¶œ)
         */
        async function cancelAnalysis() {
            if (!currentTaskId) {
                logMessage('í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            const taskIdToCancel = currentTaskId;
            currentTaskId = null; // UI ì¦‰ì‹œ ë¹„í™œì„±í™”
            stopSseSimulation();
            setControlsState(false);
            updateGlobalStatus(0, 'ì·¨ì†Œ ìš”ì²­ ì¤‘', 'status-cancelled');
            logMessage(`ì‘ì—… ID ${taskIdToCancel} ì·¨ì†Œë¥¼ ìš”ì²­í•©ë‹ˆë‹¤...`, 'warning');

            try {
                // ì‹¤ì œ API ì—”ë“œí¬ì¸íŠ¸: /api/analysis/cancel/{taskId}
                // const response = await fetch(`/api/analysis/cancel/${taskIdToCancel}`, { method: 'POST' });
                
                // MOCK API: 1ì´ˆ ì§€ì—° í›„ ì‘ë‹µ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                logMessage(`ì‘ì—… ID ${taskIdToCancel}ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'complete');
                updateGlobalStatus(0, 'ì·¨ì†Œë¨', 'status-idle');
                document.getElementById('resultsDisplay').innerHTML = '<p class="p-4 text-orange-500 font-semibold">âŒ ë¶„ì„ ì‘ì—…ì´ ì‚¬ìš©ì ìš”ì²­ì— ì˜í•´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>';


            } catch (error) {
                logMessage(`ì·¨ì†Œ ìš”ì²­ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì§€ë§Œ, UIëŠ” ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
                updateGlobalStatus(0, 'ì·¨ì†Œ ì˜¤ë¥˜', 'status-failed');
            }
        }

        // =====================================================================
        // 4. SSE (Server-Sent Events) ì‹œë®¬ë ˆì´ì…˜ ë¡œì§
        // =====================================================================

        /**
         * SSE ì—°ê²°ì„ ì‹œì‘í•˜ê³  ì‹¤ì‹œê°„ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. (Mock EventSource ëŒ€ì‹  setInterval ì‚¬ìš©)
         */
        function startSseSimulation(taskId) {
            let progress = 0;
            let currentStep = 0;
            const steps = [
                "ë°ì´í„° ìˆ˜ì§‘ ë° ì „ì²˜ë¦¬ ì¤‘...",
                "ë¶„ì„ ì¡°ê±´ í•„í„°ë§ ì¤‘...",
                "íŒ¨í„´ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ ì ìš© ì¤‘ (Worker 1/8)",
                "íŒ¨í„´ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ ì ìš© ì¤‘ (Worker 3/8)",
                "íŒ¨í„´ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ ì ìš© ì¤‘ (Worker 5/8)",
                "íŒ¨í„´ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ ì ìš© ì¤‘ (Worker 8/8)",
                "ìµœì¢… ì ìˆ˜ ì‚°ì • ë° ì •ë ¬ ì¤‘...",
                "ê²°ê³¼ ì €ì¥ ì¤‘...",
            ];
            const runner = `User_${taskId.slice(-4)}`; // ì‹¤í–‰ì ID ì‹œë®¬ë ˆì´ì…˜

            updateGlobalStatus(0, 'ì‹¤í–‰ ì¤‘', 'status-running', runner);
            logMessage('SSE ì—°ê²°(ì‹œë®¬ë ˆì´ì…˜) ì‹œì‘. ì‹¤ì‹œê°„ ìƒíƒœë¥¼ ìˆ˜ì‹ í•©ë‹ˆë‹¤.', 'info');

            sseSimulatorInterval = setInterval(() => {
                if (!currentTaskId) {
                    stopSseSimulation();
                    return;
                }

                // 100% ë„ë‹¬
                if (progress >= 100) {
                    updateSseStatus({ status: 'COMPLETED', progress: 100, message: 'ë¶„ì„ ì™„ë£Œ. ìµœì¢… ê²°ê³¼ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.' });
                    stopSseSimulation();
                    return;
                }

                // ì§„í–‰ë¥  ì¦ê°€ ë° ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                progress += Math.floor(Math.random() * 8) + 3; // 3~10% ì¦ê°€
                progress = Math.min(progress, 100);

                if (progress >= 10 && currentStep === 0) {
                    currentStep = 1;
                } else if (progress >= 25 && currentStep === 1) {
                    currentStep = 2;
                } else if (progress >= 40 && currentStep === 2) {
                    currentStep = 3;
                } else if (progress >= 55 && currentStep === 3) {
                    currentStep = 4;
                } else if (progress >= 70 && currentStep === 4) {
                    currentStep = 5;
                } else if (progress >= 85 && currentStep === 5) {
                    currentStep = 6;
                } else if (progress >= 95 && currentStep === 6) {
                    currentStep = 7;
                }

                const statusMessage = steps[currentStep] || steps[steps.length - 1];

                updateSseStatus({ 
                    status: 'RUNNING', 
                    progress: progress, 
                    message: `${statusMessage} (${progress}%)`
                });

            }, 1500); // 1.5ì´ˆë§ˆë‹¤ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜
        }

        /**
         * SSE ì‹œë®¬ë ˆì´ì…˜ì„ ì¤‘ì§€í•©ë‹ˆë‹¤.
         */
        function stopSseSimulation() {
            if (sseSimulatorInterval) {
                clearInterval(sseSimulatorInterval);
                sseSimulatorInterval = null;
            }
        }

        /**
         * SSE ì´ë²¤íŠ¸ì— ë”°ë¼ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateSseStatus(eventData) {
            const { status, progress, message } = eventData;
            
            if (status === 'RUNNING') {
                updateGlobalStatus(progress, 'ì‹¤í–‰ ì¤‘', 'status-running');
                logMessage(message, 'progress');
            } else if (status === 'COMPLETED' || progress >= 100) {
                // ìµœì¢… ì™„ë£Œ ì²˜ë¦¬
                logMessage('ë°°ì¹˜ ë¶„ì„ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'complete');
                updateGlobalStatus(100, 'ì™„ë£Œ', 'status-completed');
                currentTaskId = null;
                setControlsState(false);
                displayFinalResults(getMockFinalResults());

            } else if (status === 'FAILED') {
                logMessage(`ì‘ì—… ì‹¤íŒ¨: ${message}`, 'error');
                updateGlobalStatus(progress, 'ì‹¤íŒ¨', 'status-failed');
                currentTaskId = null;
                setControlsState(false);
            }
        }

        /**
         * ìµœì¢… ê²°ê³¼ë¥¼ HTML í…Œì´ë¸”ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function displayFinalResults(results) {
            const resultsDisplay = document.getElementById('resultsDisplay');
            const topN = parseInt(document.getElementById('topNCount').value, 10);
            
            if (results.length === 0) {
                resultsDisplay.innerHTML = '<p class="p-4 text-gray-500">ì¡°ê±´ì— ë§ëŠ” ìœ ë§ ì¢…ëª©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const headerClass = "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50";
            const rowClass = "px-6 py-4 whitespace-nowrap text-sm text-gray-900";

            let html = `
                <div class="overflow-x-auto shadow ring-1 ring-black ring-opacity-5 sm:rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="${headerClass}">ìˆœìœ„</th>
                                <th class="${headerClass}">ì¢…ëª©ëª…</th>
                                <th class="${headerClass}">ì¢…ëª©ì½”ë“œ</th>
                                <th class="${headerClass}">ë§¤ì¹­ íŒ¨í„´</th>
                                <th class="${headerClass}">ì ìˆ˜</th>
                                <th class="${headerClass}">ìµœê·¼ ê±°ë˜ëŸ‰</th>
                                <th class="${headerClass}">ì°¨íŠ¸</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            results.slice(0, topN).forEach((item, index) => {
                const volumeIcon = item.recent_volume_increase 
                    ? '<span class="text-green-600 font-semibold">ğŸ”º ê¸‰ì¦</span>' 
                    : '<span class="text-gray-500">í‰ê· </span>';
                
                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">${index + 1}</td>
                        <td class="${rowClass} font-bold text-indigo-600">${item.name}</td>
                        <td class="${rowClass} text-gray-500">${item.code}</td>
                        <td class="${rowClass} text-indigo-500">${item.pattern_match.toUpperCase().replace('_', ' ')}</td>
                        <td class="${rowClass} font-extrabold">${item.score.toFixed(1)}</td>
                        <td class="${rowClass}">${volumeIcon}</td>
                        <td class="${rowClass}">
                            <button onclick="showChartModal('${item.code}', '${item.name}')" class="text-indigo-600 hover:text-indigo-900 font-semibold text-xs py-1 px-3 border border-indigo-400 rounded-full transition duration-150 hover:bg-indigo-50">
                                ì°¨íŠ¸ ë³´ê¸°
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            resultsDisplay.innerHTML = html;
        }

        // =====================================================================
        // 5. Chart.js ëª¨ë‹¬ ë° ë Œë”ë§ í•¨ìˆ˜
        // =====================================================================

        /**
         * ì°¨íŠ¸ ëª¨ë‹¬ì„ ì—´ê³  ë°ì´í„°ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function showChartModal(code, name) {
            document.getElementById('modalTitle').textContent = `${name} (${code}) - ì£¼ê°€ ë° íŒ¨í„´ ë¶„ì„`;
            const mockData = getMockStockData(code, name);
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆìœ¼ë©´ íŒŒê´´
            if (chartInstance) {
                chartInstance.destroy();
            }

            // ì°¨íŠ¸ ë Œë”ë§
            initChart(mockData);

            // ëª¨ë‹¬ í‘œì‹œ
            const modal = document.getElementById('chartModal');
            modal.classList.add('active');
        }
        
        /**
         * ì°¨íŠ¸ ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤.
         */
        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            modal.classList.remove('active');
            // ëª¨ë‹¬ ë‹«ì„ ë•Œ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ íŒŒê´´
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        /**
         * Chart.js ìº”ë²„ìŠ¤ì— ì£¼ê°€ ì°¨íŠ¸ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
         */
        function initChart(data) {
            const ctx = document.getElementById('stockChartCanvas').getContext('2d');
            
            const priceColor = '#3b82f6'; // Blue-500
            const ma5Color = '#f59e0b'; // Amber-500
            const ma20Color = '#ef4444'; // Red-500

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'ì¢…ê°€',
                            data: data.prices,
                            borderColor: priceColor,
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'MA 5ì¼',
                            data: data.ma5,
                            borderColor: ma5Color,
                            borderWidth: 1,
                            pointRadius: 0,
                            yAxisID: 'y'
                        },
                        {
                            label: 'MA 20ì¼',
                            data: data.ma20,
                            borderColor: ma20Color,
                            borderWidth: 1,
                            pointRadius: 0,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                            }
                        },
                        title: {
                            display: false,
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month'
                            },
                            title: {
                                display: true,
                                text: 'ë‚ ì§œ'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: 'auto',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ê°€ê²© (ì›)'
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * ì°¨íŠ¸ í™•ëŒ€/ì¶•ì†Œ ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜ (Chart.js ì˜µì…˜ ë³€ê²½)
         */
        function simulateZoom(direction) {
            if (!chartInstance) return;

            const currentStart = chartInstance.options.scales.x.min ? new Date(chartInstance.options.scales.x.min) : new Date(chartInstance.data.labels[0]);
            const currentEnd = chartInstance.options.scales.x.max ? new Date(chartInstance.options.scales.x.max) : new Date(chartInstance.data.labels[chartInstance.data.labels.length - 1]);
            
            const diffDays = (currentEnd - currentStart) / (1000 * 60 * 60 * 24);
            const zoomFactor = 0.2; // 20% ì¤Œ

            let newStart, newEnd;
            let infoText;

            if (direction === 'in') {
                if (diffDays <= 90) { // ìµœì†Œ 3ê°œì›” ìœ ì§€
                    document.getElementById('chartZoomInfo').textContent = '(í˜„ì¬: ìµœëŒ€ í™•ëŒ€ ë²”ìœ„) ë” ì´ìƒ í™•ëŒ€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    return;
                }
                // í™•ëŒ€ (ì¤‘ì•™ì„ ê¸°ì¤€ìœ¼ë¡œ 20% ì¶•ì†Œ)
                const zoomAmount = diffDays * zoomFactor / 2;
                newStart = new Date(currentStart);
                newStart.setDate(currentStart.getDate() + Math.round(zoomAmount));
                newEnd = new Date(currentEnd);
                newEnd.setDate(currentEnd.getDate() - Math.round(zoomAmount));
                infoText = `(í˜„ì¬: ${Math.round(diffDays * (1 - 2 * zoomFactor))}ì¼ ë²”ìœ„) ì°¨íŠ¸ê°€ í™•ëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤.`;

            } else { // 'out'
                // ì¶•ì†Œ (ì „ì²´ ë°ì´í„° ë²”ìœ„ê¹Œì§€ ë³µì›)
                if (currentStart.toISOString().split('T')[0] === chartInstance.data.labels[0] && currentEnd.toISOString().split('T')[0] === chartInstance.data.labels[chartInstance.data.labels.length - 1]) {
                    document.getElementById('chartZoomInfo').textContent = '(í˜„ì¬: ê¸°ë³¸ ì°¨íŠ¸ ë²”ìœ„) ë” ì´ìƒ ì¶•ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    return;
                }
                
                // 100% ë²”ìœ„ë¡œ ë³µê·€
                newStart = new Date(chartInstance.data.labels[0]);
                newEnd = new Date(chartInstance.data.labels[chartInstance.data.labels.length - 1]);
                infoText = '(í˜„ì¬: ê¸°ë³¸ ì°¨íŠ¸ ë²”ìœ„) ì°¨íŠ¸ê°€ ì´ˆê¸° ë²”ìœ„ë¡œ ì¶•ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            }

            chartInstance.options.scales.x.min = newStart.toISOString().split('T')[0];
            chartInstance.options.scales.x.max = newEnd.toISOString().split('T')[0];

            chartInstance.update();
            document.getElementById('chartZoomInfo').textContent = infoText;
        }


        // =====================================================================
        // 6. ì´ˆê¸°í™”
        // =====================================================================
        window.onload = function() {
            // ì´ˆê¸° MA ê¸°ê°„ ì»¨í…Œì´ë„ˆ ìƒíƒœ ì„¤ì •
            toggleMaPeriods();
            // ì´ˆê¸° 500ì¼ì„  ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì„¤ì •
            updateMaCheckboxes();
            // ì´ˆê¸° ì»¨íŠ¸ë¡¤ ìƒíƒœ ì„¤ì •
            setControlsState(false);
            
            logMessage('UI ë° Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¤€ë¹„ ì™„ë£Œ.', 'info');
            logMessage('ë¶„ì„ ì˜µì…˜ì„ ì„ íƒí•˜ê³  ğŸš€ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.', 'info');
        };
    </script>
</th:block>
</body>
</html>