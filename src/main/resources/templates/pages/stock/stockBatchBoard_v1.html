<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
<meta charset="UTF-8">
<title>ğŸ“Š Stock Batch Dashboard</title>

<!-- ===============================================================
ğŸ“Š MyBaseLinkV2 - stockBatchBoard ì•ˆì •íŒ v1.0 (2025-11-01)
---------------------------------------------------------------
âœ… ë¡œê·¸ DOM ëˆ„ì  ì œê±° (ë²„í¼ + ë¡¤ë§ + 200ms Flush)
âœ… ìƒˆë¡œê³ ì¹¨ ë°˜ë³µ/ë‹¤ì¤‘ SSE ì—°ê²° ì‹œ ë ‰ ì™„ì „ ì œê±°
âœ… ë²„íŠ¼/í¼ì„¼íŠ¸/ìƒíƒœ ì™„ì „ ì¼ì¹˜
---------------------------------------------------------------
ğŸš€ ì•ˆì • ê¸°ì¤€ ë²„ì „ â€” ì´í›„ ë³€ê²½ ì‹œ ë°˜ë“œì‹œ ì´ ë²„ì „ì„ ë°±ì—…í•  ê²ƒ
=============================================================== -->
<style>
  .content-container{width:100%;max-width:1600px;margin:0 auto;padding:1rem 2%;box-sizing:border-box;}
  h2{font-size:1.3rem;font-weight:700;margin-bottom:.4rem;color:#111827;}
  .card-box,.dashboard-cards,.log-wrapper{background:#fff;border-radius:12px;padding:18px;box-shadow:0 2px 6px rgba(0,0,0,.05);margin-top:14px;}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-size:.9rem;font-weight:600;color:#fff;min-width:110px;text-align:center;}
  .btn-start{background:#2563eb;}
  .btn-cancel{background:#dc2626;}
  .btn:disabled{opacity:.5;cursor:not-allowed;}
  .controls{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;}
  input[type=number]{width:90px;padding:.45rem .6rem;border:1px solid #bbb;border-radius:6px;}
  .dashboard-cards{display:flex;flex-wrap:wrap;gap:14px;}
  .card{flex:1 1 300px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.05);display:flex;flex-direction:column;}
  .card-header{display:flex;align-items:center;gap:6px;font-size:.95rem;font-weight:600;margin-bottom:6px;}
  .card-header i{color:#2563eb;}
  .card-header .right{margin-left:auto;font-weight:600;font-size:.9rem;}
  .progress-bar{width:100%;background:#e5e7eb;height:14px;border-radius:7px;margin-top:10px;overflow:hidden;}
  .progress-bar div{height:100%;width:0%;transition:width .3s;}
  .bar-total div{background:#2563eb;}
  .bar-krx div{background:#10b981;}
  .bar-data div{background:#f59e0b;}
  .log-wrapper h3{display:flex;align-items:center;justify-content:space-between;margin:0;font-size:1rem;}
  .copy-btn{font-size:.9rem;cursor:pointer;user-select:none;margin-left:10px;color:#444;opacity:.7;}
  .copy-btn:hover{opacity:1;text-decoration:none;}
  .log-box{background:#111;color:#eee;font-family:Consolas,mono;font-size:13px;padding:10px;border-radius:10px;height:350px;overflow-y:auto;white-space:pre-wrap;margin-top:6px;}
</style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>ğŸ“Š ì¢…ëª© ì¼ê´„ ì—…ë°ì´íŠ¸ Dashboard</h2>
    <p>ì§„í–‰ìƒí™© + ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸ ê°€ëŠ¥</p>

    <div class="card-box">
      <div class="controls">
        <label>ì›Œì»¤:
          <input type="number" id="workers" value="8" min="1" max="16">
        </label>
        <label><input type="checkbox" id="force"> ê°•ì œ ë‹¤ìš´ë¡œë“œ</label>
        <button id="btnStart" class="btn btn-start">ì—…ë°ì´íŠ¸ ì‹œì‘</button>
        <button id="btnCancel" class="btn btn-cancel" disabled>ì·¨ì†Œ</button>
      </div>
      <div id="adminHint" style="font-size:12px;color:#666;margin-top:4px;">
        â€» ê´€ë¦¬ìë§Œ ì‹¤í–‰ ê°€ëŠ¥
      </div>
    </div>

    <div class="dashboard-cards">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-layer-group"></i>ì „ì²´ ì§„í–‰ë¥ 
          <span class="right" id="badgeTotal">-</span>
        </div>
        <strong id="pctTotal">0%</strong>
        <div class="progress-bar bar-total"><div id="barTotal"></div></div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-database"></i>KRX ì¢…ëª© ëª©ë¡
          <span class="right" id="badgeKrx"></span>
        </div>
        <strong id="pctKrx">0%</strong>
        <div class="progress-bar bar-krx"><div id="barKrx"></div></div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-chart-line"></i>ê°œë³„ ì¢…ëª© ë°ì´í„°
          <span class="right" id="badgeData"></span>
        </div>
        <strong id="pctData">0%</strong>
        <div class="progress-bar bar-data"><div id="barData"></div></div>
      </div>
    </div>

    <div class="log-wrapper">
      <h3>
        ì‹¤ì‹œê°„ ë¡œê·¸
        <span class="copy-btn" id="copyLogBtn">ğŸ“„</span>
      </h3>
      <div id="logBox" class="log-box">ë¡œê·¸ ëŒ€ê¸°ì¤‘...</div>
    </div>
  </div>
</div>


<th:block layout:fragment="pageScript">
<script>
(function(){
  const $workers=document.getElementById("workers"),
        $force=document.getElementById("force"),
        $btnStart=document.getElementById("btnStart"),
        $btnCancel=document.getElementById("btnCancel"),
        $barTotal=document.getElementById("barTotal"),
        $pctTotal=document.getElementById("pctTotal"),
        $barKrx=document.getElementById("barKrx"),
        $pctKrx=document.getElementById("pctKrx"),
        $barData=document.getElementById("barData"),
        $pctData=document.getElementById("pctData"),
        $badgeTotal=document.getElementById("badgeTotal"),
        $badgeKrx=document.getElementById("badgeKrx"),
        $badgeData=document.getElementById("badgeData"),
        $hint=document.getElementById("adminHint"),
        $log=document.getElementById("logBox"),
        $copy=document.getElementById("copyLogBtn");

  let isOwner=false, currentTaskId=null, es=null, connected=false;

  // ====== ë¡œê·¸ ì„±ëŠ¥ ìµœì í™”: ë²„í¼ + ë¡¤ë§ ì œí•œ ======
  const MAX_LOG_LINES = 500;          // ìµœëŒ€ ìœ ì§€ ì¤„ ìˆ˜ (ìµœê·¼ 500ì¤„ë§Œ ìµœëŒ€1000 ê·¼ë° ë ‰ë°œìƒì€ ë‚®ìœ¼ë©´ ì¢‹ìŒ)
  const FLUSH_INTERVAL = 200;         // DOM ë°˜ì˜ ì£¼ê¸°(ms)
  let logLines = [];                  // í™”ë©´ì— ìœ ì§€ë˜ëŠ” ì „ì²´ ë¡œê·¸(ìµœê·¼ MAX_LOG_LINES)
  let pendingLogs = [];               // ì•„ì§ DOMì— ë°˜ì˜í•˜ì§€ ì•Šì€ ì‹ ê·œ ë¡œê·¸
  let flushTimer = null;

  function scheduleFlush(){
    if(flushTimer!=null) return;
    flushTimer = setTimeout(()=>{
      flushTimer=null;
      if(pendingLogs.length===0) return;

      // 1) ë©”ëª¨ë¦¬ ë°°ì—´(logLines)ì— ì‹ ê·œ ì¤„ í•©ì¹˜ê³  ë¡¤ë§
      for(const line of pendingLogs){
        logLines.push(line);
      }
      pendingLogs.length = 0;
      if(logLines.length>MAX_LOG_LINES){
        logLines = logLines.slice(logLines.length - MAX_LOG_LINES);
      }

      // 2) DOM ê°±ì‹ ì€ í…ìŠ¤íŠ¸ í†µìœ¼ë¡œ êµì²´(ë¦¬í”Œë¡œìš° ìµœì†Œí™”)
      //    ë„ˆë¬´ ìì£¼ reflowë˜ì§€ ì•Šë„ë¡ ìœ„ì—ì„œ ê°„ê²© ì œì–´
      $log.textContent = logLines.join("\n");
      $log.scrollTop = $log.scrollHeight;
    }, FLUSH_INTERVAL);
  }

  function appendLog(msg){
    if(!msg) return;
    if($log.textContent.includes("ëŒ€ê¸°ì¤‘")) {
      // ì´ˆê¸° ë¬¸êµ¬ ì œê±° ë° ì´ˆê¸°í™”
      $log.textContent="";
      logLines.length = 0;
      pendingLogs.length = 0;
    }
    pendingLogs.push(msg);
    scheduleFlush();
  }

  function setBar(bar,pct,val){
    const v=Math.min(100,Math.max(0,Math.round(val||0)));
    bar.style.width=v+"%"; pct.textContent=v+"%";
  }

  function resetUI(){
    isOwner=false; currentTaskId=null;
    setBar($barTotal,$pctTotal,0);
    setBar($barKrx,$pctKrx,0);
    setBar($barData,$pctData,0);
    $badgeTotal.textContent="-"; $badgeKrx.textContent=""; $badgeData.textContent="";
    $hint.innerHTML="â€» ê´€ë¦¬ìë§Œ ì‹¤í–‰ ê°€ëŠ¥";
    $btnStart.disabled=false; $btnCancel.disabled=true;

    // ë¡œê·¸ ë°•ìŠ¤ ì´ˆê¸°í™”(ë©”ëª¨ë¦¬+DOM)
    logLines.length = 0;
    pendingLogs.length = 0;
    if(flushTimer){ clearTimeout(flushTimer); flushTimer=null; }
    $log.textContent="ë¡œê·¸ ëŒ€ê¸°ì¤‘...";
  }

  function lockUI(){
    $btnStart.disabled=true;
    $btnCancel.disabled=!isOwner;
  }

  // ìƒíƒœ ë³µì› (SSE ì—°ê²° ì•ˆì • í›„)
  async function restoreStatus(){
    try {
      const res = await fetch("/api/stock/batch/status/current",{credentials:"include"});
      if(!res.ok) return;
      const d = await res.json();
      if(!d || !d.status) return;

      if(d.status==="IN_PROGRESS"){
        if(d.currentUser===d.runner){
          isOwner=true;
          $hint.innerHTML=`âš™ï¸ ${d.runner}ë‹˜ ì‹¤í–‰ ì¤‘ (${Math.round(d.progress||0)}%)`;
          $btnStart.disabled=true;
          $btnCancel.disabled=false;
        } else {
          isOwner=false;
          $hint.innerHTML=`ğŸš« ${d.runner}ë‹˜ ì‹¤í–‰ ì¤‘ (${Math.round(d.progress||0)}%)`;
          $btnStart.disabled=true;
          $btnCancel.disabled=true;
        }
        const p = (typeof d.progress==="number")? d.progress : (d.result && typeof d.result.progress==="number" ? d.result.progress : 0);
        setBar($barTotal,$pctTotal,p||0);
      } else {
        resetUI();
      }
    } catch(e){
      console.warn("ë³µì› ì‹¤íŒ¨",e);
    }
  }

  // SSE ì—°ê²° (ì¤‘ë³µ ì—°ê²° ë°©ì§€ + ìë™ ì¬ì—°ê²°)
  function connect(){
    if(connected){ return; }
    connected=true;

    if(es){ try{es.close();}catch(_){} es=null; }

    es = new EventSource("/api/stock/batch/sse",{withCredentials:true});

    es.addEventListener("status", e=>{
      const d = JSON.parse(e.data||"{}");

      if(d.status==="IDLE"){ resetUI(); return; }

      // í¼ì„¼íŠ¸
      if(d.dataTotal>0){
        setBar($barData,$pctData,(d.dataSaved*100/d.dataTotal));
        $badgeData.textContent=`${d.dataSaved}/${d.dataTotal}`;
      }
      if(d.krxTotal>0){
        setBar($barKrx,$pctKrx,(d.krxSaved*100/d.krxTotal));
        $badgeKrx.textContent=`${d.krxSaved}/${d.krxTotal}`;
      }
      if(typeof d.progress==="number"){
        setBar($barTotal,$pctTotal,d.progress);
      }

      // ì‹¤í–‰ì/ë²„íŠ¼
      if(d.runner){
        if(d.owner){
          isOwner=true;
          $hint.innerHTML=`âš™ï¸ ${d.runner}ë‹˜ ì‹¤í–‰ ì¤‘ (${Math.round(d.progress||0)}%)`;
          $btnStart.disabled=true;
          $btnCancel.disabled=false;
        } else {
          isOwner=false;
          $hint.innerHTML=`ğŸš« ${d.runner}ë‹˜ ì‹¤í–‰ ì¤‘ (${Math.round(d.progress||0)}%)`;
          $btnStart.disabled=true;
          $btnCancel.disabled=true;
        }
      }

      // ë¡œê·¸(ì—¬ê¸°ì„œ ì ˆëŒ€ DOMì— ì§ì ‘ ëˆ„ì í•˜ì§€ ë§ê³  ë²„í¼ë§ë§Œ)
      if(Array.isArray(d.logs)){ for(const l of d.logs){ appendLog(l); } }

      if(d.status==="START" || d.status==="IN_PROGRESS"){ lockUI(); }

      if(d.status==="COMPLETED"){
        setBar($barTotal,$pctTotal,100);
        $badgeTotal.textContent="âœ… ì™„ë£Œ";
        if(!isOwner) resetUI();
        else { $btnStart.disabled=false; $btnCancel.disabled=true; }
      }

      if(d.status==="CANCELLED" || d.status==="FAILED"){ resetUI(); }
    });

    es.addEventListener("ping", ()=>{ /* heartbeat */ });

    es.onerror = ()=>{
      // ì¬ì—°ê²° ì‹œ ê¸°ì¡´ ì—°ê²°ì„ ì¦‰ì‹œ ë‹«ì•„ ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ ë°©ì§€
      try{es.close();}catch(_){}
      es=null;
      connected=false;
      setTimeout(connect, 1500);
    };

    // íƒ­ ë‹«ê¸°/ìƒˆë¡œê³ ì¹¨ ì‹œ ì—°ê²° ì •ë¦¬
    window.addEventListener("beforeunload",()=>{
      if(es){ try{es.close();}catch(_){ } es=null; connected=false; }
    });

    // SSE ì•ˆì •í™” í›„ ìƒíƒœ ë³µì›
    setTimeout(restoreStatus, 800);
  }

  // ì‹œì‘
  $btnStart.onclick=async()=>{
    resetUI(); setBar($barTotal,$pctTotal,0);
    $btnStart.disabled=true; $btnCancel.disabled=true;
    const url=`/api/stock/batch/update?workers=${$workers.value||8}${$force.checked?"&force=true":""}`;
    const res=await fetch(url,{method:"POST",credentials:"include"});
    if(res.ok){
      const d=await res.json().catch(()=>({}));
      currentTaskId=d.taskId||null;
    } else {
      appendLog("âš ï¸ ë‹¤ë¥¸ ì‚¬ìš©ì ì‘ì—… ì¤‘");
    }
  };

  // ì·¨ì†Œ
  $btnCancel.onclick=async()=>{
    if(!isOwner||!currentTaskId) return;
    await fetch(`/api/stock/batch/cancel/${currentTaskId}`,{method:"POST",credentials:"include"});
  };

  // ë¡œê·¸ ë³µì‚¬
  $copy.onclick=()=>{
    // í˜„ì¬ ë©”ëª¨ë¦¬ì— ìˆëŠ” ìµœê·¼ MAX_LOG_LINES ê¸°ì¤€ìœ¼ë¡œ ë³µì‚¬
    const text = logLines.length>0 ? logLines.join("\n") : ($log.textContent||"");
    navigator.clipboard.writeText(text);
    $copy.textContent="âœ…"; setTimeout(()=>{$copy.textContent="ğŸ“„";},900);
  };

  connect();
})();
</script>
</th:block>


</body>
</html>
