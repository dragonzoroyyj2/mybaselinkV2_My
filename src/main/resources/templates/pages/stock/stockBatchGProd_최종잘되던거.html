<!-- stockBatchGProd.html -->
<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
<meta charset="UTF-8">
<title>ğŸ“Š Stock Batch GProd</title>

<style>
  :root{
    --main-bg:#f3f4f6;--card-bg:#ffffff;--text-color-primary:#111827;--text-color-secondary:#6b7280;
    --border-color-default:#d1d5db;--input-bg:#ffffff;--progress-bar-bg:#e5e7eb;
    --log-box-bg:#111;--log-text-default:#e0e0e0;--log-text-info:#9ca3af;--log-text-progress:#60a5fa;
    --log-text-warning:#f59e0b;--log-text-error:#ef4444;--log-text-complete:#22c55e;
  }
  h2{font-size:1.3rem;font-weight:700;margin-bottom:.4rem;color:var(--text-color-primary);}
  .card-box,.dashboard-cards,.log-wrapper{background:var(--card-bg);border-radius:12px;padding:18px;box-shadow:0 2px 6px rgba(0,0,0,.15);margin-top:14px;}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-size:.9rem;font-weight:600;color:#fff;min-width:110px;text-align:center;}
  .btn-start{background:#2563eb;}
  .btn-cancel{background:#dc2626;}
  .btn:disabled{opacity:.5;cursor:not-allowed;}
  .controls{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;}
  input[type=number],select{width:90px;padding:.45rem .6rem;border:1px solid var(--border-color-default);border-radius:6px;color:var(--text-color-primary);background-color:var(--input-bg);}
  .dashboard-cards{display:flex;flex-wrap:wrap;gap:14px;}
  .card{flex:1 1 300px;background:var(--card-bg);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.05);display:flex;flex-direction:column;}
  .card-header{display:flex;align-items:center;gap:6px;font-size:.95rem;font-weight:600;margin-bottom:6px;}
  .card-header i{color:#2563eb;}
  .card-header .right{margin-left:auto;font-weight:600;font-size:.9rem;}
  .progress-bar{width:100%;background:var(--progress-bar-bg);height:14px;border-radius:7px;margin-top:10px;overflow:hidden;}
  .progress-bar div{height:100%;width:0%;transition:width .25s;}
  .bar-total div{background:#2563eb;}
  .bar-krx div{background:#10b981;}
  .bar-data div{background:#f59e0b;}
  .log-wrapper h3{display:flex;align-items:center;justify-content:space-between;margin:0;font-size:1rem;padding-bottom:4px;border-bottom:1px solid var(--border-color-default);}
  .copy-btn{display:flex;align-items:center;gap:4px;font-size:.9rem;cursor:pointer;user-select:none;margin-left:10px;color:#3b82f6;opacity:.9;padding:4px 8px;border-radius:6px;}
  .log-box{background:var(--log-box-bg);color:var(--log-text-default);font-family:Consolas,mono;font-size:13px;padding:12px;border-radius:10px;height:240px;overflow:auto;margin-top:6px;line-height:1.4;}
  .log-box p{margin:0;padding:0;white-space:nowrap;}
  .status-pill{margin-left:8px;padding:2px 8px;border-radius:999px;font-size:12px;color:#fff;}
  @media(max-width:640px){.controls{flex-direction:column;align-items:stretch}.btn{width:100%;margin-top:4px}.dashboard-cards .card{flex:1 1 100%}.log-box{height:200px}}
  /* ì „ì—­ ì¹´ë“œ */
  .global-status-card{background:#fff;border:1px solid #d1d5db;border-radius:12px;padding:14px 18px;margin-bottom:12px;box-shadow:inset 0 1px 3px rgba(0,0,0,0.05);}
  .global-status-header{font-weight:600;color:#111827;display:flex;justify-content:space-between;align-items:center;font-size:1rem;}
  .global-status-body{font-size:.9rem;color:#6b7280;display:flex;justify-content:space-between;margin-top:4px;}
  .global-status-progress{width:100%;height:10px;background:#e5e7eb;border-radius:6px;overflow:hidden;margin-top:8px;}
  .global-status-progress div{height:100%;width:0%;background:#2563eb;transition:width .25s;}
  /* ì „ì—­ ìƒíƒœ ìƒ‰ìƒ */
  .status-idle{color:#6b7280;}
  .status-running{color:#2563eb;}
  .status-completed{color:#22c55e;}
  .status-failed,.status-timeout{color:#ef4444;}
  .status-cancelled{color:#f59e0b;}
  /* ğŸ”µ RUNNING í…ìŠ¤íŠ¸ ê¹œë¹¡ì„ */
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.35} }
  .blinking{ animation: blink 1.2s infinite; }
</style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <div class="page-header">
      <div class="page-title"><h2>ğŸ“Š ì „ì—­(Global) ë°ì´í„° ì—…ë°ì´íŠ¸</h2></div>
      <div class="breadcrumb"><i class="fas fa-database"></i><span>ë°ì´í„° / Global ì—…ë°ì´íŠ¸</span></div>
    </div>

    <!-- ì „ì—­ ìƒíƒœ ì¹´ë“œ -->
    <div class="global-status-card">
      <div class="global-status-header">
        ğŸŒ ì „ì—­(Global) ì§„í–‰ ìƒíƒœ
        <span id="globalStatusText">-</span>
      </div>
      <div class="global-status-body">
        <div>ì‹¤í–‰ì: <span id="globalRunner">-</span></div>
        <div>ì „ì²´ ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div>
      </div>
      <div class="global-status-progress"><div id="globalProgressBar"></div></div>
    </div>

    <!-- ì œì–´ -->
    <div class="card-box">
      <div class="controls">
        <label>ì›Œì»¤:<input type="number" id="workers" value="16" min="1" max="16"></label>
        <label>ìˆ˜ì§‘ ê¸°ê°„ (ë…„):
          <select id="historyYears">
            <option value="3" selected>3ë…„</option><option value="4">4ë…„</option>
            <option value="5">5ë…„</option><option value="6">6ë…„</option>
            <option value="7">7ë…„</option><option value="8">8ë…„</option>
            <option value="9">9ë…„</option><option value="10">10ë…„</option>
          </select>
        </label>
        <label><input type="checkbox" id="force"> ê°•ì œ ë‹¤ìš´ë¡œë“œ</label>
        <button id="btnStart" class="btn btn-start">ì—…ë°ì´íŠ¸ ì‹œì‘</button>
        <button id="btnCancel" class="btn btn-cancel" disabled>ì·¨ì†Œ</button>
        <span id="connStatus"></span>
      </div>
      <div id="adminHint" style="font-size:12px;color:#6b7280;margin-top:4px;">
        <span id="hintStatus">â€» ê´€ë¦¬ìë§Œ ì‹¤í–‰ ê°€ëŠ¥</span>
        <span id="hintTimer" style="margin-left:10px;color:#6b7280;"></span>
      </div>
    </div>

    <div class="dashboard-cards">
      <div class="card">
        <div class="card-header"><i class="fas fa-layer-group"></i>ì „ì²´ ì§„í–‰ë¥ 
          <span class="right" id="badgeTotal">-</span>
        </div>
        <strong id="pctTotal">0%</strong>
        <div class="progress-bar bar-total"><div id="barTotal"></div></div>
      </div>

      <div class="card">
        <div class="card-header"><i class="fas fa-database"></i>KRX ì¢…ëª© ëª©ë¡
          <span class="right" id="badgeKrx"></span>
        </div>
        <strong id="pctKrx">0%</strong>
        <div class="progress-bar bar-krx"><div id="barKrx"></div></div>
      </div>

      <div class="card">
        <div class="card-header"><i class="fas fa-chart-line"></i>ê°œë³„ ì¢…ëª© ë°ì´í„°
          <span class="right" id="badgeData"></span>
        </div>
        <strong id="pctData">0%</strong>
        <div class="progress-bar bar-data"><div id="barData"></div></div>
      </div>
    </div>

    <div class="log-wrapper">
      <h3>ì‹¤ì‹œê°„ ë¡œê·¸
        <span class="copy-btn" id="copyLogBtn"><i class="fas fa-copy"></i> ë¡œê·¸ ë³µì‚¬</span>
      </h3>
      <div id="logBox" class="log-box"><p class="log-info">ë¡œê·¸ ëŒ€ê¸°ì¤‘...</p></div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
(function() {
  const $globalStatusText = document.getElementById("globalStatusText"),
        $globalRunner = document.getElementById("globalRunner"),
        $globalProgressLabel = document.getElementById("globalProgressLabel"),
        $globalProgressBar = document.getElementById("globalProgressBar"),

        $btnStart = document.getElementById("btnStart"),
        $btnCancel = document.getElementById("btnCancel"),

        $barTotal = document.getElementById("barTotal"),
        $pctTotal = document.getElementById("pctTotal"),
        $badgeTotal = document.getElementById("badgeTotal"),

        $barKrx = document.getElementById("barKrx"),
        $pctKrx = document.getElementById("pctKrx"),
        $badgeKrx = document.getElementById("badgeKrx"),

        $barData = document.getElementById("barData"),
        $pctData = document.getElementById("pctData"),
        $badgeData = document.getElementById("badgeData"),

        $log = document.getElementById("logBox"),
        $workers = document.getElementById("workers"),
        $force = document.getElementById("force"),
        $historyYears = document.getElementById("historyYears"),
        $hintTimer = document.getElementById("hintTimer");

  let currentTaskId = null, es = null, startTime = null, timerInterval = null;
  let currentUser = "-"; // ğŸ‘¤ í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì

  // âœ… í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì í™•ì¸
  async function initCurrentUser() {
    try {
      const res = await fetch("/auth/me", { credentials: "include" });
      if (!res.ok) return "-";
      const data = await res.json();
      return data.username || data.fullName || "-";
    } catch {
      return "-";
    }
  }

  // âœ… ì§„í–‰ë¥  í‘œì‹œ í•¨ìˆ˜
  function setBar(bar, pctEl, pctVal, status) {
    let v = Math.max(0, Math.min(100, Math.floor(pctVal || 0)));
    if (v >= 100 && ["FAILED","CANCELLED","TIMEOUT"].includes((status || "").toUpperCase())) {
      v = Math.max(0, v - 1); // ì‹¤íŒ¨ ì‹œ 99%ë¡œ ë³´ì •
    }
    bar.style.width = v + "%";
    pctEl.textContent = v + "%";
  }

  // âœ… ë¡œê·¸ ì¶”ê°€
  function appendLog(msg) {
    if (!msg) return;
    const p = document.createElement("p");
    p.textContent = msg;
    $log.appendChild(p);
    $log.scrollTop = $log.scrollHeight;
  }

  // âœ… íƒ€ì´ë¨¸
  function startTimer() {
    startTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      const sec = Math.floor((Date.now() - startTime) / 1000);
      const m = Math.floor(sec / 60), s = sec % 60;
      $hintTimer.textContent = `â± ${m > 0 ? m + "ë¶„ " : ""}${s}ì´ˆ ê²½ê³¼`;
    }, 1000);
  }
  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  // âœ… ì „ì—­ ìƒíƒœ í…ìŠ¤íŠ¸ / ìƒ‰ìƒ / ê¹œë¹¡ì„
  function updateGlobalStatus(status, runner, progress) {
    const s = (status || "IDLE").toUpperCase();
    $globalStatusText.textContent = s;
    $globalStatusText.className = "";
    if (s === "RUNNING") {
      $globalStatusText.classList.add("status-running", "blinking");
    } else if (s === "COMPLETED") {
      $globalStatusText.classList.add("status-completed");
    } else if (s === "FAILED") {
      $globalStatusText.classList.add("status-failed");
    } else if (s === "CANCELLED") {
      $globalStatusText.classList.add("status-cancelled");
    } else if (s === "TIMEOUT") {
      $globalStatusText.classList.add("status-timeout");
    } else {
      $globalStatusText.classList.add("status-idle");
    }

    $globalRunner.textContent = runner || "-";
    const v = Math.min(100, Math.max(0, Math.floor(progress || 0)));
    $globalProgressLabel.textContent = v + "%";
    $globalProgressBar.style.width = v + "%";
  }

  // âœ… ì´ˆê¸° ìƒíƒœ ë²„íŠ¼ ì œì–´
  async function initGlobalStatus() {
    try {
      const res = await fetch("/api/global/status", { credentials: "include" });
      if (res.ok) {
        const d = await res.json();
        updateGlobalStatus(d.status, d.runner, d.progress);
        const isRunning = (d.status || "").toUpperCase() === "RUNNING";
        if (isRunning) {
          if (d.runner && d.runner === currentUser) {
            $btnStart.disabled = true;
            $btnCancel.disabled = false; // ì‹¤í–‰ì â†’ ì·¨ì†Œ ê°€ëŠ¥
          } else {
            $btnStart.disabled = true;
            $btnCancel.disabled = true;  // ëŒ€ê¸°ì â†’ ë‘˜ ë‹¤ ë¹„í™œì„±
          }
        } else {
          $btnStart.disabled = false;
          $btnCancel.disabled = true;
        }
      }
    } catch {}
  }

  // âœ… ìƒˆë¡œê³ ì¹¨ í›„ taskId ë³µì›
  async function initActiveTask() {
    try {
      const res = await fetch("/api/stock/batch/gprod/active", { credentials: "include" });
      if (!res.ok) return;
      const d = await res.json();
      if (d && d.active) {
        currentTaskId = d.taskId || null;
        if (d.runner && d.runner === currentUser) {
          $btnStart.disabled = true;
          $btnCancel.disabled = false;
        }
      }
    } catch {}
  }

  // âœ… SSE ì—°ê²°
  function connect() {
    if (es) { try { es.close(); } catch {} }
    es = new EventSource("/api/stock/batch/gprod/sse", { withCredentials: true });

    es.addEventListener("status", e => {
      const d = JSON.parse(e.data || "{}");

      if (d.globalStatus) updateGlobalStatus(d.globalStatus, d.globalRunner, d.globalProgress);

      if (typeof d.krxTotal === "number" && typeof d.krxSaved === "number" && d.krxTotal > 0) {
        setBar($barKrx, $pctKrx, (d.krxSaved * 100 / d.krxTotal), d.status);
        $badgeKrx.textContent = `${d.krxSaved}/${d.krxTotal}`;
      }
      if (typeof d.dataTotal === "number" && typeof d.dataSaved === "number" && d.dataTotal > 0) {
        setBar($barData, $pctData, (d.dataSaved * 100 / d.dataTotal), d.status);
        $badgeData.textContent = `${d.dataSaved}/${d.dataTotal}`;
      }

      if (typeof d.progress === "number") {
        setBar($barTotal, $pctTotal, d.progress, d.status);
      }

      if (Array.isArray(d.logs)) d.logs.forEach(appendLog);

      const isOwner = (typeof d.owner === "boolean") ? d.owner : (d.runner && d.runner === currentUser);

      if (d.status === "START") {
        startTimer();
        $btnStart.disabled = true;
        $btnCancel.disabled = isOwner ? false : true;
      }

      if (["IN_PROGRESS","RUNNING"].includes(d.status)) {
        $btnStart.disabled = true;
        $btnCancel.disabled = isOwner ? false : true;
      }

      if (d.status === "COMPLETED") {
        stopTimer();
        $badgeTotal.textContent = "âœ… ì™„ë£Œ";
        $btnStart.disabled = false;
        $btnCancel.disabled = true;
      }

      if (["FAILED","CANCELLED","TIMEOUT"].includes(d.status)) {
        stopTimer();
        $btnStart.disabled = false;
        $btnCancel.disabled = true;
      }

      if (!currentTaskId && d.taskId) currentTaskId = d.taskId;
    });

    es.onerror = () => {
      try { es.close(); } catch {}
      es = null;
      setTimeout(connect, 2000);
    };
  }

  // âœ… ë¡œê·¸ ë³µì‚¬
  document.getElementById("copyLogBtn").onclick = () => {
    const text = Array.from($log.querySelectorAll("p")).map(p => p.textContent).join("\n");
    navigator.clipboard.writeText(text).then(() => appendLog("[LOG] ğŸ“‹ ë¡œê·¸ ë³µì‚¬ ì™„ë£Œ"));
  };

  // âœ… ì‹¤í–‰
  $btnStart.onclick = async () => {
    $btnStart.disabled = true;
    $btnCancel.disabled = false;
    const url = `/api/stock/batch/gprod/start?workers=${$workers.value || 16}&historyYears=${$historyYears.value || 3}&force=${$force.checked}`;
    const res = await fetch(url, { method: "POST", credentials: "include" });
    if (res.ok) {
      const d = await res.json();
      currentTaskId = d.taskId;
      appendLog("ğŸŸ¢ ì‹¤í–‰ ì‹œì‘ë¨: " + (d.runner || "ê´€ë¦¬ì"));
      startTimer();
    } else {
      const err = await res.json().catch(() => ({ error: `ì„œë²„ ì˜¤ë¥˜ (${res.status})` }));
      appendLog("âš ï¸ ì‹¤í–‰ ì‹¤íŒ¨: " + (err.error || "Unknown"));
      $btnStart.disabled = false;
      $btnCancel.disabled = true;
    }
  };

  // âœ… ì·¨ì†Œ
  $btnCancel.onclick = async () => {
    if (!currentTaskId) return;
    const res = await fetch(`/api/stock/batch/gprod/cancel/${currentTaskId}`, { method: "POST", credentials: "include" });
    if (res.ok) {
      appendLog("ğŸŸ¥ ì‘ì—… ì·¨ì†Œë¨");
      stopTimer();
      $btnStart.disabled = false;
      $btnCancel.disabled = true;
    } else {
      appendLog("âš ï¸ ì·¨ì†Œ ì‹¤íŒ¨ (" + res.status + ")");
    }
  };

  // âœ… ì´ˆê¸° ì‹¤í–‰
  (async function() {
    currentUser = await initCurrentUser();
    await initGlobalStatus();
    await initActiveTask();
    connect();
  })();
})();
</script>
</th:block>

