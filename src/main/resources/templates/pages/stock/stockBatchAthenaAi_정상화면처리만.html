<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š AthenaAI ë°°ì¹˜ ì—…ë°ì´íŠ¸</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Font Import URL */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
    <!-- Chart.js and Adapter for Time Series -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
      :root {
        --main-bg: #f3f4f6;
        --card-bg: #ffffff;
        --text-color-primary: #111827;
        --text-color-secondary: #6b7280;
        --border-color-default: #d1d5db;
        --input-bg: #ffffff;
        --progress-bar-bg: #e5e7eb;
        --log-box-bg: #111; 
        --log-text-default: #e0e0e0;
        --log-text-info: #9ca3af;
        --log-text-progress: #60a5fa;
        --log-text-warning: #f59e0b;
        --log-text-error: #ef4444;
        --log-text-complete: #22c55e;
        --card-border: #d1d5db;
        --error-card-bg: #fff;
        --error-card-border: #e5e7eb;
        --error-card-text: #374151;
        --error-card-hover: #fee2e2;
        --error-card-header: #b91c1c;
      }
      /* Dark mode styles would go here if needed */

      .global-status-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 14px 18px;
        margin-bottom: 12px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
      }
      .global-status-header {
        font-weight: 600;
        color: var(--text-color-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1rem;
      }
      .global-status-body {
        font-size: .9rem;
        color: var(--text-color-secondary);
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
      }
      .global-status-progress {
        width: 100%;
        height: 10px;
        background: var(--progress-bar-bg);
        border-radius: 6px;
        overflow: hidden;
        margin-top: 8px;
      }
      .global-status-progress div {
        height: 100%;
        width: 0%;
        background: #2563eb;
        transition: width .25s;
      }
      .status-idle{color:#6b7280;}
      .status-running{color:#2563eb;}
      .status-completed{color:#22c55e;}
      .status-failed,.status-timeout{color:#ef4444;}
      .status-cancelled{color:#f59e0b;}
      @keyframes blink {0%,100%{opacity:1}50%{opacity:.35}}
      .blinking{animation:blink 1.2s infinite;}

      /* ì·¨ì†Œ ë²„íŠ¼ ìœ„ì¹˜ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
      .run-controls-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75rem; /* Tailwind: gap-3 */
        margin-top: 2rem; /* Tailwind: mt-8 */
      }
      
      /* Option Card Styles */
      .option-card {
        @apply p-4 rounded-xl border border-gray-200 shadow-md transition duration-150 cursor-pointer;
      }
      input[type="radio"]:checked + .option-card {
        @apply border-indigo-500 bg-indigo-50 shadow-lg;
      }

      /* Modal and Chart Styles */
      #chartModal.active {
          opacity: 1;
          pointer-events: auto;
      }
      .modal-content {
          transform: scale(0.9);
          opacity: 0;
          transition: all 0.3s ease-out;
      }
      #chartModal.active .modal-content {
          transform: scale(1);
          opacity: 1;
      }
    </style>
</head>
<body>


<div layout:fragment="content">
  <div class="content-container">

    <div class="page-header">
      <div class="page-title">
        <h2 th:text="${pageTitle} ?: 'ğŸ“„ êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜'">ğŸ“„ êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜</h2>
      </div>
      <div class="breadcrumb">
        <i class="fas fa-folder-open"></i>
        <span th:text="${breadcrumb} ?: 'ì‹œìŠ¤í…œ / ë¶„ì„ ë„êµ¬ (AthenaAi)'">ì‹œìŠ¤í…œ / ë¶„ì„ ë„êµ¬ (AthenaAi)</span>
      </div>
    </div>

    <div class="global-status-card">
        <div class="global-status-header">
          ğŸŒ AthenaAI ë°°ì¹˜ ì§„í–‰ ìƒíƒœ
          <span id="globalStatusText" class="status-idle">ëŒ€ê¸°ì¤‘</span>
        </div>
        <div class="global-status-body">
          <div>ì‹¤í–‰ì: <span id="globalRunner">ë¯¸ì—°ê²°</span></div>
          <div>ì „ì²´ ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div>
        </div>
        <div class="global-status-progress"><div id="globalProgressBar"></div></div>
    </div>
    <div class="card mb-8">
            
            <div id="errorMessageContainer" class="hidden p-3 mb-6 bg-red-100 border border-red-400 text-red-700 rounded-lg font-semibold transition-all duration-300" role="alert">
                <span id="errorMessageTitle" class="font-bold mr-2"></span>
                <span id="errorMessageText"></span>
            </div>
            
            <form id="analysisForm">
                
                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-0 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('analysisTypeContent', this)">
                    <span>1. ë¶„ì„ ìœ í˜• ì„ íƒ</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="analysisTypeContent" class="pb-4 transition-all duration-300 ease-in-out">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        
                        <label for="maRadio" class="block">
                            <input type="radio" name="analysisType" id="maRadio" value="ma" checked 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-indigo-500">ğŸ“‰</span> ì´ë™í‰ê· ì„ (MA) ë¶„ì„ (Default)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ì¥ê¸° í•˜ë½ì¶”ì„¸ ì§„í–‰ ì¢…ëª© íƒìƒ‰</p>
                                <div id="maPeriodsContainer" class="ml-0 mt-3 p-3 bg-indigo-100/50 rounded-lg transition-all duration-300">
                                    <h4 class="font-semibold text-indigo-700 mb-2 text-sm">MA ê¸°ê°„ ì„ íƒ (í•˜ë½ë°°ì—´ í™•ì¸):</h4>
                                    <div class="flex flex-wrap gap-x-4 gap-y-2">
                                        <input type="checkbox" name="maPeriods" value="60" id="ma60" checked class="rounded text-indigo-600"> 
                                        <label for="ma60" class="text-sm">60ì¼ì„ </label>
                                        
                                        <input type="checkbox" name="maPeriods" value="200" id="ma200" checked class="rounded text-indigo-600"> 
                                        <label for="ma200" class="text-sm">200ì¼ì„ </label>
                                        
                                        <input type="checkbox" name="maPeriods" value="500" id="ma500" checked class="rounded text-indigo-600" disabled> 
                                        <label for="ma500" id="ma500Label" class="text-sm opacity-50">500ì¼ì„ </label>
                                        <span id="ma500Hint" class="text-red-500 text-xs font-semibold">(ìµœì†Œ 3ë…„ í•„ìš”)</span>
                                    </div>
                                </div>
                            </div>
                        </label>

                        <label for="doubleBottomRadio" class="block">
                            <input type="radio" name="analysisType" id="doubleBottomRadio" value="double_bottom" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-green-500">ğŸ“ˆ</span> ì´ì¤‘ë°”ë‹¥ (Wìí˜• íŒ¨í„´)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ê°•ë ¥í•œ ì¶”ì„¸ ë°˜ì „ ì´ˆê¸° ì‹ í˜¸ íƒìƒ‰</p>
                            </div>
                        </label>

                        <label for="tripleBottomRadio" class="block">
                            <input type="radio" name="analysisType" id="tripleBottomRadio" value="triple_bottom" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-green-500">ğŸ“Š</span> ì‚¼ì¤‘ë°”ë‹¥ íŒ¨í„´
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ë°”ë‹¥ ë‹¤ì§€ê¸°ê°€ ì™„ë£Œëœ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>

                        <label for="cupAndHandleRadio" class="block">
                            <input type="radio" name="analysisType" id="cupAndHandleRadio" value="cup_and_handle" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-amber-500">â˜•</span> ì»µì•¤í•¸ë“¤ íŒ¨í„´
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ëŒíŒŒ ì§ì „ì˜ ìƒìŠ¹ ìœ ë ¥ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>
                        
                        <label for="decline5dRadio" class="block">
                            <input type="radio" name="analysisType" id="decline5dRadio" value="decline_5d" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-red-600">ğŸ”»</span> ë‹¨ê¸° ê¸‰ë½ì£¼ (5ì¼ ì—°ì† í•˜ë½)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ì¼ì£¼ì¼ê°„ ë§¤ë„ì„¸ê°€ ì§‘ì¤‘ëœ ê³¼ëŒ€ ë‚™í­ì£¼ íƒìƒ‰</p>
                            </div>
                        </label>

                        <label for="decline20dRadio" class="block">
                            <input type="radio" name="analysisType" id="decline20dRadio" value="decline_20d" 
                                class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-red-700">â¬‡ï¸</span> ì¤‘ê¸° ì—°ì† í•˜ë½ (20ì¼ ì—°ì† í•˜ë½)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">í•œ ë‹¬ê°„ ëšœë ·í•œ ë°˜ë“± ì—†ì´ í•˜ë½í•œ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>
                        
                    </div>
                </div>

                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('filteringOptionsContent', this)">
                    <span>2. ì¶”ê°€ í•„í„°ë§ ì˜µì…˜</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="filteringOptionsContent" class="pb-4 transition-all duration-300 ease-in-out">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-white rounded-lg border border-red-200 shadow-sm flex items-center">
                            <input type="checkbox" id="excludeNegatives" name="excludeNegatives" checked
                                class="mr-3 h-5 w-5 rounded text-red-500 focus:ring-red-400 border-gray-300">
                            <label for="excludeNegatives" class="text-lg text-red-700 font-bold flex-grow">
                                ğŸš¨ ì•…ì¬ ì¢…ëª© ì œì™¸ í•„í„°
                            </label>
                        </div>
                        
                        <div class="p-4 bg-white rounded-lg border border-blue-200 shadow-sm flex items-center">
                            <span class="mr-3 text-blue-700 font-bold">ğŸ“… ë¶„ì„ ê¸°ê°„:</span>
                            <input type="number" id="dataPeriodYears" value="5" min="1" max="10" 
                                oninput="updateMaCheckboxes()"
                                class="w-16 px-3 py-1 border border-blue-300 rounded-lg text-center font-bold text-lg focus:ring-blue-500">
                            <span class="ml-2 text-blue-800 font-semibold">ë…„ì¹˜</span>
                        </div>
                        
                        <div class="p-4 bg-white rounded-lg border border-purple-200 shadow-sm flex items-center">
                            <span class="mr-3 text-purple-700 font-bold">ğŸ› ï¸ ì‘ì—…ì ìˆ˜:</span>
                            <input type="number" id="workerCount" value="8" min="1" max="16" 
                                class="w-16 px-3 py-1 border border-purple-300 rounded-lg text-center font-bold text-lg focus:ring-purple-500">
                            <span class="ml-2 text-purple-800 font-semibold">ê°œ</span>
                        </div>
                    </div>
                </div>

                <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('topNCountContent', this)">
                    <span>3. ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ ì„¤ì •</span>
                    <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
                </button>
                <div id="topNCountContent" class="pb-4 transition-all duration-300 ease-in-out">
                    <div class="flex items-center bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label for="topNCount" class="text-lg text-gray-700 font-medium mr-4">ìƒìœ„ ì¢…ëª© ê°œìˆ˜ (N):</label>
                        <input type="number" id="topNCount" value="10" min="1" max="50" 
                            class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-center font-bold text-xl">
                        <span class="ml-4 text-gray-500 text-sm">1ì—ì„œ 50 ì‚¬ì´</span>
                    </div>
                </div>

            </form>

            <div class="run-controls-wrapper">
                <button type="button" onclick="runAnalysis()" id="runAnalysisBtn"
                        class="flex-grow px-6 py-3 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                    ğŸš€ ë¶„ì„ ì‹¤í–‰ ë° ìœ ë§ ì¢…ëª© ì°¾ê¸°
                </button>
                
                <button type="button" id="btnCancel" onclick="cancelAnalysis()" class="px-6 py-3 bg-red-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50" disabled>
                    âŒ ì·¨ì†Œ
                </button>
            </div>
            
            <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('resultsContent', this)">
                <span>4. ë¶„ì„ ê²°ê³¼</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>
            <div id="resultsContent" class="hidden pb-4 transition-all duration-300 ease-in-out">
                <div id="resultsContainer" class="relative">
                    <div id="resultsDisplay" class="p-0 bg-white min-h-[120px]">
                        <p class="p-4 text-gray-500">ë¶„ì„ ì‹¤í–‰ í›„ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
    
                    <div id="loadingOverlay" class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center hidden transition-opacity duration-300 rounded-xl border-4 border-blue-400 p-8 z-20">
                        <div class="text-4xl animate-spin text-blue-600">âš™ï¸</div>
                        <p class="mt-4 text-xl font-bold text-blue-600">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
                        <p class="text-gray-500 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”. ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>

            <button type="button" class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-8 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150" onclick="toggleSection('logContent', this)">
                <span>5. ì‹¤ì‹œê°„ ë¡œê·¸</span>
                <span class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>
            <div id="logContent" class="pb-4 transition-all duration-300 ease-in-out">
                <div id="logDisplay" class="h-48 bg-gray-800 text-gray-200 p-4 overflow-y-scroll rounded-xl font-mono text-sm border border-gray-700">
                    <div class="log-line"><span style="color:#9ca3af;">[INFO]</span> ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì„ í™•ì¸ ì¤‘...</div>
                </div>
            </div>
            
        </div>
        </div>

    <div id="chartModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300 pointer-events-none">
        <div id="modalContent" class="modal-content bg-white rounded-xl p-6 sm:p-8 shadow-2xl max-w-5xl w-full h-[95vh] sm:h-[90vh] flex flex-col">
            
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b pb-3">
                <h3 id="modalTitle" class="text-xl sm:text-3xl font-bold text-indigo-700 mb-2 sm:mb-0 truncate">ì°¨íŠ¸ ìƒì„¸ ë¶„ì„</h3>
                <div class="flex space-x-2 flex-shrink-0">
                    <button onclick="simulateZoom('out')" class="px-2 py-1 sm:px-3 sm:py-1 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300 transition">
                        ğŸ” ì¶•ì†Œ
                    </button>
                    <button onclick="simulateZoom('in')" class="px-2 py-1 sm:px-3 sm:py-1 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300 transition">
                        ğŸ” í™•ëŒ€
                    </button>
                    <button onclick="closeChartModal()" class="px-3 py-1 sm:px-4 sm:py-1 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition">
                        âœ–ï¸ ë‹«ê¸°
                    </button>
                </div>
            </div>

            <div class="flex-grow overflow-hidden bg-gray-100 rounded-lg p-2">
                <canvas id="stockChartCanvas" class="w-full h-full"></canvas>
            </div>

            <div id="chartZoomInfo" class="mt-4 text-center text-gray-500 text-xs sm:text-sm">
                (í˜„ì¬: ê¸°ë³¸ ì°¨íŠ¸ ë²”ìœ„) ì°¨íŠ¸ ë°ì´í„°ëŠ” ì‹œë®¬ë ˆì´ì…˜ì´ë©° ì‹¤ì œ ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="pageScript">
    <script>
        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜ (API ì—°ë™ì„ ìœ„í•´ ì‚¬ìš©)
        let currentTaskId = null;
        let sseSimulatorInterval = null; // SSE ì—°ê²°ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” ì¸í„°ë²Œ
        let chartInstance = null;
        
        // =====================================================================
        // 1. UI ë° ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜
        // =====================================================================

        /**
         * ë¡œê·¸ ë©”ì‹œì§€ë¥¼ ì‹¤ì‹œê°„ ë¡œê·¸ ì°½ì— ì¶”ê°€í•˜ê³  ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ë‚´ë¦½ë‹ˆë‹¤.
         */
        function logMessage(message, level = 'info') {
            const logDisplay = document.getElementById('logDisplay');
            const now = new Date();
            const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            
            let color = '';
            let label = '';

            switch (level) {
                case 'progress':
                    color = '#60a5fa'; // Tailwind blue-400
                    label = 'PROGRESS';
                    break;
                case 'warning':
                    color = '#f59e0b'; // Tailwind amber-500
                    label = 'WARN';
                    break;
                case 'error':
                    color = '#ef4444'; // Tailwind red-500
                    label = 'ERROR';
                    break;
                case 'complete':
                    color = '#22c55e'; // Tailwind green-500
                    label = 'COMPLETE';
                    break;
                case 'info':
                default:
                    color = '#9ca3af'; // Tailwind gray-400
                    label = 'INFO';
            }

            const logLine = document.createElement('div');
            logLine.classList.add('log-line', 'mt-1');
            logLine.innerHTML = `<span style="color: #6b7280;">[${timeString}]</span> <span style="color:${color}; font-weight: 600;">[${label}]</span> ${message}`;
            logDisplay.appendChild(logLine);
            
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }

        /**
         * ì „ì—­ ìƒíƒœ ì¹´ë“œ(Global Status Card)ì˜ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateGlobalStatus(progress, statusText, statusClass, runner = 'ë¯¸ì—°ê²°') {
            const statusLabel = document.getElementById('globalStatusText');
            const progressBar = document.getElementById('globalProgressBar');
            const progressLabel = document.getElementById('globalProgressLabel');
            const runnerLabel = document.getElementById('globalRunner');

            // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            statusLabel.textContent = statusText;
            progressLabel.textContent = `${Math.round(progress)}%`;
            if (runner !== 'ë¯¸ì—°ê²°') {
                 runnerLabel.textContent = runner;
            }

            // ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            statusLabel.className = statusClass;
            statusLabel.classList.toggle('blinking', statusClass === 'status-running' && progress < 100);
            
            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
            progressBar.style.width = `${progress}%`;

            // ë¡œë”© ì˜¤ë²„ë ˆì´ ì œì–´
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (statusClass === 'status-running' && progress < 100) {
                loadingOverlay.classList.remove('hidden');
            } else {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        /**
         * ì„¹ì…˜ ë‚´ìš© í‘œì‹œ/ìˆ¨ê¹€ì„ í† ê¸€í•©ë‹ˆë‹¤.
         */
        function toggleSection(contentId, button) {
            const content = document.getElementById(contentId);
            const icon = button.querySelector('span.transition-transform');
            
            if (content.classList.contains('hidden')) {
                // ì—´ê¸°
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                // ë‹«ê¸°
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        /**
         * ë¶„ì„ ìœ í˜•ì´ MAì¼ ë•Œë§Œ ê¸°ê°„ ì„ íƒ ì˜µì…˜ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function toggleMaPeriods() {
            const maPeriodsContainer = document.getElementById('maPeriodsContainer');
            const maRadio = document.getElementById('maRadio');

            if (maRadio.checked) {
                maPeriodsContainer.style.display = 'block';
            } else {
                maPeriodsContainer.style.display = 'none';
            }
        }

        /**
         * ë°ì´í„° ê¸°ê°„(ë…„)ì— ë”°ë¼ 500ì¼ì„  ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateMaCheckboxes() {
            const dataPeriodYears = parseInt(document.getElementById('dataPeriodYears').value, 10);
            const ma500 = document.getElementById('ma500');
            const ma500Label = document.getElementById('ma500Label');
            const ma500Hint = document.getElementById('ma500Hint');

            if (dataPeriodYears >= 3) {
                ma500.disabled = false;
                ma500.checked = true;
                ma500Label.classList.remove('opacity-50');
                ma500Hint.classList.add('hidden');
            } else {
                ma500.disabled = true;
                ma500.checked = false;
                ma500Label.classList.add('opacity-50');
                ma500Hint.classList.remove('hidden');
            }
        }

        /**
         * ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  ë¡œê·¸ì— ê¸°ë¡í•©ë‹ˆë‹¤.
         */
        function displayError(title, text) {
            const container = document.getElementById('errorMessageContainer');
            document.getElementById('errorMessageTitle').textContent = title;
            document.getElementById('errorMessageText').textContent = text;
            container.classList.remove('hidden');
            logMessage(`${title}: ${text}`, 'error');
        }

        /**
         * ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
         */
        function hideError() {
            document.getElementById('errorMessageContainer').classList.add('hidden');
        }

        /**
         * UI ì»¨íŠ¸ë¡¤ ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function setControlsState(isRunning) {
            document.getElementById('runAnalysisBtn').disabled = isRunning;
            document.getElementById('btnCancel').disabled = !isRunning;
            
            // í¼ ì…ë ¥ ë¹„í™œì„±í™”/í™œì„±í™”
            const formInputs = document.querySelectorAll('#analysisForm input');
            formInputs.forEach(input => {
                // MA 500ì¼ì„ ì²˜ëŸ¼ ë¡œì§ìƒ disabledì¸ ê²ƒì€ ì œì™¸
                if (input.id !== 'ma500' || !input.disabled) {
                    input.disabled = isRunning;
                }
            });
        }

        // =====================================================================
        // 2. API ë° SSE ì—°ê²° (ì‹œë®¬ë ˆì´ì…˜ í¬í•¨)
        // =====================================================================
        
        // API ìš”ì²­ì— í•„ìš”í•œ íŒŒë¼ë¯¸í„°ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
        function getAnalysisParams() {
            const pattern = document.querySelector('input[name="analysisType"]:checked').value;
            const years = parseInt(document.getElementById('dataPeriodYears').value, 10);
            const workers = parseInt(document.getElementById('workerCount').value, 10);
            const excludeNeg = document.getElementById('excludeNegatives').checked;
            const topN = parseInt(document.getElementById('topNCount').value, 10);

            return { pattern, years, workers, excludeNeg, topN };
        }


        /**
         * ë¶„ì„ ì‹¤í–‰ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (API í˜¸ì¶œ)
         */
        async function runAnalysis() {
            if (currentTaskId) {
                logMessage('ì´ë¯¸ ë¶„ì„ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.', 'warning');
                return;
            }

            const params = getAnalysisParams();

            if (params.topN < 1 || params.topN > 50) {
                displayError('ì…ë ¥ ì˜¤ë¥˜', 'ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ëŠ” 1ì—ì„œ 50 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            hideError();
            setControlsState(true);

            // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° êµ¬ì„±
            const query = new URLSearchParams({
                pattern: params.pattern,
                workers: params.workers,
                years: params.years,
                excludeNeg: params.excludeNeg
            }).toString();

            try {
                const response = await fetch(`/api/stock/batch/athena/start?${query}`, {
                    method: 'POST'
                });
                
                if (response.status === 409) {
                    const data = await response.json();
                    displayError('ì‹¤í–‰ ì¤‘', data.error);
                    setControlsState(false); // ì¬ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                currentTaskId = data.taskId;
                
                logMessage(`[${currentTaskId.substring(0, 8)}] Athena ë¶„ì„ ìš”ì²­ ì„±ê³µ. ì‹¤í–‰ì: ${data.runner}`, 'info');
                
                // SSE ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” EventSourceë¡œ ì—°ê²°)
                connectToSSE(currentTaskId, data.runner, 0);

            } catch (error) {
                displayError('ë¶„ì„ ì‹¤í–‰ ì‹¤íŒ¨', error.message);
                setControlsState(false);
                currentTaskId = null;
            }
        }

        /**
         * ë¶„ì„ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (API í˜¸ì¶œ)
         */
        async function cancelAnalysis() {
            if (!currentTaskId) {
                logMessage('í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            const taskIdToCancel = currentTaskId;
            currentTaskId = null; // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì¦‰ì‹œ ì·¨ì†Œ ìƒíƒœë¡œ ë³€ê²½

            logMessage(`[${taskIdToCancel.substring(0, 8)}] Athena ì·¨ì†Œ ìš”ì²­ ì¤‘...`, 'warning');
            
            if (sseSimulatorInterval) {
                clearInterval(sseSimulatorInterval); // SSE ì‹œë®¬ë ˆì´ì…˜ ì¤‘ë‹¨
            }

            try {
                const response = await fetch(`/api/stock/batch/athena/cancel/${taskIdToCancel}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || response.statusText);
                }

                logMessage(`[${taskIdToCancel.substring(0, 8)}] ë¶„ì„ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'complete');
                updateGlobalStatus(0, 'ëŒ€ê¸°ì¤‘', 'status-idle', 'ë¯¸ì—°ê²°');
                setControlsState(false);

            } catch (error) {
                displayError('ë¶„ì„ ì·¨ì†Œ ì‹¤íŒ¨', error.message);
                updateGlobalStatus(0, 'ì‹¤íŒ¨', 'status-failed');
                setControlsState(false);
            }
        }

        /**
         * SSE ì—°ê²° ì‹œë®¬ë ˆì´ì…˜ (ë°±ì—”ë“œ TaskStatusServiceì˜ ì—­í• ì„ ê°€ì •)
         */
        function connectToSSE(taskId, runner, initialProgress = 0) {
            if (sseSimulatorInterval) clearInterval(sseSimulatorInterval);
            
            // UI ì´ˆê¸°í™”
            document.getElementById('resultsDisplay').innerHTML = '<p class="p-4 text-gray-500">ë¶„ì„ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>';
            setControlsState(true);
            updateGlobalStatus(initialProgress, 'ì‹¤í–‰ ì¤‘', 'status-running', runner);

            let progress = initialProgress;
            let step = 0;
            const totalSteps = 100;
            const taskIdShort = taskId.substring(0, 8);
            
            // ì‹œë®¬ë ˆì´ì…˜ ì¸í„°ë²Œ ì‹œì‘
            sseSimulatorInterval = setInterval(() => {
                // currentTaskIdê°€ nullì´ë©´ ì·¨ì†Œëœ ìƒíƒœ
                if (!currentTaskId || currentTaskId !== taskId) { 
                    clearInterval(sseSimulatorInterval);
                    if (progress < 100) {
                        updateGlobalStatus(progress, 'ì·¨ì†Œë¨', 'status-cancelled', runner);
                        logMessage(`[${taskIdShort}] ë¡œì»¬ SSE ì‹œë®¬ë ˆì´ì…˜ ì¢…ë£Œ (ì·¨ì†Œë¨)`, 'warning');
                    }
                    return;
                }

                if (progress >= totalSteps) {
                    clearInterval(sseSimulatorInterval);
                    
                    // 1. ê²°ê³¼ ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜ (ë°±ì—”ë“œì—ì„œ JSONìœ¼ë¡œ ì „ì†¡ë  ë‚´ìš©)
                    const finalResults = getMockFinalResults(); 
                    renderResults(finalResults, getAnalysisParams().pattern);
                    
                    // 2. ìµœì¢… ìƒíƒœ ì—…ë°ì´íŠ¸
                    updateGlobalStatus(100, 'ì™„ë£Œ', 'status-completed', runner);
                    logMessage(`[${taskIdShort}] ë°°ì¹˜ ë¶„ì„ ì™„ë£Œ. ìµœì¢… ê²°ê³¼ ë Œë”ë§.`, 'complete');
                    
                    // 3. UI ìƒíƒœ ë¦¬ì…‹
                    currentTaskId = null;
                    setControlsState(false);
                    return;
                }

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì‹¤ì œ SSE ë°ì´í„° ìˆ˜ì‹  ê°€ì •)
                progress += (Math.random() * 5) + 3; // Random increase
                progress = Math.min(progress, totalSteps);

                // ë¡œê·¸ ë©”ì‹œì§€ ì‹œë®¬ë ˆì´ì…˜
                if (progress > 10 && step === 0) { logMessage(`[${taskIdShort}] 1/4: ë°ì´í„° ë¡œë”© ë° ì „ì²˜ë¦¬ (ê¸°ê°„: ${getAnalysisParams().years}ë…„)`, 'progress'); step = 1; }
                if (progress > 40 && step === 1) { logMessage(`[${taskIdShort}] 2/4: íŒ¨í„´ ì•Œê³ ë¦¬ì¦˜ ì ìš© (íŒ¨í„´: ${getAnalysisParams().pattern})`, 'progress'); step = 2; }
                if (progress > 75 && step === 2) { logMessage(`[${taskIdShort}] 3/4: ë³‘ë ¬ ì‘ì—…ì(${getAnalysisParams().workers}) ìµœì¢… ì ìˆ˜ ë³‘í•© ì¤‘...`, 'progress'); step = 3; }
                if (progress > 95 && step === 3) { logMessage(`[${taskIdShort}] 4/4: Top ${getAnalysisParams().topN} ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘.`, 'progress'); step = 4; }

                updateGlobalStatus(progress, 'ì‹¤í–‰ ì¤‘', 'status-running', runner);

            }, 500); // 0.5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        }
        
        /**
         * í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì´ ìˆëŠ”ì§€ í™•ì¸ (API í˜¸ì¶œ)
         */
        async function checkActiveTaskOnLoad() {
            logMessage('ë°±ì—”ë“œ Active ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
            try {
                const response = await fetch('/api/stock/batch/athena/active');
                if (!response.ok) {
                    throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
                }
                const data = await response.json();

                if (data.active) {
                    currentTaskId = data.taskId;
                    logMessage(`[${data.taskId.substring(0, 8)}] ê¸°ì¡´ í™œì„± ì‘ì—… ê°ì§€ë¨. (${data.menu})`, 'warning');
                    // ê¸°ì¡´ ì‘ì—…ì— ë‹¤ì‹œ ì—°ê²° (SSE ì‹œë®¬ë ˆì´ì…˜ ì¬ê°œ)
                    connectToSSE(data.taskId, data.runner, data.progress);
                } else {
                    logMessage('í˜„ì¬ í™œì„± ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ë¶„ì„ ì¤€ë¹„ ì™„ë£Œ.', 'info');
                }

            } catch (error) {
                logMessage(`ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            }
        }

        // =====================================================================
        // 3. ê²°ê³¼ ë Œë”ë§ ë° ëª¨ì˜ ë°ì´í„° (ë°±ì—”ë“œ ë°ì´í„° êµ¬ì¡°ë¥¼ ê°€ì •)
        // =====================================================================
        
        /**
         * ë°±ì—”ë“œì—ì„œ JSONìœ¼ë¡œ ì „ì†¡ë  ìµœì¢… ê²°ê³¼ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.
         */
        function getMockFinalResults() {
            const params = getAnalysisParams();
            const mockStocks = [
                { code: '005930', name: 'ì‚¼ì„±ì „ì', score: 98.5, reason: 'ê°•ë ¥í•œ ì´ì¤‘ ë°”ë‹¥ íŒ¨í„´ í˜•ì„± ë° ì™¸êµ­ì¸ ë§¤ìˆ˜ì„¸ ìœ ì…' },
                { code: '000660', name: 'SKí•˜ì´ë‹‰ìŠ¤', score: 95.1, reason: 'MA ê³¨ë“ í¬ë¡œìŠ¤ ì„ë°•, ë©”ëª¨ë¦¬ ë°˜ë„ì²´ ì—…í™© ê°œì„  ê¸°ëŒ€' },
                { code: '035420', name: 'NAVER', score: 92.0, reason: 'ê¸´ ì»µì•¤í•¸ë“¤ íŒ¨í„´ ì™„ì„± í›„ í•¸ë“¤ë¶€ ì§€ì§€ í™•ì¸' },
                { code: '068270', name: 'ì…€íŠ¸ë¦¬ì˜¨', score: 88.7, reason: 'ì‚¼ì¤‘ ë°”ë‹¥ í˜•ì„± í›„ ëŒ€ëŸ‰ ê±°ë˜ëŸ‰ ìˆ˜ë°˜ ì–‘ë´‰ ì¶œí˜„' },
                { code: '005380', name: 'í˜„ëŒ€ì°¨', score: 85.3, reason: '20ì¼ ì—°ì† í•˜ë½ í›„, 500ì¼ì„  ì§€ì§€ ë°˜ë“± ì‹œë„' },
                { code: '003550', name: 'LGì „ì', score: 81.9, reason: 'MA ì—­ë°°ì—´ í•´ì†Œ ì§ì „, ê¸°ê´€ ë§¤ìˆ˜ ì „í™˜ í¬ì°©' },
                { code: '005490', name: 'POSCOí™€ë”©ìŠ¤', score: 78.4, reason: 'ì¥ê¸° í•˜ë½ ë°°ì—´ í•´ì†Œ ê³¼ì •ì˜ ì´ˆê¸° ë‹¨ê³„' },
                { code: '096770', name: 'SKì´ë…¸ë² ì´ì…˜', score: 75.2, reason: 'ë‹¨ê¸° ê¸‰ë½ì— ë”°ë¥¸ ê³¼ëŒ€ ë‚™í­ êµ¬ê°„ ì§„ì… í›„ ë°˜ë“± ê¸°ëŒ€' },
                { code: '051910', name: 'LGí™”í•™', score: 72.0, reason: '5ì¼ ì—°ì† í•˜ë½ì— ë”°ë¥¸ ê¸°ìˆ ì  ë°˜ë“± ê°€ëŠ¥ì„±' },
                { code: '032830', name: 'ì‚¼ì„±ìƒëª…', score: 68.9, reason: 'ì—…ì¢… ë‚´ ì„ ë‘ì£¼ì, ì•ˆì •ì ì¸ í€ë”ë©˜í„¸ ê¸°ë°˜ íŒ¨í„´' },
            ];

            const analysisMap = {
                'ma': 'ì´ë™í‰ê· ì„  ë°°ì—´ ë¶„ì„',
                'double_bottom': 'ì´ì¤‘ë°”ë‹¥ íŒ¨í„´ ë¶„ì„',
                'triple_bottom': 'ì‚¼ì¤‘ë°”ë‹¥ íŒ¨í„´ ë¶„ì„',
                'cup_and_handle': 'ì»µì•¤í•¸ë“¤ íŒ¨í„´ ë¶„ì„',
                'decline_5d': 'ë‹¨ê¸° ê¸‰ë½ì£¼ ë¶„ì„',
                'decline_20d': 'ì¤‘ê¸° ì—°ì† í•˜ë½ ë¶„ì„'
            };
            
            return {
                type: analysisMap[params.pattern] || 'ì•Œ ìˆ˜ ì—†ëŠ” ë¶„ì„',
                count: params.topN,
                stocks: mockStocks.slice(0, params.topN).map((stock, index) => ({
                    ...stock,
                    rank: index + 1
                }))
            };
        }

        /**
         * ë¶„ì„ ê²°ê³¼ë¥¼ HTMLë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderResults(results) {
            const resultsDisplay = document.getElementById('resultsDisplay');
            
            let html = `
                <div class="p-4 sm:p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">âœ… ${results.type} ê²°ê³¼ (Top ${results.count} ì¢…ëª©)</h3>
                    <div class="space-y-4">
            `;
            
            results.stocks.forEach(stock => {
                const color = stock.score >= 90 ? 'text-green-600' : stock.score >= 80 ? 'text-blue-600' : 'text-indigo-600';
                html += `
                    <div class="p-4 border border-gray-100 rounded-xl shadow-md cursor-pointer hover:bg-indigo-50 transition duration-150 flex items-center" 
                         onclick="openChartModal('${stock.name} (${stock.code})', '${results.type}', '${stock.code}')">
                        <div class="text-3xl font-extrabold mr-4 text-gray-400 w-10 text-center">${stock.rank}</div>
                        <div class="flex-grow">
                            <p class="text-lg font-bold text-gray-900">${stock.name} (<span class="text-sm font-mono text-gray-600">${stock.code}</span>)</p>
                            <p class="text-sm text-gray-500 mt-1">${stock.reason}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            <span class="text-2xl font-black ${color}">${stock.score.toFixed(1)}</span>
                            <span class="text-xs text-gray-500">ì </span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div class="mt-6 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-700">
                        <i class="fas fa-info-circle mr-2"></i> ì¢…ëª©ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì°¨íŠ¸ ë¶„ì„ ëª¨ë‹¬ì´ ì—´ë¦½ë‹ˆë‹¤.
                    </div>
                </div>
            `;

            resultsDisplay.innerHTML = html;
            toggleSection('resultsContent', document.querySelector('#resultsContent').previousElementSibling); // ê²°ê³¼ ì„¹ì…˜ ì—´ê¸°
        }


        // =====================================================================
        // 4. ì°¨íŠ¸ ëª¨ë‹¬ í•¨ìˆ˜ (Chart.js - ì‹œë®¬ë ˆì´ì…˜ ìœ ì§€)
        // =====================================================================
        
        /**
         * ëª¨ë‹¬ì„ ì—´ê³  ì°¨íŠ¸ë¥¼ ê·¸ë¦½ë‹ˆë‹¤. (ì°¨íŠ¸ ë°ì´í„°ëŠ” ì‹œë®¬ë ˆì´ì…˜)
         */
        function openChartModal(stockName, analysisType, stockCode) {
            document.getElementById('modalTitle').textContent = `${stockName} - íŒ¨í„´ ë¶„ì„ (${analysisType})`;
            document.getElementById('chartModal').classList.add('active');
            
            // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” /api/stock/data/${stockCode} ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•©ë‹ˆë‹¤.
            logMessage(`[${stockCode}] ì°¨íŠ¸ ë°ì´í„° ìš”ì²­ ì‹œë®¬ë ˆì´ì…˜`, 'info');

            setTimeout(() => {
                const mockChartData = generateMockChartData();
                drawChart(mockChartData);
            }, 100); 
        }

        /**
         * ì°¨íŠ¸ ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤.
         */
        function closeChartModal() {
            document.getElementById('chartModal').classList.remove('active');
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }
        
        /**
         * ì°¨íŠ¸ í™•ëŒ€/ì¶•ì†Œ ì‹œë®¬ë ˆì´ì…˜
         */
        function simulateZoom(action) {
            const zoomInfo = document.getElementById('chartZoomInfo');
            if (action === 'in') {
                zoomInfo.textContent = '(í˜„ì¬: 3ê°œì›” ë²”ìœ„) ì°¨íŠ¸ ë°ì´í„°ëŠ” ì‹œë®¬ë ˆì´ì…˜ì´ë©° ì‹¤ì œ ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            } else {
                zoomInfo.textContent = '(í˜„ì¬: ê¸°ë³¸ ì°¨íŠ¸ ë²”ìœ„) ì°¨íŠ¸ ë°ì´í„°ëŠ” ì‹œë®¬ë ˆì´ì…˜ì´ë©° ì‹¤ì œ ì •ë³´ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
            logMessage(`ì°¨íŠ¸ ${action === 'in' ? 'í™•ëŒ€' : 'ì¶•ì†Œ'} ì‹œë®¬ë ˆì´ì…˜`, 'info');
        }

        /**
         * ì‹œë®¬ë ˆì´ì…˜ìš© ì°¨íŠ¸ ë°ì´í„° (ìº”ë“¤ìŠ¤í‹± + MA)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
         */
        function generateMockChartData() {
            const dataPoints = 120; // ì•½ 6ê°œì›” ë°ì´í„°
            const today = new Date();
            let prices = [];
            let currentPrice = 10000;

            for (let i = dataPoints - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i * 7/5); 

                const open = currentPrice;
                const close = open + (Math.random() - 0.5) * 500;
                const high = Math.max(open, close) + Math.random() * 200;
                const low = Math.min(open, close) - Math.random() * 200;

                prices.push({ t: date, o: open, h: high, l: low, c: close });

                currentPrice = close + (Math.random() - 0.45) * 300; 
                if (currentPrice < 5000) currentPrice = 5000;
            }

            const calculateMA = (period) => {
                const maData = [];
                for (let i = 0; i < prices.length; i++) {
                    if (i < period - 1) {
                        maData.push(null);
                        continue;
                    }
                    const sum = prices.slice(i - period + 1, i + 1).reduce((acc, p) => acc + p.c, 0);
                    maData.push({ t: prices[i].t, y: sum / period });
                }
                return maData.filter(d => d !== null);
            };

            return {
                prices: prices.map(p => ({ t: p.t, y: p.c })), // ì¢…ê°€ë§Œ ì‚¬ìš©
                ma20: calculateMA(20),
                ma60: calculateMA(60)
            };
        }

        /**
         * Chart.js ì„ í˜• ì°¨íŠ¸ë¥¼ ê·¸ë¦½ë‹ˆë‹¤. (ìº”ë“¤ìŠ¤í‹±ì€ ë³µì¡í•˜ì—¬ ì„ í˜• ì°¨íŠ¸ë¡œ ì‹œë®¬ë ˆì´ì…˜)
         */
        function drawChart(data) {
            const ctx = document.getElementById('stockChartCanvas').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'ì¢…ê°€ (Close)',
                            data: data.prices,
                            borderColor: '#3b82f6', 
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: '20ì¼ ì´ë™í‰ê·  (MA20)',
                            data: data.ma20,
                            borderColor: '#10b981', 
                            borderWidth: 1,
                            fill: false,
                            pointRadius: 0,
                            tension: 0.2
                        },
                        {
                            label: '60ì¼ ì´ë™í‰ê·  (MA60)',
                            data: data.ma60,
                            borderColor: '#f59e0b', 
                            borderWidth: 1,
                            fill: false,
                            pointRadius: 0,
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month'
                            },
                            title: {
                                display: true,
                                text: 'ë‚ ì§œ'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ê°€ê²© (KRW)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // =====================================================================
        // 5. ì´ˆê¸°í™”
        // =====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            updateMaCheckboxes();
            toggleMaPeriods();
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì‹¤í–‰ ì‘ì—… ìƒíƒœë¥¼ í™•ì¸
            checkActiveTaskOnLoad(); 
        });

    </script>
</th:block>
</body>
</html>