<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š AthenaAI ë°°ì¹˜ ì—…ë°ì´íŠ¸</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ì „ì²´ ìŠ¤íƒ€ì¼ (ì›ë³¸ ìœ ì§€ + ë°˜ì‘í˜• ê°•í™”) */
body { font-family: 'Inter', sans-serif; }
.chart-canvas-wrap{width:100%;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;min-height:300px;}
#chartCanvas,#macdCanvas{width:100%;height:360px;}
@media(max-width:640px){#chartCanvas,#macdCanvas{height:260px;}}

/* ë“œë˜ê·¸ ìƒíƒœ ì‹œê°í™” */
.option-card-wrapper { cursor: grab; transition: all 0.2s; }
.option-card-wrapper:active { cursor: grabbing; }
.option-card-wrapper.dragging { opacity: 0.5; border: 2px dashed #3b82f6; }
.option-card-wrapper.drag-over { border: 2px solid #3b82f6; box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
.option-card { transition: border-color 0.2s, background-color 0.2s; }
input:checked + .option-card { border-color: #4f46e5; background-color: #eef2ff; }

/* ì„¹ì…˜ í† ê¸€ í™”ì‚´í‘œ ì• ë‹ˆë©”ì´ì…˜ */
.rotate-180 { transform: rotate(180deg); transition: transform 0.4s ease-in-out; }
.page-title h2 { margin-bottom: 0.25rem; }

/* ê¸€ë¡œë²Œ ìƒíƒœ ìŠ¤íƒ€ì¼ */
.status-running { color: #3b82f6; font-weight: bold; }
.status-running.blinking { animation: blink 1s infinite; }
.status-locked { color: #f59e0b; font-weight: bold; }
.status-completed { color: #22c55e; font-weight: bold; }
.status-failed { color: #ef4444; font-weight: bold; }
.status-cancelled { color: #9ca3af; font-weight: bold; }
.status-idle { color: #6b7280; }

@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script> 
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
</head>
<body>
<div layout:fragment="content">
<div class="content-container p-4 md:p-6 lg:p-8">
<div class="page-header mb-6">
<div class="page-title"><h2 class="text-2xl md:text-3xl font-bold">ğŸ“„ êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜</h2></div>
<div class="breadcrumb text-gray-500 flex items-center gap-2 text-sm md:text-base"><i class="fas fa-folder-open"></i><span>ì‹œìŠ¤í…œ / ë¶„ì„ ë„êµ¬ (AthenaAi)</span></div>
</div>

<div class="global-status-card bg-white border border-gray-200 rounded-xl p-4 shadow-sm mb-6">
<div class="flex justify-between items-center mb-2"><span class="font-bold text-lg">ğŸŒ AthenaAI ë°°ì¹˜ ì§„í–‰ ìƒíƒœ</span><span id="globalStatusText" class="text-gray-500">ëŒ€ê¸°ì¤‘</span></div>
<div class="flex justify-between text-sm text-gray-600 mb-2"><div>ì‹¤í–‰ì: <span id="globalRunner">ë¯¸ì—°ê²°</span></div><div>ì „ì²´ ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div></div>
<div class="w-full h-3 bg-gray-200 rounded-lg overflow-hidden"><div id="globalProgressBar" class="h-full bg-blue-600 transition-all duration-300" style="width:0%"></div></div>
</div>

<div class="card bg-white border border-gray-200 rounded-xl p-5 mb-10 shadow-sm">
<form id="analysisForm" class="space-y-8">

<div>
<button type="button" onclick="toggleSection('analysisTypeContent', this, 'analysisTypeArrow')" class="w-full flex justify-between items-center text-xl md:text-2xl font-bold border-b pb-3">
    1. ë¶„ì„ ìœ í˜• ì„ íƒ<span id="analysisTypeArrow" class="text-3xl rotate-180">â–¾</span>
</button>
<div id="analysisTypeContent" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 transition-max-height duration-400 ease-in-out">
<label class="option-card-wrapper" draggable="true"><input type="radio" name="analysisType" id="maRadio" value="ma" class="hidden" checked onclick="toggleMaPeriods()"><div class="option-card border-2 p-4 rounded-xl">ğŸ“‰ MA ë¶„ì„</div></label>
<label class="option-card-wrapper" draggable="true"><input type="radio" name="analysisType" value="double_bottom" class="hidden" onclick="toggleMaPeriods()"><div class="option-card border-2 p-4 rounded-xl">ğŸ“ˆ ì´ì¤‘ë°”ë‹¥</div></label>
<label class="option-card-wrapper" draggable="true"><input type="radio" name="analysisType" value="triple_bottom" class="hidden" onclick="toggleMaPeriods()"><div class="option-card border-2 p-4 rounded-xl">ğŸ“Š ì‚¼ì¤‘ë°”ë‹¥</div></label>
<label class="option-card-wrapper" draggable="true"><input type="radio" name="analysisType" value="cup_and_handle" class="hidden" onclick="toggleMaPeriods()"><div class="option-card border-2 p-4 rounded-xl">â˜• ì»µì•¤í•¸ë“¤</div></label>
<label class="option-card-wrapper" draggable="true"><input type="radio" name="analysisType" value="decline_5d" class="hidden" onclick="toggleMaPeriods()"><div class="option-card border-2 p-4 rounded-xl">ğŸ”» 5ì¼ í•˜ë½</div></label>
<label class="option-card-wrapper" draggable="true"><input type="radio" name="analysisType" value="decline_20d" class="hidden" onclick="toggleMaPeriods()"><div class="option-card border-2 p-4 rounded-xl">â¬‡ï¸ 20ì¼ í•˜ë½</div></label>
</div>
</div>

<div id="maPeriodsContainer" class="bg-indigo-50 rounded-lg p-4 mt-4">
<h4 class="font-bold text-indigo-600 mb-2">MA ê¸°ê°„</h4>
<div class="flex flex-wrap gap-4 items-center text-sm">
<input type="checkbox" id="ma20" value="20" checked disabled class="mr-1"><label for="ma20" class="font-bold">20ì¼ (í•„ìˆ˜)</label>
<input type="checkbox" id="ma60" name="maPeriods" value="60" checked><label for="ma60">60ì¼</label>
<input type="checkbox" id="ma200" name="maPeriods" value="200" checked><label for="ma200">200ì¼</label>
<input type="checkbox" id="ma500" name="maPeriods" value="500" checked><label for="ma500">500ì¼</label>
</div>
</div>

<div>
<button type="button" onclick="toggleSection('filteringOptionsContent', this, 'filteringOptionsArrow')" class="w-full flex justify-between items-center text-xl md:text-2xl font-bold border-b pb-3">
    2. ì‹¤í–‰ ì˜µì…˜<span id="filteringOptionsArrow" class="text-3xl">â–¾</span>
</button>
<div id="filteringOptionsContent" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 transition-max-height duration-400 ease-in-out overflow-hidden" style="max-height: 0px;">
<div class="p-4 bg-white border rounded-lg flex items-center gap-2"><span class="text-purple-700 font-bold">ğŸ› ï¸ ì‘ì—…ì:</span><input id="workerCount" type="number" value="8" min="1" max="16" class="w-20 text-center border rounded-lg"></div>
</div>
</div>

<div>
<button type="button" onclick="toggleSection('topNCountContent', this, 'topNCountArrow')" class="w-full flex justify-between items-center text-xl md:text-2xl font-bold border-b pb-3">
    3. ê²°ê³¼ ê°œìˆ˜<span id="topNCountArrow" class="text-3xl rotate-180">â–¾</span>
</button>
<div id="topNCountContent" class="mt-4 flex items-center gap-3 p-4 bg-gray-50 border rounded-lg transition-max-height duration-400 ease-in-out">
    <label for="topNCount">ìƒìœ„ N:</label>
    <input id="topNCount" type="number" value="10" min="1" max="50" class="w-20 border rounded text-center font-bold">
</div>
</div>
</form>

<div class="flex flex-col sm:flex-row gap-4 mt-8">
<button id="runAnalysisBtn" onclick="runAnalysis()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-lg font-bold">ğŸš€ ë¶„ì„ ì‹¤í–‰</button>
<button id="btnCancel" onclick="cancelAnalysis()" class="flex-1 bg-red-600 text-white py-3 rounded-xl text-lg font-bold" disabled>âŒ ì·¨ì†Œ</button>
</div>
</div>

<div class="card bg-white border rounded-xl p-5 mb-10 shadow-sm">
<h3 class="text-2xl font-bold mb-4">ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>
<div class="overflow-x-auto"><table class="min-w-full text-sm" id="resultTable"><thead class="bg-gray-100"><tr><th class="p-3">ì¢…ëª©ì½”ë“œ</th><th class="p-3">ì¢…ëª©ëª…</th><th class="p-3">ì‹ í˜¸</th><th class="p-3">MA ë°°ì—´</th><th class="p-3">ì°¨íŠ¸</th></tr></thead><tbody id="resultTableBody"></tbody></table></div>
<div id="noResultBox" class="hidden p-6 text-center text-gray-500">ê²°ê³¼ ì—†ìŒ</div>
</div>

<div class="card bg-white border rounded-xl p-5 mb-10 shadow-sm">
<h3 class="text-2xl font-bold mb-4 flex items-center">
    ğŸªµ ì‹¤ì‹œê°„ ë¡œê·¸
    <button id="copyLogBtn" class="ml-3 text-sm bg-indigo-600 text-white px-3 py-1 rounded-md">ë³µì‚¬</button>
</h3>
<div id="logBox" class="h-64 bg-black text-green-300 p-3 overflow-y-auto font-mono text-xs rounded-md"><p>ë¡œê·¸ ëŒ€ê¸°ì¤‘...</p></div>
</div>

<div id="chartModal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-50 p-2 md:p-0">
<div class="bg-white rounded-xl p-4 w-full max-w-[95%] md:max-w-3xl shadow-xl max-h-[95vh] overflow-y-auto">
<div class="flex justify-between items-center mb-4">
    <h3 id="modalTitle" class="text-xl font-bold">ğŸ“ˆ ì°¨íŠ¸</h3>
    <div class="flex items-center gap-2">
        <button id="btnResetZoom" class="px-3 py-1 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-sm hidden">ì¤Œ ì´ˆê¸°í™”</button>
        <button onclick="updateResultStatus()" class="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">â­ ìˆ˜ë™ ê²€í†  ì™„ë£Œ</button>
        <button onclick="closeChartModal()" class="text-2xl">&times;</button>
    </div>
</div>
<img id="chartImage" class="w-full rounded-lg shadow-md mb-4 hidden" />
<div class="chart-canvas-wrap mb-4"><canvas id="chartCanvas"></canvas></div>
<div class="chart-canvas-wrap mb-4"><canvas id="macdCanvas"></canvas></div>
</div>
</div>

<th:block layout:fragment="pageScript">
<script>
(function () {
  /* ================================
     âœ… ìš”ì†Œ ì„ íƒ (HTML ì‹¤ì œ id ê¸°ì¤€)
  ================================== */
  const $runBtn = document.getElementById("runAnalysisBtn");
  const $cancelBtn = document.getElementById("btnCancel");

  const $analysisForm = document.getElementById("analysisForm");
  const $log = document.getElementById("logBox");
  const $copyLogBtn = document.getElementById("copyLogBtn");

  const $resultTableBody = document.getElementById("resultTableBody");
  const $noResultBox = document.getElementById("noResultBox");

  const $chartModal = document.getElementById("chartModal");
  const $chartImage = document.getElementById("chartImage");
  const $modalTitle = document.getElementById("modalTitle");
  const $btnResetZoom = document.getElementById('btnResetZoom'); 

  const $globalStatusText = document.getElementById("globalStatusText");
  const $globalRunner = document.getElementById("globalRunner");
  const $globalProgressLabel = document.getElementById("globalProgressLabel");
  const $globalProgressBar = document.getElementById("globalProgressBar");

  const $priceCanvas = document.getElementById('chartCanvas'); // ê¸°ì¡´ $priceCanvas
  const $macdCanvas  = document.getElementById('macdCanvas');  // ê¸°ì¡´ $macdCanvas

  let priceChart = null;
  let macdChart  = null;

  let currentTaskId = null;
  let es = null;
  let currentUser = "ë¯¸ì—°ê²°";
  let $currentRow = null; 
  let globalStatus = "IDLE"; 

  /* ================================
     âœ… ë¶„ì„ ìœ í˜• ì„ íƒ ë° MA ê¸°ê°„
  ================================== */
  function getSelectedPattern() {
    const checked = document.querySelector("input[name='analysisType']:checked");
    return checked ? checked.value : "ma";
  }
  
  function getMaPeriods() {
    const maPeriodsElements = document.querySelectorAll('input[name="maPeriods"]:checked');
    const maPeriods = Array.from(maPeriodsElements)
        .map(el => el.value)
        .filter((value, index, self) => self.indexOf(value) === index) 
        .sort((a, b) => parseInt(a) - parseInt(b))
        .join(',');
    return maPeriods;
  }

  /* ================================
     âœ… MA ì²´í¬ë°•ìŠ¤ í‘œì‹œ/ìˆ¨ê¹€
  ================================== */
  window.toggleMaPeriods = function () {
    const isMA = document.getElementById("maRadio").checked;
    const box = document.getElementById("maPeriodsContainer");
    const inputs = box.querySelectorAll('input[type="checkbox"]');

    inputs.forEach(input => {
        if (input.id === 'ma20') return;
        input.disabled = !isMA;
    });

    box.style.display = isMA ? "block" : "none";
  };

  /* ================================
     âœ… ì„¹ì…˜ í† ê¸€
  ================================== */
  /* ================================
  âœ… ì„¹ì…˜ í† ê¸€ (ìˆ˜ì •ëœ ì•ˆì •í™” ë²„ì „)
================================== */
/* ================================
âœ… ì„¹ì…˜ í† ê¸€ (ìµœì¢… ì•ˆì •í™” ë²„ì „)
================================== */
window.toggleSection = function (contentId, buttonElement, arrowId) {
 const content = document.getElementById(contentId);
 const arrow = document.getElementById(arrowId);
 
 // content.style.maxHeightê°€ '0px' ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ì´ë©´ ë‹«íŒ ìƒíƒœë¡œ ê°„ì£¼
 const isClosed = content.style.maxHeight === '0px' || content.style.maxHeight === '';
 
 // 1ë²ˆê³¼ 3ë²ˆ ë‹«ê¸° ì•ˆë¨ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´:
 // **transitionì´ ì ìš©ëœ ìƒíƒœì—ì„œ ìŠ¤í¬ë¡¤ ë†’ì´ë¥¼ ì½ì–´ë“¤ì´ë„ë¡ ê°•ì œ í”ŒëŸ¬ì‹œ**
 // 2ë²ˆ ë²„ë²…ì„ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´:
 // **ë¶ˆí•„ìš”í•œ ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ë³€ê²½ ë°©ì§€**

 if (isClosed) {
     // 1. ì—´ê¸°: maxHeightë¥¼ scrollHeightë¡œ ì„¤ì •í•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
     content.style.maxHeight = content.scrollHeight + "px";
     arrow.classList.add('rotate-180');
     
     // 2. ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ maxHeightë¥¼ nullë¡œ ì„¤ì •í•˜ì—¬ ë‚´ìš© ë³€ê²½ì— ëŒ€ì‘
     // 450msëŠ” CSS transition ì‹œê°„(0.4s)ë³´ë‹¤ ê¸¸ê²Œ ì„¤ì •í•˜ì—¬ ì•ˆì •ì„±ì„ ë†’ì„.
     setTimeout(() => {
         // ë‹«ê¸° ìš”ì²­ì´ ë“¤ì–´ì˜¨ ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´ (maxHeightê°€ 0pxì´ ì•„ë‹ˆë¼ë©´) nullë¡œ ë³€ê²½
         if (content.style.maxHeight && content.style.maxHeight !== '0px') {
             content.style.maxHeight = null; 
         }
     }, 450); 
     
 } else {
     // 1. ë‹«ê¸° ì¤€ë¹„: maxHeightë¥¼ í˜„ì¬ scrollHeightë¡œ ê³ ì •í•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ì´ ë¶€ë“œëŸ½ê²Œ ì‹œì‘ë˜ë„ë¡ í•¨
     // (content.style.maxHeight === '0px'ì´ ì•„ë‹Œ null ìƒíƒœì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
     if (content.style.maxHeight === 'none' || content.style.maxHeight === '') {
         content.style.maxHeight = content.scrollHeight + "px";
     }
     
     arrow.classList.remove('rotate-180');

     // 2. ê°•ì œ ë¦¬í”Œë¡œìš° (ë¸Œë¼ìš°ì €ê°€ í˜„ì¬ maxHeight ê°’ì„ í™•ì‹¤íˆ ê³„ì‚°í•˜ë„ë¡ í•¨)
     // ì´ í•œ ì¤„ì´ 1ë²ˆ, 3ë²ˆ 'ë‹«ê¸° ì•ˆë¨' ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” í•µì‹¬ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     void content.offsetWidth; 

     // 3. ë‹¤ìŒ ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ì—ì„œ maxHeightë¥¼ 0pxë¡œ ì„¤ì •í•˜ì—¬ ë‹«ê¸° ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
     requestAnimationFrame(() => {
         content.style.maxHeight = '0px';
     });
 }
};

  /* ================================
     âœ… ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¨ìˆ˜
  ================================== */
  let dragSrcEl = null;

  function handleDragStart (e) {
    dragSrcEl = this;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
    this.classList.add('dragging');
  }

  function handleDragOver (e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  }

  function handleDragEnter () {
    this.classList.add('drag-over');
  }

  function handleDragLeave () {
    this.classList.remove('drag-over');
  }

  function handleDrop (e) {
    e.stopPropagation();
    this.classList.remove('drag-over');

    if (dragSrcEl !== this) {
      const container = document.getElementById("analysisTypeContent");
      
      if (dragSrcEl.compareDocumentPosition(this) & Node.DOCUMENT_POSITION_FOLLOWING) {
        container.insertBefore(dragSrcEl, this.nextSibling);
      } else {
        container.insertBefore(dragSrcEl, this);
      }
      
      const sourceRadio = dragSrcEl.querySelector('input[type="radio"]');
      const targetRadio = this.querySelector('input[type="radio"]');

      if (sourceRadio && sourceRadio.checked) {
          sourceRadio.checked = true;
      } else if (targetRadio && targetRadio.checked) {
          targetRadio.checked = true;
      }
    }
    return false;
  }

  function handleDragEnd () {
    this.classList.remove('dragging');
    document.querySelectorAll('.option-card-wrapper').forEach(item => {
      item.classList.remove('drag-over');
    });
  }

  function attachDragListeners() {
      document.querySelectorAll('#analysisTypeContent label.option-card-wrapper').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('dragenter', handleDragEnter);
        item.addEventListener('dragleave', handleDragLeave);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);
      });
  }

  /* ================================
     âœ… ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  ================================== */
  function updateButtonState(status, runner) {
      const S = (status || "IDLE").toUpperCase();
      const isRunning = ["START", "IN_PROGRESS", "RUNNING"].includes(S);
      const isOwner = (runner === currentUser);
      
      globalStatus = S;

      if (!isRunning) {
          $runBtn.disabled = false;
      } else if (isRunning && !isOwner) {
          $runBtn.disabled = true;
      } else if (isRunning && isOwner) {
          $runBtn.disabled = true;
      }
      
      const inputs = $analysisForm.querySelectorAll('input, select'); 
      inputs.forEach(input => {
          if (input.id === 'ma20' && input.getAttribute('disabled') !== null) return; 
          input.disabled = isRunning;
      });
      toggleMaPeriods();
      $cancelBtn.disabled = !(isRunning && isOwner);
  }

  function updateGlobalState(st, runner, progress) {
    const S = (st || "IDLE").toUpperCase();
    let displayText = S;

    if (S === "RUNNING" && runner !== currentUser) {
        displayText = "ë‹¤ë¥¸ ì‚¬ìš©ì ì‹¤í–‰ ì¤‘ (ì ê¹€)";
        $globalStatusText.classList.add("status-locked");
    } else {
        $globalStatusText.classList.remove("status-locked");
    }

    $globalStatusText.textContent = displayText;
    $globalRunner.textContent = runner || "ë¯¸ì—°ê²°";

    let pct = 0;
    if (S === "COMPLETED") pct = 100;
    else if (S === "RUNNING") pct = Math.min(100, Math.max(0, Math.floor(progress || 0)));
    else pct = 0;
    
    $globalProgressLabel.textContent = pct + "%";
    $globalProgressBar.style.width = pct + "%";

    $globalStatusText.className = "";
    if (S === "RUNNING" && runner === currentUser) $globalStatusText.classList.add("status-running", "blinking");
    else if (S === "RUNNING" && runner !== currentUser) $globalStatusText.classList.add("status-locked");
    else if (S === "COMPLETED") $globalStatusText.classList.add("status-completed");
    else if (S === "FAILED") $globalStatusText.classList.add("status-failed");
    else if (S === "CANCELLED") $globalStatusText.classList.add("status-cancelled");
    else $globalStatusText.classList.add("status-idle");
  }

  // âœ… í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì í™•ì¸
  async function initCurrentUser() {
    try {
      const res = await fetch("/auth/me", { credentials: "include" });
      if (!res.ok) return "-";
      const data = await res.json();
      currentUser = data.username || data.fullName || "-"; 
      return currentUser;
    } catch { 
      currentUser = "-";
      return "-"; 
    }
  }
  
  

  /* ================================
     âœ… ë¡œê·¸
  ================================== */
  function appendLog(line) {
    if (!line) return;
    const p = document.createElement("p");
    
    if (line.includes("[ERROR]") || line.includes("FATAL") || line.includes("ì‹¤íŒ¨")) {
        p.className = 'text-red-500';
    } else if (line.includes("WARNING")) {
        p.className = 'text-yellow-500';
    } else if (line.includes("COMPLETED") || line.includes("ì„±ê³µ")) {
        p.className = 'text-green-500 font-extrabold text-lg';
    } else if (line.includes("[LOG]") || line.includes("ìš”ì²­")) {
        p.className = 'text-blue-400';
    } else {
        p.className = 'text-gray-300';
    }
    
    p.textContent = line;
    $log.appendChild(p);
    $log.scrollTop = $log.scrollHeight;
  }

  /* ================================
     âœ… ë¡œê·¸ ë³µì‚¬
  ================================== */
  $copyLogBtn.onclick = () => {
    const t = Array.from($log.querySelectorAll("p"))
      .map(p => p.textContent)
      .join("\n");

    if (t.trim() === 'ë¡œê·¸ ëŒ€ê¸°ì¤‘...') {
        appendLog("[LOG] ğŸš« ë³µì‚¬í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    
    navigator.clipboard.writeText(t)
      .then(() => appendLog("[LOG] ğŸ“‹ ë¡œê·¸ ë³µì‚¬ ì™„ë£Œ"));
  };

  /* ================================
     âœ… ê²°ê³¼ í…Œì´ë¸”
  ================================== */
  function renderResults(list) {
    $resultTableBody.innerHTML = "";

    if (!list || list.length === 0) {
      $noResultBox.classList.remove("hidden");
      return;
    }
    $noResultBox.classList.add("hidden");

    list.forEach((item) => {
      const rowId = `result-row-${item.ticker}`;
      const tr = document.createElement("tr");
      tr.id = rowId;
      const initialClasses = item.reviewed ? 'bg-green-50 transition-colors duration-500' : 'hover:bg-gray-100 transition duration-100';
      tr.className = initialClasses;
      
      const scoreContent = item.reviewed ? 
        `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">â­ ìˆ˜ë™ ê²€í†  ì™„ë£Œ</span>${item.score || "-"}` :
        `${item.score || "-"}`;

      tr.innerHTML = `
        <td class="px-4 py-2 border">${item.ticker || "-"}</td>
        <td class="px-4 py-2 border">${item.name || "-"}</td>
        <td class="px-4 py-2 border font-bold">${scoreContent}</td>
        <td class="px-4 py-2 border">${item.ma_pattern || "-"}</td>
        <td class="px-4 py-2 border text-center">
          <button class="px-3 py-1 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                  onclick="showChart('${item.ticker}', '${item.name}', '${rowId}')">ë³´ê¸°</button>
        </td>
      `;
      $resultTableBody.appendChild(tr);
    });
    
    appendLog(`[LOG] âœ… ìµœì¢… ë¶„ì„ ê²°ê³¼ ${list.length}ê°œ í•­ëª© í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ.`);
  }

  /* ================================
     âœ… ì°¨íŠ¸ ê´€ë ¨ ìœ í‹¸
  ================================== */
  function destroyCharts() {
    try { if (priceChart) { priceChart.destroy(); priceChart = null; } } catch(e){}
    try { if (macdChart)  { macdChart.destroy();  macdChart  = null; } } catch(e){}
    $btnResetZoom.classList.add('hidden'); 
  }

  // âœ… [ìˆ˜ì • 1] ë‚ ì§œ ë¬¸ìì—´ì„ íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜í•˜ë„ë¡ toXY í•¨ìˆ˜ ìˆ˜ì •
  function toXY(ds) {
    if (!Array.isArray(ds)) return [];
    return ds.map(d => {
        const timestamp = new Date(d.x).getTime(); // íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜
        if (isNaN(timestamp) || d.y === null || d.y === undefined || isNaN(d.y)) {
            return null; // ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° ì œì™¸
        }
        return { x: timestamp, y: d.y };
    }).filter(p => p !== null);
  }
  
  // ------------------------------------------------------------------------------------------------------
  // âœ… [ìˆ˜ì • 2] buildPriceChart ë‚´ OHLCV ë°ì´í„° ë³€í™˜ ë¡œì§ ì¶”ê°€
  // ------------------------------------------------------------------------------------------------------
  function buildPriceChart(ctx, payload) {
    // ìº”ë“¤ìŠ¤í‹± ë°ì´í„°ì…‹ êµ¬ì„± (OHLCV ë°ì´í„° ì „ì²´ë¥¼ ì‚¬ìš©)
    const ohlcData = payload.ohlcv_data ? payload.ohlcv_data.map(d => {
        const timestamp = new Date(d.x).getTime(); // íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜
        if (isNaN(timestamp) || d.o === undefined || d.h === undefined || d.l === undefined || d.c === undefined) {
            return null; // ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° ì œì™¸
        }
        return { x: timestamp, o: d.o, h: d.h, l: d.l, c: d.c };
    }).filter(d => d !== null) : [];

    const ma20  = payload.ma_data && payload.ma_data.MA20  ? toXY(payload.ma_data.MA20)  : [];
    const ma50  = payload.ma_data && payload.ma_data.MA50  ? toXY(payload.ma_data.MA50)  : [];
    const ma200 = payload.ma_data && payload.ma_data.MA200 ? toXY(payload.ma_data.MA200) : [];
    
    const ma60  = payload.ma_data && payload.ma_data.MA60  ? toXY(payload.ma_data.MA60)  : [];
    const ma500 = payload.ma_data && payload.ma_data.MA500 ? toXY(payload.ma_data.MA500) : [];

    // Cross/Pattern í¬ì¸íŠ¸ë„ íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜
    const cross = Array.isArray(payload.cross_points) ? payload.cross_points.map(p => {
        const timestamp = new Date(p.x).getTime();
        if (isNaN(timestamp)) return null;
        return {x:timestamp, y:p.y, type:p.type};
    }).filter(p=>p!==null) : [];
    
    const pats  = Array.isArray(payload.pattern_points) ? payload.pattern_points.map(p => {
        const timestamp = new Date(p.x).getTime();
        if (isNaN(timestamp)) return null;
        return {x:timestamp, y:p.y, type:p.type, status:p.status};
    }).filter(p=>p!==null) : [];


    priceChart = new Chart(ctx, {
      type: 'candlestick', 
      data: {
        datasets: [
          { label: 'OHLCV', data: ohlcData, parsing:false, borderWidth:1.5 },
          { type:'line', label: 'MA20',  data: ma20,  parsing:false, pointRadius:0, borderWidth:1.2, borderColor: '#22c55e' },
          { type:'line', label: 'MA60',  data: ma60,  parsing:false, pointRadius:0, borderWidth:1.2, borderColor: '#f59e0b' },
          { type:'line', label: 'MA50',  data: ma50,  parsing:false, pointRadius:0, borderWidth:1.2, borderColor: '#7c3aed' }, 
          { type:'line', label: 'MA200', data: ma200, parsing:false, pointRadius:0, borderWidth:1.2, borderColor: '#3b82f6' },
          { type:'line', label: 'MA500', data: ma500, parsing:false, pointRadius:0, borderWidth:1.2, borderColor: '#e11d48' },
          { label: 'Cross', type:'scatter', data: cross, parsing:false, pointRadius:4, pointBackgroundColor:'#ef4444', showLine:false },
          { label: 'Pattern', type:'scatter', data: pats, parsing:false, pointRadius:4, pointBackgroundColor:'#8b5cf6', showLine:false }
        ].filter(ds => ds.data.length > 0 || ds.type === 'candlestick' || ds.type === 'line') 
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:false },
        scales:{
          // Xì¶• ìŠ¤ì¼€ì¼ íƒ€ì… 'time' ìœ ì§€ (íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì¸ì‹)
          x:{ type:'time', time:{ tooltipFormat:'yyyy-MM-dd' }, grid:{ display:false } },
          y:{ beginAtZero:false, ticks:{ callback:v => v.toLocaleString() } }
        },
        plugins:{
          legend:{ display:true, position:'top' },
          tooltip:{ callbacks:{
            label: (ctx)=>{
              const d = ctx.raw;
              if (ctx.dataset.type === 'candlestick' && d && d.o !== undefined) {
                  return `O:${d.o.toLocaleString()}, H:${d.h.toLocaleString()}, L:${d.l.toLocaleString()}, C:${d.c.toLocaleString()}`;
              }
              if (ctx.dataset.type === 'scatter' && d && (d.type || d.status)) {
                return `${ctx.dataset.label}: ${d.type || ''} ${d.status ? '('+d.status+')' : ''}  y=${d.y?.toLocaleString?.()}`;
              }
              return `${ctx.dataset.label}: ${ctx.parsed.y?.toLocaleString?.()}`;
            }
          }},
          zoom:{
            pan:{ enabled:true, mode:'xy' },
            zoom:{ wheel:{ enabled:true }, pinch:{ enabled:true }, mode:'xy' }
          }
        }
      }
    });
  }
  // ------------------------------------------------------------------------------------------------------
  
  // ------------------------------------------------------------------------------------------------------
  // âœ… [ìˆ˜ì • 3] buildMacdChart ë°ì´í„° ë³€í™˜ ë¡œì§ì€ toXY í•¨ìˆ˜ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  // ------------------------------------------------------------------------------------------------------
  function buildMacdChart(ctx, payload) {
    // toXY í•¨ìˆ˜ê°€ íƒ€ì„ìŠ¤íƒ¬í”„ ë³€í™˜ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    const macd = payload.macd_data && payload.macd_data.MACD ? toXY(payload.macd_data.MACD) : [];
    const signal = payload.macd_data && payload.macd_data.Signal ? toXY(payload.macd_data.Signal) : [];
    const hist = payload.macd_data && payload.macd_data.Histogram ? toXY(payload.macd_data.Histogram) : [];

    macdChart = new Chart(ctx, {
      data: {
        // labelsê°€ ì•„ë‹Œ datasets ë‚´ì˜ x ê°’ì„ ì‚¬ìš©í•˜ë¯€ë¡œ labelsëŠ” ë¹„ì›Œë„ ë¬´ë°©
        datasets: [
          { type:'line', label:'MACD',   data: macd,   parsing:false, pointRadius:0, borderWidth:1.2, borderColor:'#111827' },
          { type:'line', label:'Signal', data: signal, parsing:false, pointRadius:0, borderWidth:1.2, borderColor:'#f43f5e' },
          { 
            type:'bar',  
            label:'Hist',   
            data: hist,   
            parsing:false,
            backgroundColor: (ctx) => { 
                const value = ctx.parsed.y;
                return value > 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'; 
            },
          }
        ].filter(ds => ds.data.length > 0 || ds.type !== 'line') 
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:false },
        scales:{
          // Xì¶• ìŠ¤ì¼€ì¼ íƒ€ì… 'time' ìœ ì§€
          x:{ type:'time', time:{ tooltipFormat:'yyyy-MM-dd' }, grid:{ display:false } },
          y:{ beginAtZero:false }
        },
        plugins:{
          legend:{ display:true, position:'top' },
          tooltip:{ enabled:true },
          zoom:{
            pan:{ enabled:true, mode:'x' },
            zoom:{ wheel:{ enabled:true }, pinch:{ enabled:true }, mode:'x' }
          }
        }
      }
    });
  }

  /* ==========================================================
     âœ… JSON ì°¨íŠ¸ ìš”ì²­
  ========================================================== */
  async function tryRenderChartsByJson(ticker, name){
    const url = `/api/stock/batch/athena/chart?symbol=${encodeURIComponent(ticker)}&mode=chart_data&ts=${Date.now()}`;

    const res = await fetch(url, { headers: { 'Accept':'application/json' } });
    const ct = res.headers.get('Content-Type') || '';
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    // ì„œë²„ê°€ JSON ëŒ€ì‹  ì´ë¯¸ì§€ë¥¼ ë°˜í™˜í•˜ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ Content-Type ê²€ì‚¬ ê°•í™”
    if (!ct.includes('application/json')) throw new Error('Not JSON. Server returned: ' + ct);

    const payload = await res.json();

    $chartImage.style.display = 'none';

    destroyCharts();
    // ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìƒˆë¡œ ê°€ì ¸ì™€ ì°¨íŠ¸ ìƒì„±
    buildPriceChart($priceCanvas.getContext('2d'), payload);
    buildMacdChart($macdCanvas.getContext('2d'), payload);

    $btnResetZoom.classList.remove('hidden'); 
    $btnResetZoom.onclick = () => {
      try { priceChart.resetZoom(); } catch(e){}
      try { macdChart.resetZoom(); } catch(e){}
    };

    appendLog(`[LOG] ğŸ“ˆ ì°¨íŠ¸ ë°ì´í„°(JSON) ë¡œë“œ ì™„ë£Œ: ${ticker} - ${name}`);
  }

  /* ==========================================================
     âœ… ì°¨íŠ¸ ëª¨ë‹¬
  ========================================================== */
  window.showChart = async (ticker, name, rowId) => {
    $currentRow = document.getElementById(rowId);
    $modalTitle.textContent = `ğŸ“ˆ ${ticker} - ${name}`;
    $chartModal.classList.remove("hidden");

    try {
      await tryRenderChartsByJson(ticker, name);
    } catch (err) {
      destroyCharts();
      $chartImage.style.display = '';
      $btnResetZoom.classList.add('hidden'); 

      $chartImage.src = `/api/stock/batch/athena/chart?symbol=${encodeURIComponent(ticker)}&ts=${Date.now()}`;

      appendLog(`[LOG] â„¹ï¸ ì„œë²„ JSON ë¯¸ì§€ì› â†’ ì´ë¯¸ì§€ fallback (${ticker}): ${err.message}`);
    }
  };

  window.closeChartModal = () => {
    $chartModal.classList.add("hidden");
    $chartImage.src = "";
    destroyCharts();
    $currentRow = null;
  };
  
  // âœ… ìˆ˜ë™ ê²€í†  ì™„ë£Œ ì²˜ë¦¬ ê¸°ëŠ¥
  window.updateResultStatus = function() {
      if ($currentRow) {
          const scoreCell = $currentRow.cells[2];
          const ticker = $currentRow.cells[0].textContent;
          const originalContent = scoreCell.textContent.replace('â­ ìˆ˜ë™ ê²€í†  ì™„ë£Œ', '').trim(); 

          if (scoreCell.innerHTML.includes('ìˆ˜ë™ ê²€í†  ì™„ë£Œ')) {
              appendLog(`[UPDATE] ${ticker} ì¢…ëª©ì€ ì´ë¯¸ ê²€í†  ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
              closeChartModal();
              return;
          }
          
          scoreCell.innerHTML = `
            <span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">
              â­ ìˆ˜ë™ ê²€í†  ì™„ë£Œ
            </span> 
            ${originalContent}
          `;

          $currentRow.classList.add('bg-green-50');
          $currentRow.classList.remove('hover:bg-gray-100');
          $currentRow.classList.add('transition-colors', 'duration-500');

          appendLog(`[UPDATE] ${ticker} ì¢…ëª© ìˆ˜ë™ ê²€í†  ì™„ë£Œ.`);
      }
      closeChartModal();
  };

  /* ================================
     âœ… SSE
  ================================== */
  function connectSSE() {
    if (es) { try { es.close(); } catch {} }
    
    appendLog(`[LOG] SSE ì—°ê²° ì‹œë„. í˜„ì¬ ì‚¬ìš©ì ID: ${currentUser}`);

    es = new EventSource("/api/stock/batch/athena/sse");

    es.onopen = () => {
        appendLog("[LOG] SSE ì—°ê²° ì„±ê³µ.");
    };

    es.addEventListener("status", (ev) => {
      const d = JSON.parse(ev.data || "{}");
      
      if (d.globalStatus) {
        updateGlobalState(d.globalStatus, d.globalRunner, d.globalProgress);
        updateButtonState(d.globalStatus, d.globalRunner);
      }
      
      if (Array.isArray(d.logs))
        d.logs.forEach(line => appendLog(line));

      if (Array.isArray(d.results)) {
        renderResults(d.results);
      }
      
      if (d.taskId) currentTaskId = d.taskId;
    });

    es.onerror = (err) => {
      appendLog("[ERROR] SSE ì—°ê²° ì˜¤ë¥˜. ì¬ì‹œë„ ì¤‘...");
      console.error("SSE Error:", err);
      try { es.close(); } catch {}
      es = null;
      updateButtonState("IDLE", currentUser);
      setTimeout(connectSSE, 2000);
    };
  }

  /* ================================
     âœ… ë¶„ì„ ì‹¤í–‰
  ================================== */
  window.runAnalysis = async () => {
    if ($runBtn.disabled) {
        if (globalStatus === 'RUNNING' && $globalRunner.textContent !== currentUser) {
            appendLog("[ERROR] ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì‹¤í–‰ ì¤‘. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
        } else {
            appendLog("[ERROR] í˜„ì¬ ì‹¤í–‰ ë¶ˆê°€ ìƒíƒœ.");
        }
        return; 
    }
    
    updateButtonState("RUNNING", currentUser);
    $log.innerHTML = `<p class="opacity-70">ë¶„ì„ ìš”ì²­ ì‹œì‘...</p>`;
    $resultTableBody.innerHTML = "";
    $noResultBox.classList.add("hidden");

    const pattern = getSelectedPattern();
    const workers = document.getElementById("workerCount").value;
    const topN = document.getElementById("topNCount").value;
    const maPeriods = getMaPeriods();

    const url = `/api/stock/batch/athena/start`
      + `?pattern=${pattern}`
      + `&workers=${workers}`
      + `&maPeriods=${maPeriods}`
      + `&topN=${topN}`;
      
    try {
        const res = await fetch(url, { method: 'POST' });
        if (!res.ok) {
            const errorText = await res.text();
            appendLog(`[ERROR] ë¶„ì„ ì‹œì‘ ìš”ì²­ ì‹¤íŒ¨: ${res.status} ${errorText}`);
            updateButtonState("IDLE", currentUser);
        } else {
            const data = await res.json();
            currentTaskId = data.taskId;
            appendLog(`[LOG] ë¶„ì„ ì‹œì‘ ìš”ì²­ ì„±ê³µ. Task ID: ${currentTaskId}`);
            // SSEëŠ” ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
        }
    } catch (error) {
        appendLog(`[FATAL] ë¶„ì„ ì‹œì‘ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
        updateButtonState("IDLE", currentUser);
    }
  };
  
  /* ================================
     âœ… ë¶„ì„ ì·¨ì†Œ
  ================================== */
  window.cancelAnalysis = async () => {
    if (!currentTaskId || $cancelBtn.disabled) {
        appendLog("[WARNING] ì·¨ì†Œí•  í™œì„± ì‘ì—…ì´ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    try {
        const res = await fetch(`/api/stock/batch/athena/cancel?taskId=${currentTaskId}`, { method: 'POST' });
        if (res.ok) {
            appendLog(`[LOG] Task ID ${currentTaskId} ì·¨ì†Œ ìš”ì²­ ì„±ê³µ.`);
            // SSEë¥¼ í†µí•´ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ë°›ìŠµë‹ˆë‹¤.
        } else {
            const errorText = await res.text();
            appendLog(`[ERROR] ë¶„ì„ ì·¨ì†Œ ìš”ì²­ ì‹¤íŒ¨: ${res.status} ${errorText}`);
        }
    } catch (error) {
        appendLog(`[FATAL] ë¶„ì„ ì·¨ì†Œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
    }
  };


  /* ================================
     âœ… ì´ˆê¸°í™” ë° ì‹œì‘
  ================================== */
  document.addEventListener("DOMContentLoaded", () => {
    attachDragListeners();
    toggleMaPeriods(); // í˜ì´ì§€ ë¡œë“œ ì‹œ MA ê¸°ê°„ í‘œì‹œ/ìˆ¨ê¹€ ì´ˆê¸°í™”
    
    // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì í™•ì¸ í›„ SSE ì—°ê²° ì‹œì‘
    initCurrentUser().then(() => {
        connectSSE();
    });
  });

})();
</script>
</th:block>



</div></div>
</body>
</html>