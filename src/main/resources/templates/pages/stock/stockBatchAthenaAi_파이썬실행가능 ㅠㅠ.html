<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š AthenaAI ë°°ì¹˜ ì—…ë°ì´íŠ¸</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
      :root {
        --main-bg: #f3f4f6;
        --card-bg: #ffffff;
        --text-color-primary: #111827;
        --text-color-secondary: #6b7280;
        --border-color-default: #d1d5db;
        --input-bg: #ffffff;
        --progress-bar-bg: #e5e7eb;
        --log-box-bg: #111; 
        --log-text-default: #e0e0e0;
        --log-text-info: #9ca3af;
        --log-text-progress: #60a5fa;
        --log-text-warning: #f59e0b;
        --log-text-error: #ef4444;
        --log-text-complete: #22c55e;
        --card-border: #d1d5db;
        --error-card-bg: #fff;
        --error-card-border: #e5e7eb;
        --error-card-text: #374151;
        --error-card-hover: #fee2e2;
        --error-card-header: #b91c1c;
      }

      .global-status-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 14px 18px;
        margin-bottom: 12px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
      }
      .global-status-header {
        font-weight: 600;
        color: var(--text-color-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1rem;
      }
      .global-status-body {
        font-size: .9rem;
        color: var(--text-color-secondary);
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
      }
      .global-status-progress {
        width: 100%;
        height: 10px;
        background: var(--progress-bar-bg);
        border-radius: 6px;
        overflow: hidden;
        margin-top: 8px;
      }
      .global-status-progress div {
        height: 100%;
        width: 0%;
        background: #2563eb;
        transition: width .25s;
      }
      .status-idle{color:#6b7280;}
      .status-running{color:#2563eb;}
      .status-completed{color:#22c55e;}
      .status-failed,.status-timeout{color:#ef4444;}
      .status-cancelled{color:#f59e0b;}
      @keyframes blink {0%,100%{opacity:1}50%{opacity:.35}}
      .blinking{animation:blink 1.2s infinite;}
      .run-controls-wrapper {display:flex;align-items:center;gap:0.75rem;margin-top:2rem;}
    </style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <div class="page-header">
      <div class="page-title"><h2>ğŸ“„ AthenaAI ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜</h2></div>
      <div class="breadcrumb"><i class="fas fa-robot"></i><span>AthenaAI ë¶„ì„</span></div>
    </div>

    <!-- âœ… ì „ì—­ ìƒíƒœ ì¹´ë“œ -->
    <div class="global-status-card">
        <div class="global-status-header">
          ğŸŒ AthenaAI ë°°ì¹˜ ì§„í–‰ ìƒíƒœ
          <span id="globalStatusText" class="status-idle">ëŒ€ê¸°ì¤‘</span>
        </div>
        <div class="global-status-body">
          <div>ì‹¤í–‰ì: <span id="globalRunner">ë¯¸ì—°ê²°</span></div>
          <div>ì „ì²´ ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div>
        </div>
        <div class="global-status-progress"><div id="globalProgressBar"></div></div>
    </div>

    <!-- âœ… ë¶„ì„ í¼ -->
    <div class="card mb-8">
      <form id="analysisForm">
        <div class="flex flex-col gap-4">
          <div>
            <label class="font-bold text-gray-700">ë¶„ì„ ìœ í˜•</label>
            <select id="analysisType" class="border rounded p-2 w-full">
              <option value="ma" selected>ì´ë™í‰ê· ì„ (MA) ë¶„ì„</option>
              <option value="double_bottom">ì´ì¤‘ë°”ë‹¥</option>
              <option value="cup_and_handle">ì»µì•¤í•¸ë“¤</option>
              <option value="decline_5d">ë‹¨ê¸°ê¸‰ë½(5ì¼)</option>
            </select>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label>ë¶„ì„ ì—°ë„(Years)</label>
              <input id="years" type="number" class="border rounded p-2 w-full" value="3" min="1" max="10">
            </div>
            <div>
              <label>ì‘ì—…ì ìˆ˜(Workers)</label>
              <input id="workers" type="number" class="border rounded p-2 w-full" value="8" min="1" max="16">
            </div>
            <div>
              <label>ì•…ì¬ì¢…ëª© ì œì™¸</label>
              <input id="excludeNeg" type="checkbox" class="ml-2" checked>
            </div>
          </div>
        </div>

        <div class="run-controls-wrapper">
          <button type="button" id="runAnalysisBtn" onclick="runAnalysis()" class="flex-grow px-6 py-3 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700">
            ğŸš€ ë¶„ì„ ì‹¤í–‰
          </button>
          <button type="button" id="btnCancel" onclick="cancelAnalysis()" class="px-6 py-3 bg-red-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-red-700" disabled>
            âŒ ì·¨ì†Œ
          </button>
        </div>
      </form>

      <!-- âœ… ê²°ê³¼ -->
      <div id="resultsDisplay" class="mt-6 bg-white border rounded-xl p-4 min-h-[120px]">
        <p class="text-gray-500">ë¶„ì„ ì‹¤í–‰ í›„ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>

      <!-- âœ… ë¡œê·¸ -->
      <div id="logDisplay" class="mt-6 h-48 bg-gray-800 text-gray-200 p-4 overflow-y-scroll rounded-xl font-mono text-sm border border-gray-700">
        <div>[INFO] ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì„ í™•ì¸ ì¤‘...</div>
      </div>
    </div>
  </div>
</div>

<!-- âœ… SSE ë° ì œì–´ ìŠ¤í¬ë¦½íŠ¸ -->
<th:block layout:fragment="pageScript">
<script>
let currentTaskId = null;
let eventSource = null;

function logMessage(msg, level='info'){
  const logDisplay = document.getElementById('logDisplay');
  const line = document.createElement('div');
  line.textContent = `[${level.toUpperCase()}] ${msg}`;
  logDisplay.appendChild(line);
  logDisplay.scrollTop = logDisplay.scrollHeight;
}

function updateGlobalStatus(progress, text, cls, runner='ë¯¸ì—°ê²°'){
  document.getElementById('globalStatusText').textContent = text;
  document.getElementById('globalStatusText').className = cls;
  document.getElementById('globalRunner').textContent = runner;
  document.getElementById('globalProgressBar').style.width = progress + '%';
  document.getElementById('globalProgressLabel').textContent = Math.round(progress) + '%';
}

async function runAnalysis(){
  if(currentTaskId){ logMessage('ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.','warn'); return; }
  const pattern = document.getElementById('analysisType').value;
  const years = document.getElementById('years').value;
  const workers = document.getElementById('workers').value;
  const excludeNeg = document.getElementById('excludeNeg').checked;
  
  const query = new URLSearchParams({ pattern, years, workers, excludeNeg }).toString();
  try{
    const res = await fetch(`/api/stock/batch/athena/start?${query}`, { method:'POST' });
    if(!res.ok) throw new Error('ì‹œì‘ ì‹¤íŒ¨');
    const data = await res.json();
    currentTaskId = data.taskId;
    logMessage(`ì‘ì—… ì‹œì‘ë¨: ${currentTaskId}`);
    startSSE();
  }catch(e){ logMessage('ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨: '+e.message,'error'); }
}

function startSSE(){
  if(eventSource) eventSource.close();
  eventSource = new EventSource('/api/stock/batch/athena/sse');
  eventSource.onmessage = e=>{
    const data = JSON.parse(e.data);
    if(data.status==='IN_PROGRESS'){
      updateGlobalStatus(data.progress,'ì‹¤í–‰ì¤‘','status-running',data.runner);
      logMessage(`ì§„í–‰ë¥  ${data.progress}%`);
    }
    if(data.status==='COMPLETED'){
      updateGlobalStatus(100,'ì™„ë£Œ','status-completed');
      document.getElementById('resultsDisplay').innerHTML = `<pre>${JSON.stringify(data.result||{},null,2)}</pre>`;
      stopSSE();
    }
    if(data.status==='FAILED'){
      updateGlobalStatus(0,'ì‹¤íŒ¨','status-failed');
      stopSSE();
    }
  };
  eventSource.onerror=()=>{
    logMessage('SSE ì—°ê²° ì¢…ë£Œ','warn');
    stopSSE();
  };
}

function stopSSE(){
  if(eventSource){ eventSource.close(); eventSource=null; }
  currentTaskId=null;
}

async function cancelAnalysis(){
  if(!currentTaskId) return;
  try{
    await fetch(`/api/stock/batch/athena/cancel/${currentTaskId}`,{method:'POST'});
    logMessage('ì‘ì—… ì·¨ì†Œ ìš”ì²­ ì™„ë£Œ','warn');
    updateGlobalStatus(0,'ì·¨ì†Œë¨','status-cancelled');
    stopSSE();
  }catch(e){ logMessage('ì·¨ì†Œ ì‹¤íŒ¨: '+e.message,'error'); }
}
</script>
</th:block>
</body>
</html>
