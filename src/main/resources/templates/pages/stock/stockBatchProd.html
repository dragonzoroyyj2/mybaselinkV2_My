<!--stockBatchProd.html  -->
<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
<meta charset="UTF-8">
<title>ğŸ“Š Stock Batch Prod</title>

<style>
  /* ===============================================================
     âœ… CSS ë³€ìˆ˜ ì •ì˜ (Light & Dark Mode)
  =============================================================== */
  :root {
    --main-bg: #f3f4f6;
    --card-bg: #ffffff;
    --text-color-primary: #111827;
    --text-color-secondary: #6b7280;
    --border-color-default: #d1d5db;
    --input-bg: #ffffff;
    --progress-bar-bg: #e5e7eb;
    
    /* Log Box (always dark background, but text colors adapt) */
    --log-box-bg: #111; 
    --log-text-default: #e0e0e0;
    --log-text-info: #9ca3af;
    --log-text-progress: #60a5fa;
    --log-text-warning: #f59e0b;
    --log-text-error: #ef4444;
    --log-text-complete: #22c55e;
  }

  body.dark-mode {
    --main-bg: #1f2937;
    --card-bg: #374151;
    --text-color-primary: #f9fafb;
    --text-color-secondary: #9ca3af; 
    --border-color-default: #4b5563; 
    --input-bg: #4b5563;
    --progress-bar-bg: #4b5563;

    /* Log Box text colors for Dark Mode (better contrast) */
    --log-text-warning: #fbbf24; /* Brighter orange/yellow */
    --log-text-error: #f87171; /* Brighter red */
  }

  /* ===============================================================
     âœ… ì¼ë°˜ UI ìŠ¤íƒ€ì¼ (CSS ë³€ìˆ˜ ì ìš©)
  =============================================================== */

  h2{font-size:1.3rem;font-weight:700;margin-bottom:.4rem;color:var(--text-color-primary);}
  .card-box,.dashboard-cards,.log-wrapper{
      background:var(--card-bg);
      border-radius:12px;
      padding:18px;
      box-shadow:0 2px 6px rgba(0,0,0,.15); /* Keep shadow for contrast */
      margin-top:14px;
      transition: background 0.3s;
  }
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-size:.9rem;font-weight:600;color:#fff;min-width:110px;text-align:center;}
  .btn-start{background:#2563eb;}
  .btn-cancel{background:#dc2626;}
  .btn:disabled{opacity:.5;cursor:not-allowed;}
  .controls{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;}
  
  input[type=number], select{
      width:90px;
      padding:.45rem .6rem;
      border:1px solid var(--border-color-default);
      border-radius:6px;
      color:var(--text-color-primary);
      background-color:var(--input-bg);
      transition: background-color 0.3s, border-color 0.3s;
  }
  
  .dashboard-cards{display:flex;flex-wrap:wrap;gap:14px;}
  .card{
      flex:1 1 300px;
      background:var(--card-bg);
      border-radius:12px;
      padding:16px;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
      display:flex;
      flex-direction:column;
      transition: background 0.3s;
  }
  .card-header{display:flex;align-items:center;gap:6px;font-size:.95rem;font-weight:600;margin-bottom:6px;}
  .card-header i{color:#2563eb;}
  .card-header .right{margin-left:auto;font-weight:600;font-size:.9rem;}
  
  .progress-bar{
      width:100%;
      background:var(--progress-bar-bg);
      height:14px;
      border-radius:7px;
      margin-top:10px;
      overflow:hidden;
      transition: background-color 0.3s;
  }
  .progress-bar div{height:100%;width:0%;transition:width .3s;}
  .bar-total div{background:#2563eb;}
  .bar-krx div{background:#10b981;}
  .bar-data div{background:#f59e0b;}
  
  /* ğŸš© ìˆ˜ì •ëœ ë¶€ë¶„: ë¡œê·¸ í—¤ë” ë””ìì¸ í†µì¼ì„± ê°•í™” */
  .log-wrapper h3{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin:0;
    font-size:1rem;
    padding-bottom: 4px; /* í—¤ë” ì•„ë˜ ê³µê°„ ì¶”ê°€ */
    border-bottom: 1px solid var(--border-color-default); /* êµ¬ë¶„ì„  ì¶”ê°€ */
  }

  /* ğŸš© ìˆ˜ì •ëœ ë¶€ë¶„: ë¡œê·¸ ë³µì‚¬ ë²„íŠ¼ í˜¸ë²„ ë””ìì¸ í†µì¼ì„± ê°•í™” */
  .copy-btn{
    display: flex;
    align-items: center;
    gap: 4px;
    font-size:.9rem;
    cursor:pointer;
    user-select:none;
    margin-left:10px;
    color:#3b82f6; 
    opacity: 0.9;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
  }
  .copy-btn:hover{
    opacity:1;
    background: var(--border-color-default); /* ì¹´ë“œ ë°°ê²½ìƒ‰ê³¼ í†µì¼ì„± ìˆëŠ” í˜¸ë²„ íš¨ê³¼ */
    text-decoration:none;
  }
  
  /* ğŸš© ìˆ˜ì •ëœ ë¶€ë¶„: ë¡œê·¸ ë°•ìŠ¤ ë†’ì´ ì¦ê°€ ë° í…Œë‘ë¦¬ ëª¨ì–‘(inset shadow) ì¶”ê°€ */
  .log-box{
      background:var(--log-box-bg); /* Always black/dark gray */
      color:var(--log-text-default);
      font-family:Consolas,mono;
      font-size:13px;
      padding:12px; /* íŒ¨ë”©ì„ ì•½ê°„ ëŠ˜ë ¤ ì—¬ìœ  ê³µê°„ í™•ë³´ */
      border-radius:10px;
      /* --- ë†’ì´ ìˆ˜ì •: 180px -> 240px --- */
      height:240px; 
      /* --- ë©‹ì§„ í…Œë‘ë¦¬ëª¨ì–‘ ì¶”ê°€ (ë‚´ë¶€ ê·¸ë¦¼ì) --- */
      box-shadow:inset 0 2px 4px rgba(0,0,0,0.3); 
      overflow-y:auto;
      overflow-x:auto; 
      margin-top:6px;
      line-height:1.4;
      transition: all 0.3s ease;
  }
  .log-box p { 
    margin: 0; 
    padding: 0; 
    white-space: nowrap; 
  }
  /* ë¡œê·¸ ìƒ‰ìƒ ë³€ìˆ˜ ì ìš© */
  .log-default{color:var(--log-text-default);}
  .log-info{color:var(--log-text-info);}
  .log-progress{color:var(--log-text-progress);}
  .log-warning{color:var(--log-text-warning);font-weight:600;} 
  .log-error{color:var(--log-text-error);font-weight:600;}
  .log-complete{color:var(--log-text-complete);font-weight:600;}

  /* íŒíŠ¸ ë° ì—°ê²° ìƒíƒœ */
  #adminHint{font-size:12px;color:var(--text-color-secondary);margin-top:4px;}
  #hintTimer{margin-left: 10px; color:var(--text-color-secondary);}
  #connStatus{font-size:12px;margin-left:10px;color:var(--text-color-secondary);}

  /* ëª¨ë°”ì¼ í•´ìƒë„ì— ë§ì¶˜ ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ */
  @media (max-width: 640px) {
    .controls {
      flex-direction: column;
      align-items: stretch;
    }
    .controls label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .controls input[type=number], .controls select {
        width: 100px;
    }
    .btn {
        width: 100%;
        margin-top: 4px;
    }
    .dashboard-cards .card {
        flex: 1 1 100%; 
    }
    /* ğŸš© ìˆ˜ì •ëœ ë¶€ë¶„: ëª¨ë°”ì¼ í•´ìƒë„ì—ì„œë„ ë†’ì´ ì¦ê°€ (150px -> 200px) */
    .log-box {
        height: 200px; 
    }
  }
</style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
		<div class="page-header">
		  <div class="page-title">
		    <h2 th:text="${pageTitle} ?: 'ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ ì œëª©'">ğŸ“„ ê¸°ë³¸ í˜ì´ì§€ ì œëª©</h2>
		  </div>
		  <div class="breadcrumb">
		    <i class="fas fa-folder-open"></i>
		    <span th:text="${breadcrumb} ?: 'ì‹œìŠ¤í…œ / ê¸°ë³¸ ê²½ë¡œ'">ì‹œìŠ¤í…œ / ê¸°ë³¸ ê²½ë¡œ</span>
		  </div>
		</div>   

    <div class="card-box">
      <div class="controls">
        <label>ì›Œì»¤:
          <input type="number" id="workers" value="16" min="1" max="16">
        </label>
        
        <label>ìˆ˜ì§‘ ê¸°ê°„ (ë…„):
          <select id="historyYears">
            <option value="3" selected>3ë…„</option>
            <option value="4">4ë…„</option>
            <option value="5">5ë…„</option>
            <option value="6">6ë…„</option>
            <option value="7">7ë…„</option>
            <option value="8">8ë…„</option>
            <option value="9">9ë…„</option>
            <option value="10">10ë…„</option>
          </select>
        </label>
        
        <label><input type="checkbox" id="force"> ê°•ì œ ë‹¤ìš´ë¡œë“œ</label>
        <button id="btnStart" class="btn btn-start">ì—…ë°ì´íŠ¸ ì‹œì‘</button>
        <button id="btnCancel" class="btn btn-cancel" disabled>ì·¨ì†Œ</button>
        <span id="connStatus"></span>
      </div>
      <div id="adminHint" style="font-size:12px;color:#666;margin-top:4px;">
        <span id="hintStatus">â€» ê´€ë¦¬ìë§Œ ì‹¤í–‰ ê°€ëŠ¥</span>
        <span id="hintTimer" style="margin-left: 10px; color:#999;"></span>
      </div>
    </div>

    <div class="dashboard-cards">
      <div class="card">
        <div class="card-header"><i class="fas fa-layer-group"></i>ì „ì²´ ì§„í–‰ë¥ 
          <span class="right" id="badgeTotal">-</span>
        </div>
        <strong id="pctTotal">0%</strong>
        <div class="progress-bar bar-total"><div id="barTotal"></div></div>
      </div>

      <div class="card">
        <div class="card-header"><i class="fas fa-database"></i>KRX ì¢…ëª© ëª©ë¡
          <span class="right" id="badgeKrx"></span>
        </div>
        <strong id="pctKrx">0%</strong>
        <div class="progress-bar bar-krx"><div id="barKrx"></div></div>
      </div>

      <div class="card">
        <div class="card-header"><i class="fas fa-chart-line"></i>ê°œë³„ ì¢…ëª© ë°ì´í„°
          <span class="right" id="badgeData"></span>
        </div>
        <strong id="pctData">0%</strong>
        <div class="progress-bar bar-data"><div id="barData"></div></div>
      </div>
    </div>

    <div class="log-wrapper">
      <h3>
        ì‹¤ì‹œê°„ ë¡œê·¸
        <span class="copy-btn" id="copyLogBtn"><i class="fas fa-copy"></i> ë¡œê·¸ ë³µì‚¬</span>
      </h3>
      <div id="logBox" class="log-box"><p class="log-info">ë¡œê·¸ ëŒ€ê¸°ì¤‘...</p></div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
	(function(){
	  const $btnStart=document.getElementById("btnStart"),
	        $btnCancel=document.getElementById("btnCancel"),
	        $barTotal=document.getElementById("barTotal"),
	        $pctTotal=document.getElementById("pctTotal"),
	        $barKrx=document.getElementById("barKrx"),
	        $pctKrx=document.getElementById("pctKrx"),
	        $barData=document.getElementById("barData"),
	        $pctData=document.getElementById("pctData"),
	        $badgeTotal=document.getElementById("badgeTotal"),
	        $badgeKrx=document.getElementById("badgeKrx"),
	        $badgeData=document.getElementById("badgeData"),
	        $hint=document.getElementById("adminHint"),
            $hintStatus=document.getElementById("hintStatus"), // ìƒíƒœ/ì§„í–‰ë¥  ì˜ì—­ (ê¹œë¹¡ì„ ë°©ì§€ìš©)
            $hintTimer=document.getElementById("hintTimer"),   // íƒ€ì´ë¨¸ ì˜ì—­ (ê¹œë¹¡ì„ ë°©ì§€ìš©)
	        $log=document.getElementById("logBox"),
	        $copy=document.getElementById("copyLogBtn"),
	        $workers=document.getElementById("workers"),
	        $force=document.getElementById("force"),
            $historyYears=document.getElementById("historyYears"),
	        $conn=document.getElementById("connStatus");
	
	  let isOwner=false, currentTaskId=null, es=null, startTime=null, timerInterval=null;
	  let connected=false, reconnecting=false, currentUser=null, currentRunner=null, currentProgress=0;
	
	  // ===== ë¡œê·¸ ê´€ë¦¬ (ì„±ëŠ¥ ìµœì í™” ìœ ì§€) =====
	  const MAX_LOG_LINES=700, FLUSH_INTERVAL=200;
	  let logLines=[], pendingLogs=[], flushTimer=null;

	  function colorize(line){
	    if(/(error|ì˜ˆì™¸)/i.test(line)) return `<span class="log-error">${line}</span>`;
	    if(/\[PROGRESS\]/i.test(line)) return `<span class="log-progress">${line}</span>`;
	    if(/\b(LOG|INFO)\b/i.test(line)) return `<span class="log-info">${line}</span>`;
	    if(/(ì™„ë£Œ|COMPLETED)/i.test(line)) return `<span class="log-complete">${line}</span>`;
	    return line;
	  }
	
	  function scheduleFlush(){
	    if(flushTimer) return;
	    flushTimer=setTimeout(()=>{
	      flushTimer=null;
	      if(pendingLogs.length===0) return;
	      
	      const fragment = document.createDocumentFragment();
	      
	      for(const line of pendingLogs){
	          logLines.push(line); 
	          
	          const p = document.createElement('p');
	          p.innerHTML = colorize(line); 
	          fragment.appendChild(p);
	      }
	      
	      const currentDomLines = $log.children.length;
	      const newLinesCount = pendingLogs.length;
          
	      while(currentDomLines + newLinesCount > MAX_LOG_LINES && $log.firstChild) {
	          $log.removeChild($log.firstChild);
	      }
          
	      if(logLines.length > MAX_LOG_LINES) logLines=logLines.slice(-MAX_LOG_LINES);

	      $log.appendChild(fragment); 

	      pendingLogs.length=0; 
	      
	      $log.scrollTop=$log.scrollHeight;
	    },FLUSH_INTERVAL);
	  }
	
	  function appendLog(msg){
	    if(!msg) return;
	    if($log.textContent.includes("ëŒ€ê¸°ì¤‘")){
	        $log.innerHTML=""; 
	        logLines.length=0; 
	        pendingLogs.length=0;
	    }
	    pendingLogs.push(msg);
	    scheduleFlush();
	  }
	
	  // ===== íƒ€ì´ë¨¸ (0ì´ˆë¶€í„° íŒíŠ¸ ì˜†ì— í‘œì‹œ - ê¹œë¹¡ì„ í•´ê²°) =====
	  function updateHintTimer(){
	    if(startTime===null || !currentRunner) return;
	    
	    const sec=Math.floor((Date.now()-startTime)/1000);
	    const m=Math.floor(sec/60), s=sec%60;
	    const timeStr = `â± ${m>0?m+"ë¶„ ":""}${s}ì´ˆ ê²½ê³¼`;
	    
	    // *í•µì‹¬ ìˆ˜ì •*: íŒíŠ¸ íƒ€ì´ë¨¸ ì—˜ë¦¬ë¨¼íŠ¸ë§Œ í…ìŠ¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ê¹œë¹¡ì„ ì œê±°
	    $hintTimer.textContent = timeStr; 
	  }

	  function startTimer(){
	    startTime=Date.now();
	    if(timerInterval) clearInterval(timerInterval);
	    updateHintTimer(); // ì¦‰ì‹œ 0ì´ˆ í‘œì‹œ
	    timerInterval=setInterval(updateHintTimer,1000);
	  }
	  
	  function stopTimer(){
	    if(timerInterval){clearInterval(timerInterval);timerInterval=null;}
	  }
	
	  // ===== í¼ì„¼íŠ¸ =====
	  function setBar(bar,pct,val){
	    const v=Math.min(100,Math.max(0,Math.round(val||0)));
	    bar.style.width=v+"%"; pct.textContent=v+"%";
	  }
	
	  // ===== UI =====
	  function resetUI(){
	    isOwner=false; currentTaskId=null; currentRunner=null; currentProgress=0;
	    setBar($barTotal,$pctTotal,0);
	    setBar($barKrx,$pctKrx,0);
	    setBar($barData,$pctData,0);
	    $badgeTotal.textContent="-"; $badgeKrx.textContent=""; $badgeData.textContent="";
	    $hintStatus.innerHTML="â€» ê´€ë¦¬ìë§Œ ì‹¤í–‰ ê°€ëŠ¥"; 
        $hintTimer.textContent=""; // íƒ€ì´ë¨¸ ë¹„ìš°ê¸°
	    $btnStart.disabled=false; $btnCancel.disabled=true;
	    $log.innerHTML='<p class="log-info">ë¡œê·¸ ëŒ€ê¸°ì¤‘...</p>';
        logLines.length=0; pendingLogs.length=0;
	    stopTimer(); startTime=null;
	  }
	
	  // finalTime ì¸ì ì œê±° (íŒíŠ¸ ì˜ì—­ì— ì™„ë£Œ ì‹œê°„ í‘œì‹œ ì•ˆ í•¨)
	  function updateHint(runner, progress){ 
	    currentRunner = runner;
	    currentProgress = progress;
        
	    const runnerText = isOwner ? `âš™ï¸ ${currentRunner}ë‹˜ ì‹¤í–‰ ì¤‘` : `ğŸš« ${currentRunner}ë‹˜ ì‹¤í–‰ ì¤‘`;
	    const progressText = ` (${Math.round(progress||0)}%)`;

        // ì‹¤í–‰ ì¤‘: "âš™ï¸ adminë‹˜ ì‹¤í–‰ ì¤‘ (45%)" ë§Œ hintStatusì— ì„¤ì •
        $hintStatus.innerHTML = `${runnerText}${progressText}`;
        // hintTimerëŠ” updateHintTimer()ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ê±°ë‚˜, COMPLETED ì‹œ ë¹„ì›Œì§
	  }
	
	  function applyOwnerUI(runner, progress){
	    isOwner=true;
	    updateHint(runner, progress);
	    $btnStart.disabled=true; $btnCancel.disabled=false;
	  }
	
	  function applyWatcherUI(runner, progress){
	    isOwner=false;
	    updateHint(runner, progress);
	    $btnStart.disabled=true; $btnCancel.disabled=true;
	  }
	
	  // ===== ìƒíƒœ ë³µì› (ì²« ë²ˆì§¸ ì‚¬ìš©ìë§Œ) =====
	  async function restoreState(){
	    try{
	      const meRes = await fetch("/auth/validate",{credentials:"include"});
	      if(meRes.ok){
	        const me = await meRes.json();
	        if(me && me.valid) currentUser = me.username || me.name || null;
	      }
	      const res = await fetch("/api/stock/batch/prod/active",{credentials:"include"});
	      if(!res.ok) return;
	      const a = await res.json();
	      if(!a || !a.active) { resetUI(); return; }
	
	      const runner = a.runner || "ì•Œ ìˆ˜ ì—†ìŒ";
	      const prog = (typeof a.progress==="number") ? a.progress : 0;
	      currentTaskId = a.taskId || null;
	
	      setBar($barTotal,$pctTotal,prog||0);
	
	      if(currentUser && runner && currentUser===runner){
	        applyOwnerUI(runner, prog);
	      }else{
	        applyWatcherUI(runner, prog);
	      }
	    }catch(e){
	      console.warn("ìƒíƒœ ë³µì› ì‹¤íŒ¨", e);
	    }
	  }
	
	  // ===== SSE =====
	  function connect(){
	    if(es){try{es.close();}catch(_){}} es=null;
	    es=new EventSource("/api/stock/batch/prod/sse",{withCredentials:true});
	    connected=true; reconnecting=false; $conn.textContent="";
	
	    es.addEventListener("status",e=>{
	      const d=JSON.parse(e.data||"{}");
	      if(d.status==="IDLE"){resetUI();return;}
	
	      if(d.dataTotal>0){setBar($barData,$pctData,(d.dataSaved*100/d.dataTotal));$badgeData.textContent=`${d.dataSaved}/${d.dataTotal}`;}
	      if(d.krxTotal>0){setBar($barKrx,$pctKrx,(d.krxSaved*100/d.krxTotal));$badgeKrx.textContent=`${d.krxSaved}/${d.krxTotal}`;}
	      if(typeof d.progress==="number"){setBar($barTotal,$pctTotal,d.progress);}
	
	      if(d.runner){
	        const owner = (typeof d.owner==="boolean") ? d.owner : (currentUser && d.runner && currentUser===d.runner);
	        isOwner = owner;
            currentRunner = d.runner;
            currentProgress = d.progress||0;

	        if(owner){ applyOwnerUI(d.runner, d.progress||0); }
	        else     { applyWatcherUI(d.runner, d.progress||0); }
	      }
          
          // ì‹¤í–‰ ì¤‘ì´ë©´ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ (SSEë¡œ PROGRESSê°€ ì˜¬ ë•Œë§ˆë‹¤ ì‹¤í–‰ ìƒíƒœë¥¼ ìµœì‹ í™”)
          if (d.status === "RUNNING" && startTime) {
              updateHintTimer();
          }

	      if(Array.isArray(d.logs)) d.logs.forEach(l=>appendLog(l));
	
	      if(d.status==="START"){ startTimer(); }
	      
	      if(d.status==="COMPLETED"){
	        setBar($barTotal,$pctTotal,100);
	        $badgeTotal.textContent="âœ… ì™„ë£Œ";
	        
            // ìµœì¢… ì‹œê°„ ê³„ì‚° ë° íƒ€ì´ë¨¸ ì¤‘ì§€
            let timeStr = "ì•Œ ìˆ˜ ì—†ëŠ” ì‹œê°„";
            if(startTime !== null){ 
                const finalSeconds = Math.floor((Date.now()-startTime)/1000);
                const m = Math.floor(finalSeconds/60), s = finalSeconds%60;
                timeStr = `${m>0?m+"ë¶„ ":""}${s}ì´ˆ`; 
            }
	        stopTimer(); 
            
            // íŒíŠ¸ ì˜ì—­ì— ì™„ë£Œ ìƒíƒœë§Œ ìµœì¢… í‘œì‹œ (ì‹œê°„ì€ í‘œì‹œ ì•ˆí•¨)
            updateHint(currentRunner || 'admin', 100); 
            $hintTimer.textContent = "";

            // ë¡œê·¸ ì°½ì— ìµœì¢… ì†Œìš” ì‹œê°„ ì¶œë ¥ (ìš”ì²­ ì‚¬í•­ ë°˜ì˜)
            appendLog(`[COMPLETED] ì „ì²´ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ì†Œìš” ì‹œê°„: ${timeStr})`);
	        
	        $btnStart.disabled=false; $btnCancel.disabled=true;
	      }
	      
	      if(d.status==="CANCELLED"||d.status==="FAILED"){
	        stopTimer();
	        resetUI();
	      }
	    });
	
	    es.addEventListener("ping",()=>{connected=true;});
	
	    es.onerror=()=>{
	      if(!reconnecting){reconnecting=true;$conn.textContent="âš ï¸ SSE ì¬ì—°ê²° ì¤‘...";}
	      connected=false;
	      try{es.close();}catch(_){}
	      es=null;
	      setTimeout(()=>{
	        connect();
	        $conn.textContent="âœ… ì—°ê²° ë³µì›ë¨";
	        setTimeout(()=>{$conn.textContent="";},1500);
	      },2000);
	    };
	
	    window.addEventListener("beforeunload",()=>{if(es){try{es.close();}catch(_){}}});
	  }
	
	  // ===== ë²„íŠ¼ =====
	  $btnStart.onclick=async()=>{
	    resetUI(); setBar($barTotal,$pctTotal,0);
	    $btnStart.disabled=true; $btnCancel.disabled=true;
	    
	    // workers, historyYears, force ê°’ì„ ê°€ì ¸ì™€ URL ìƒì„±
        const workers = $workers.value || 16;
        const historyYears = $historyYears.value || 3;
        const force = $force.checked ? "&force=true" : "";
        
	    const url=`/api/stock/batch/prod/update?workers=${workers}&historyYears=${historyYears}${force}`;
	    
	    const res=await fetch(url,{method:"POST",credentials:"include"});
	    if(res.ok){
	      const d=await res.json().catch(()=>({}));
	      currentTaskId=d.taskId||null;
	    } else {
	      const err = await res.json().catch(()=>({error: `ì„œë²„ ì˜¤ë¥˜ (${res.status})`}));
	      if (err.error) {
              appendLog(`âš ï¸ ì‹¤í–‰ ì‹¤íŒ¨: ${err.error}`);
          } else {
              appendLog("âš ï¸ ë‹¤ë¥¸ ì‚¬ìš©ì ì‘ì—… ì¤‘");
          }
	    }
	  };
	
	  $btnCancel.onclick=async()=>{
	    if(!isOwner||!currentTaskId) return;
	    await fetch(`/api/stock/batch/prod/cancel/${currentTaskId}`,{method:"POST",credentials:"include"});
	  };
	
	  $copy.onclick=()=>{
	    // logLinesì€ ë³µì‚¬ ê°€ëŠ¥í•œ Raw Textë§Œ í¬í•¨
	    const t=logLines.join("\n");
        const textArea = document.createElement("textarea");
        textArea.value = t;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            // ë³µì‚¬ ì„±ê³µ ì‹œ ì•„ì´ì½˜ ë³€ê²½ (ìš°ì•„í•œ ìŠ¤íƒ€ì¼ ìœ ì§€)
            $copy.innerHTML=`<i class="fas fa-check"></i> ë³µì‚¬ ì™„ë£Œ`;
            $copy.style.color = '#22c55e';
            $copy.style.background = '#dcfce7';
            setTimeout(()=>{
                $copy.innerHTML=`<i class="fas fa-copy"></i> ë¡œê·¸ ë³µì‚¬`;
                $copy.style.color = '#3b82f6';
                $copy.style.background = 'transparent';
            },1500);
        } catch (err) {
            console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        }
        document.body.removeChild(textArea);
	  };
	
	  // ì‹¤í–‰ ìˆœì„œ: 1) ìƒíƒœ ë³µì› â†’ 2) SSE ì—°ê²°
	  (async function init(){
	    await restoreState();
	    connect();
	  })();
	})();
</script>
</th:block>

</body>
</html>