<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š AthenaAI ë°°ì¹˜ ì—…ë°ì´íŠ¸</title> 
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --main-bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-color-primary: #111827;
            --text-color-secondary: #6b7280;
            --border-color-default: #d1d5db;
            --input-bg: #ffffff;
            --progress-bar-bg: #e5e7eb;

            --log-box-bg: #111;
            --log-text-default: #e0e0e0;
            --log-text-info: #9ca3af;
            --log-text-progress: #60a5fa;
            --log-text-warning: #f59e0b;
            --log-text-error: #ef4444;
            --log-text-complete: #22c55e;

            --card-border: #d1d5db;
            --error-card-bg: #fff;
            --error-card-border: #e5e7eb;
            --error-card-text: #374151;
            --error-card-hover: #fee2e2;
            --error-card-header: #b91c1c;
        }

        /* ğŸ’¡ ë“œë˜ê·¸ ì¤‘ì¸ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        .dragging {
            opacity: 0.4;
            box-shadow: none !important; 
        }

        /* ğŸ’¡ ë“œë¡­ ì˜ì—­ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .drag-over {
            border: 4px dashed #6366f1 !important;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        
        /* âœ… [ê°œì„ ] ì¹´ë“œ ì„ íƒ ì‹œ ë ˆì´ì•„ì›ƒ í”ë“¤ë¦¼(ìš¸ë ê±°ë¦¼) ì œê±° (border 3pxë¡œ ê³ ì •) */
        .option-card {
            border: 3px solid var(--border-color-default); /* 1px ëŒ€ì‹  3pxë¡œ ê³ ì •í•˜ì—¬ CLS ë°©ì§€ */
            border-radius: 8px;
            padding: 16px;
            background-color: var(--card-bg);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            height: 100%; 
        }
        .option-card:hover {
            border-color: #a5b4fc;
        }
        input[type="radio"]:checked + .option-card {
            border-color: #6366f1; /* í…Œë‘ë¦¬ ìƒ‰ìƒë§Œ ë³€ê²½ */
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
            background-color: #f7f9fd; /* ì€ì€í•œ ë°°ê²½ìƒ‰ */
        }

        /* âœ… MA 20ì¼ì„  ì‹œê°ì  ìˆ˜ì • */
        /* disabled ë˜ì–´ë„ ì²´í¬ í‘œì‹œê°€ ëª…í™•í•˜ê²Œ ë³´ì´ë„ë¡ ê°•ì¡° */
        #ma20:checked:disabled {
            background-color: #6366f1 !important; /* Indigo-600 */
            border-color: #4f46e5 !important;
            color: #ffffff !important; /* ì²´í¬ ë§ˆí¬ ìƒ‰ìƒ */
        }
        
        /* âœ… ì„¹ì…˜ í† ê¸€ ê°œì„ : max-height íŠ¸ëœì§€ì…˜ ë° overflow: hidden */
        .section-content-toggle {
            transition: max-height 0.35s ease-out; 
            overflow: hidden;
            padding-bottom: 0 !important; 
        }
        .section-content-inner-padding {
            padding-bottom: 1rem; 
        }


        .global-status-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 12px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .global-status-header {
            font-weight: 600;
            color: var(--text-color-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
        }
        .global-status-body {
            font-size: .9rem;
            color: var(--text-color-secondary);
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }
        .global-status-progress {
            width: 100%;
            height: 10px;
            background: var(--progress-bar-bg);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 8px;
        }
        .global-status-progress div {
            height: 100%;
            width: 0%;
            background: #2563eb;
            transition: width .25s;
        }

        .status-idle{color:#6b7280;}
        .status-running{color:#2563eb;}
        .status-completed{color:#22c55e;}
        .status-failed{color:#ef4444;}
        .status-cancelled{color:#f59e0b;}
        .status-locked{color:#9333ea;} 
        
        @keyframes blink {0%,100%{opacity:1}50%{opacity:.35}}
        .blinking{animation:blink 1.2s infinite;}
        
        /* ===============================================================
           âœ… ì¶”ê°€: ì°¨íŠ¸ ìº”ë²„ìŠ¤ ì‚¬ì´ì¦ˆ/íˆ´ë°” (ì´ë¯¸ì§€ ëŒ€ë¹„ êµì²´ìš©)
           ---------------------------------------------------------------
           - ê¸°ì¡´ <img id="chartImage"> ëŠ” Fallback ìœ¼ë¡œ ìœ ì§€(ìˆ¨ê¹€/í‘œì‹œ)
           - ì°¨íŠ¸ ìº”ë²„ìŠ¤ëŠ” ë°˜ì‘í˜• 100%ë¡œ í‘œì‹œ
           - íˆ´ë°”(ë¦¬ì…‹/í™•ëŒ€/ì´ë™ ì•ˆë‚´)ëŠ” ìµœì†Œí•œìœ¼ë¡œ ì¶”ê°€
        =============================================================== */
        .chart-canvas-wrap{width:100%; background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:12px;}
        .chart-toolbar{display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-bottom:8px;}
        .chart-toolbar button{font-size:.85rem; padding:.35rem .6rem; border:1px solid #d1d5db; border-radius:8px;}
        .chart-toolbar .hint{margin-right:auto; font-size:.8rem; color:#6b7280;}
        #chartCanvas, #macdCanvas{width:100%; height:360px;}
        @media (max-width: 640px){
          #chartCanvas, #macdCanvas{height:280px;}
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- âœ… ì¶”ê°€: í™•ëŒ€/ì´ë™ í”ŒëŸ¬ê·¸ì¸ (ì°¨íŠ¸ ìƒí˜¸ì‘ìš© ê°•í™”) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">

    <div class="page-header">
      <div class="page-title">
        <h2>ğŸ“„ êµ­ë‚´ ì£¼ì‹ íŒ¨í„´ ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜</h2>
      </div>
      <div class="breadcrumb">
        <i class="fas fa-folder-open"></i>
        <span>ì‹œìŠ¤í…œ / ë¶„ì„ ë„êµ¬ (AthenaAi)</span>
      </div>
    </div>

    <!-- âœ… ì „ì—­(Global) ìƒíƒœ ì¹´ë“œ -->
    <div class="global-status-card">
        <div class="global-status-header">
          ğŸŒ AthenaAI ë°°ì¹˜ ì§„í–‰ ìƒíƒœ
          <span id="globalStatusText" class="status-idle">ëŒ€ê¸°ì¤‘</span>
        </div>

        <div class="global-status-body">
          <div>ì‹¤í–‰ì: <span id="globalRunner">ë¯¸ì—°ê²°</span></div>
          <div>ì „ì²´ ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div>
        </div>

        <div class="global-status-progress">
            <div id="globalProgressBar"></div>
        </div>
    </div>
    
        <!-- âœ… ë¶„ì„ ì˜µì…˜ ì„¹ì…˜ -->
    <div class="card mb-8">
        <form id="analysisForm">

            <!-- âœ… 1. ë¶„ì„ ìœ í˜• ì„ íƒ (ìˆœì„œ ë³€ê²½ ê°€ëŠ¥) -->
            <button type="button"
                    class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-0 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150"
                    onclick="toggleSection('analysisTypeContent', this)">
                <span>1. ë¶„ì„ ìœ í˜• ì„ íƒ (ìˆœì„œ ë³€ê²½ ê°€ëŠ¥)</span>
                <span id="analysisTypeArrow" class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>

            <div id="analysisTypeContent" class="section-content-toggle">
                <div class="section-content-inner-padding">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

                        <!-- MA ë¶„ì„ (Draggable) -->
                        <label for="maRadio" class="block option-card-wrapper" draggable="true">
                            <input type="radio" name="analysisType" id="maRadio" value="ma"
                                   class="hidden" checked onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-indigo-500">ğŸ“‰</span> ì´ë™í‰ê· ì„ (MA) ë¶„ì„ (ê¸°ë³¸)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ì¥ê¸° í•˜ë½ ë°°ì—´ ì¢…ëª© íƒìƒ‰</p>

                                <!-- MA ê¸°ê°„ -->
                                <div id="maPeriodsContainer"
                                     class="ml-0 mt-3 p-3 bg-indigo-100/50 rounded-lg transition-all duration-300">
                                    <h4 class="font-semibold text-indigo-700 mb-2 text-sm">
                                        MA ê¸°ê°„ ì„ íƒ (í•˜ë½ ë°°ì—´ í™•ì¸):
                                    </h4>

                                    <div class="flex flex-wrap gap-x-4 gap-y-2 items-center">
                                        <!-- âœ… MA 20ì¼ì„  ì²´í¬ í‘œì‹œ ì‹œê°í™” ìˆ˜ì • ë°˜ì˜ -->
                                        <input type="checkbox" name="maPeriods" value="20" id="ma20"
                                               checked disabled class="rounded text-indigo-600 focus:ring-0">
                                        <label for="ma20" class="text-sm text-gray-700 font-extrabold">20ì¼ì„  (í•„ìˆ˜)</label>
                                        
                                        <input type="checkbox" name="maPeriods" value="60" id="ma60"
                                               checked class="rounded text-indigo-600">
                                        <label for="ma60" class="text-sm">60ì¼ì„ </label>

                                        <input type="checkbox" name="maPeriods" value="200" id="ma200"
                                               checked class="rounded text-indigo-600">
                                        <label for="ma200" class="text-sm">200ì¼ì„ </label>
                                        
                                        <input type="checkbox" name="maPeriods" value="500" id="ma500"
                                               checked class="rounded text-indigo-600">
                                        <label for="ma500" id="ma500Label" class="text-sm">500ì¼ì„ </label>
                                    </div>
                                </div>
                            </div>
                        </label>

                        <!-- Double Bottom (Draggable) -->
                        <label for="doubleBottomRadio" class="block option-card-wrapper" draggable="true">
                            <input type="radio" name="analysisType" id="doubleBottomRadio"
                                   value="double_bottom" class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-green-500">ğŸ“ˆ</span> ì´ì¤‘ë°”ë‹¥ (Wìí˜• íŒ¨í„´)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ê°•ë ¥í•œ ì¶”ì„¸ ë°˜ì „ íƒìƒ‰</p>
                            </div>
                        </label>

                        <!-- Triple Bottom (Draggable) -->
                        <label for="tripleBottomRadio" class="block option-card-wrapper" draggable="true">
                            <input type="radio" name="analysisType" id="tripleBottomRadio"
                                   value="triple_bottom" class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-green-500">ğŸ“Š</span> ì‚¼ì¤‘ë°”ë‹¥ íŒ¨í„´
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ë°”ë‹¥ ë‹¤ì§€ê¸° ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>

                        <!-- Cup & Handle (Draggable) -->
                        <label for="cupAndHandleRadio" class="block option-card-wrapper" draggable="true">
                            <input type="radio" name="analysisType" id="cupAndHandleRadio"
                                   value="cup_and_handle" class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-amber-500">â˜•</span> ì»µì•¤í•¸ë“¤ íŒ¨í„´
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ëŒíŒŒ ì§ì „ ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>

                        <!-- Decline 5 Days (Draggable) -->
                        <label for="decline5dRadio" class="block option-card-wrapper" draggable="true">
                            <input type="radio" name="analysisType" id="decline5dRadio"
                                   value="decline_5d" class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-red-600">ğŸ”»</span> ë‹¨ê¸° ê¸‰ë½ì£¼ (5ì¼ ì—°ì† í•˜ë½)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">ê³¼ëŒ€ ë‚™í­ì£¼ íƒìƒ‰</p>
                            </div>
                        </label>

                        <!-- Decline 20 Days (Draggable) -->
                        <label for="decline20dRadio" class="block option-card-wrapper" draggable="true">
                            <input type="radio" name="analysisType" id="decline20dRadio"
                                   value="decline_20d" class="hidden" onclick="toggleMaPeriods()">
                            <div class="option-card">
                                <p class="text-lg font-semibold text-gray-800 flex items-center">
                                    <span class="mr-2 text-red-700">â¬‡ï¸</span> ì¤‘ê¸° ì—°ì† í•˜ë½ (20ì¼)
                                </p>
                                <p class="text-sm text-gray-500 mt-1">í•œ ë‹¬ê°„ ë°˜ë“± ì—†ëŠ” ì¢…ëª© íƒìƒ‰</p>
                            </div>
                        </label>

                    </div>
                </div>
            </div>

            <!-- âœ… 2. ì‹¤í–‰ ì˜µì…˜ ì„¤ì • (mt-8 -> mt-6ë¡œ ê°„ê²© ì¶•ì†Œ) -->
            <button type="button"
                    class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-6 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150"
                    onclick="toggleSection('filteringOptionsContent', this)">
                <span>2. ì‹¤í–‰ ì˜µì…˜ ì„¤ì •</span>
                <span id="filteringOptionsArrow" class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>

            <div id="filteringOptionsContent" class="section-content-toggle">
                <div class="section-content-inner-padding">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                        <!-- ì›Œì»¤ìˆ˜ -->
                        <div class="p-4 bg-white rounded-lg border border-purple-200 shadow-sm flex items-center">
                            <span class="mr-3 text-purple-700 font-bold">ğŸ› ï¸ ì‘ì—…ì ìˆ˜:</span>
                            <input type="number" id="workerCount" value="8" min="1" max="16"
                                   class="w-16 px-3 py-1 border border-purple-300 rounded-lg text-center font-bold text-lg focus:ring-purple-500">
                            <span class="ml-2 text-purple-800 font-semibold">ê°œ</span>
                        </div>

                        <!-- ë¹ˆ ê³µê°„ì„ ì±„ìš°ê¸° ìœ„í•œ ë”ë¯¸ (ë ˆì´ì•„ì›ƒ ìœ ì§€ë¥¼ ìœ„í•´) -->
                        <div class="hidden md:block"></div>
                        <div class="hidden md:block"></div>
                    </div>
                </div>
            </div>

            <!-- âœ… 3. ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ (mt-8 -> mt-6ë¡œ ê°„ê²© ì¶•ì†Œ) -->
            <button type="button"
                    class="w-full text-left flex justify-between items-center text-2xl font-bold text-gray-700 mt-6 mb-5 border-b pb-3 hover:text-indigo-600 transition duration-150"
                    onclick="toggleSection('topNCountContent')">
                <span>3. ê²°ê³¼ í‘œì‹œ ê°œìˆ˜ ì„¤ì •</span>
                <span id="topNCountArrow" class="text-3xl transition-transform duration-300 transform">â–¾</span>
            </button>

            <div id="topNCountContent" class="section-content-toggle">
                <div class="section-content-inner-padding">
                    <div class="flex items-center bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <label for="topNCount"
                               class="text-lg text-gray-700 font-medium mr-4">
                            ìƒìœ„ ì¢…ëª© ê°œìˆ˜(N):
                        </label>

                        <input type="number" id="topNCount" value="10" min="1" max="50"
                               class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-center font-bold text-xl">

                        <span class="ml-4 text-gray-500 text-sm">1~50 ì‚¬ì´</span>
                    </div>
                </div>
            </div>

        </form>

        <!-- âœ… ì‹¤í–‰ / ì·¨ì†Œ ë²„íŠ¼ -->
        <div class="run-controls-wrapper mt-8 flex space-x-4">

            <button type="button" id="runAnalysisBtn"
                    onclick="runAnalysis()"
                    class="flex-grow px-6 py-3 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                ğŸš€ ë¶„ì„ ì‹¤í–‰ ë° ìœ ë§ ì¢…ëª© ì°¾ê¸°
            </button>

            <button type="button" id="btnCancel"
                    onclick="cancelAnalysis()"
                    class="px-6 py-3 bg-red-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    disabled>
                âŒ ì·¨ì†Œ
            </button>

        </div>

    </div>
    
    
        <!-- âœ… ê²°ê³¼ ì˜ì—­ -->
    <div class="card mb-10">

        <!-- í™”ë©´ ìƒë‹¨ ì œëª© -->
        <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center">
            ğŸ“Š ë¶„ì„ ê²°ê³¼
        </h3>

        <!-- âœ… ê²°ê³¼ í…Œì´ë¸” -->
        <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
            <table class="min-w-full bg-white text-gray-800" id="resultTable">
                <thead class="bg-gray-100 border-b border-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">ì¢…ëª©ì½”ë“œ</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">ì¢…ëª©ëª…</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">ì‹ í˜¸ ê°•ë„ / ìˆ˜ë™ ê²€í† </th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">MA ë°°ì—´</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">ì°¨íŠ¸ í™•ì¸</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody"></tbody>
            </table>
        </div>

        <!-- âœ… ê²°ê³¼ ì—†ìŒ -->
        <div id="noResultBox" class="hidden p-6 text-center text-gray-500 text-lg">
            ë¶„ì„ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>

    </div>

    <!-- âœ… ë¡œê·¸ ì˜ì—­ -->
    <div class="card mb-14">
        <h3 class="text-2xl font-bold text-gray-700 mb-4 flex items-center">
            ğŸªµ ì‹¤ì‹œê°„ ë¡œê·¸
            <button id="copyLogBtn" class="ml-4 px-3 py-1 bg-indigo-600 text-white text-sm rounded-md hover:bg-indigo-700 transition duration-200">
                ë³µì‚¬
            </button>
        </h3>

        <div id="logBox"
             class="h-64 bg-black text-green-300 text-sm p-3 rounded-md overflow-y-auto font-mono">
            <p class="opacity-70">ë¡œê·¸ ëŒ€ê¸°ì¤‘...</p>
        </div>
    </div>

    <!-- âœ… ì°¨íŠ¸ ëª¨ë‹¬ -->
    <div id="chartModal"
         class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-50">
        <div class="bg-white rounded-xl shadow-xl p-4 max-w-4xl w-full relative">

            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-700">ğŸ“ˆ ì°¨íŠ¸</h3>
                <button onclick="closeChartModal()"
                        class="text-gray-600 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <!-- âœ… ì°¨íŠ¸ ì´ë¯¸ì§€ (Fallback ìš©ë„) -->
            <img id="chartImage" src="" class="w-full rounded-lg shadow-md mb-4" style="display:none;">

            <!-- âœ… ì°¨íŠ¸ ìº”ë²„ìŠ¤(ê°€ê²©/MA + MACD) -->
            <div class="chart-canvas-wrap">
              <div class="chart-toolbar">
                <span class="hint">ë§ˆìš°ìŠ¤ íœ  í™•ëŒ€ Â· ë“œë˜ê·¸ ì´ë™ Â· ë”ë¸”í´ë¦­ ë¦¬ì…‹</span>
                <button type="button" id="btnResetZoom">ë¦¬ì…‹</button>
              </div>
              <canvas id="chartCanvas"></canvas>
            </div>
            <div class="chart-canvas-wrap mt-3">
              <canvas id="macdCanvas"></canvas>
            </div>
            
            <!-- âœ… ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜ ì˜ì—­ (ì°¨íŠ¸ ë¶„ì„ í›„ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ê¸°ëŠ¥) -->
            <div id="manualReviewArea" class="p-4 bg-gray-50 border border-gray-200 rounded-lg mt-4">
                <p class="text-sm text-gray-600 mb-3">
                    âœï¸ <strong>ìˆ˜ë™ ê²€í† :</strong> ì°¨íŠ¸ë¥¼ í™•ì¸í•œ í›„, ì´ ì¢…ëª©ì— ëŒ€í•œ <strong>ìˆ˜ë™ ê²€í†  ìƒíƒœ</strong>ë¥¼ í…Œì´ë¸”ì— ë°˜ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="flex justify-end">
                    <button id="updateResultBtn"
                            class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-200"
                            onclick="updateResultStatus()">
                        â­ ìœ ë§ ì¢…ëª©ìœ¼ë¡œ ìˆ˜ë™ ì—…ë°ì´íŠ¸ (í…Œì´ë¸”ì— ë°˜ì˜)
                    </button>
                </div>
            </div>

        </div>
    </div>
    
<th:block layout:fragment="pageScript">
<script>
(function () {

  /* ================================
     âœ… ìš”ì†Œ ì„ íƒ (HTML ì‹¤ì œ id ê¸°ì¤€)
  ================================== */
  const $runBtn = document.getElementById("runAnalysisBtn");
  const $cancelBtn = document.getElementById("btnCancel");

  const $analysisForm = document.getElementById("analysisForm");
  const $log = document.getElementById("logBox");
  const $copyLogBtn = document.getElementById("copyLogBtn");

  const $resultTableBody = document.getElementById("resultTableBody");
  const $noResultBox = document.getElementById("noResultBox");

  const $chartModal = document.getElementById("chartModal");
  const $chartImage = document.getElementById("chartImage");
  const $modalTitle = document.getElementById("modalTitle");

  const $globalStatusText = document.getElementById("globalStatusText");
  const $globalRunner = document.getElementById("globalRunner");
  const $globalProgressLabel = document.getElementById("globalProgressLabel");
  const $globalProgressBar = document.getElementById("globalProgressBar");

  const $analysisTypeContent = document.getElementById('analysisTypeContent');
  const $filteringOptionsContent = document.getElementById('filteringOptionsContent');
  const $topNCountContent = document.getElementById('topNCountContent');

  /* ================================
     âœ… ì¶”ê°€: ì°¨íŠ¸ DOM ìš”ì†Œ/ìƒíƒœ
     - ì˜¤ì§ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë Œë” (ì„œë²„ ë³€ê²½ ç„¡)
     - JSON ì‹¤íŒ¨ ì‹œ ìë™ Fallback(ê¸°ì¡´ ì´ë¯¸ì§€)
  ================================== */
  const $priceCanvas = document.getElementById('chartCanvas');
  const $macdCanvas  = document.getElementById('macdCanvas');
  const $btnResetZoom = document.getElementById('btnResetZoom');
  let priceChart = null;
  let macdChart  = null;

  let currentTaskId = null;
  let es = null;
  let currentUser = "ë¯¸ì—°ê²°"; // ì´ˆê¸° ì‚¬ìš©ì ID
  let $currentRow = null; 
  let globalStatus = "IDLE"; 


  /* ================================
     âœ… ë¶„ì„ ìœ í˜• ì„ íƒ ë° ë§¤ê°œë³€ìˆ˜
  ================================== */
  function getSelectedPattern() {
    const checked = document.querySelector("input[name='analysisType']:checked");
    return checked ? checked.value : "ma";
  }
  
  function getMaPeriods() {
    // íŒŒì´ì¬ ë°±ì—”ë“œ ë§¤ê°œë³€ìˆ˜ í˜•ì‹ì— ë§ê²Œ ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ ìƒì„±
    const maPeriodsElements = document.querySelectorAll('input[name="maPeriods"]:checked');
    const maPeriods = Array.from(maPeriodsElements)
        .map(el => el.value)
        .filter((value, index, self) => self.indexOf(value) === index) 
        .sort((a, b) => parseInt(a) - parseInt(b))
        .join(',');
        
    return maPeriods; // ì˜ˆ: "20,60,200"
  }


  /* ================================
     âœ… MA ì²´í¬ë°•ìŠ¤ í‘œì‹œ/ìˆ¨ê¹€
  ================================== */
  window.toggleMaPeriods = function () {
    const isMA = document.getElementById("maRadio").checked;
    const box = document.getElementById("maPeriodsContainer");
    
    // MAê°€ ì•„ë‹Œ íŒ¨í„´ì„ ì„ íƒí•˜ë©´ MA ê¸°ê°„ ì…ë ¥ í•„ë“œë¥¼ ì ê·¸ê³  ìˆ¨ê¹€
    const inputs = box.querySelectorAll('input[type="checkbox"]');
    inputs.forEach(input => {
        // MA 20ì¼ì„ ì€ HTMLì—ì„œ ì´ë¯¸ disabled ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œ ìƒíƒœë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        if (input.id === 'ma20') return; 

        if (isMA) {
            input.disabled = false;
        } else {
            input.disabled = true;
        }
    });

    box.style.display = isMA ? "block" : "none";
  };
  
  /* ================================
     âœ… ì„¹ì…˜ í† ê¸€ ê°œì„  (maxHeight ê¸°ë°˜)
  ================================== */
  window.toggleSection = function (contentId) {
    const buttonElement = event.currentTarget;
    const content = document.getElementById(contentId);
    const arrow = buttonElement.querySelector('span:last-child');
    
    const isClosed = content.style.maxHeight === '0px';

    if (isClosed) {
        content.style.maxHeight = content.scrollHeight + "px";
        arrow.classList.add('rotate-180');
        setTimeout(() => {
            if (content.style.maxHeight !== '0px') {
                content.style.maxHeight = null; 
            }
        }, 400); 
    } else {
        content.style.maxHeight = content.scrollHeight + "px";
        requestAnimationFrame(() => {
            content.style.maxHeight = '0px';
        });
        arrow.classList.remove('rotate-180');
    }
  };


  /* ================================
     âœ… ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ (ë¶„ì„ ìœ í˜•)
  ================================== */
  let dragSrcEl = null;

  window.handleDragStart = function (e) {
    dragSrcEl = this;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
    this.classList.add('dragging');
  };

  window.handleDragOver = function (e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  };

  window.handleDragEnter = function (e) {
    this.classList.add('drag-over');
  };

  window.handleDragLeave = function (e) {
    this.classList.remove('drag-over');
  };

  window.handleDrop = function (e) {
    e.stopPropagation();
    this.classList.remove('drag-over');

    if (dragSrcEl !== this) {
      const container = document.getElementById("analysisTypeContent").querySelector('.grid');
      if (dragSrcEl.compareDocumentPosition(this) & Node.DOCUMENT_POSITION_FOLLOWING) {
        container.insertBefore(dragSrcEl, this.nextSibling);
      } else {
        container.insertBefore(dragSrcEl, this);
      }
    }
    return false;
  };

  window.handleDragEnd = function (e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.option-card-wrapper').forEach(item => {
      item.classList.remove('drag-over');
    });
  };

  function attachDragListeners() {
      document.querySelectorAll('#analysisTypeContent label.option-card-wrapper').forEach(item => {
        item.ondragstart = window.handleDragStart;
        item.ondragover = window.handleDragOver;
        item.ondragenter = window.handleDragEnter;
        item.ondragleave = window.handleDragLeave;
        item.ondrop = window.handleDrop;
        item.ondragend = window.handleDragEnd;
      });
  }

  /* ================================
     âœ… ë²„íŠ¼ ìƒíƒœ ë° ì „ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸
  ================================== */
  function updateButtonState(status, runner) {
      const S = (status || "IDLE").toUpperCase();
      const isRunning = ["START", "IN_PROGRESS", "RUNNING"].includes(S);
      const isOwner = (runner === currentUser);
      
      globalStatus = S;

      if (!isRunning) {
          $runBtn.disabled = false;
      } else if (isRunning && !isOwner) {
          $runBtn.disabled = true;
      } else if (isRunning && isOwner) {
          $runBtn.disabled = true;
      }
      
      const inputs = $analysisForm.querySelectorAll('input, select:not([disabled])');
      inputs.forEach(input => {
          if (input.id === 'ma20') return; 
          input.disabled = isRunning;
      });
      toggleMaPeriods(); 

      $cancelBtn.disabled = !(isRunning && isOwner); 
  }

  function updateGlobalState(st, runner, progress) {
    const S = (st || "IDLE").toUpperCase();
    let displayText = S;
    if (S === "RUNNING" && runner !== currentUser) {
        displayText = "ë‹¤ë¥¸ ì‚¬ìš©ì ì‹¤í–‰ ì¤‘ (ì ê¹€)";
        $globalStatusText.classList.add("status-locked");
    } else {
        $globalStatusText.classList.remove("status-locked");
    }

    $globalStatusText.textContent = displayText;
    $globalRunner.textContent = runner || "ë¯¸ì—°ê²°";

    let pct = 0;
    if (S === "COMPLETED") {
        pct = 100;
    } else if (S === "RUNNING") {
        pct = Math.min(100, Math.max(0, Math.floor(progress || 0)));
    } else {
        pct = 0; 
    }
    
    $globalProgressLabel.textContent = pct + "%";
    $globalProgressBar.style.width = pct + "%";

    $globalStatusText.className = "";
    if (S === "RUNNING" && runner === currentUser) $globalStatusText.classList.add("status-running", "blinking");
    else if (S === "RUNNING" && runner !== currentUser) $globalStatusText.classList.add("status-locked");
    else if (S === "COMPLETED") $globalStatusText.classList.add("status-completed");
    else if (S === "FAILED") $globalStatusText.classList.add("status-failed");
    else if (S === "CANCELLED") $globalStatusText.classList.add("status-cancelled");
    else $globalStatusText.classList.add("status-idle");
  }

  /* ================================
     âœ… ë¡œê·¸ì¸ ì‚¬ìš©ì (ì„ì‹œ ID)
  ================================== */
  async function initCurrentUser() {
    const id = "user_" + Math.random().toString(36).substring(2, 8);
    currentUser = id;
    return id;
  }

  /* ================================
     âœ… ë¡œê·¸
  ================================== */
  function appendLog(line) {
    if (!line) return;
    const p = document.createElement("p");
    
    if (line.includes("[ERROR]") || line.includes("FATAL") || line.includes("ì‹¤íŒ¨")) {
        p.className = 'text-red-500';
    } else if (line.includes("WARNING")) {
        p.className = 'text-yellow-500';
    } else if (line.includes("COMPLETED") || line.includes("ì„±ê³µ")) {
        p.className = 'text-green-500 font-extrabold text-lg'; 
    } else if (line.includes("[LOG]") || line.includes("ìš”ì²­")) {
        p.className = 'text-blue-400';
    } else {
        p.className = 'text-gray-300';
    }
    
    p.textContent = line;
    $log.appendChild(p);
    $log.scrollTop = $log.scrollHeight;
  }

  /* ================================
     âœ… ë¡œê·¸ ë³µì‚¬
  ================================== */
  $copyLogBtn.onclick = () => {
    const t = Array.from($log.querySelectorAll("p"))
      .map(p => p.textContent)
      .join("\n");

    if (t.trim() === 'ë¡œê·¸ ëŒ€ê¸°ì¤‘...') {
        appendLog("[LOG] ğŸš« ë³µì‚¬í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    
    navigator.clipboard.writeText(t)
      .then(() => appendLog("[LOG] ğŸ“‹ ë¡œê·¸ ë³µì‚¬ ì™„ë£Œ"));
  };

  /* ================================
     âœ… ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
  ================================== */
  function renderResults(list) {
    $resultTableBody.innerHTML = "";

    if (!list || list.length === 0) {
      $noResultBox.classList.remove("hidden");
      return;
    }
    $noResultBox.classList.add("hidden");

    list.forEach((item) => {
      const rowId = `result-row-${item.ticker}`;
      const tr = document.createElement("tr");
      tr.id = rowId; 
      tr.className = 'hover:bg-gray-100 transition duration-100'; 
      tr.innerHTML = `
        <td class="px-4 py-2 border">${item.ticker || "-"}</td>
        <td class="px-4 py-2 border">${item.name || "-"}</td>
        <td class="px-4 py-2 border font-bold">${item.score || "-"}</td>
        <td class="px-4 py-2 border">${item.ma_pattern || "-"}</td>
        <td class="px-4 py-2 border text-center">
          <button class="px-3 py-1 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                  onclick="showChart('${item.ticker}', '${item.name}', '${rowId}')">ë³´ê¸°</button>
        </td>
      `;
      $resultTableBody.appendChild(tr);
    });
    
    appendLog(`[LOG] âœ… ìµœì¢… ë¶„ì„ ê²°ê³¼ ${list.length}ê°œ í•­ëª© í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ.`);
  }

  /* ============================================================
     âœ… ì°¨íŠ¸ ë Œë”ë§(Chart.js) â€” ê¸°ì¡´ ì´ë¯¸ì§€ì™€ í˜¸í™˜ Fallback
     ------------------------------------------------------------
     - ì„œë²„ì— ë³€ê²½ ì—†ì´ /chart?mode=chart_data ë¡œ JSON ìš”ì²­ ì‹œë„
     - ì‹¤íŒ¨/ë¹„JSON ì‘ë‹µì´ë©´ ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œë¡œ ìë™ ë³µê·€
     - í™•ëŒ€/ì´ë™ í™œì„±í™” (wheel/drag), ë”ë¸”í´ë¦­/ë²„íŠ¼ìœ¼ë¡œ ë¦¬ì…‹
  ============================================================ */
  function destroyCharts() {
    try { if (priceChart) { priceChart.destroy(); priceChart = null; } } catch(e){}
    try { if (macdChart)  { macdChart.destroy();  macdChart  = null; } } catch(e){}
  }

  function toLine(ds, key) {
    if (!Array.isArray(ds)) return [];
    return ds.map(d => ({ x: d.x, y: d[key] ?? d.y ?? null })).filter(p => p.y !== null && p.y !== undefined);
  }

  function toXY(ds) {
    if (!Array.isArray(ds)) return [];
    return ds.map(d => ({ x: d.x, y: d.y })).filter(p => p.y !== null && p.y !== undefined);
  }

  function color(op) {
    // Base indigo-ish set without forcing specific colors too much
    const c = 'rgba(37, 99, 235,' + (op ?? 1) + ')'; 
    return c;
  }

  function buildPriceChart(ctx, payload) {
    const closes = payload.ohlcv_data ? payload.ohlcv_data.map(d => ({ x: d.x, y: d.c })) : [];
    const ma20  = payload.ma_data && payload.ma_data.MA20  ? toXY(payload.ma_data.MA20)  : [];
    const ma50  = payload.ma_data && payload.ma_data.MA50  ? toXY(payload.ma_data.MA50)  : [];
    const ma200 = payload.ma_data && payload.ma_data.MA200 ? toXY(payload.ma_data.MA200) : [];

    // íŒ¨í„´/í¬ë¡œìŠ¤ í¬ì¸íŠ¸ (ì‚°ì ë„)
    const cross = Array.isArray(payload.cross_points) ? payload.cross_points.map(p => ({x:p.x, y:p.y, type:p.type})) : [];
    const pats  = Array.isArray(payload.pattern_points) ? payload.pattern_points.map(p => ({x:p.x, y:p.y, type:p.type, status:p.status})) : [];

    priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          { label: 'Close', data: closes, parsing:false, pointRadius:0, borderWidth:1.5, borderColor: '#111827' },
          { label: 'MA20',  data: ma20,  parsing:false, pointRadius:0, borderWidth:1.2, borderColor: '#22c55e' },
          { label: 'MA50',  data: ma50,  parsing:false, pointRadius:0, borderWidth:1.2, borderColor: '#f59e0b' },
          { label: 'MA200', data: ma200, parsing:false, pointRadius:0, borderWidth:1.2, borderColor: '#3b82f6' },
          // ê³¨ë“ /ë°ë“œ í¬ë¡œìŠ¤ í¬ì¸íŠ¸
          { label: 'Cross', type:'scatter', data: cross, parsing:false, pointRadius:4, pointBackgroundColor:'#ef4444', showLine:false },
          // íŒ¨í„´ ë„¥ë¼ì¸ ë“± í‘œì‹œ
          { label: 'Pattern', type:'scatter', data: pats, parsing:false, pointRadius:4, pointBackgroundColor:'#8b5cf6', showLine:false }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:false },
        scales:{
          x:{ type:'time', time:{ tooltipFormat:'yyyy-MM-dd' }, grid:{ display:false } },
          y:{ beginAtZero:false, ticks:{ callback:v => v.toLocaleString() } }
        },
        plugins:{
          legend:{ display:true, position:'top' },
          tooltip:{ callbacks:{
            label: (ctx)=>{
              const d = ctx.raw;
              if (ctx.dataset.type === 'scatter' && d && (d.type || d.status)) {
                return `${ctx.dataset.label}: ${d.type || ''} ${d.status ? '('+d.status+')' : ''}  y=${d.y?.toLocaleString?.()}`;
              }
              return `${ctx.dataset.label}: ${ctx.parsed.y?.toLocaleString?.()}`;
            }
          }},
          zoom:{
            pan:{ enabled:true, mode:'xy' },
            zoom:{ wheel:{ enabled:true }, pinch:{ enabled:true }, mode:'xy' }
          }
        }
      }
    });
  }

  function buildMacdChart(ctx, payload) {
    const macd = payload.macd_data && payload.macd_data.MACD ? toXY(payload.macd_data.MACD) : [];
    const signal = payload.macd_data && payload.macd_data.Signal ? toXY(payload.macd_data.Signal) : [];
    const hist = payload.macd_data && payload.macd_data.Histogram ? toXY(payload.macd_data.Histogram) : [];

    macdChart = new Chart(ctx, {
      data: {
        labels: (macd || []).map(p=>p.x),
        datasets: [
          { type:'line', label:'MACD',   data: macd,   parsing:false, pointRadius:0, borderWidth:1.2, borderColor:'#111827' },
          { type:'line', label:'Signal', data: signal, parsing:false, pointRadius:0, borderWidth:1.2, borderColor:'#f43f5e' },
          { type:'bar',  label:'Hist',   data: hist,   parsing:false }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:false },
        scales:{
          x:{ type:'time', time:{ tooltipFormat:'yyyy-MM-dd' }, grid:{ display:false } },
          y:{ beginAtZero:false }
        },
        plugins:{
          legend:{ display:true, position:'top' },
          tooltip:{ enabled:true },
          zoom:{
            pan:{ enabled:true, mode:'x' },
            zoom:{ wheel:{ enabled:true }, pinch:{ enabled:true }, mode:'x' }
          }
        }
      }
    });
  }

  async function tryRenderChartsByJson(ticker, name){
    // âœ… ì„œë²„ ë³€ê²½ ì—†ì´ ê¸°ì¡´ /chart ì—”ë“œí¬ì¸íŠ¸ì— mode=chart_data ì¿¼ë¦¬ë§Œ ì¶”ê°€
    //    - ì„œë²„ê°€ JSONì„ ì§€ì›í•˜ë©´ ì°¨íŠ¸ ë Œë”, ì•„ë‹ˆë©´ ì˜ˆì™¸ â†’ Fallback(ì´ë¯¸ì§€)
    const url = `/api/stock/batch/athena/chart?ticker=${encodeURIComponent(ticker)}&mode=chart_data&ts=${Date.now()}`;
    const res = await fetch(url, { headers: { 'Accept':'application/json' } });
    const ct = res.headers.get('Content-Type') || '';
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    if (!ct.includes('application/json')) throw new Error('Not JSON');

    const payload = await res.json();

    // âœ… ì°¨íŠ¸ ëª¨ë“œë¡œ ì „í™˜: ì´ë¯¸ì§€ ìˆ¨ê¹€
    $chartImage.style.display = 'none';

    // ì´ì „ ì°¨íŠ¸ íŒŒê´´ í›„ ë Œë”
    destroyCharts();
    buildPriceChart($priceCanvas.getContext('2d'), payload);
    buildMacdChart($macdCanvas.getContext('2d'), payload);

    // ë¦¬ì…‹ ë²„íŠ¼ í•¸ë“¤ëŸ¬ (ê°€ê²©/ë§¥ë”” ëª¨ë‘ ë¦¬ì…‹)
    $btnResetZoom.onclick = () => {
      try { priceChart.resetZoom(); } catch(e){}
      try { macdChart.resetZoom(); } catch(e){}
    };

    appendLog(`[LOG] ğŸ“ˆ ì°¨íŠ¸ ë°ì´í„°(JSON) ë¡œë“œ ë° ë Œë”ë§ ì™„ë£Œ: ${ticker} - ${name}`);
  }

  /* ================================
     âœ… ì°¨íŠ¸ ëª¨ë‹¬ ë° ìˆ˜ë™ ê²€í† 
     - showChart(): JSON ì°¨íŠ¸ ì‹œë„ â†’ ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ì´ë¯¸ì§€ Fallback
  ================================== */
  window.showChart = async (ticker, name, rowId) => {
    $currentRow = document.getElementById(rowId);
    $modalTitle.textContent = `ğŸ“ˆ ${ticker} - ${name}`;
    $chartModal.classList.remove("hidden");

    try {
      await tryRenderChartsByJson(ticker, name);
    } catch (err) {
      // ğŸ” Fallback: ê¸°ì¡´ ì´ë¯¸ì§€ ë°©ì‹ ìœ ì§€
      destroyCharts();
      $chartImage.style.display = ''; 
      $chartImage.src = `/api/stock/batch/athena/chart?ticker=${encodeURIComponent(ticker)}&ts=${Date.now()}`;
      appendLog(`[LOG] â„¹ï¸ ì„œë²„ JSON ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ì–´ ê¸°ì¡´ ì´ë¯¸ì§€ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. (${ticker})`);
    }
  };

  window.closeChartModal = () => {
    $chartModal.classList.add("hidden");
    $chartImage.src = "";
    destroyCharts();
    $currentRow = null;
  };
  
  window.updateResultStatus = function() {
      if ($currentRow) {
          const scoreCell = $currentRow.cells[2]; 
          
          if (scoreCell.innerHTML.includes('ìˆ˜ë™ ê²€í†  ì™„ë£Œ')) {
              closeChartModal();
              return;
          }

          const originalContent = scoreCell.textContent;
          scoreCell.innerHTML = `
            <span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">
              â­ ìˆ˜ë™ ê²€í†  ì™„ë£Œ
            </span> 
            ${originalContent}
          `;

          $currentRow.classList.add('bg-green-50');
          $currentRow.classList.remove('hover:bg-gray-100'); 
          $currentRow.classList.add('transition-colors', 'duration-500');

          const ticker = $currentRow.cells[0].textContent;
          appendLog(`[UPDATE] ${ticker} ì¢…ëª©ì´ ìˆ˜ë™ ê²€í†  ì™„ë£Œ(ìœ ë§ ì¢…ëª©)ë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
      closeChartModal();
  };

  /* ================================
     âœ… SSE ì—°ê²° ë° ìƒíƒœ ì²˜ë¦¬
  ================================== */
  function connectSSE() {
    if (es) { try { es.close(); } catch {} }
    
    appendLog(`[LOG] SSE ì—°ê²° ì‹œë„. í˜„ì¬ ì‚¬ìš©ì ID: ${currentUser}`);

    es = new EventSource("/api/stock/batch/athena/sse");

    es.onopen = () => {
        appendLog("[LOG] SSE ì—°ê²° ì„±ê³µ.");
    };

    es.addEventListener("status", (ev) => {
      const d = JSON.parse(ev.data || "{}");
      
      if (d.globalStatus) {
        updateGlobalState(d.globalStatus, d.globalRunner, d.globalProgress);
        updateButtonState(d.globalStatus, d.globalRunner); 
      }
      
      if (Array.isArray(d.logs))
        d.logs.forEach(line => appendLog(line));

      if (Array.isArray(d.results)) {
        renderResults(d.results);
      }
      
      if (d.taskId) currentTaskId = d.taskId;
    });

    es.onerror = () => {
      appendLog("[ERROR] SSE ì—°ê²° ì˜¤ë¥˜ ë°œìƒ. 2ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„.");
      try { es.close(); } catch {}
      es = null;
      updateButtonState("IDLE", currentUser); 
      setTimeout(connectSSE, 2000);
    };
  }

  /* ================================
     âœ… ì‹¤í–‰
  ================================== */
  window.runAnalysis = async () => {
    if ($runBtn.disabled) {
        if (globalStatus === 'RUNNING' && $globalRunner.textContent !== currentUser) {
            appendLog("[ERROR] âš ï¸ ë‹¤ë¥¸ ì‚¬ìš©ì(" + $globalRunner.textContent + ")ê°€ ì´ë¯¸ ë¶„ì„ì„ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        } else {
            appendLog("[ERROR] âš ï¸ í˜„ì¬ ë¶„ì„ ì‹¤í–‰ì´ ë¶ˆê°€ëŠ¥í•œ ìƒíƒœì…ë‹ˆë‹¤. ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
        return; 
    }
    
    updateButtonState("RUNNING", currentUser);
    $log.innerHTML = `<p class="opacity-70">ë¶„ì„ ìš”ì²­ ì‹œì‘...</p>`;
    $resultTableBody.innerHTML = "";
    $noResultBox.classList.add("hidden");

    const pattern = getSelectedPattern();
    const workers = document.getElementById("workerCount").value;
    const topN = document.getElementById("topNCount").value;
    const maPeriods = getMaPeriods(); // "20,60,200"

    const url = `/api/stock/batch/athena/start`
      + `?pattern=${pattern}`
      + `&workers=${workers}`
      + `&maPeriods=${maPeriods}` 
      + `&topN=${topN}`
      + `&symbol=`;

    try {
        const res = await fetch(url, { method: "POST" });
        if (res.ok) {
          const d = await res.json();
          currentTaskId = d.taskId;
          appendLog(`ğŸŸ¢ ì‹¤í–‰ ìš”ì²­ ì„±ê³µ. ì‘ì—…ì: ${d.runner}. SSEë¥¼ í†µí•´ ìƒíƒœ ì¶”ì `);
        } else {
          const err = await res.json();
          const errorMsg = err.error || res.statusText;
          
          if (errorMsg.includes('ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.')) {
              const otherRunner = err.runner || 'ì•Œ ìˆ˜ ì—†ìŒ';
              appendLog(`[ERROR] ğŸš¨ ì‹¤í–‰ ì‹¤íŒ¨: ë‹¤ë¥¸ ì‚¬ìš©ì(${otherRunner})ê°€ ì´ë¯¸ ë¶„ì„ì„ ì„ ì í–ˆìŠµë‹ˆë‹¤.`);
              updateGlobalState("RUNNING", otherRunner, 0);
              updateButtonState("RUNNING", otherRunner);
          } else {
              appendLog(`âš ï¸ ì‹¤í–‰ ì‹¤íŒ¨ (${res.status}): ${errorMsg}`);
              updateButtonState("IDLE", currentUser); 
          }
        }
    } catch (e) {
        appendLog(`[ERROR] ë¶„ì„ ì‹¤í–‰ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${e.message}`);
        updateButtonState("IDLE", currentUser);
    }
  };

  /* ================================
     âœ… ì·¨ì†Œ (409 ì‹œ ìƒíƒœ ë¦¬ì…‹)
  ================================== */
  window.cancelAnalysis = async () => {
    if (!currentTaskId || $cancelBtn.disabled) return;
    
    $cancelBtn.disabled = true;
    appendLog("ğŸ”´ ì·¨ì†Œ ìš”ì²­ ì „ì†¡ ì¤‘...");

    try {
        const res = await fetch(`/api/stock/batch/athena/cancel/${currentTaskId}`, { method: "POST" });
        if (res.ok) {
          appendLog("ğŸŸ¥ ì‘ì—… ì·¨ì†Œ ìš”ì²­ë¨. ìƒíƒœ ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘...");
        } else {
            let errorMsg = res.statusText;
            
            if (res.status === 409) {
                errorMsg = "ì‘ì—…ì´ ì´ë¯¸ ì™„ë£Œ, ì‹¤íŒ¨ ë˜ëŠ” ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ìµœì¢… ìƒíƒœì—ì„œëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                updateGlobalState("IDLE", currentUser, 0); 
                updateButtonState("IDLE", currentUser);
                currentTaskId = null;
            } else {
                try {
                    const err = await res.json();
                    errorMsg = err.error || errorMsg;
                } catch (e) {}
            }
            
            appendLog(`âš ï¸ ì·¨ì†Œ ìš”ì²­ ì‹¤íŒ¨ (${res.status}): ${errorMsg}`);
            if (res.status !== 409) {
                $cancelBtn.disabled = false;
                updateButtonState(globalStatus, $globalRunner.textContent);
            }
        }
    } catch (e) {
        appendLog(`[ERROR] ì·¨ì†Œ ìš”ì²­ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${e.message}`);
        $cancelBtn.disabled = false;
        updateButtonState(globalStatus, $globalRunner.textContent);
    }
  };

  /* ================================
     âœ… ì´ˆê¸° ì‹¤í–‰ ë° ìƒíƒœ ì„¤ì •
  ================================== */
  function setInitialSectionState() {
      $analysisTypeContent.style.maxHeight = null; 
      document.getElementById('analysisTypeArrow').classList.add('rotate-180');
      
      $filteringOptionsContent.style.maxHeight = '0px'; 
      document.getElementById('filteringOptionsArrow').classList.remove('rotate-180'); 

      $topNCountContent.style.maxHeight = null; 
      document.getElementById('topNCountArrow').classList.add('rotate-180');
  }

  (async function init() {
    await initCurrentUser();
    connectSSE();
    attachDragListeners();
    toggleMaPeriods();
    setInitialSectionState();
    updateButtonState(globalStatus, $globalRunner.textContent);
  })();

})();
</script>
</th:block>

    </div>
  </div>
 </body>
</html>
