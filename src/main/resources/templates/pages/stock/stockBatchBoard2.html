<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
<meta charset="UTF-8">
<title>📊 Stock Batch Dashboard</title>

<style>
  .content-container {
    width: 100%;
    max-width: 1600px;
    margin: 0 auto;
    padding: 1rem 2%;
    box-sizing: border-box;
  }
  h2 {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 0.4rem;
    color: #111827;
  }

  .card-box, .dashboard-cards, .log-wrapper {
    background: #fff;
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    margin-top: 14px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    color: #fff;
    min-width: 110px;
    text-align: center;
  }
  .btn-start { background:#2563eb; }
  .btn-cancel { background:#dc2626; }
  .btn:disabled { opacity:0.5; cursor:not-allowed; }

  .controls {
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    align-items: center;
  }
  input[type=number] {
    width:90px;
    padding:0.45rem 0.6rem;
    border:1px solid #bbb;
    border-radius:6px;
  }

  .dashboard-cards {
    display:flex;
    flex-wrap:wrap;
    gap:14px;
  }
  .card {
   flex:1 1 300px;
    background:#fff;
    border-radius:12px;
    padding:16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    display:flex;
    flex-direction:column;
  }
  .card-header {
    display:flex;
    align-items:center;
    gap:6px;
    font-size:0.95rem;
    font-weight:600;
    margin-bottom:6px;
  }
  .card-header i { color:#2563eb; }
  .card-header .right {
    margin-left:auto;
    font-weight:600;
    font-size:0.9rem;
  }

  .progress-bar {
    width:100%;
    background:#e5e7eb;
    height:14px;
    border-radius:7px;
    margin-top:10px;
    overflow:hidden;
  }
  .progress-bar div { height:100%; width:0%; transition:width .3s; }
  .bar-total div { background:#2563eb; }
  .bar-krx div { background:#10b981; }
  .bar-data div { background:#f59e0b; }

  .status { display:none; }
  .msg { display:none; }

  .log-wrapper h3 {
    margin:0;
    font-size:1rem;
    font-weight:600;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .copy-btn {
    font-size:0.9rem;
    cursor:pointer;
    color:#007bff;
    margin-left:8px;
  }
  .copy-btn:hover {
    color:#0056b3;
    text-decoration:underline;
  }

  .log-box {
    background:#111;
    color:#eee;
    font-family:Consolas, monospace;
    font-size:13px;
    padding:10px;
    border-radius:10px;
    height:350px;
    overflow-y:auto;
    white-space:pre-wrap;
    border:1px solid #333;
    margin-top:6px;
  }
</style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>📊 종목 일괄 업데이트 Dashboard</h2>
    <p>진행상황 + 실시간 로그 확인 가능합니다.</p>

    <div class="card-box">
      <div class="controls">
        <label>워커:
          <input type="number" id="workers" value="8" min="1" max="16">
        </label>
        <label><input type="checkbox" id="force"> 강제 다운로드</label>
        <button id="btnStart" class="btn btn-start">업데이트 시작</button>
        <button id="btnCancel" class="btn btn-cancel" disabled>취소</button>
      </div>
      <div id="adminHint" style="font-size:12px;color:#666;margin-top:4px;">
        ※ 관리자만 실행 가능
      </div>
    </div>

    <div class="dashboard-cards">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-layer-group"></i>전체 진행률 
          <span class="right" id="badgeTotal">진행중</span>
        </div>
        <strong id="pctTotal">0%</strong>
        <div class="progress-bar bar-total"><div id="barTotal"></div></div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-database"></i>KRX 종목 목록
          <span class="right" id="badgeKrx"></span>
        </div>
        <strong id="pctKrx">0%</strong>
        <div class="progress-bar bar-krx"><div id="barKrx"></div></div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-chart-line"></i>개별 종목 데이터
          <span class="right" id="badgeData"></span>
        </div>
        <strong id="pctData">0%</strong>
        <div class="progress-bar bar-data"><div id="barData"></div></div>
      </div>
    </div>

    <div class="log-wrapper">
      <h3>
        실시간 로그
        <span class="copy-btn" id="copyLogBtn">📋 로그복사</span>
      </h3>
      <div id="logBox" class="log-box">로그가 표시됩니다...</div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
(function(){
  const API = {
    start:(w,f)=>`/api/stock/batch/update?workers=${w}${f?"&force=true":""}`,
    status:(id)=>`/api/stock/batch/status/${id}`,
    cancel:(id)=>`/api/stock/batch/cancel/${id}`
  };

  const $workers=document.getElementById("workers"),
        $force=document.getElementById("force"),
        $btnStart=document.getElementById("btnStart"),
        $btnCancel=document.getElementById("btnCancel"),
        $barTotal=document.getElementById("barTotal"),
        $barKrx=document.getElementById("barKrx"),
        $barData=document.getElementById("barData"),
        $pctTotal=document.getElementById("pctTotal"),
        $pctKrx=document.getElementById("pctKrx"),
        $pctData=document.getElementById("pctData"),
        $log=document.getElementById("logBox"),
        $badgeTotal=document.getElementById("badgeTotal"),
        $badgeKrx=document.getElementById("badgeKrx"),
        $badgeData=document.getElementById("badgeData"),
        $hint=document.getElementById("adminHint"),
        $copyLogBtn=document.getElementById("copyLogBtn");

  let taskId=null, poll=null, lastLogSeq=0, polling=false;

  function setBar(bar,pct,v){
    v=Math.max(0,Math.min(100,Math.round(v||0)));
    bar.style.width=v+"%"; pct.textContent=v+"%";
  }

  function disableUI(dis){
    $btnStart.disabled=dis;
    $btnCancel.disabled=!dis;
    $workers.disabled=dis;
    $force.disabled=dis;
  }

  function resetAll(){
    setBar($barTotal,$pctTotal,0);
    setBar($barKrx,$pctKrx,0);
    setBar($barData,$pctData,0);
    $log.textContent="";
    $badgeTotal.textContent="진행중";
    $badgeKrx.textContent="";
    $badgeData.textContent="";
    lastLogSeq=0;
    if(poll){clearInterval(poll);poll=null;}
    polling=false;
    $hint.innerHTML="※ 관리자만 실행 가능";
  }

  function applyProgress(data){
    const st=data?.result ?? {};

    if(typeof st.progress==="number") setBar($barTotal,$pctTotal,st.progress);

    if(st.dataTotal>0){
      const ds=Number(st.dataSaved||0), dt=Number(st.dataTotal||0);
      const p=Math.round((ds/dt)*100);
      setBar($barData,$pctData,p);
      if(ds>=dt) $badgeData.textContent=`✅ 완료 ${dt}/${dt}`;
      else $badgeData.textContent=`${ds}/${dt}`;
    }

    if(typeof st.krxPct==="number"){
      const ks=Number(st.krxSaved||0), kt=Number(st.krxTotal||0);
      setBar($barKrx,$pctKrx,Math.round(st.krxPct));
      if(kt>0){
        if(ks>=kt) $badgeKrx.textContent=`✅ 완료 ${kt}/${kt}`;
        else $badgeKrx.textContent=`${ks}/${kt}`;
      }
    }

    if(data.status==="COMPLETED"){
      setBar($barKrx,$pctKrx,100);
      setBar($barData,$pctData,100);
      setBar($barTotal,$pctTotal,100);
      $badgeTotal.textContent="✅ 업데이트 완료";
      disableUI(false);
    }
  }

  async function pollStatus(){
    if(polling||!taskId)return; polling=true;
    try{
      const res=await fetch(API.status(taskId),{
        headers:{ "Accept":"application/json" },credentials:"include"
      });
      if(!res.ok){polling=false;return;}
      const data=await res.json();
      applyProgress(data);

      if(data.logs){
        let latest=data.logs[data.logs.length-1];
        if(latest && latest.seq > lastLogSeq){
          if($log.textContent.trim()==="" || $log.textContent.includes("로그"))
            $log.textContent=latest.line;
          else
            $log.textContent+="\n"+latest.line;
          lastLogSeq=latest.seq;
          $log.scrollTop=$log.scrollHeight;
        }
      }

      if(["COMPLETED","FAILED","CANCELLED"].includes(data.status)){
        clearInterval(poll);poll=null;disableUI(false);
        if(data.status==="CANCELLED"){
          $hint.innerHTML=`※ 관리자만 실행 가능 <span style="color:#dc2626;font-weight:600;margin-left:6px;">⏹ 취소되었습니다.</span>`;
          if($log.textContent.trim()==="" || $log.textContent.includes("로그"))
            $log.textContent="⏹ 사용자 요청으로 취소됨";
          else
            $log.textContent+="\n⏹ 사용자 요청으로 취소됨";
          $log.scrollTop=$log.scrollHeight;
        }
      }

    }catch(e){console.error(e);}
    polling=false;
  }

  $btnStart.onclick=async()=>{
    resetAll(); disableUI(true);
    const w=+$workers.value||8, f=$force.checked;
    try{
      const res=await fetch(API.start(w,f),{
        method:"POST",headers:{ "Accept":"application/json" },credentials:"include"
      });
      const data=await res.json();
      if(!res.ok){disableUI(false);return;}
      taskId=data.taskId;
      poll=setInterval(pollStatus,700);
    }catch(e){console.error(e);disableUI(false);}
  };

  $btnCancel.onclick=async()=>{
    if(!taskId)return;
    $btnCancel.disabled=true;
    await fetch(API.cancel(taskId),{ method:"POST", credentials:"include" });

    clearInterval(poll);
    poll=null;
    taskId=null;
    disableUI(false);

    $hint.innerHTML=`※ 관리자만 실행 가능 <span style="color:#dc2626;font-weight:600;margin-left:6px;">⏹ 취소되었습니다.</span>`;
    if($log.textContent.trim()==="" || $log.textContent.includes("로그"))
      $log.textContent="⏹ 사용자 요청으로 취소됨";
    else
      $log.textContent+="\n⏹ 사용자 요청으로 취소됨";
    $log.scrollTop=$log.scrollHeight;
  };

  $copyLogBtn.onclick=()=>{
    navigator.clipboard.writeText($log.textContent).then(()=>{
      $copyLogBtn.textContent="✅ 복사됨";
      setTimeout(()=> $copyLogBtn.textContent="📋 복사",1000);
    });
  };

})();
</script>
</th:block>

</body>
</html>
