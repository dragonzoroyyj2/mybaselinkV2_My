<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š AthenaAI ë°°ì¹˜ ì—…ë°ì´íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">

    <!-- ğŸ“Œ Header -->
    <div class="page-header">
      <div class="page-title">
        <h2>ğŸ“„ AthenaAI ì¢…ëª© ë¶„ì„</h2>
      </div>
      <div class="breadcrumb">
        <i class="fas fa-brain"></i><span>AI ë¶„ì„ / AthenaAI</span>
      </div>
    </div>

    <!-- ğŸŒ ì „ì—­ ìƒíƒœ ì¹´ë“œ -->
    <div class="global-status-card mb-6 p-4 rounded-xl border border-gray-300 bg-white shadow-sm">
      <div class="flex justify-between items-center">
        <span class="font-semibold text-gray-700 text-lg">ğŸŒ AthenaAI ì§„í–‰ ìƒíƒœ</span>
        <span id="globalStatusText" class="text-gray-500 font-bold">ëŒ€ê¸°ì¤‘</span>
      </div>
      <div class="flex justify-between text-sm mt-2 text-gray-600">
        <div>ì‹¤í–‰ì: <span id="globalRunner">-</span></div>
        <div>ì§„í–‰ë¥ : <span id="globalProgressLabel">0%</span></div>
      </div>
      <div class="w-full bg-gray-200 h-2 rounded mt-3 overflow-hidden">
        <div id="globalProgressBar" class="h-2 bg-indigo-600 transition-all duration-300 w-0"></div>
      </div>
    </div>

    <!-- âš™ï¸ ë¶„ì„ ì˜µì…˜ -->
    <div class="card-box bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
      <form id="analysisForm" class="space-y-4">
        <div>
          <label class="font-bold text-gray-700 block mb-1">íŒ¨í„´ ìœ í˜•</label>
          <select id="pattern" class="w-full border rounded-lg p-2">
            <option value="ma">ì´ë™í‰ê· ì„  (MA)</option>
            <option value="double_bottom">ì´ì¤‘ë°”ë‹¥ (Double Bottom)</option>
            <option value="triple_bottom">ì‚¼ì¤‘ë°”ë‹¥ (Triple Bottom)</option>
            <option value="cup_and_handle">ì»µì•¤í•¸ë“¤ (Cup & Handle)</option>
            <option value="decline_5d">5ì¼ ì—°ì† í•˜ë½</option>
            <option value="decline_20d">20ì¼ ì—°ì† í•˜ë½</option>
          </select>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label class="font-bold text-gray-700 block mb-1">ì‘ì—…ì ìˆ˜</label>
            <input type="number" id="workers" value="8" min="1" max="16" class="w-full border rounded-lg p-2 text-center font-bold">
          </div>
          <div>
            <label class="font-bold text-gray-700 block mb-1">ë¶„ì„ ì—°ë„</label>
            <input type="number" id="years" value="5" min="1" max="10" class="w-full border rounded-lg p-2 text-center font-bold">
          </div>
          <div class="flex items-center mt-6">
            <input type="checkbox" id="excludeNeg" checked class="mr-2 w-5 h-5 text-red-500">
            <label for="excludeNeg" class="font-semibold text-gray-700">ğŸš« ì•…ì¬ ì¢…ëª© ì œì™¸</label>
          </div>
        </div>
      </form>

      <div class="flex gap-3 mt-6">
        <button id="runAnalysisBtn" class="flex-grow px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700 transition"
                onclick="runAnalysis()">ğŸš€ ë¶„ì„ ì‹¤í–‰</button>
        <button id="cancelBtn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg shadow hover:bg-red-700 transition"
                onclick="cancelAnalysis()" disabled>âŒ ì·¨ì†Œ</button>
      </div>
    </div>

    <!-- ğŸ“œ ë¡œê·¸ ì¶œë ¥ -->
    <div class="mt-6 bg-gray-900 text-gray-100 rounded-lg p-4 h-64 overflow-y-scroll font-mono text-sm" id="logBox">
      <div>[INFO] AthenaAI ë¶„ì„ ì¤€ë¹„ ì™„ë£Œ...</div>
    </div>

  </div>
</div>

<!-- âœ… Script -->
<th:block layout:fragment="pageScript">
<script>
let currentTaskId = null;
let eventSource = null;

// ===============================
// ğŸ“¡ SSE ì—°ê²°
// ===============================
function connectSSE() {
  if (eventSource) eventSource.close();
  eventSource = new EventSource("/api/stock/batch/athena/sse");

  eventSource.onmessage = e => {
    const data = JSON.parse(e.data);
    updateStatus(data);
  };

  eventSource.onerror = e => {
    console.warn("SSE ì—°ê²° ì¢…ë£Œë¨", e);
    eventSource.close();
  };
}

// ===============================
// ğŸš€ ë¶„ì„ ì‹¤í–‰
// ===============================
async function runAnalysis() {
  if (currentTaskId) {
    appendLog("[WARN] ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.", "orange");
    return;
  }

  const pattern = document.getElementById("pattern").value;
  const workers = document.getElementById("workers").value;
  const years = document.getElementById("years").value;
  const excludeNeg = document.getElementById("excludeNeg").checked;

  document.getElementById("runAnalysisBtn").disabled = true;
  document.getElementById("cancelBtn").disabled = false;
  appendLog(`[INFO] AthenaAI ë¶„ì„ ìš”ì²­ ì¤‘... (pattern=${pattern})`);

  try {
    const res = await fetch(`/api/stock/batch/athena/start?pattern=${pattern}&workers=${workers}&years=${years}&excludeNeg=${excludeNeg}`, {
      method: "POST"
    });

    if (!res.ok) {
      const err = await res.json();
      appendLog(`[ERROR] ì‹¤í–‰ ì‹¤íŒ¨: ${err.error || res.statusText}`, "red");
      resetUI();
      return;
    }

    const result = await res.json();
    currentTaskId = result.taskId;
    appendLog(`[INFO] ì‘ì—… ì‹œì‘ë¨: ${currentTaskId}`);
    updateGlobalStatus("RUNNING", 0, result.runner);
  } catch (e) {
    appendLog(`[ERROR] ì„œë²„ ìš”ì²­ ì‹¤íŒ¨: ${e.message}`, "red");
    resetUI();
  }
}

// ===============================
// âŒ ì·¨ì†Œ
// ===============================
async function cancelAnalysis() {
  if (!currentTaskId) {
    appendLog("[WARN] í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.", "orange");
    return;
  }

  const taskId = currentTaskId;
  appendLog(`[WARN] ì‘ì—…(${taskId}) ì·¨ì†Œ ìš”ì²­ ì¤‘...`);

  try {
    const res = await fetch(`/api/stock/batch/athena/cancel/${taskId}`, { method: "POST" });
    const result = await res.json();

    if (result.cancelled) {
      appendLog(`[INFO] ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    } else {
      appendLog(`[ERROR] ì·¨ì†Œ ì‹¤íŒ¨: ${result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`, "red");
    }
  } catch (e) {
    appendLog(`[ERROR] ì·¨ì†Œ ì¤‘ í†µì‹  ì˜¤ë¥˜: ${e.message}`, "red");
  } finally {
    resetUI();
  }
}

// ===============================
// ğŸ” ìƒíƒœ ì—…ë°ì´íŠ¸
// ===============================
function updateStatus(data) {
  if (!data) return;

  if (data.status === "IN_PROGRESS") {
    updateGlobalStatus("RUNNING", data.globalProgress, data.runner);
    if (data.logs) data.logs.forEach(line => appendLog(line));
  } else if (data.status === "FAILED") {
    appendLog("[ERROR] ë¶„ì„ ì‹¤íŒ¨", "red");
    updateGlobalStatus("FAILED", data.globalProgress);
    resetUI();
  } else if (data.status === "COMPLETED") {
    appendLog("[SUCCESS] ë¶„ì„ ì™„ë£Œ âœ…", "green");
    updateGlobalStatus("COMPLETED", 100);
    resetUI();
  } else if (data.status === "CANCELLED") {
    appendLog("[CANCELLED] ì‚¬ìš©ìì— ì˜í•´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", "orange");
    updateGlobalStatus("CANCELLED", 0);
    resetUI();
  }
}

// ===============================
// ğŸ§­ ìƒíƒœ í‘œì‹œ UI
// ===============================
function updateGlobalStatus(status, progress = 0, runner = "-") {
  const statusEl = document.getElementById("globalStatusText");
  const bar = document.getElementById("globalProgressBar");
  const label = document.getElementById("globalProgressLabel");
  const runnerEl = document.getElementById("globalRunner");

  runnerEl.textContent = runner;
  label.textContent = Math.floor(progress) + "%";
  bar.style.width = `${progress}%`;

  let color = "text-gray-500";
  if (status === "RUNNING") color = "text-indigo-600";
  if (status === "FAILED") color = "text-red-600";
  if (status === "COMPLETED") color = "text-green-600";
  if (status === "CANCELLED") color = "text-yellow-500";

  statusEl.className = `font-bold ${color}`;
  statusEl.textContent = status;
}

// ===============================
// ğŸ§¹ ë¡œê·¸ ì¶œë ¥
// ===============================
function appendLog(text, color = "#9ca3af") {
  const logBox = document.getElementById("logBox");
  const el = document.createElement("div");
  el.innerHTML = `<span style="color:${color}">${text}</span>`;
  logBox.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
}

// ===============================
// ğŸ” UI ì´ˆê¸°í™”
// ===============================
function resetUI() {
  currentTaskId = null;
  document.getElementById("runAnalysisBtn").disabled = false;
  document.getElementById("cancelBtn").disabled = true;
}

// ===============================
// ğŸš€ ì´ˆê¸°í™”
// ===============================
window.onload = function() {
  connectSSE();
  appendLog("[INFO] AthenaAI í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. SSE ì—°ê²° ì¤‘...");
};
</script>
</th:block>
</body>
</html>
